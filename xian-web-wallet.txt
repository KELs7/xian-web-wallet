======================================================================
File: xian-web-wallet/background.js
======================================================================
let appTabId = null;

// Retrieve the stored `appTabId` when the service worker starts
chrome.storage.local.get("appTabId", (result) => {
    if (result.appTabId) {
        appTabId = result.appTabId;
        verifyTab(appTabId); // Ensure the tab is still valid on startup
    }
});

// Listener for the extension icon click
chrome.action.onClicked.addListener(() => {
    openOrFocusAppTab();
});

// Function to open a new tab or focus on an existing one
function openOrFocusAppTab() {
    const url = chrome.runtime.getURL('index.html');
    if (appTabId !== null) {
        chrome.tabs.get(appTabId, (existingTab) => {
            if (chrome.runtime.lastError || !existingTab) {
                createTab(); // Create a new tab if the existing one is missing or closed
            } else {
                chrome.tabs.update(appTabId, { active: true }); // Focus on the existing tab
            }
        });
    } else {
        findTab(); // Try finding the tab first before creating a new one
    }
}

// Function to find the existing app tab by URL
function findTab() {
    const url = chrome.runtime.getURL('index.html');
    chrome.tabs.query({ url }, (tabs) => {
        if (tabs.length > 0) {
            appTabId = tabs[0].id;
            chrome.storage.local.set({ appTabId });
            chrome.tabs.update(appTabId, { active: true });
        } else {
            createTab(); // If no existing tab, create a new one
        }
    });
}

// Function to create a new app tab
function createTab() {
    const url = chrome.runtime.getURL('index.html');
    chrome.tabs.create({ url }, (newTab) => {
        appTabId = newTab.id;
        chrome.storage.local.set({ appTabId });
    });
}

// Verify if a stored tab ID is still valid and open
function verifyTab(tabId) {
    chrome.tabs.get(tabId, (tab) => {
        if (chrome.runtime.lastError || !tab) {
            appTabId = null;
            chrome.storage.local.remove("appTabId");
        }
    });
}

// Listener for messages from the content script
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
    if (["dAppSendTransaction", "getWalletInfo", "dAppSignMessage", "dAppAddToken"].includes(message.type)) {
        if (appTabId === null) findTab();

        if (appTabId === null && message.type === "getWalletInfo") {
            sendResponse({ address: "", locked: true, chainId: "" });
            return;
        }

        chrome.tabs.sendMessage(appTabId, message, sendResponse);
    }
    return true; // Indicate that we will send a response asynchronously
});

// Listener for when a tab is removed
chrome.tabs.onRemoved.addListener((tabId) => {
    if (tabId === appTabId) {
        appTabId = null;
        chrome.storage.local.remove("appTabId");
    }
});

// Listener for when a tab is updated
chrome.tabs.onUpdated.addListener((tabId, changeInfo) => {
    if (tabId === appTabId && changeInfo.status === "complete") {
        appTabId = tabId;
        chrome.storage.local.set({ appTabId });
    }
});

======================================================================
File: xian-web-wallet/index-external.html
======================================================================
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xian Wallet</title>
    <meta name="description"
        content="Manage your Xian wallet. No browser extension required. No server-side processing. Open-Source.">
 


    <link rel="icon" type="image/png" href="assets/logo.png">

    <link rel="stylesheet" href="css/style.css?v=1">
    <link rel="stylesheet" href="css/custom.css?v=312">
    <link rel="stylesheet" href="css/lint.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">


    <link rel="stylesheet" href="css/codemirror.css">
    <script src="js/dark-mode.js?v=1"></script>
    <script src="js/external.js"></script>
</head>

<body class="dark-mode">
    

    <div class="app-container" style="padding: 0 !important;">

        <div class="app-box" style="border:0!important">
            <div style="
display: flex;

height: 100%;
">
                <div style="
display: flex;max-width: 100%; width: 100%;flex-direction: column;;
" id="app-box">
                </div>
            </div>
        </div>
    
    </div>

    <button class="btn dark-mode-toggler d-none" id="darkModeToggler" title="Toggle Dark Mode">
        <i class="fas fa-moon"></i> <!-- Default icon -->
    </button>

    <script src="js/providers/bip39.bundle.js"></script>
    <script src="js/providers/micro-ed25519-hdkey.bundle.js"></script>
    <script src="js/providers/bootstrap-bundle.min.js"></script>
    <script src="js/toaster.js"></script>
    <script src="js/providers/nacl.js"></script>
    <script src="js/cookietoolz.js"></script>
    <script src="js/xian.js?v=13237"></script>
    <script src="js/router.js?v=133223272"></script>
    <script src="js/helpers.js"></script>
    <script src="js/providers/codemirror.js"></script>
    <script src="js/providers/python.js"></script>
    <script src="js/providers/lint.js"></script>
    <script src="js/index.js?v=122"></script>
    <script src="js/extension.js"></script>
    <script src="js/tx-result-manager.js"></script>
    
</body>

</html>

======================================================================
File: xian-web-wallet/content.js
======================================================================
const isJSON = (json) => {
	if (Object.prototype.toString.call(json) !== "[object String]") return false
    try{
        return JSON.parse(json)
    }catch (e){ return false}
}

document.addEventListener('xianWalletGetInfo', (event) => {
    getWalletInfo()
});

document.addEventListener('xianWalletSendTx', (event) => {
    xianWalletSendTx(event.detail)
});

document.addEventListener('xianWalletSignMsg', (event) => {
    xianWalletSignMsg(event.detail)
});

document.addEventListener('xianWalletAddToken', (event) => {
    xianWalletAddToken(event.detail)
});

const xianWalletSendTx = (detail) => { 
    chrome.runtime.sendMessage({type: 'dAppSendTransaction', data: detail}, (response) => {
        if(!chrome.runtime.lastError || response !== 'ok'){
            document.dispatchEvent(new CustomEvent('xianWalletTxStatus', {detail: response}));
            handleFocus();
        }
    });
}

const getWalletInfo = () => {  
    chrome.runtime.sendMessage({type: 'getWalletInfo'}, (response) => {
        if(!chrome.runtime.lastError || response !== 'ok'){
            document.dispatchEvent(new CustomEvent('xianWalletInfo', {detail: response}));
        }
    });
}

const xianWalletSignMsg = (detail) => {
    chrome.runtime.sendMessage({type: 'dAppSignMessage', data: detail}, (response) => {
        if(!chrome.runtime.lastError || response !== 'ok'){
            document.dispatchEvent(new CustomEvent('xianWalletSignMsgResponse', {detail: response}));
            handleFocus();
        }
    });
}

const xianWalletAddToken = (detail) => {
    chrome.runtime.sendMessage({type: 'dAppAddToken', data: detail}, (response) => {
        if(!chrome.runtime.lastError || response !== 'ok'){
            document.dispatchEvent(new CustomEvent('xianWalletAddTokenResponse', {detail: response}));
            handleFocus();
        }
    });
}

const handleFocus = () => {
    window.blur();
    setTimeout(() => {
        window.focus();
    }, 100);
};

// Dispatch xianReady event when the content script is loaded and ready
document.dispatchEvent(new CustomEvent('xianReady'));

======================================================================
File: xian-web-wallet/index.html
======================================================================
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xian Wallet</title>
    <meta name="description" content="Manage your Xian wallet. No browser extension required. No server-side processing. Open-Source.">

    <link rel="icon" type="image/png" href="assets/logo.png">

    <link rel="stylesheet" href="css/style.css?v=1">
    <link rel="stylesheet" href="css/custom.css?v=133723">
    <link rel="stylesheet" href="css/lint.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="css/codemirror.css">
    <script src="js/dark-mode.js?v=1"></script>
</head>
<body class="dark-mode">
    <nav class="navbar">
        <div class="container-fluid">
            <div class="navbar-brand" href="index.html">
                
                <div class="app-name"><img src="assets/xian-white.svg" alt="Xian Connect Logo" class="app-logo"><h2>Xian Wallet</h2></div>
                <div class="online-status" id="onlineStatus">Node Status <div class='grey-circle' title='Node Status is Unknown'></div></div>
            </div>
        </div>
    </nav>
    
    <div class="app-container">
        <div class="wrap-app">
            <div class="side-nav" id="side-nav" style="display: none;">
                <div class="side-nav-item" id="side-change-page-wallet">
                    <i class="fas fa-wallet"  title="Wallet"></i>
                    Wallet
                </div>
                <div class="side-nav-item" id="side-change-page-ide">
                    <i class="fas fa-code"  title="IDE"></i>
                    IDE
                </div>
                
                <div class="side-nav-item" id="side-change-page-messenger">
                    <i class="fas fa-envelope"  title="Messenger"></i>
                    Messenger
                </div>
                <div class="side-nav-item" id="side-change-page-ecosystem-news" style="margin-top: auto;">
                    <i class="fas fa-newspaper"  title="Ecosystem News"></i>
                    Chain News
                </div>
                <div class="side-nav-item" id="side-change-page-insights" style="display: none;">
                    <i class="fas fa-link"  title="Insights"></i>
                    Insights
                </div>
                <div class="side-nav-item" id="side-change-page-settings" >
                    <i class="fas fa-cog
                    "  title="Settings"></i>
                    Settings
                </div>
                
                <div class="side-nav-item" id="side-lock-wallet">
                    <i class="fas fa-lock"  title="Logout"></i>
                    Logout
                </div>
            </div>
            <div class="app-box" >
                <div  style="
display: flex;

height: 100%;
">
<div style="
display: flex;max-width: 100%; width: 100%;flex-direction: column;;
" id="app-box">
</div>
</div>
            </div>
        </div>
    </div>

    <button class="btn dark-mode-toggler d-none" id="darkModeToggler" title="Toggle Dark Mode">
        <i class="fas fa-moon"></i> <!-- Default icon -->
    </button>   

    <script src="js/providers/bip39.bundle.js"></script>
    <script src="js/providers/micro-ed25519-hdkey.bundle.js"></script>
    <script src="js/providers/bootstrap-bundle.min.js"></script>
    <script src="js/toaster.js"></script>
    <script src="js/providers/libsodium.js"></script>
    <script src="js/providers/nacl.js"></script>
    <script src="js/cookietoolz.js"></script>
    <script src="js/placeholder.min.js"></script>
    <script src="js/xian.js?v=132337"></script>
    <script src="js/router.js?v=13377"></script>
    <script src="js/helpers.js"></script>
    <script src="js/providers/codemirror.js"></script>
    <script src="js/providers/python.js"></script>
    <script src="js/providers/lint.js"></script>
    <script src="js/index.js?v=122"></script>
    <script src="js/extension.js"></script>
    <script src="js/tx-result-manager.js"></script>
    <script src="js/providers/pyodide-0.25.1/pyodide.js"></script>
    <script src="js/pyodide-linting.js"></script>
</body>
</html>

======================================================================
File: xian-web-wallet/README.md
======================================================================
# Xian Web Wallet & Extension

Available at https://wallet.xian.org

Or get it as a browser extension to interact with dApps. https://chromewebstore.google.com/detail/xian-wallet/kcimjjhplbcgkcnanijkolfillgfanlc

## Introduction
Xian Web Wallet is a cutting-edge, serverless web application tailored for secure wallet management and cryptographic keypair generation, utilizing advanced client-side JavaScript.

## Features
- **Wallet Management**: Intuitive interface for managing your cryptocurrency wallet, including sending and receiving transactions.
- **Serverless Architecture**: Operates entirely on the client-side, simplifying deployment and eliminating the need for server-side infrastructure.
- **Secure Key Management**: Securely generates and manages Xian keypairs with robust encryption techniques.

## Getting Started

### Prerequisites
As Website
- A web server with HTTPS cert
- A node that you are allowed to connect to (CORS)


As Extension
- Load the folder as an unpacked extension

## Security
Security and privacy are paramount in Xian Web Wallet:
- Executes all cryptographic functions client-side, ensuring private keys never leave the user's device.
- Important Keys are encrypted
- It's recommended to use a strong, unique password for your wallet and ensure your device is secure against unauthorized access.

## dApp Integration
**Only for Extension**

Documented at [https://github.com/xian-network/dapp-utils](https://github.com/xian-network/dapp-utils)


## Contributions
We warmly welcome contributions to Xian Web Wallet. To contribute, fork the repository, make your changes, and submit a pull request.

## Disclaimer
Xian Web Wallet is offered "as is", with no warranties. Users should use it at their own risk, understanding the inherent responsibilities of managing cryptographic assets.

======================================================================
File: xian-web-wallet/templates/request-transaction.html
======================================================================
<h1 class="app-box-title">Transaction Request</h1>
<p class="app-box-description">You have received a transaction request from a website.</p>
<div id="failure-alert" class="alert alert-danger d-none">
    <strong>This transaction will most likely fail!</strong>
    <p>The outcome of this transaction is: <span id="failure-reason"></span></p>
</div>
<div class="app-box-form">
    <div class="form-group">
        <label for="requestTransactionContract">Contract</label>
        <p id="requestTransactionContract"></p>
    </div>
    <div class="form-group">
        <label for="requestTransactionFunction">Function</label>
        <p id="requestTransactionFunction" style="text-overflow: ellipsis;
    overflow: hidden;"></p>
    </div>
    <div class="form-group">
        <label for="requestTransactionParams">Parameters</label>
        <details> 
            <summary>Show/Hide Parameters</summary>
            <p id="requestTransactionParams" style="word-break: break-all;"></p>
        </details>
    </div>
    <div class="form-group">
        <label for="requestTransactionChainId">Chain ID</label>
        <p id="requestTransactionChainId"></p>
    </div>
    <div class="form-group">
        <label for="requestTransactionStampLimit">Transaction Fee</label>
        <p id="stamp_line">Calculating..</p>
        <p id="stamp_line_finished" style="display: none;"><span id="requestTransactionStampLimit"></span> Stamps (<span id="requestTransactionStampLimitXian"></span> Xian)</p>
    </div>
    <div class="btn-group">
        <button class="btn btn-primary" id="request-transaction-accept">Accept</button>
        <button class="btn btn-secondary" id="request-transaction-reject">Reject</button>
    </div>
</div>
<script src="templates/page_js/request-transaction.js"></script>

======================================================================
File: xian-web-wallet/templates/request-token.html
======================================================================
<h1 class="app-box-title">Token Add Request</h1>
<p class="app-box-description">You have received a request to add a token from a website.</p>
<div class="app-box-form">
    <div class="form-group">
        <label for="requestTokenMessage">Token Contract</label>
        <p id="requestTokenMessage"></p>
    </div>

    <div class="form-group">
        <label for="requestTokenName">Token Name</label>
        <p id="requestTokenName"></p>
    </div>

    <div class="form-group">
        <label for="requestTokenSymbol">Token Symbol</label>
        <p id="requestTokenSymbol"></p>
    </div>
    
    <div class="btn-group">
        <button class="btn btn-primary" id="request-token-accept">Accept</button>
        <button class="btn btn-secondary" id="request-token-reject">Reject</button>
    </div>
</div>
<script src="templates/page_js/request-token.js"></script>

======================================================================
File: xian-web-wallet/templates/create-token.html
======================================================================
<h1 class="app-box-title">Create Token</h1>
<p class="app-box-description">Create a fungible token on the blockchain.</p>
<div class="app-box-form">
    <div class="alert alert-danger" role="alert" id="createTokenError" style="display: none;"></div>
    <div class="alert alert-success" role="alert" id="createTokenSuccess" style="display: none;"></div>
    <div class="form-group">
        <label for="NameCreateToken">Token Name (*)</label>
        <input type="text" class="form-control" id="NameCreateToken" placeholder="Enter the token name" required>
    </div>
    <div class="form-group">
        <label for="SymbolCreateToken">Token Symbol (*)</label>
        <input type="text" class="form-control" id="SymbolCreateToken" placeholder="Enter the token symbol" required>
    </div>
    <div class="form-group">
        <label for="SupplyCreateToken">Token Supply (*)</label>
        <input type="number" class="form-control" id="SupplyCreateToken" placeholder="Enter the token supply" required>
    </div>
    <div class="form-group">
        <label for="LogoCreateToken">Token Logo URL</label>
        <input type="text" class="form-control" id="LogoCreateToken" placeholder="Enter the token logo URL">
    </div>
    <div class="form-group">
        <label for="WebsiteCreateToken">Token Website URL</label>
        <input type="text" class="form-control" id="WebsiteCreateToken" placeholder="Enter the token website URL">
    </div>
    <div class="form-group">
        <label for="ContractNameCreateToken">Token Contract Name (*)</label>
        <input type="text" class="form-control" id="ContractNameCreateToken" placeholder="con_tokenname" required>
    </div>
    <div class="form-group">
    <small id="emailHelp" class="form-text text-muted">(*) Required fields</small>
    </div>
    <div class="form-group" id="tokenFeeContainer" style="display: none;">
        <label for="transactionFee">Transaction Fee: 
             <span id="estimation-loading">Calculating..</span>
            <span id="estimation-result" style="display:none"><span id="tokenFee"></span> Stamps (<span id="tokenFeeXian"></span> Xian)</label></span>
    </div>
    <div class="btn-group">
        <button class="btn btn-primary" id="btn-create-token-create">Create Token</button>
        <button class="btn btn-secondary" id="btn-create-token-cancel">Cancel</button>
    </div>
</div>
<script src="templates/page_js/create-token.js"></script>

======================================================================
File: xian-web-wallet/templates/wallet.html
======================================================================
<div class="title-container">
    <h1 class="app-box-title">Wallet</h1>
</div>
<div class="app-box-form" style="display: flex;flex-direction: column;height:100%">

    <!-- Modified Wallet Info Card for Account Switching -->
    <div id="wallet-info" class="wallet-info-card mb-3"> <!-- Added margin-bottom -->
        <div class="wallet-info-title">
            <b><span id="selectedAccountName">Account</span></b> <!-- Dynamic Name -->
        </div>
        <div class="wallet-info-address">
            <span id="walletAddress" style="flex-grow: 1;"></span> <!-- Address takes available space -->
            <div class="dropdown"> <!-- Dropdown for account switching -->
                 <button class="btn btn-sm btn-light dropdown-toggle" type="button" id="accountSwitcherDropdown" data-bs-toggle="dropdown" aria-expanded="false" title="Switch Account">
                     <i class="fas fa-users"></i> <!-- Icon for accounts -->
                 </button>
                 <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="accountSwitcherDropdown" id="accountListDropdown">
                     <!-- Account list will be populated here -->
                     <li><a class="dropdown-item" href="#" id="wallet-add-account-btn"><i class="fas fa-plus fa-fw me-2"></i>Create Account</a></li>
                     <li><hr class="dropdown-divider"></li>
                     <!-- Existing accounts added by JS -->
                 </ul>
             </div>
            <a href="#" id="wallet-copy-address" title="Copy Address" class="btn btn-sm btn-light"><i class="far fa-copy"></i></a> <!-- Button style for copy -->
        </div>
    </div>
    <!-- End Modified Wallet Info Card -->

    <div class="wallet-tabs">
        <a href="#" id="wallet-tokens-tab" class="active">Tokens</a> <!-- Removed redundant IDs -->
        <a href="#" id="wallet-nfts-tab">NFTs</a>
        <a href="#" id="local-activity-tab">Local Activity</a>
    </div>
    <div id="wallet-tokens" class="token-list" style=" flex-grow: 1;display: flex;flex-flow: column nowrap;overflow: auto;">
       <!-- Token list populated by JS -->
    </div>
    <div id="wallet-nfts" class="token-list" style=" flex-grow: 1;display: flex;flex-flow: column nowrap;overflow: auto;display: none;">
       <!-- NFT list populated by JS -->
    </div>
    <div id="local-activity" style="display: none; flex-grow: 1;flex-flow: column nowrap;overflow: auto;">
        <div class="title-container">
            <h2 class="token-list-title">Local Activity</h2>
            <i class="fas fa-trash cogwheel-icon" id="wallet-clear-local-activity" title="Clear Local Activity"></i>
        </div>
        <div id="local-activity-list">
            No activity yet.
        </div>
    </div>
    <div style="display:flex;justify-content: space-between; margin-top: 1rem;" id="wallet-adv-btns"> <!-- Added margin-top -->
        <a href="#" id="wallet-refresh-all"><i class="fas fa-sync-alt"></i> Refresh All</a>
        <a href="#" class="advanced-tx-link" id="wallet-send-adv-tx"><i class="fas fa-paper-plane"></i> Advanced Transaction</a>
    </div>
</div>
<script src="templates/page_js/wallet.js"></script>

======================================================================
File: xian-web-wallet/templates/receive-token.html
======================================================================
<h1 class="app-box-title">Receive</h1>
<p class="app-box-description">Receive tokens from another wallet address.</p>
<div class="app-box-form">
    <div class="alert alert-danger" role="alert" id="receiveTokenError" style="display: none;"></div>
    <div class="form-group">
        <label for="yourAddressReceive">Your Address</label>
        <span id="yourAddressReceive"></span>
    </div>
    <div class="btn-group">
        <button class="btn btn-secondary" id="receive-token-back">Back</button>
    </div>
</div>
<script src="templates/page_js/receive-token.js"></script>

======================================================================
File: xian-web-wallet/templates/ecosystem-news.html
======================================================================
<h1 class="app-box-title">Chain News</h1>
<p class="app-box-description">Stay up to date with the latest news and updates from the Xian ecosystem.</p>
<div id="news-container">
  <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Loading news...</div>
</div>
<style>
  .card{
    border: none!important;
  }
</style>
<script src="templates/page_js/ecosystem-news.js"></script>

======================================================================
File: xian-web-wallet/templates/request-signature.html
======================================================================
<h1 class="app-box-title">Signature Request</h1>
<p class="app-box-description">You have received a Signature request from a website.</p>
<div class="app-box-form">
    <div class="form-group">
        <label for="requestSignatureMessage">Message</label>
        <p id="requestSignatureMessage"></p>
    </div>
    
    <div class="btn-group">
        <button class="btn btn-primary" id="request-signature-accept">Accept</button>
        <button class="btn btn-secondary" id="request-signature-reject">Reject</button>
    </div>
</div>
<script src="templates/page_js/request-signature.js"></script>

======================================================================
File: xian-web-wallet/templates/new-proposal.html
======================================================================
<h1 class="app-box-title">Create New Proposal</h1>
<p class="app-box-description">Create a new proposal to change network parameters.</p>
<div class="app-box-form">
    <div class="alert alert-danger" role="alert" id="proposalError" style="display: none;"></div>
    <div class="alert alert-success" role="alert" id="proposalSuccess" style="display: none;"></div>
    <div class="form-group">
        <label for="proposalType">Type</label>
        <input type="text" class="form-control" id="proposalType" placeholder="Enter the proposal type" required>
    </div>
    <div class="form-group">
        <label for="proposalValue">Value</label>
        <input type="text" class="form-control" id="proposalValue" placeholder="Enter the proposal value" required>
    </div>
    <div class="form-group" id="proposalFeeContainer" style="display: none;"> <!-- TODO: make nicer .. -->
        <label for="proposalFee">Transaction Fee: <span id="proposalFee"></span> Stamps (<span id="proposalFeeXian"></span> Xian)</label>
    </div>
    <div class="btn-group">
        <button class="btn btn-primary" id="create-proposal-create">Create Proposal</button>
        <button class="btn btn-secondary" id="create-proposal-cancel">Cancel</button>
    </div>
</div>
<script src="templates/page_js/new-proposal.js"></script>

======================================================================
File: xian-web-wallet/templates/create-wallet.html
======================================================================
<div style="max-width: 30rem;margin:auto;display: flex; flex-direction: column; justify-content: center;height:100%">
<h1 class="app-box-title">Create a Wallet</h1>
<p class="app-box-description">To create a wallet, please enter a password. This password will be used to encrypt your private key. Make sure to remember it, as it <b>cannot be recovered</b>. After creating a wallet, remember to export your private key in the settings for backup.</p>
<div class="app-box-form">
    <div class="alert alert-danger" role="alert" id="createWalletError" style="display: none;"></div>
    <div class="form-group">
        <label for="password">Password</label>
        <input type="password" class="form-control" id="password" placeholder="Enter a password" required>
    </div>
    <div class="form-group">
        <label for="confirmPassword">Confirm Password</label>
        <input type="password" class="form-control" id="confirmPassword" placeholder="Confirm your password" required>
    </div>
    <div class="btn-group">
        <button class="btn btn-primary" id="btn-create-wallet-create">Create Wallet</button>
        <button class="btn btn-secondary" id="btn-create-wallet-back">Back</button>
    </div>
</div>
<script src="templates/page_js/create-wallet.js"></script>

======================================================================
File: xian-web-wallet/templates/password-input.html
======================================================================
<div style="max-width: 30rem;margin:auto;display: flex; flex-direction: column; justify-content: center;height:100%">
    <h1 class="app-box-title">Enter your password</h1>
    <p class="app-box-description">Please enter your password to unlock your wallet.</p>
    <div class="app-box-form">
        <div class="alert alert-danger" role="alert" id="passwordError" style="display: none;"></div>
        <div class="form-group">
            <label for="password">Password</label>
            <input type="password" class="form-control" id="unlock_password" placeholder="Enter your password" autofocus required>
        </div>
        <div class="btn-group">
            <button class="btn btn-primary" id="btn-password-input-unlock-wallet">Unlock Wallet</button>
            <button class="btn btn-secondary" id="btn-password-input-remove-wallet">Remove Wallet</button>
        </div>
    </div>
</div>
<script src="templates/page_js/password-input.js"></script>

======================================================================
File: xian-web-wallet/templates/messenger.html
======================================================================
<h1 class="app-box-title">On-Chain Messenger</h1>
<p class="app-box-description">Send encrypted messages to other users on the chain. Only the recipient can decrypt and read the message, no one else. Your 100% privacy is guaranteed.</p>
<div class="app-box-form" style="display: flex
;
    flex-direction: column;
    flex-grow: 1;">
    <!-- Message Inbox and Chat Box-->
    <div class="d-flex column-mobile flex-grow-1">
        <div class="messenger-inbox">
            <div class="messenger-inbox-header">
                <h5>Chat Partners</h5>
                <a href="#" class="messenger-inbox-new"><i class="fas fa-plus"></i></a>
            </div>
            <div class="messenger-inbox-body">
               
            </div>
        </div>
        <div class="messenger-chat-wrapper">
            <div style="display: none;" class="messenger-chat">
                <div class="messenger-chat-header">
                    <h5 id="address_chat">13ca9a62d10cbc28d55408e0a85d31f5c059fe3bb49316538e1d03064f3f2c8e</h5>
                </div>
                <div class="messenger-chat-body">
                    <!--
                    <div class="messenger-chat-item-me">
                        <div class="messenger-chat-item-content">
                            <p>Hey, how are you?</p>
                            <small>2021-01-01 12:00:00</small>
                        </div>
                    </div>
                    <div class="messenger-chat-item-you">
                        <div class="messenger-chat-item-content">
                            <p>Can you send me the latest code?</p>
                            <small>2021-01-01 12:00:00</small>
                        </div>
                    </div>
                    -->
                </div>
                <div class="messenger-chat-footer">
                    <input type="text" placeholder="Type a message..." id="message_input">
                    <button id="send_message">Send <span id="estimation-loading" style="display: none;">Calculating..</span>
                        <span id="estimation-result" style="display:none"><span id="tokenFee" style="display: none;"></span>(<span id="tokenFeeXian"></span> Xian)</span></button>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="templates/page_js/messenger.js"></script>

======================================================================
File: xian-web-wallet/templates/request.html
======================================================================
<h1 class="app-box-title">Request from <span id="requestFrom">Site</span></h1>
<p class="app-box-description"><span id="requestFrom2">Site</span> is requesting to send a transaction on your behalf.</p>
<div class="app-box-form">
    <div class="alert alert-danger" role="alert" id="requestError" style="display: none;"></div>
    <div class="alert alert-success" role="alert" id="requestSuccess" style="display: none;"></div>
    <div class="form-group">
        <label for="contractRequest">Contract</label>
        <p id="contractRequest" style="text-overflow: ellipsis;overflow: hidden;"></p>
    </div>
    <div class="form-group">
        <label for="methodRequest">Method</label>
        <p id="methodRequest" style="text-overflow: ellipsis;overflow: hidden;"></p>
    </div>
    <div class="form-group">
        <label for="kwargsRequest">Kwargs</label>
        <p id="kwargsRequest" style="text-overflow: ellipsis;overflow: hidden;"></p>
    </div>
    <div class="form-group">
        <label for="stampLimitRequest">Stamp Limit</label>
        <p id="stampLimitRequest" style="text-overflow: ellipsis;overflow: hidden;"></p>
    </div>
    <div class="btn-group">
        <button class="btn btn-primary" id="request-accept-request">Accept Request</button>
        <button class="btn btn-secondary" id="request-reject-request">Reject Request</button>
    </div>
</div>
<script src="templates/page_js/request.js"></script>

======================================================================
File: xian-web-wallet/templates/settings.html
======================================================================
<h1 class="app-box-title">Settings</h1>
<p class="app-box-description">Manage your wallet settings and accounts.</p>
<div class="app-box-form">
    <div class="alert alert-danger" role="alert" id="settingsError" style="display: none;"></div>
    <div class="alert alert-success" role="alert" id="settingsSuccess" style="display: none;"></div>
    <div class="alert alert-warning" role="alert" id="settingsWarning" style="display: none;"></div> <!-- For warnings like needing unlock -->

    <!-- RPC Management (Unchanged) -->
    <div class="form-group">
        <label for="rpc_manager">Network Configuration</label>
        <div class="input-group mb-2">
            <select class="form-control" id="rpc_select">
                <option value="https://node.xian.org,https://explorer.xian.org">Mainnet (node.xian.org)</option>
                <option value="https://testnet.xian.org,https://testnet-explorer.xian.org">Testnet (testnet.xian.org)</option>
                <!-- Custom RPCs added here by JS -->
            </select>
            <div class="input-group-append">
                <button class="btn btn-sm btn-danger" id="remove_rpc_button" title="Remove Selected Custom Network"><i class="fas fa-trash-alt"></i></button>
            </div>
        </div>
        <div class="input-group mb-2">
            <input type="text" class="form-control" id="add_rpc_input" placeholder="Enter new RPC URL (e.g., https://my-node.com)">
            <div class="input-group-append">
                <button class="btn btn-sm btn-secondary" id="add_rpc_button" title="Add Custom Network"><i class="fas fa-plus"></i></button>
            </div>
        </div>
        <div class="input-group">
            <input type="text" class="form-control" id="add_explorer_input" placeholder="Enter corresponding Explorer URL (e.g., https://my-explorer.com)">
        </div>
    </div>
    <hr> <!-- Separator -->

    <!-- View Recovery Phrase Section -->
    <div class="form-group">
        <label>Recovery Phrase (Mnemonic)</label>
        <p>This is your master key. Keep it secret and safe! Anyone with this phrase can access all your accounts.</p>
        <a href="#" id="view_recovery_phrase_link">View Recovery Phrase</a>
        <div id="recovery_phrase_confirmation" style="display: none; margin-top: 10px;">
            <input type="password" class="form-control mb-2" id="recovery_phrase_password" placeholder="Enter password to confirm">
            <button class="btn btn-sm btn-warning" id="confirm_view_recovery_phrase">Confirm</button>
            <button class="btn btn-sm btn-secondary" id="cancel_view_recovery_phrase">Cancel</button>
        </div>
        <div id="recovery_phrase_display_area" class="alert alert-warning" style="display: none; margin-top: 10px; word-wrap: break-word;">
            <strong>Your Recovery Phrase:</strong><br>
            <span id="recovery_phrase_text"></span>
            <button class="btn btn-sm btn-secondary mt-2" id="hide_recovery_phrase">Hide Phrase</button>
        </div>
    </div>
    <hr> <!-- Separator -->

     <!-- Account Management Section -->
     <div class="form-group">
        <label>Accounts</label>
        <p>Manage accounts derived from your recovery phrase.</p>
        <div id="account-list-settings" class="list-group mb-3" style="max-height: 200px; overflow-y: auto;">
            <!-- Account list populated by JS -->
            <div class="list-group-item text-center" id="accounts-loading">
                <i class="fas fa-spinner fa-spin"></i> Loading Accounts...
            </div>
        </div>
        <button class="btn btn-sm btn-primary" id="setting-create-account-btn"><i class="fas fa-plus"></i> Create New Account</button>
     </div>
     <hr> <!-- Separator -->


    <!-- Remove Wallet (Unchanged) -->
    <div class="form-group">
        <label for="remove_wallet_export">Remove Wallet</label>
        <p>Remove this wallet (including all accounts and the recovery phrase) from this browser. This action is irreversible without your recovery phrase.</p>
        <a href="#" id="remove_wallet_export" class="text-danger">Remove this Wallet</a>
    </div>
    <hr> <!-- Separator -->

    <!-- Version Info (Unchanged) -->
    <div class="form-group">
        <label for="version">Wallet Version</label>
        <p id="version">Loading...</p>
    </div>

    <!-- Back button hidden as it's in side nav now -->
    <!--
    <div class="btn-group" style="display:none">
        <button class="btn btn-secondary" id="settings-back">Back</button>
    </div>
    -->
</div>
<!-- Modal for Renaming Account -->
<div class="modal fade" id="renameAccountModal" tabindex="-1" aria-labelledby="renameAccountModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="renameAccountModalLabel">Rename Account</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="renameAccountIndex">
        <div class="mb-3">
          <label for="renameAccountName" class="form-label">New Account Name</label>
          <input type="text" class="form-control" id="renameAccountName" required>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveAccountNameBtn">Save Name</button>
      </div>
    </div>
  </div>
</div>
<script src="templates/page_js/settings.js"></script>

======================================================================
File: xian-web-wallet/templates/import-wallet.html
======================================================================
<div style="max-width: 30rem;margin:auto;display: flex; flex-direction: column; justify-content: center;height:100%">
    <h1 class="app-box-title">Import a Wallet</h1>
    <!-- Updated description -->
    <p class="app-box-description">To import a wallet, please enter your 12 or 24-word recovery phrase (mnemonic) and set a password. This password will be used to encrypt your recovery phrase for storage in this browser. Make sure to remember the password, as it <b>cannot be recovered</b>.</p>
    <div class="app-box-form">
        <div class="alert alert-danger" role="alert" id="importWalletError" style="display: none;"></div>
        <div class="form-group">
            <!-- Changed label and input type/placeholder -->
            <label for="import_mnemonic">Recovery Phrase (Mnemonic)</label>
            <textarea class="form-control" id="import_mnemonic" placeholder="Enter your 12 or 24 words separated by spaces" rows="3" required></textarea>
        </div>
        <div class="form-group">
            <label for="import_password">Password</label>
            <input type="password" class="form-control" id="import_password" placeholder="Enter a password (min. 6 characters)" required>
        </div>
        <div class="form-group">
            <label for="import_confirmPassword">Confirm Password</label>
            <input type="password" class="form-control" id="import_confirmPassword" placeholder="Confirm your password" required>
        </div>
        <div class="btn-group">
            <button class="btn btn-primary" id="btn-import-wallet-import-wallet">Import Wallet</button>
            <button class="btn btn-secondary" id="btn-import-wallet-back">Back</button>
        </div>
    </div>
    </div>
    <!-- Updated script reference -->
    <script src="templates/page_js/import-wallet.js"></script>

======================================================================
File: xian-web-wallet/templates/add-to-token-list.html
======================================================================
<h1 class="app-box-title">Add to token list</h1>
<p class="app-box-description">Add a token to the list of tokens you can interact with.</p>
<div class="app-box-form">
    <div class="alert alert-danger" role="alert" id="addTokenError" style="display: none;"></div>
    <div class="alert alert-success" role="alert" id="addTokenSuccess" style="display: none;"></div>
    <div class="form-group">
        <label for="contractNameAddToken">Contract</label>
        <input type="text" class="form-control" id="contractNameAddToken" placeholder="Enter the contract name" required>
    </div>
    <div class="btn-group">
        <button class="btn btn-primary" id="btn-add-token-add">Add Token</button>
        <button class="btn btn-secondary" id="btn-add-token-cancel">Cancel</button>
    </div>
</div>
<script src="templates/page_js/add-to-token-list.js"></script>

======================================================================
File: xian-web-wallet/templates/advanced-transaction.html
======================================================================
<h1 class="app-box-title">Create Advanced Transaction</h1>
<p class="app-box-description">Directly interact with a smart contract on the Xian Network.</p>
<div class="app-box-form">
    <div class="alert alert-danger" role="alert" id="sendAdvTxError" style="display: none;"></div>
    <div class="alert alert-success" role="alert" id="sendAdvTxSuccess" style="display: none;"></div>
    <div class="form-group">
        <label for="contractName">Contract</label>
        <input type="text" class="form-control" id="contractName" placeholder="Enter the contract name" required>
    </div>
    <div class="form-group">
        <label for="functionName">Function</label>
        <select class="form-control" id="functionName" required>
        </select>
    </div>
    <div class="form-group" id="adv_args" style="display: none;">
        <label for="kwargs">Keyword Arguments</label>
        <div id="adv_kwargs">
           
        </div>
    </div>
    <div class="form-group" id="tokenFeeContainer" style="display: none;">
        <label for="transactionFee">Transaction Fee: 
             <span id="estimation-loading">Calculating..</span>
            <span id="estimation-result" style="display:none"><span id="tokenFee"></span> Stamps (<span id="tokenFeeXian"></span> Xian)</label></span>
    </div>
    <div class="btn-group">
        <button class="btn btn-primary" id="btn-adv-tx-send">Send Transaction</button>
    </div>
</div>
<script src="templates/page_js/advanced-transaction.js"></script>

======================================================================
File: xian-web-wallet/templates/ide.html
======================================================================
<div class="title-container">
    <h1 class="app-box-title">IDE</h1>
</div>
<p class="app-box-description">This is the most basic form of the Xian IDE. You can use it to write and deploy smart contracts on the Xian Network. Find standardized smart contract templates <a href="https://github.com/xian-network/xian-standard-contracts" target="_blank">here</a> and docs <a href="https://docs.xian.org" target="_blank">here</a>. Deployed Smart Contracts can be directly interacted with by using <a href="#" class="advanced-tx-link" id="ide-send-adv-tx">Advanced Transactions</a>.
<div class="app-box-form" style="flex-grow: 1;display: flex;flex-direction: column;">
    <div class="alert alert-danger" role="alert" id="submitContractError" style="display: none;"></div>
    <div class="alert alert-success" role="alert" id="submitContractSuccess" style="display: none;"></div>
    <div class="tabs-editor" id="tabs-editor"></div>
    <div id="editor" style="flex-grow:1"></div>
    <div id="function-boxes">

    </div>
    <div id="submission-form">
        <div class="form-group" style="display: none;" id="submitContractNameWrapper">
            <label for="submitContractName">Contract Name</label>
            <input type="text" class="form-control" id="submitContractName" placeholder="Unique, beginning with 'con_'" required>
        </div>
        <div class="form-group" style="display: none;" id="submitContractconstructorKwargsWrapper">
            <label for="submitContractconstructorKwargs">Constructor Kwargs (If any, not required)</label>
            <input type="text" class="form-control" id="submitContractconstructorKwargs" placeholder="Enter the constructor kwargs in JSON format">
        </div>
        <div class="form-group" style="display: none;" id="submitContractstampLimitWrapper">
            <label for="submitContractstampLimit">Stamp/GAS Limit (1 Xian = <span id="stampRate"><i class='fas fa-spinner fa-spin'></i></span> Stamps)</label>
            <input type="number" class="form-control" id="submitContractstampLimit" placeholder="Enter the stamp limit" required value="800">
        </div>
        <div id="wallet-actions" class="btn-group">
            <button class="btn btn-primary" id="btn-ide-submit-contract">Start Deployment</button>
            <button class="btn btn-secondary" id="btn-ide-go-to-wallet" style="display:none">Back</button>
        </div>
    </div>
</div>

<style>
    #editor > .CodeMirror {
        height: 100%;
    }
    .app-box-form .CodeMirror {
        color: #121212; /* Dark text */
            border:1px solid #ced4da;
        border-bottom-right-radius: 8px;
        border-bottom-left-radius: 8px;
    }
    .dark-mode .app-box-form .CodeMirror{
        background-color: #121212; /* Dark background */
        color: #e4e6eb; /* Bright text */
        border:1px solid #8a8b8e;
        
    }
    .dark-mode .CodeMirror-hscrollbar{
        scrollbar-color: #8a8b8e #121212;
    }
    .dark-mode .app-box-form .CodeMirror-selected {
        background-color: #8a8b8e; /* Dark background */
    }

    .dark-mode .app-box-form .CodeMirror-cursor {
        border-color: #e4e6eb; /* Bright text */
    }
    .dark-mode .app-box-form .CodeMirror-gutters {
        background-color: #202020;
    border-right: 1px solid #8a8b8e;
    }
    .dark-mode .app-box-form .CodeMirror-linenumber {
        color: #e4e6eb;
    }
    #editor{
        margin-bottom: 10px;
    }
    .tabs-editor{
        display: flex;
        justify-content: flex-start;
        flex-wrap: wrap;
        gap: 5px;
        padding: 5px;
        border: 1px solid #ced4da;
        background-color: #f8f9fa;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
        border-bottom: 0px!important;
    }
    .dark-mode .tabs-editor{
        background-color: #202020;
        border: 1px solid #8a8b8e;
        color: #e4e6eb;
    }
    .dark-mode .add-tab-button{
        background-color: #202020;
        border: 1px solid #8a8b8e;
        color: #e4e6eb;
    }
    .tab-editor{
        padding: 5px;
        cursor: pointer;
        border: 1px solid #ced4da;
        border-radius: 8px;
        background-color: #f8f9fa;

        display: flex;
    align-items: center;
    gap: 5px;
    }
    .dark-mode .tab-editor{
        background-color: #494a50;
        border: 1px solid #8a8b8e;
        color: #e4e6eb;
    }
    .tab-editor.active{
        background-color: #fff;
    }
    .dark-mode .tab-editor.active{
        background-color: #8a8b8e;
    }
    .add-tab-button{
        padding: 5px;
        cursor: pointer;
        border: 1px solid #ced4da;
        border-radius: 8px;
        background-color: #f8f9fa;
        position: relative;
    }
    .dark-mode .cm-s-default .cm-builtin {
    color: #e4e6eb;
    }
    .function-box{
        padding: 5px;
    border: 1px solid #ced4da;
    border-radius: 8px;
    background-color: #f8f9fa;
    margin-bottom: 5px;
    display: flex;
    flex-direction: column;
    justify-content: space-around;
    align-items: flex-start;
    gap: 10px;
    }
    .dark-mode .function-box{
        background-color: #494a50;
        border: 1px solid #8a8b8e;
        color: #e4e6eb;
    }
    #function-boxes{
        gap: 10px;
        flex-wrap: wrap;
        display: flex;
    }
    .function-args
    {
        flex:auto;
    }
</style>
<script src="templates/page_js/ide.js"></script>

======================================================================
File: xian-web-wallet/templates/insights.html
======================================================================
<h1 class="app-box-title">Chain Insights</h1>
<p class="app-box-description">Chain Insights provides a detailed view of the Xian Network. Here you can find information about the blockchain's current state.</p>
<div class="app-box-form">
    <div class="alert alert-danger" role="alert" id="governanceError" style="display: none;"></div>
    <div class="alert alert-success" role="alert" id="governanceSuccess" style="display: none;"></div>
    <span id="validator-state"></span>
    <div class="governance-section-wrapper">
        <div class="governance-section-flex">
            <h2 class="governance-sub-title">Stamp Conversion Rate (Pay Fees with XIAN)</h2> 
            <p>Stamps measure the computational effort required to process transactions, while XIAN is used to pay for these stamps.</p>
            <p>1 Xian = <span id="stamp-rate-governance"><i class='fas fa-spinner fa-spin'></i></span> Stamps</p>
            <p>As a point of reference, a typical XIAN transfer transaction costs 14 stamps.</p>
        </div>
       
    </div>
    
    <div class="governance-section-wrapper">
        <div class="governance-section">
            <h2 class="governance-sub-title">Transaction Fee Distribution (Paid in XIAN)</h2>
            <p><span class="label-gov">Foundation:</span> <span class="value-gov" id="transaction-rewards-foundation-governance"><i class='fas fa-spinner fa-spin'></i></span>%</p>
            <p><span class="label-gov">Validators:</span> <span class="value-gov" id="transaction-rewards-validators-governance"><i class='fas fa-spinner fa-spin'></i></span>%</p>
            <p><span class="label-gov">Contract Developers:</span> <span class="value-gov" id="transaction-rewards-developers-governance"><i class='fas fa-spinner fa-spin'></i></span>%</p>
            <p><span class="label-gov">Burned:</span> <span class="value-gov" id="transaction-rewards-burn-governance"><i class='fas fa-spinner fa-spin'></i></span>%</p>
        </div>
        
    </div>
    <div class="governance-section-wrapper">
        <div class="governance-section">
            <h2 class="governance-sub-title">Validators</h2>
            <p><span class="label-gov">Number of Validators:</span> <span class="value-gov" id="number-of-validators-governance"><i class='fas fa-spinner fa-spin'></i></span></p>
        </div>
    </div>
    <div class="governance-section-wrapper">
        <div class="governance-section-flex">
            <h2 class="governance-sub-title">Validator DAO Balance</h2>
            <p><span id="dao-balance-governance"><i class='fas fa-spinner fa-spin'></i></span> Xian</p>
        </div>
    </div>
    <div class="title-container-governance d-none">
        <h2 class="token-list-title">Ongoing Votes</h2>
        <div class="governance-section-buttons" >
            <button class="btn" id="new-proposal" style="display: none;">New Proposal</button>
        </div>
    </div>
    <div id="proposal-list" class="d-none">
        
    </div>
    
    
</div>
<script src="templates/page_js/governance.js"></script>

======================================================================
File: xian-web-wallet/templates/send-token.html
======================================================================
<h1 class="app-box-title"><span>Send<span id="tokenName" style="display:none"></span> <span id="realTokenName" style="display:none"></span></span></h1>
<p class="app-box-description">Send tokens to another wallet address.</p>
<div class="app-box-form">
    <div class="alert alert-danger" role="alert" id="sendTokenError" style="display: none;"></div>
    <div class="alert alert-success" role="alert" id="sendTokenSuccess" style="display: none;"></div>
    <div class="form-group">
        <label for="toAddress">To Address / XNS Name</label>
        <input type="text" class="form-control" id="toAddress" placeholder="Enter the wallet address or XNS name" required>
        <div class="xns-found" style="display: none;">
            <span class="xns-found-text">XNS Found <i class="fa fa-check"></i></span>
            <span class="d-none xns-found-address" id="xnsFoundAddress"></span>
        </div>
    </div>
    <div class="form-group">
        <label for="tokenAmount">Token Amount (max. <span id="maxTokenAmount" style="display:none;cursor:pointer;"></span>)</label>
        <input type="text" class="form-control" id="tokenAmount" placeholder="Enter the token amount" required>
    </div>
    <div class="form-group" id="tokenFeeContainer" style="display: none;"> <!-- TODO: make nicer .. -->
        <label for="tokenFee">Transaction Fee: 
            <span id="estimation-loading">Calculating..</span>
            <span id="estimation-result"><span id="tokenFee"></span> Stamps (<span id="tokenFeeXian"></span> Xian)</span>
        </label>
    </div>
    <div class="btn-group">
        <button class="btn btn-primary" id="send-token-send-token">Send Token</button>
        <button class="btn btn-secondary" id="send-token-cancel">Cancel</button>
    </div>
</div>
<script src="templates/page_js/send-token.js"></script>

======================================================================
File: xian-web-wallet/templates/get-started.html
======================================================================
<div style="max-width: 30rem;margin:auto;display: flex; flex-direction: column; justify-content: center;height:100%">
<h1 class="app-box-title">Get started</h1>

<div class="btn-group" style="
width: 350px;
max-width: 100%;
">
    <button class="btn btn-primary" id="btn-get-started-create-wallet">Create a Wallet</button>
    <button class="btn btn-secondary" id="btn-get-started-import-wallet">Import a Wallet</button>
</div>
</div>
<script src="templates/page_js/get-started.js"></script>

======================================================================
File: xian-web-wallet/templates/page_js/wallet.js
======================================================================
// Assumes global vars: accounts, selectedAccountIndex, unencryptedMnemonic, locked, RPC, EXPLORER, CHAIN_ID, tx_history, token_list
// Assumes functions: getSelectedAccount, getSelectedVK, deriveKeyPairFromMnemonic, execute_balance_of, getTokenInfo,
//                    saveAccounts, saveSelectedAccountIndex, changePage, toast, placeholder, copyToClipboard,
//                    prependToTransactionHistory, signTransaction, broadcastTransaction, estimateStamps (if needed by advanced tx link)

var token_list = JSON.parse(localStorage.getItem("token_list")) || ["currency"];

// --- NFT Loading (Keep previous version or simplify if not priority) ---
async function getNFTData(nftKey) {
    let graphQLEndpoint = RPC + "/graphql"; // Ensure RPC is current
    try {
        let nftDataRes = await fetchWithTimeout(graphQLEndpoint, { // Use fetchWithTimeout
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                // Simplified query, ensure it matches your GraphQL schema
                query: `query NFTInfo { allStates( filter: { key: { startsWith: "con_pixel_frames_info.S:${nftKey}" } } ) { nodes { key value } } }`
            })
        });
        if (!nftDataRes.ok) throw new Error(`GraphQL query failed: ${nftDataRes.statusText}`);
        const nftData = await nftDataRes.json();
        // Basic check for expected data structure
        if (!nftData?.data?.allStates?.nodes) {
             console.warn(`Unexpected NFT data structure for key ${nftKey}:`, nftData);
             return null; // Return null if structure is wrong
        }
        // Extract specific fields based on assumed order/key names (fragile!)
        // It's better to filter by key name explicitly if possible.
        const nodes = nftData.data.allStates.nodes;
        const findValue = (keySuffix) => nodes.find(n => n.key.endsWith(keySuffix))?.value;

        return {
            name: findValue("name") || 'Unknown NFT', // Provide defaults
            description: findValue("description") || '',
        };
    } catch (error) {
        console.error(`Error fetching NFT data for key ${nftKey}:`, error);
        // Avoid toast here as it could spam if many NFTs fail
        // toast('danger', `Failed to load details for NFT ${nftKey.substring(0, 8)}...`);
        return null; // Return null on error
    }
}

async function loadNFTPage() {
    const nftListElement = document.getElementById("wallet-nfts");
    const refreshIcon = document.getElementById("wallet-refresh-all")?.querySelector("i");
    const selectedAccount = getSelectedAccount(); // Use helper from router.js

    if (!nftListElement) { console.error("NFT list element not found."); return; }
    if (!selectedAccount) { console.warn("No account selected for NFT view."); return; }


    // Start loading indicator
    nftListElement.innerHTML = `<div class="title-container"><h2 class="token-list-title">NFTs</h2></div>`;
    nftListElement.innerHTML += `<div class="loading-spinner" id="nft-loading-spinner"><i class="fas fa-spinner fa-spin"></i> Loading NFTs...</div>`;
    if (refreshIcon) refreshIcon.classList.add("fa-spin");

    let graphQLEndpoint = RPC + "/graphql";

    try {
        const response = await fetchWithTimeout(graphQLEndpoint, { // Use fetchWithTimeout
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                query: ` query OwnedNFTs($ownerAddress: String!) { allStates( filter: { key: { startsWith: "con_pixel_frames_info.S:", endsWith: ":owner" }, value: { equalTo: $ownerAddress } }, offset: 0, first: 100, orderBy: KEY_ASC ) { nodes { key } } } `,
                variables: { ownerAddress: selectedAccount.vk } // Pass selected VK as variable
            })
        });

        if (!response.ok) throw new Error(`GraphQL query failed: ${response.statusText}`);

        const data = await response.json();

        // Stop loading indicator
        document.getElementById('nft-loading-spinner')?.remove();

        if (!data?.data?.allStates?.nodes) {
             throw new Error("Unexpected GraphQL response structure for NFTs.");
        }

        const nfts = data.data.allStates.nodes;

        if (nfts.length === 0) {
            nftListElement.innerHTML += `<div class="text-center p-3 text-muted">No NFTs found for this account.</div>`;
             if (refreshIcon) refreshIcon.classList.remove("fa-spin"); // Stop spin if no NFTs
            return;
        }

        // Prepare container for NFT cards
        let containerNFTs = document.createElement("div");
        containerNFTs.className = "container row p-0 m-0"; // Added Bootstrap row class, reset padding/margin
         nftListElement.appendChild(containerNFTs);

        // Fetch details for each NFT concurrently
        const nftDetailPromises = nfts.map(async (nft) => {
            // Extract the NFT key (e.g., frame ID) - This depends heavily on the key structure
             const keyParts = nft.key.split(':');
             const nftAddress = keyParts.length >= 2 ? keyParts[keyParts.length - 2] : null;

            if (!nftAddress) {
                console.warn("Could not extract NFT address from key:", nft.key);
                return null; // Skip if key format is unexpected
            }

            const nftData = await getNFTData(nftAddress);
            if (!nftData) return null; // Skip if data fetch failed
            const placeholderIcon = placeholder.getData({ text: 'NFT', bgcolor: '#333', color: '#fff', ffamily: 'Roboto Mono', size: '64x64' });

             // Create card HTML - ensure template literals handle potential nulls gracefully
             return `
             <div class="col-xl-3 col-lg-4 col-md-6 col-sm-6 col-12 mb-4">
                 <div class="card h-100" data-contract="${nftAddress || ''}" style="background-color:transparent; border: 1px solid #8a8b8e;">
                     <img class="card-img-top" src="https://pixelsnek.xian.org/gif/${nftAddress || 'error'}.gif" alt="${nftData.name || 'NFT Image'}" onerror="this.src='${placeholderIcon}'; this.alt='Image Error';">
                     <div class="card-body d-flex flex-column justify-content-between">
                          <div>
                             <h5 class="card-title token-symbol">${nftData.name}</h5>
                             <p class="card-text small">${nftData.description || ''}</p>
                          </div>
                         <a class="btn btn-sm send-btn mt-2" style="background-color: #ffffff; width: 100%; border-radius: 0 0 .25rem .25rem;" href="https://pixelsnek.xian.org/frames/${nftAddress || ''}" target="_blank" rel="noopener noreferrer"><i class="fas fa-eye"></i> View</a>
                     </div>
                 </div>
             </div>`;
        });

        // Wait for all details to be fetched and render
        const nftCardsHtml = (await Promise.all(nftDetailPromises)).filter(Boolean).join('');
        containerNFTs.innerHTML = nftCardsHtml;

    } catch (error) {
        console.error("Error loading NFTs:", error);
        document.getElementById('nft-loading-spinner')?.remove();
        nftListElement.innerHTML += `<div class="text-center p-3 text-danger">Error loading NFTs.</div>`;
         toast('danger', 'Failed to load NFTs.');
    } finally {
        if (refreshIcon) refreshIcon.classList.remove("fa-spin");
    }
}


// --- Account Management UI ---

function populateAccountSwitcher() {
    const dropdownMenu = document.getElementById('accountListDropdown');
    if (!dropdownMenu) {
        console.error("Account dropdown menu element (#accountListDropdown) not found!");
        return;
    }

    // Ensure global accounts array is available and is an array
    if (typeof accounts === 'undefined' || !Array.isArray(accounts)) {
        console.error("Global 'accounts' variable is missing or not an array.");
        // Optionally try to read from storage again as a fallback?
        // readAccounts().then(storedAccounts => { accounts = storedAccounts; populateAccountSwitcher(); }); // Be careful of infinite loops
        return;
    }

    // Clear only existing account items (those with the specific class)
    dropdownMenu.querySelectorAll('li.dynamic-account-item').forEach(item => item.remove());

    // Sort accounts by index before displaying
    const sortedAccounts = [...accounts].sort((a, b) => a.index - b.index);

    // Add accounts to the dropdown
    console.log("Populating dropdown with accounts:", sortedAccounts); // Debug log
    sortedAccounts.forEach(account => {
        if (!account || typeof account.index === 'undefined' || !account.vk) {
            console.warn("Skipping invalid account object during dropdown population:", account);
            return; // Skip invalid account entries
        }

        const listItem = document.createElement('li');
        listItem.classList.add('dynamic-account-item'); // Class for easy clearing

        const link = document.createElement('a');
        link.className = 'dropdown-item d-flex justify-content-between align-items-center pe-2';
        link.href = '#';
        link.dataset.index = account.index; // Store index

        const nameSpan = document.createElement('span');
        nameSpan.textContent = account.name || `Account ${account.index + 1}`; // Default name if missing
        nameSpan.title = account.vk;
        nameSpan.style.cssText = `
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex-grow: 1;
            margin-right: 10px;
        `; // Apply styles via cssText

        link.appendChild(nameSpan);

        if (account.index === selectedAccountIndex) {
            const checkIcon = document.createElement('i');
            checkIcon.className = 'fas fa-check text-success ms-auto';
            link.appendChild(checkIcon);
        }

        link.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            switchAccount(account.index);
        });

        listItem.appendChild(link);
        dropdownMenu.appendChild(listItem);
    });

    // Log the final state of the dropdown menu for debugging
     // console.log("Dropdown menu final HTML:", dropdownMenu.innerHTML);
}

async function switchAccount(index) {
    const newIndex = parseInt(index, 10);
    if (isNaN(newIndex) || newIndex === selectedAccountIndex) return;

    selectedAccountIndex = newIndex;
    await saveSelectedAccountIndex(selectedAccountIndex); // Persist selection
    const newAccount = accounts.find(a => a.index === selectedAccountIndex);
    toast('info', `Switched to ${newAccount?.name || `Account ${newIndex + 1}`}`);
    changePage('wallet'); // Reload wallet page to reflect changes everywhere
}

async function createNewAccount() {
     if (locked || !unencryptedMnemonic) {
         toast('warning', 'Wallet must be unlocked to create a new account.');
         return;
     }
     toast('info', 'Creating new account...');
     // Disable button? Add loading state?
     const createButton = document.getElementById('wallet-add-account-btn');
      if (createButton) createButton.style.pointerEvents = 'none'; // Simple disable

     try {
         const nextIndex = accounts.length > 0 ? Math.max(...accounts.map(a => a.index)) + 1 : 0;
         const newKeyPair = deriveKeyPairFromMnemonic(unencryptedMnemonic, nextIndex);

         const newAccount = {
             index: nextIndex,
             vk: toHexString(newKeyPair.vk),
             name: `Account ${nextIndex + 1}`
         };

         accounts.push(newAccount);
         await saveAccounts(accounts);

         toast('success', `Account "${newAccount.name}" created.`);
         await switchAccount(nextIndex); // Switch and reload

     } catch (error) {
         console.error("Error creating new account:", error);
         toast('danger', 'Failed to create new account.');
          if (createButton) createButton.style.pointerEvents = 'auto'; // Re-enable on error
     }
}


// --- Token List and Balance Refresh ---

async function refreshBalance(contract) {
    const selectedAccount = getSelectedAccount();
    if (!selectedAccount) return;

    const balanceElement = document.getElementById(`${contract}Balance`);
    if (!balanceElement) {
        // console.warn(`Balance element not found for contract: ${contract}`);
        return;
    }

    balanceElement.innerHTML = `<i class='fas fa-spinner fa-spin fa-xs'></i>`;

    try {
        let balance = await execute_balance_of(contract, selectedAccount.vk);
         if (balance === null || balance === undefined) {
             balanceElement.textContent = 'Error'; // Use textContent for simple text
         } else {
             let formattedBalance = parseFloat(balance);
             if (isNaN(formattedBalance)) {
                 balanceElement.textContent = 'Invalid';
             } else {
                 balanceElement.textContent = formattedBalance.toLocaleString(undefined, { minimumFractionDigits: 4, maximumFractionDigits: 8 });
             }
         }
    } catch (error) {
        console.error(`Error fetching balance for ${contract}:`, error);
        balanceElement.textContent = 'Error';
    }
}

// --- Main Wallet Page Loading Logic ---

async function loadWalletPage() {
    console.log("loadWalletPage called"); // Debug log

    const selectedAccount = getSelectedAccount(); // Get current account {index, vk, name}
    const refreshIcon = document.getElementById("wallet-refresh-all")?.querySelector("i");
    const walletAddressElement = document.getElementById("walletAddress");
    const accountNameElement = document.getElementById("selectedAccountName");

    if (!walletAddressElement || !accountNameElement) {
         console.error("Essential UI elements (#walletAddress or #selectedAccountName) not found!");
         return; // Stop if core elements are missing
    }

    if (!selectedAccount) {
        console.log("Wallet locked or no account selected, redirecting...");
        if (locked) changePage('password-input');
        else changePage('get-started');
        return;
    }

     // --- Update Wallet Info Card ---
     console.log("Updating wallet info card for account:", selectedAccount);
     walletAddressElement.textContent = selectedAccount.vk; // Use textContent for address
     accountNameElement.textContent = selectedAccount.name || `Account ${selectedAccount.index + 1}`; // Display name or default
     // --- End Update Wallet Info Card ---


     // --- Populate Dropdown ---
     // Ensure this is called *after* accounts array is confirmed loaded and available globally
     populateAccountSwitcher();
     // --- End Populate Dropdown ---

    if (refreshIcon) refreshIcon.classList.add("fa-spin");

    // --- Load Tokens ---
    const tokenListElement = document.getElementById("wallet-tokens");
    if (!tokenListElement) {
        console.error("Token list element not found!");
        if (refreshIcon) refreshIcon.classList.remove("fa-spin");
        return;
    }

    tokenListElement.innerHTML = `
        <div class="title-container">
            <div class="create-token-link" style="font-size:1rem; cursor: pointer;"> <i class="fas fa-coins" title="Create Token"></i> Create Token </div>
            <h2 class="token-list-title">Tokens</h2>
            <div class="cogwheel-icon add-token-link" style="font-size:1rem; cursor: pointer;"> <i class="fas fa-plus-circle" title="Add Token"></i> Add Token </div>
        </div>
        <div class="loading-spinner" id="token-loading-spinner"><i class="fas fa-spinner fa-spin"></i> Loading tokens...</div>`;

    try {
        // Ensure token_list is loaded correctly
        if (!Array.isArray(token_list)) {
            console.warn("token_list is not an array, reloading from storage.");
            token_list = JSON.parse(localStorage.getItem("token_list")) || ["currency"];
        }

        const tokenInfos = await Promise.all(token_list.map(tokenContract => getTokenInfo(tokenContract)));
        document.getElementById('token-loading-spinner')?.remove();

        let tokenHtml = '';
        tokenInfos.forEach(tokenInfo => {
             if (!tokenInfo || tokenInfo.name === "\x9Eée" || tokenInfo.symbol === "\x9Eée") return;

            const isXian = tokenInfo.contract === "currency";
            const iconSrc = isXian ? "assets/xian-white.svg" : (tokenInfo.token_logo_url || '');
            const placeholderIcon = placeholder.getData({ text: (tokenInfo.symbol || '?').charAt(0).toUpperCase(), bgcolor: '#333', color: '#fff', ffamily: 'Roboto Mono', size: '32x32' });

            tokenHtml += `
                <div class="token-item" data-contract="${tokenInfo.contract}">
                    <div class="token-details">
                        <div class="token-title-container">
                            <img class="token-icon" src="${iconSrc}" alt="${tokenInfo.symbol || '?'}" onerror="this.onerror=null; this.src='${placeholderIcon}';">
                            <div class="token-name">
                                <span class="token-symbol">${tokenInfo.symbol || '???'}</span><br>
                                <a class="small" style="font-weight:400; color: #aaa;" target="_blank" rel="noopener noreferrer" href="${EXPLORER}/contracts/${tokenInfo.contract}">${tokenInfo.name || tokenInfo.contract}</a>
                             </div>
                        </div>
                    </div>
                    <div class="token-balance"><span id="${tokenInfo.contract}Balance"><i class='fas fa-spinner fa-spin fa-xs'></i></span> <span>${tokenInfo.symbol || ''}</span></div>
                    <div class="token-actions">
                        ${!isXian ? `<button class="btn remove-btn btn-sm btn-outline-danger" data-contract="${tokenInfo.contract}" title="Remove Token"><i class="fas fa-minus-circle"></i></button>` : ''}
                        <button class="btn send-btn btn-sm btn-outline-primary" data-contract="${tokenInfo.contract}"><i class="fas fa-paper-plane"></i> Send</button>
                    </div>
                </div>`;
        });
        // Append generated HTML - ensuring the loading spinner was removed first
        tokenListElement.innerHTML += tokenHtml;

        // Refresh balances for displayed tokens
        tokenInfos.forEach(tokenInfo => {
            if (tokenInfo && tokenInfo.name !== "\x9Eée") {
                refreshBalance(tokenInfo.contract); // Call refreshBalance AFTER element exists
            }
        });

        // Setup listeners AFTER elements are in DOM
        setupTokenEventListeners();

    } catch (error) {
        console.error("Error loading token list:", error);
        document.getElementById('token-loading-spinner')?.remove();
        tokenListElement.innerHTML += `<div class="text-center p-3 text-danger">Error loading tokens.</div>`;
        toast('danger', 'Failed to load token list.');
    }


    // --- Load Local Activity ---
    const localActivityList = document.getElementById("local-activity-list");
     if (!localActivityList) {
         console.error("Local activity list element not found!");
     } else {
        localActivityList.innerHTML = ""; // Clear previous
        if (tx_history.length === 0) {
            localActivityList.innerHTML = `<div class="text-center p-3 text-muted">No recent activity.</div>`;
        } else {
            tx_history.forEach((tx) => {
                let statusIndicator;
                switch (tx.status) {
                    case 'success': statusIndicator = '<i class="fas fa-check-circle text-success" title="Success"></i>'; break;
                    case 'error': statusIndicator = '<i class="fas fa-times-circle text-danger" title="Error"></i>'; break;
                    case 'pending': default: statusIndicator = '<i class="fas fa-spinner fa-spin" title="Pending"></i>'; break;
                }
                const timestamp = tx.timestamp ? new Date(tx.timestamp).toLocaleString() : 'N/A';
                const kwargsDisplay = typeof tx.kwargs === 'object' ? JSON.stringify(tx.kwargs) : tx.kwargs;
                localActivityList.innerHTML += `
                <div class="activity-item">
                    <div class="activity-details">
                         <div style="flex-basis: 10%; min-width: 40px;" class="text-center">${statusIndicator}</div>
                         <div style="flex-basis: 30%; min-width: 150px;" title="${tx.hash}"><strong class="me-2">Hash:</strong><a href="${EXPLORER}/tx/${tx.hash}" target="_blank" rel="noopener noreferrer" class="text-truncate d-inline-block" style="max-width: 120px;">${tx.hash}</a></div>
                         <div style="flex-basis: 20%; min-width: 100px;"><strong class="me-2">Contract:</strong>${tx.contract}</div>
                         <div style="flex-basis: 20%; min-width: 100px;"><strong class="me-2">Function:</strong>${tx.function}</div>
                         <div style="flex-basis: 20%; min-width: 150px;" class="text-muted small">${timestamp}</div>
                     </div>
                </div>`;
            });
        }
     }

    // Ensure correct tab is shown initially
    changeWalletTab('wallet-tokens'); // Default to tokens tab

    if (refreshIcon) refreshIcon.classList.remove("fa-spin");
}

// --- Event Listener Setup ---
function setupTokenEventListeners() {
    // Icon error handling
    document.querySelectorAll('.token-icon').forEach(icon => {
        // Prevent adding multiple error listeners
        if (!icon.dataset.errorListenerAttached) {
             icon.addEventListener('error', handleImageError);
             icon.dataset.errorListenerAttached = 'true';
        }
         // Set placeholder if src is missing or invalid initially
         if (!icon.getAttribute('src')) {
              handleImageError.call(icon); // Call handler directly
          }
    });
    function handleImageError() {
         const symbol = this.alt || '?';
         const placeholderIcon = placeholder.getData({ text: symbol.charAt(0).toUpperCase(), bgcolor: '#333', color: '#fff', ffamily: 'Roboto Mono', size: '32x32' });
        this.src = placeholderIcon;
        this.onerror = null; // Prevent infinite loop
    }


    // Use event delegation for token actions for dynamically loaded items
    const tokenListElement = document.getElementById('wallet-tokens');
    if (tokenListElement) {
        // Remove previous listener if exists to prevent duplicates
        tokenListElement.removeEventListener('click', handleTokenActionClick);
        // Add new listener
        tokenListElement.addEventListener('click', handleTokenActionClick);
    }
    function handleTokenActionClick(event) {
        const target = event.target;
        const sendButton = target.closest('.send-btn');
        const removeButton = target.closest('.remove-btn');

        if (sendButton) {
            const contract = sendButton.getAttribute('data-contract');
            if (contract) changePage('send-token', contract);
        } else if (removeButton) {
             const contract = removeButton.getAttribute('data-contract');
             if (contract) removeToken(contract);
        }
    }


     // Static link listeners (ensure they exist before adding listeners)
     const addTokenLink = document.querySelector('.add-token-link');
     if (addTokenLink) {
          addTokenLink.onclick = () => changePage('add-to-token-list'); // Simple assignment if listener duplication is not a concern
     }
     const createTokenLink = document.querySelector('.create-token-link');
      if (createTokenLink) {
           createTokenLink.onclick = () => changePage('create-token');
      }

      // Add account button listener (ensure it's attached only once)
      const addAccountBtn = document.getElementById('wallet-add-account-btn');
       if (addAccountBtn && !addAccountBtn.dataset.listenerAttached) {
           addAccountBtn.addEventListener('click', handleCreateAccountClick);
           addAccountBtn.dataset.listenerAttached = 'true';
       }
        function handleCreateAccountClick(e) {
            e.preventDefault();
            e.stopPropagation(); // Prevent dropdown close
            createNewAccount();
        }

}

// --- Tab Switching Logic ---
function changeWalletTab(tabId) {
    const tabs = ['wallet-tokens', 'wallet-nfts', 'local-activity'];
    const tabLinks = {
        'wallet-tokens': 'wallet-tokens-tab',
        'wallet-nfts': 'wallet-nfts-tab',
        'local-activity': 'local-activity-tab'
    };

    tabs.forEach(id => {
        const element = document.getElementById(id);
        const link = document.getElementById(tabLinks[id]);
        if (element && link) {
            const isActive = (id === tabId);
            element.style.display = isActive ? 'flex' : 'none';
            link.classList.toggle('active', isActive);

             if (isActive && id === 'wallet-nfts' && !element.dataset.loaded) {
                loadNFTPage().then(() => { element.dataset.loaded = 'true'; });
             }
        } else {
             console.warn(`Missing element or link for tab: ${id}`);
        }
    });
}

// --- Action Functions ---

function clearLocalActivity() {
    if (!confirm("Are you sure you want to clear the local activity history?")) return;
    tx_history = [];
    localStorage.removeItem('tx_history');
    loadWalletPage(); // Reload wallet page UI
    toast('info', 'Local activity cleared.');
}

function removeToken(contract) {
    if (contract === 'currency') {
        toast('warning', 'Cannot remove the native Xian token.');
        return;
    }
    if (!confirm(`Remove token "${contract}" from list? This will not affect your balance.`)) return;

    token_list = token_list.filter((token) => token !== contract);
    localStorage.setItem("token_list", JSON.stringify(token_list));
    loadWalletPage(); // Reload the wallet page
    toast('info', `Token ${contract} removed from list.`);
}

// --- Event Listeners attached ONCE at the end ---

// Use event delegation for tab clicks
document.getElementById('wallet-tabs')?.addEventListener('click', (event) => {
    if (event.target.tagName === 'A' && event.target.id) {
         event.preventDefault();
         const tabId = event.target.id.replace('-tab', '');
         if (['wallet-tokens', 'wallet-nfts', 'local-activity'].includes(tabId)) {
             changeWalletTab(tabId);
         }
    }
});

// Direct binding for static buttons (assuming they are always present in wallet.html)
document.getElementById('wallet-clear-local-activity')?.addEventListener('click', clearLocalActivity);
document.getElementById('wallet-refresh-all')?.addEventListener('click', (e) => { e.preventDefault(); loadWalletPage(); });
document.getElementById('wallet-copy-address')?.addEventListener('click', (e) => { e.preventDefault(); copyToClipboard('walletAddress'); });
document.getElementById('wallet-send-adv-tx')?.addEventListener('click', (e) => { e.preventDefault(); changePage('send-advanced-transaction'); });


// Initial load trigger (called when changePage navigates to 'wallet')
loadWalletPage();

======================================================================
File: xian-web-wallet/templates/page_js/request-transaction.js
======================================================================
// State variables for the popup context
let callbackKey = null;
let transactionDetails = {};
let isActionTaken = false; // Flag to prevent double actions (e.g., reject on close after accept)
let selectedVk = null; // To display which account is making the request
let chainId = null;

// --- Initialization and Message Handling ---

// Listen for messages from the main window (router.js)
window.addEventListener("message", (event) => {
    // Basic security check (optional but recommended)
    // if (event.origin !== "chrome-extension://your-extension-id") {
    //     console.warn("Ignoring message from unknown origin:", event.origin);
    //     return;
    // }

    console.log("Popup received message:", event.data);

    if (event.data.type === "INITIAL_STATE") {
        // Store necessary state passed from main window
        selectedVk = event.data.state.selectedVk;
        chainId = event.data.state.CHAIN_ID;
        // Display chain ID if needed (already in HTML, just update if dynamic)
        const chainIdElement = document.getElementById("requestTransactionChainId");
        if (chainIdElement) chainIdElement.textContent = chainId || 'Unknown';
    }

    if (event.data.type === "REQUEST_TRANSACTION") {
        // This is the main data for this popup
        callbackKey = event.data.callbackKey;
        transactionDetails = event.data.data; // Contains { contract, method, kwargs, stampLimit, chainId }

        // Populate the UI
        document.getElementById('requestTransactionContract').textContent = transactionDetails.contract || 'N/A';
        document.getElementById('requestTransactionFunction').textContent = transactionDetails.method || 'N/A';
        // Pretty print kwargs JSON for readability
        try {
            document.getElementById('requestTransactionParams').textContent = JSON.stringify(transactionDetails.kwargs || {}, null, 2);
        } catch (e) {
            document.getElementById('requestTransactionParams').textContent = 'Invalid Kwargs Format';
        }
        document.getElementById('requestTransactionChainId').textContent = transactionDetails.chainId || chainId || 'Unknown'; // Use provided or initial

        // Display stamp limit and estimate Xian cost (needs access to getStampRate)
        displayStampLimit(transactionDetails.stampLimit);

        // Trigger estimation (if needed, or rely on main window estimation)
        // If the main window couldn't estimate, the popup *could* try, but it lacks the private key.
        // For now, we'll assume the main window provided a valid estimate or the user accepts the risk.
        // Let's focus on displaying what was provided.
        if (transactionDetails.stampLimit && transactionDetails.stampLimit !== 'Estimating...') {
            // If a numeric limit was passed, try to show Xian cost
             getStampRatePopup().then(rate => { // Need a way to get rate in popup
                if (rate) {
                     const feeInXian = (parseInt(transactionDetails.stampLimit, 10) / rate).toFixed(8);
                     document.getElementById('stamp_line_finished').style.display = 'block';
                     document.getElementById('stamp_line').style.display = 'none';
                     document.getElementById('requestTransactionStampLimit').textContent = transactionDetails.stampLimit;
                     document.getElementById('requestTransactionStampLimitXian').textContent = feeInXian;
                } else {
                    // Handle rate fetch error - show default text
                    showStampEstimationError('Could not fetch stamp rate.');
                }
            });
        } else {
             // Show "Calculating..." or error if estimation wasn't possible
             showStampEstimationError('Fee not provided or estimation failed.');
        }
        // Enable buttons now that data is loaded
         document.getElementById('request-transaction-accept').disabled = false;
         document.getElementById('request-transaction-reject').disabled = false;
    }
});

// Helper to display stamp limit and estimated cost
function displayStampLimit(limit) {
     const limitSpan = document.getElementById('requestTransactionStampLimit');
     const xianSpan = document.getElementById('requestTransactionStampLimitXian');
     const finishedLine = document.getElementById('stamp_line_finished');
     const calculatingLine = document.getElementById('stamp_line');

     if (limit && !isNaN(parseInt(limit, 10))) {
         limitSpan.textContent = limit;
         calculatingLine.style.display = 'none';
         finishedLine.style.display = 'block'; // Show the line with numbers

         // Attempt to calculate Xian cost
         getStampRatePopup().then(rate => {
             if (rate) {
                  xianSpan.textContent = (parseInt(limit, 10) / rate).toFixed(8);
             } else {
                 xianSpan.textContent = 'N/A'; // Indicate rate unavailable
             }
         });
     } else {
         showStampEstimationError(limit === 'Estimating...' ? 'Calculating...' : 'Fee not available');
     }
}

function showStampEstimationError(message) {
    const limitSpan = document.getElementById('requestTransactionStampLimit');
    const xianSpan = document.getElementById('requestTransactionStampLimitXian');
    const finishedLine = document.getElementById('stamp_line_finished');
    const calculatingLine = document.getElementById('stamp_line');

    limitSpan.textContent = 'N/A';
    xianSpan.textContent = 'N/A';
    calculatingLine.textContent = message; // Display the error/status message
    calculatingLine.style.display = 'block';
    finishedLine.style.display = 'none';
}


// Helper function to get stamp rate within the popup (if needed)
// This assumes the RPC URL is somehow available or hardcoded,
// ideally it should be passed in INITIAL_STATE too.
async function getStampRatePopup() {
     // TODO: Make RPC URL available here, e.g., from INITIAL_STATE or a default
     const POPUP_RPC = "https://node.xian.org"; // Placeholder - GET FROM INITIAL_STATE ideally
     try {
         const response = await fetch(POPUP_RPC + '/abci_query?path="/get/stamp_cost.S:value"'); // Basic fetch
         const data = await response.json();
         if (data.result?.response?.value && data.result.response.value !== "AA==") {
             return parseInt(atob(data.result.response.value), 10);
         }
         return null;
     } catch (error) {
         console.error("Popup: Error fetching stamp rate:", error);
         return null;
     }
}

// --- Action Handlers ---

function acceptRequest() {
    if (!callbackKey || isActionTaken) return;
    isActionTaken = true; // Set flag

    console.log("Popup: Request Accepted");

    // Send confirmation and original details back to the main window for signing
    window.opener.postMessage({
        type: 'REQUEST_TRANSACTION_RESPONSE', // Specific response type
        data: {
            confirmed: true,
            // Pass back the details needed for the main window to reconstruct and sign
            details: {
                contract: transactionDetails.contract,
                method: transactionDetails.method,
                kwargs: transactionDetails.kwargs,
                stamps_supplied: parseInt(document.getElementById('requestTransactionStampLimit').textContent, 10) || transactionDetails.stampLimit // Use displayed or original
            }
        },
        callbackKey: callbackKey
    }, '*'); // Use specific origin in production if possible

    window.close(); // Close the popup
}

function rejectRequest() {
    if (!callbackKey || isActionTaken) return;
    isActionTaken = true; // Set flag

    console.log("Popup: Request Rejected");

    // Send rejection back to the main window
    window.opener.postMessage({
        type: 'REQUEST_TRANSACTION_RESPONSE', // Specific response type
        data: {
            confirmed: false,
            errors: ['rejected'] // Indicate rejection
        },
        callbackKey: callbackKey
    }, '*'); // Use specific origin in production if possible

    window.close(); // Close the popup
}

// Handle the user closing the window directly
window.addEventListener('beforeunload', () => {
    // Only send rejection if no action (accept/reject) was already taken
    if (!isActionTaken) {
        console.log("Popup: Window closed by user, rejecting request.");
        rejectRequest(); // Attempt to send rejection
    }
});


// --- Attach Event Listeners ---
document.getElementById('request-transaction-accept')?.addEventListener('click', acceptRequest);
document.getElementById('request-transaction-reject')?.addEventListener('click', rejectRequest);

// Initial button state (disabled until data arrives)
document.getElementById('request-transaction-accept').disabled = true;
document.getElementById('request-transaction-reject').disabled = true;

// Request initial state from opener upon loading
if (window.opener) {
    window.opener.postMessage({ type: "POPUP_READY" }, "*"); // Signal main window that popup is ready (optional)
} else {
    console.error("Popup: Cannot communicate with opener window.");
    // Handle error state - maybe display a message in the popup
    document.body.innerHTML = '<div class="alert alert-danger m-3">Error: Could not connect to the main wallet window. Please close this window and try again.</div>';
}

======================================================================
File: xian-web-wallet/templates/page_js/new-proposal.js
======================================================================
// Assumes global vars: CHAIN_ID, RPC, EXPLORER, locked, unencryptedMnemonic, selectedAccountIndex, accounts
// Assumes functions: getSelectedAccount, signTransaction, estimateStamps, broadcastTransaction,
//                    prependToTransactionHistory, changePage, toast, getStampRate, execute_balance_of

// --- Estimate Stamps (Modified for HD) ---
async function estimateProposalStamps() { // Made async
    const typeInput = document.getElementById('proposalType');
    const valueInput = document.getElementById('proposalValue');
    const feeContainer = document.getElementById('proposalFeeContainer');
    const feeElement = document.getElementById('proposalFee');
    const feeXianElement = document.getElementById('proposalFeeXian');
    const createBtn = document.getElementById('create-proposal-create');
    const errorMsg = document.getElementById('proposalError'); // Use error field

    // Reset UI
    feeContainer.style.display = 'none';
    createBtn.disabled = true;
     errorMsg.style.display = 'none';


    // Check lock state
    if (locked || !unencryptedMnemonic) {
        toast('warning', 'Wallet locked. Cannot estimate fees.');
        return;
    }
    const selectedAccount = getSelectedAccount();
    if (!selectedAccount) {
        toast('danger', 'No account selected.');
        return;
    }

    const type = typeInput.value.trim();
    const valueStr = valueInput.value.trim(); // Trim value string

    if (type === '' || valueStr === '') return; // Not enough info

    // Attempt to parse value (similar to advanced tx)
    let value;
    try {
         // Try JSON first
         value = JSON.parse(valueStr);
    } catch (e) {
         // If JSON fails, check if it's purely numeric
         if (/^-?\d+(\.\d+)?$/.test(valueStr)) {
             value = parseFloat(valueStr); // Treat as number (float or int)
         } else {
             value = valueStr; // Treat as string if not JSON or number
         }
    }


    // Prepare transaction for estimation
    let transaction = {
        payload: {
            // chain_id, nonce, sender added by signTransaction
            contract: "masternodes", // TODO: Verify contract name
            function: "propose_vote",
            kwargs: {
                type_of_vote: type,
                arg: value // Use parsed value
            },
            stamps_supplied: 100000 // High default
        },
        metadata: { signature: "" }
    };

    try {
        // Sign for estimation
        const signedTxForEstimation = await signTransaction(transaction, unencryptedMnemonic, selectedAccount.index);
        // Estimate
        const stampResult = await estimateStamps(signedTxForEstimation);

        feeContainer.style.display = 'block'; // Show fee container

        if (stampResult.stamps === null || !stampResult.success) {
            feeElement.textContent = 'Error';
            feeXianElement.textContent = 'N/A';
             errorMsg.innerHTML = `Fee estimation failed: ${stampResult.tx_result || 'Unknown error'}`;
             errorMsg.style.display = 'block';
        } else {
            const stamps = stampResult.stamps;
            const stamp_rate = await getStampRate();
            if (stamp_rate) {
                feeElement.textContent = stamps;
                feeXianElement.textContent = (stamps / stamp_rate).toFixed(8);
                createBtn.disabled = false; // Enable create button
            } else {
                feeElement.textContent = 'Error';
                feeXianElement.textContent = 'N/A';
                 errorMsg.innerHTML = 'Could not retrieve stamp rate.';
                 errorMsg.style.display = 'block';
            }
        }
    } catch (error) {
        console.error("Error estimating proposal stamps:", error);
        feeContainer.style.display = 'block';
        feeElement.textContent = 'Error';
        feeXianElement.textContent = 'N/A';
         errorMsg.innerHTML = `Fee estimation error: ${error.message}`;
         errorMsg.style.display = 'block';
    }
}

// --- Send Proposal (Modified for HD) ---
async function sendProposal() { // Made async
    const successMsg = document.getElementById('proposalSuccess');
    const errorMsg = document.getElementById('proposalError');
    const createButton = document.getElementById('create-proposal-create');

    // Reset messages
    successMsg.style.display = 'none';
    errorMsg.style.display = 'none';

    // Check lock state
    if (locked || !unencryptedMnemonic) {
        errorMsg.innerHTML = 'Wallet is locked. Please unlock to create a proposal.';
        errorMsg.style.display = 'block';
        return;
    }
    const selectedAccount = getSelectedAccount();
    if (!selectedAccount) {
        errorMsg.innerHTML = 'Error: No account selected.';
        errorMsg.style.display = 'block';
        return;
    }

    // Get inputs
    const type = document.getElementById('proposalType').value.trim();
    const valueStr = document.getElementById('proposalValue').value.trim();

    if (type === '' || valueStr === '') {
        errorMsg.innerHTML = 'Type and Value fields are required.';
        errorMsg.style.display = 'block';
        return;
    }

     // Parse value (same logic as estimation)
     let value;
     try {
          value = JSON.parse(valueStr);
     } catch (e) {
          if (/^-?\d+(\.\d+)?$/.test(valueStr)) {
              value = parseFloat(valueStr);
          } else {
              value = valueStr;
          }
     }


    // --- Fee Check ---
    let stampsRequired;
    try {
        stampsRequired = parseInt(document.getElementById('proposalFee').textContent, 10);
        if (isNaN(stampsRequired)) {
             toast('warning', 'Transaction fee not estimated. Please wait or provide valid inputs.');
             await estimateProposalStamps(); // Try re-estimating
             stampsRequired = parseInt(document.getElementById('proposalFee').textContent, 10);
             if (isNaN(stampsRequired)) {
                throw new Error("Fee estimation failed.");
             }
        }
         // Check balance for fee
          const nativeBalanceStr = await execute_balance_of('currency', selectedAccount.vk);
          const nativeBalance = parseFloat(nativeBalanceStr);
          const stampRate = await getStampRate();
          if (isNaN(nativeBalance) || !stampRate || (stampsRequired / stampRate) > nativeBalance) {
               errorMsg.innerHTML = `Insufficient XIAN balance for proposal fee (${(stampsRequired / stampRate).toFixed(4)} Xian needed).`;
               errorMsg.style.display = 'block';
               return;
          }
    } catch (e) {
        errorMsg.innerHTML = `Could not determine transaction fee: ${e.message}`;
        errorMsg.style.display = 'block';
        return;
    }
    // --- End Fee Check ---

    // Disable button
    createButton.disabled = true;
    createButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

    // Create transaction
    let transaction = {
        payload: {
            chain_id: CHAIN_ID,
            contract: "masternodes", // TODO: Verify contract
            function: "propose_vote",
            kwargs: {
                type_of_vote: type,
                arg: value
            },
            stamps_supplied: stampsRequired // Use estimated fee
        },
        metadata: { signature: "" }
    };

    // Sign and Broadcast
    try {
        const signedTx = await signTransaction(transaction, unencryptedMnemonic, selectedAccount.index);

        let conf = confirm(`Create proposal? Type: ${type}, Value: ${JSON.stringify(value)}. Fee: ~${(stampsRequired / await getStampRate()).toFixed(4)} Xian`);
        if (!conf) {
             createButton.disabled = false;
             createButton.innerHTML = 'Create Proposal';
             return;
        }

        const response = await broadcastTransaction(signedTx);

        // Handle response
        if (response.error === 'timeout') {
             successMsg.innerHTML = 'Proposal broadcast timed out. Check Explorer.';
             successMsg.style.display = 'block';
              prependToTransactionHistory("TIMEOUT", 'masternodes', 'propose_vote', transaction.payload.kwargs, 'pending', new Date().toLocaleString());
        } else if (response && response.result && response.result.hash) {
            const hash = response.result.hash;
            let status = 'pending';
            let logMessage = response.result.log || "";

            if (response.result.code !== 0) {
                status = 'error';
                errorMsg.innerHTML = `Proposal creation failed: ${logMessage}`;
                errorMsg.style.display = 'block';
                toast('danger', `Proposal failed: ${logMessage.substring(0,100)}...`);
            } else {
                successMsg.innerHTML = `Proposal transaction sent! Hash: <a class='explorer-url text-light' href='${EXPLORER}/tx/${hash}' target='_blank' rel='noopener noreferrer'>${hash}</a>`;
                successMsg.style.display = 'block';
                toast('success', `Proposal sent: ${hash.substring(0,10)}...`);
                // Optionally clear form on success
                // document.getElementById('proposalType').value = '';
                // document.getElementById('proposalValue').value = '';
                // document.getElementById('proposalFeeContainer').style.display = 'none';
            }
            prependToTransactionHistory(hash, 'masternodes', 'propose_vote', transaction.payload.kwargs, status, new Date().toLocaleString());
        } else {
            throw new Error('Unexpected response from network during proposal creation.');
        }
    } catch (error) {
        console.error("Error sending proposal:", error);
        errorMsg.innerHTML = `Error sending proposal: ${error.message}`;
        errorMsg.style.display = 'block';
         toast('danger', `Error: ${error.message}`);
    } finally {
        // Re-enable button
        createButton.disabled = false;
        createButton.innerHTML = 'Create Proposal';
    }
}


// --- Event Listeners ---
document.getElementById("create-proposal-cancel")?.addEventListener("click", () => {
    changePage("insights"); // Go back to insights/governance page
});

document.getElementById('create-proposal-create')?.addEventListener('click', sendProposal);

// Use debounced estimation on input change
const debouncedEstimateProposalStamps = debounce(estimateProposalStamps, 500);
document.getElementById('proposalType')?.addEventListener('input', debouncedEstimateProposalStamps);
document.getElementById('proposalValue')?.addEventListener('input', debouncedEstimateProposalStamps);

// Initial estimation attempt if needed
// estimateProposalStamps();

======================================================================
File: xian-web-wallet/templates/page_js/request-token.js
======================================================================
// State variables for the popup context
let callbackKey = null;
let tokenContractToAdd = null;
let isActionTaken = false; // Flag to prevent double actions
let selectedVk = null; // To display which account context (though less relevant here)

// --- Initialization and Message Handling ---

// Listen for messages from the main window (router.js)
window.addEventListener("message", (event) => {
    // Optional origin check
    // if (event.origin !== "chrome-extension://your-extension-id") return;

    console.log("Token Popup received message:", event.data);

    if (event.data.type === "INITIAL_STATE") {
        selectedVk = event.data.state.selectedVk;
        // Could potentially pass RPC url via initial state if needed for token info fetching
    }

    if (event.data.type === "REQUEST_TOKEN") {
        callbackKey = event.data.callbackKey;
        tokenContractToAdd = event.data.data.contract; // Extract the contract name

        // Populate the UI - Just display the contract name for now.
        // Fetching full token info here adds complexity and network dependency to the popup.
        // Assume the main window or user knows what they are adding.
        const contractElement = document.getElementById('requestTokenMessage');
        const nameElement = document.getElementById('requestTokenName');
        const symbolElement = document.getElementById('requestTokenSymbol');

        if (contractElement) {
            contractElement.textContent = tokenContractToAdd || 'N/A';
        }
        // Display placeholder/loading for name/symbol, or fetch if necessary
        // For now, let's just show the contract name prominently.
         if (nameElement) nameElement.textContent = `Attempting to add: ${tokenContractToAdd}`;
         if (symbolElement) symbolElement.textContent = ''; // Clear symbol or add placeholder

        // Optional: Fetch basic info in popup for user confirmation (adds complexity)
        // fetchTokenInfoPopup(tokenContractToAdd).then(info => {
        //    if (nameElement) nameElement.textContent = info?.name || 'Unknown Name';
        //    if (symbolElement) symbolElement.textContent = info?.symbol || '???';
        // }).catch(err => {
        //     console.error("Popup: Failed to fetch token info", err);
        //     if (nameElement) nameElement.textContent = 'Could not verify token';
        // });


        // Enable buttons now that data is loaded
        document.getElementById('request-token-accept').disabled = false;
        document.getElementById('request-token-reject').disabled = false;
    }
});

// Optional: Helper to fetch minimal token info in popup (needs RPC access)
async function fetchTokenInfoPopup(contractName) {
    const POPUP_RPC = "https://node.xian.org"; // Placeholder - GET FROM INITIAL_STATE ideally
    if (contractName === 'currency') return { name: 'Xian', symbol: 'Xian' };
    try {
        const pathName = `/get/${contractName}.metadata:token_name`;
        const pathSymbol = `/get/${contractName}.metadata:token_symbol`;
        const [resName, resSymbol] = await Promise.all([
            fetch(POPUP_RPC + '/abci_query?path="' + pathName + '"'),
            fetch(POPUP_RPC + '/abci_query?path="' + pathSymbol + '"')
        ]);
        const dataName = await resName.json();
        const dataSymbol = await resSymbol.json();

        const name = (dataName.result?.response?.value && dataName.result.response.value !== "AA==") ? atob(dataName.result.response.value) : null;
        const symbol = (dataSymbol.result?.response?.value && dataSymbol.result.response.value !== "AA==") ? atob(dataSymbol.result.response.value) : null;

         if (!name && !symbol) return null; // Indicate contract likely doesn't exist or isn't a token

        return { name: name || 'Unknown Name', symbol: symbol || '???' };
    } catch (error) {
        console.error("Popup: Error fetching token info:", error);
        return null;
    }
}


// --- Action Handlers ---

function acceptRequest() {
    if (!callbackKey || isActionTaken || !tokenContractToAdd) return;
    isActionTaken = true; // Set flag

    console.log("Popup: Add Token Request Accepted");

    // Send acceptance and the contract name back to the main window
    window.opener.postMessage({
        type: 'REQUEST_TOKEN_RESPONSE', // Specific response type
        data: {
            confirmed: true,
            contract: tokenContractToAdd // Send the contract to be added
        },
        callbackKey: callbackKey
    }, '*'); // Use specific origin in production

    window.close(); // Close the popup
}

function rejectRequest() {
    if (!callbackKey || isActionTaken) return;
    isActionTaken = true; // Set flag

    console.log("Popup: Add Token Request Rejected");

    // Send rejection back to the main window
    window.opener.postMessage({
        type: 'REQUEST_TOKEN_RESPONSE', // Specific response type
        data: {
            confirmed: false,
            errors: ['rejected'] // Indicate rejection
        },
        callbackKey: callbackKey
    }, '*'); // Use specific origin in production

    window.close(); // Close the popup
}

// Handle the user closing the window directly
window.addEventListener('beforeunload', () => {
    if (!isActionTaken) {
        console.log("Popup: Window closed by user, rejecting token request.");
        rejectRequest(); // Attempt to send rejection
    }
});

// --- Attach Event Listeners ---
document.getElementById('request-token-accept')?.addEventListener('click', acceptRequest);
document.getElementById('request-token-reject')?.addEventListener('click', rejectRequest);

// Initial button state (disabled until data arrives)
document.getElementById('request-token-accept').disabled = true;
document.getElementById('request-token-reject').disabled = true;

// Signal readiness to opener window
if (window.opener) {
    window.opener.postMessage({ type: "POPUP_READY" }, "*");
} else {
    console.error("Popup: Cannot communicate with opener window.");
    document.body.innerHTML = '<div class="alert alert-danger m-3">Error: Could not connect to the main wallet window. Please close this window and try again.</div>';
}

======================================================================
File: xian-web-wallet/templates/page_js/get-started.js
======================================================================
document.getElementById('btn-get-started-create-wallet').addEventListener('click', function() {
    changePage('create-wallet');
});
document.getElementById('btn-get-started-import-wallet').addEventListener('click', function() {
    changePage('import-wallet');
});

======================================================================
File: xian-web-wallet/templates/page_js/messenger.js
======================================================================
// Assumes global vars: RPC, CHAIN_ID, accounts, selectedAccountIndex, unencryptedMnemonic, locked
// Assumes functions: getSelectedAccount, getSelectedVK, deriveKeyPairFromMnemonic, toHexString, fromHexString,
//                    signTransaction, estimateStamps, broadcastTransaction, getVariable, toast, sanitizeHTML,
//                    saveData, readData (or equivalents for local message storage)

// --- Cryptographic Helpers (Adapted for HD) ---

// stringToUint8Array, uint8ArrayToString, base64ToUint8Array, hexToUint8Array,
// fromHexString, toHexString, uint8ArrayToHex, uint8ArrayToBase64
// (Keep these helpers as they are fundamental conversions)
function stringToUint8Array(str) { return new TextEncoder().encode(str); }
function uint8ArrayToString(uint8Array) { return new TextDecoder().decode(uint8Array); }
function base64ToUint8Array(base64) { /* ... keep existing ... */ }
function hexToUint8Array(hex) { /* ... keep existing ... */ }
function fromHexString(hexString) { /* ... keep existing from xian.js ... */ }
function toHexString(uint8Array) { /* ... keep existing from xian.js ... */ }
function uint8ArrayToHex(uint8Array) { /* ... keep existing ... */ }
function uint8ArrayToBase64(uint8Array) { /* ... keep existing ... */ }


// Libsodium conversion functions (Ensure sodium is loaded)
function convertEd25519ToCurve25519PrivateKey(ed25519PrivateKeyHex) {
    // This function derives the *full* 64-byte Ed25519 private key from the 32-byte seed (hex).
    if (!window.sodium) { throw new Error("Sodium library not loaded"); }
    const ed25519Seed = sodium.from_hex(ed25519PrivateKeyHex);
    // Generate the full key pair from the seed
    const ed25519KeyPair = sodium.crypto_sign_seed_keypair(ed25519Seed);
    // The full private key includes the seed and the public key part
    const ed25519FullPrivateKey = ed25519KeyPair.privateKey;
    return sodium.crypto_sign_ed25519_sk_to_curve25519(ed25519FullPrivateKey);
}

function convertEd25519ToCurve25519PublicKey(ed25519PublicKeyHex) {
    if (!window.sodium) { throw new Error("Sodium library not loaded"); }
    const ed25519PublicKey = sodium.from_hex(ed25519PublicKeyHex);
    return sodium.crypto_sign_ed25519_pk_to_curve25519(ed25519PublicKey);
}

/**
 * Encrypts a message using NaCl box seal (public key encryption).
 * Requires the recipient's Ed25519 public key (hex).
 */
function encrypt_nacl_box_seal(cleartext_msg, recipient_vk_hex) {
    if (!window.sodium) { throw new Error("Sodium library not loaded"); }
    try {
        // Convert the recipient's Ed25519 public key to Curve25519
        const recipientCurve25519PublicKey = convertEd25519ToCurve25519PublicKey(recipient_vk_hex);

        // Encrypt using crypto_box_seal
        const encryptedMessage = sodium.crypto_box_seal(
            stringToUint8Array(cleartext_msg),
            recipientCurve25519PublicKey
        );

        return uint8ArrayToHex(encryptedMessage); // Return hex encoded encrypted message
    } catch (error) {
        console.error("Encryption failed:", error);
        throw new Error("Message encryption failed.");
    }
}

/**
 * Decrypts a message using NaCl box seal open.
 * Requires the user's UNENCRYPTED mnemonic and the ACCOUNT INDEX corresponding
 * to the public key the message was sent TO.
 */
function decrypt_nacl_box_seal_open(encrypted_msg_hex, mnemonic, accountIndex) {
     if (!window.sodium) { throw new Error("Sodium library not loaded"); }
     if (!mnemonic) { throw new Error("Decryption requires unlocked wallet (mnemonic)."); }

    try {
        // 1. Derive the specific key pair for the account index
        const keyPair = deriveKeyPairFromMnemonic(mnemonic, accountIndex); // from xian.js
        const userEd25519PublicKey = keyPair.vk; // 32-byte Uint8Array
        const userEd25519PrivateKeySeed = keyPair.sk; // 32-byte Uint8Array seed

        // 2. Convert keys to Curve25519 format
        // Public key conversion
        const userCurve25519PublicKey = sodium.crypto_sign_ed25519_pk_to_curve25519(userEd25519PublicKey);

        // Private key conversion (needs full 64-byte sk)
        const fullKeyPair = sodium.crypto_sign_seed_keypair(userEd25519PrivateKeySeed);
        const userEd25519FullPrivateKey = fullKeyPair.privateKey;
        const userCurve25519PrivateKey = sodium.crypto_sign_ed25519_sk_to_curve25519(userEd25519FullPrivateKey);


        // 3. Convert the encrypted message from hex to Uint8Array
        const encryptedMessageBytes = hexToUint8Array(encrypted_msg_hex);

        // 4. Attempt decryption using crypto_box_seal_open
        const decryptedMessageBytes = sodium.crypto_box_seal_open(
            encryptedMessageBytes,
            userCurve25519PublicKey,
            userCurve25519PrivateKey
        );

        if (!decryptedMessageBytes) {
            // console.warn(`Decryption failed for message (index ${accountIndex}). Possibly not intended receiver or corrupted.`);
            return null; // Indicate decryption failure
        }

        return uint8ArrayToString(decryptedMessageBytes); // Return decrypted message string
    } catch (error) {
        console.error(`Decryption failed for account index ${accountIndex}:`, error);
        return null; // Indicate failure
    }
}


// --- Local Message Storage (Adapted for Selected Account) ---
// Store sent messages locally, keyed by RPC and the SENDER's VK (selected account)
const LOCAL_SENT_MESSAGES_KEY = 'sentMessages';

async function saveMessageLocally(senderVk, recipientVk, messageObject) {
    const allMessages = JSON.parse(await readData(LOCAL_SENT_MESSAGES_KEY) || '{}'); // Use readData

    if (!allMessages[RPC]) allMessages[RPC] = {};
    if (!allMessages[RPC][senderVk]) allMessages[RPC][senderVk] = {};
    if (!allMessages[RPC][senderVk][recipientVk]) allMessages[RPC][senderVk][recipientVk] = [];

    allMessages[RPC][senderVk][recipientVk].push(messageObject);

    await saveData(LOCAL_SENT_MESSAGES_KEY, JSON.stringify(allMessages)); // Use saveData
}

async function loadLocalMessages(senderVk) {
    const allMessages = JSON.parse(await readData(LOCAL_SENT_MESSAGES_KEY) || '{}');
    return allMessages[RPC]?.[senderVk] || {};
}


// --- Global Message State (Refreshed on Load) ---
var allThreads = {}; // Holds processed messages, keyed by other party's VK: { otherAddress: string, lastMessage: string|null, thread: object[] }

// --- UI Interaction ---

document.querySelector('.messenger-inbox-new')?.addEventListener('click', function () {
    addTempChat();
});

document.querySelector('#message_input')?.addEventListener('input', function (event) {
    const message_input = document.getElementById('message_input').value;
    const message_receiver = document.getElementById('address_chat')?.innerText;
    if (!message_receiver || message_input === '') {
        document.getElementById('estimation-result').style.display = 'none';
        document.getElementById('estimation-loading').style.display = 'none';
    } else {
        // Debounce this? Estimation might be slow.
        estimateSendStampsMessenger(message_receiver, message_input); // Use specific estimator name
    }
});

document.querySelector('#message_input')?.addEventListener('keyup', function (event) {
    if (event.key === 'Enter') { // Use event.key
        sendMessage();
    }
});

document.querySelector('#send_message')?.addEventListener('click', function () {
    sendMessage(); // Send button calls sendMessage
});

function addTempChat() {
    if (locked) { toast('warning', 'Unlock wallet to start chat.'); return; }
    let address_chat_ = prompt("Enter the Xian address (VK) of the user you want to chat with:");
    if (!address_chat_) return; // User cancelled

    address_chat_ = address_chat_.trim();
    // Validate address format (64 hex chars)
    if (!/^[0-9a-fA-F]{64}$/.test(address_chat_)) {
        toast('danger', "Invalid Xian address format.");
        return;
    }
     const selectedVk = getSelectedVK();
     if (address_chat_ === selectedVk) {
          toast('warning', "Cannot start a chat with yourself.");
          return;
     }


    // Check if chat already exists in inbox (based on VK)
    if (document.querySelector(`.messenger-inbox-item[data-chat="${address_chat_}"]`)) {
         toast('info', 'Chat already exists.');
         switchChat(address_chat_); // Switch to existing chat
         return;
    }

    // Add to UI immediately (even if no messages yet)
    renderInboxItem(address_chat_, 'Start chatting!', Date.now(), false); // Add placeholder item
    switchChat(address_chat_); // Switch to the new chat interface
}

function switchChat(otherPartyVk) {
    // Highlight active item in inbox
    document.querySelectorAll('.messenger-inbox-item').forEach(item => {
        item.classList.toggle('messenger-inbox-item-active', item.dataset.chat === otherPartyVk);
    });

    // Update chat header
    const addressChatElement = document.getElementById('address_chat');
    if (addressChatElement) addressChatElement.innerText = otherPartyVk;
    document.querySelector('.messenger-chat').style.display = 'flex';

    // Clear message input
    const messageInput = document.querySelector('#message_input');
    if (messageInput) messageInput.value = '';
     // Clear fee estimation display
    document.getElementById('estimation-result').style.display = 'none';
    document.getElementById('estimation-loading').style.display = 'none';


    // Render messages for the selected chat
    const messageContainer = document.querySelector('.messenger-chat-body');
    messageContainer.innerHTML = ''; // Clear previous messages

    const chatThreadData = allThreads[otherPartyVk];
    const selectedVk = getSelectedVK();

    if (chatThreadData && chatThreadData.thread) {
        chatThreadData.thread.forEach(message => {
            const messageItem = document.createElement('div');
            const messageContent = document.createElement('div');
            messageContent.className = 'messenger-chat-item-content';

            const messageText = document.createElement('p');
            // Sanitize and display message
            sanitizeHTML(message.message || '[Empty Message]').then(sanitized => messageText.innerHTML = sanitized);
            messageContent.appendChild(messageText);


            const messageTimestamp = document.createElement('small');
             const timestamp = message.timestamp ? new Date(message.timestamp).toLocaleString() : 'Unknown time';
             messageTimestamp.innerText = timestamp;
             messageTimestamp.className = 'text-muted d-block mt-1'; // Styling timestamp
             messageContent.appendChild(messageTimestamp);


            // Style based on sender/receiver relative to the SELECTED account
            if (message.sender === selectedVk) {
                messageItem.className = 'messenger-chat-item-me'; // Sent by selected account
            } else if (message.recipient === selectedVk) {
                 messageItem.className = 'messenger-chat-item-you'; // Received by selected account
            } else {
                 // This case might happen if viewing history after switching accounts
                 // Mark it differently or hide? For now, style as 'you'.
                 messageItem.className = 'messenger-chat-item-you'; // Received by *another* of user's accounts
                 messageTimestamp.innerText += ` (To: ${message.recipient.substring(0, 4)}...)`; // Indicate recipient
            }


            messageItem.appendChild(messageContent);
            messageContainer.appendChild(messageItem);
        });
    } else {
         // No messages yet
         messageContainer.innerHTML = `<div class="text-center text-muted p-3">No messages yet. Send one!</div>`;
    }

    // Scroll to bottom
     setTimeout(() => {
         messageContainer.scrollTop = messageContainer.scrollHeight;
     }, 50); // Small delay ensures DOM is updated
}

// --- Send Message Logic ---

async function estimateSendStampsMessenger(recipientVk, messageInput) {
    const estimation_loading = document.getElementById('estimation-loading');
    const estimation_finished = document.getElementById('estimation-result');
    const send_btn = document.getElementById('send_message');
    const feeElement = document.getElementById('tokenFee'); // Assumes these IDs exist
    const feeXianElement = document.getElementById('tokenFeeXian');

    // Reset state
    estimation_loading.style.display = 'inline-block';
    estimation_finished.style.display = 'none';
    send_btn.disabled = true;

    if (locked || !unencryptedMnemonic || !recipientVk || !messageInput) {
        estimation_loading.style.display = 'none';
        return; // Can't estimate if locked or missing data
    }
    const selectedAccount = getSelectedAccount();
    if (!selectedAccount) {
         estimation_loading.style.display = 'none';
         return;
    }

    try {
        // Encrypt message *before* creating transaction for estimation
        const encryptedMsgHex = encrypt_nacl_box_seal(messageInput, recipientVk);

        let transaction = {
            payload: {
                // chain_id, nonce, sender will be added by signTransaction
                contract: "con_msg_main", // TODO: Confirm contract name
                function: "save_msg",
                kwargs: {
                    msg: encryptedMsgHex,
                    recipient: recipientVk
                },
                stamps_supplied: 200000 // High default for estimation
            },
            metadata: { signature: "" }
        };

        // Sign for estimation
        const signedTxForEst = await signTransaction(transaction, unencryptedMnemonic, selectedAccount.index);
        // Estimate stamps
        const stampResult = await estimateStamps(signedTxForEst); // Use global estimateStamps

        estimation_loading.style.display = 'none';
        estimation_finished.style.display = 'inline-block';

        if (stampResult.stamps === null || !stampResult.success) {
            feeElement.innerHTML = 'Error';
            feeXianElement.innerHTML = 'N/A';
            toast('danger', `Fee estimation failed: ${stampResult.tx_result || 'Unknown'}`);
        } else {
            const stamps = stampResult.stamps;
            const stamp_rate = await getStampRate(); // Assumes getStampRate is available
            if (stamp_rate) {
                feeElement.innerHTML = stamps;
                feeXianElement.innerHTML = (stamps / stamp_rate).toFixed(8);
                send_btn.disabled = false; // Enable send ONLY if estimation successful
            } else {
                feeElement.innerHTML = 'Error';
                feeXianElement.innerHTML = 'N/A';
                toast('warning', 'Could not get stamp rate for fee display.');
            }
        }
    } catch (error) {
        console.error("Error estimating message send stamps:", error);
        estimation_loading.style.display = 'none';
        estimation_finished.style.display = 'inline-block';
        feeElement.innerHTML = 'Error';
        feeXianElement.innerHTML = 'N/A';
        toast('danger', `Fee estimation error: ${error.message}`);
    }
}

async function sendMessage() {
    const messageInput = document.getElementById('message_input');
    const messageText = messageInput.value.trim();
    const recipientVk = document.getElementById('address_chat')?.innerText;
    const sendButton = document.getElementById('send_message');
    const feeElement = document.getElementById('tokenFee');

    if (locked || !unencryptedMnemonic) {
        toast('warning', 'Unlock wallet to send messages.');
        return;
    }
    if (!recipientVk) {
        toast('warning', 'No recipient selected.');
        return;
    }
    if (messageText === '') {
        toast('warning', 'Message cannot be empty.');
        return;
    }

    const selectedAccount = getSelectedAccount();
    if (!selectedAccount) {
         toast('danger', 'Error: No account selected.');
         return;
    }

    let stampsRequired;
    try {
        stampsRequired = parseInt(feeElement.textContent, 10);
        if (isNaN(stampsRequired)) {
             toast('warning', 'Fee not estimated. Please wait.');
             await estimateSendStampsMessenger(recipientVk, messageText); // Re-estimate
             stampsRequired = parseInt(feeElement.textContent, 10);
             if (isNaN(stampsRequired)) throw new Error("Fee estimation failed.");
        }
    } catch (e) {
        toast('danger', `Cannot send: ${e.message}`);
        return;
    }

    // Check balance for fee
    try {
        const nativeBalanceStr = await execute_balance_of('currency', selectedAccount.vk);
        const nativeBalance = parseFloat(nativeBalanceStr);
        const stampRate = await getStampRate();
        if (isNaN(nativeBalance) || !stampRate || (stampsRequired / stampRate) > nativeBalance) {
             toast('danger', `Insufficient XIAN for fee (${(stampsRequired / stampRate).toFixed(4)} Xian needed).`);
             return;
        }
    } catch (e) {
         toast('danger', `Error checking fee balance: ${e.message}`);
         return;
    }


    sendButton.disabled = true;
    sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

    try {
        // 1. Encrypt the message
        const encryptedMsgHex = encrypt_nacl_box_seal(messageText, recipientVk);

        // 2. Prepare Transaction
        let transaction = {
            payload: {
                // chain_id, nonce, sender added by signTransaction
                contract: "con_msg_main", // TODO: Verify contract name
                function: "save_msg",
                kwargs: {
                    msg: encryptedMsgHex,
                    recipient: recipientVk
                },
                stamps_supplied: stampsRequired
            },
            metadata: { signature: "" }
        };

        // 3. Sign Transaction
        const signedTx = await signTransaction(transaction, unencryptedMnemonic, selectedAccount.index);

        // 4. Broadcast Transaction
        const response = await broadcastTransaction(signedTx);

        // 5. Handle Response
        if (response.error === 'timeout') {
             toast('warning', 'Broadcast timed out. Message might have been sent.');
             // Assume sent locally for now, history will show timeout
              const timestamp = new Date().toISOString();
              const localMessage = { sender: selectedAccount.vk, recipient: recipientVk, message: messageText, timestamp: timestamp };
              await saveMessageLocally(selectedAccount.vk, recipientVk, localMessage);
              prependToTransactionHistory("TIMEOUT", "con_msg_main", "save_msg", { recipient: recipientVk }, 'pending', timestamp); // Add to history
              // Reload UI optimistically
              await loadMessengerData(); // Reload all data
              switchChat(recipientVk); // Switch back to the chat
              messageInput.value = ''; // Clear input

        } else if (response && response.result && response.result.hash) {
            const hash = response.result.hash;
            const timestamp = new Date().toISOString(); // Use current time as approx. timestamp

            if (response.result.code !== 0) {
                // Tx failed on chain
                toast('danger', `Error sending message: ${response.result.log || 'Unknown reason'}`);
                 prependToTransactionHistory(hash, "con_msg_main", "save_msg", { recipient: recipientVk }, 'error', timestamp);
            } else {
                // Tx likely succeeded on chain (will be confirmed by history updater)
                toast('success', 'Message sent successfully!');
                // Save locally immediately for UI update
                 const localMessage = { sender: selectedAccount.vk, recipient: recipientVk, message: messageText, timestamp: timestamp };
                 await saveMessageLocally(selectedAccount.vk, recipientVk, localMessage);
                 prependToTransactionHistory(hash, "con_msg_main", "save_msg", { recipient: recipientVk }, 'pending', timestamp); // Add to history

                 // Reload UI
                 await loadMessengerData(); // Reload all data
                 switchChat(recipientVk); // Switch back to the chat
                 messageInput.value = ''; // Clear input
            }
        } else {
             throw new Error('Unexpected response from network.');
        }

    } catch (error) {
        console.error("Error sending message:", error);
        toast('danger', `Failed to send message: ${error.message}`);
    } finally {
        sendButton.disabled = false;
        sendButton.innerHTML = 'Send'; // Restore button text
    }
}


// --- Data Loading and Rendering ---

async function loadMessengerData() {
     if (locked || !unencryptedMnemonic) {
          console.log("Wallet locked, cannot load messenger data.");
          document.querySelector('.messenger-inbox-body').innerHTML = '<div class="text-center text-muted p-3">Unlock wallet to view messages.</div>';
          document.querySelector('.messenger-chat-wrapper').style.display = 'none'; // Hide chat area
          return;
     }
      document.querySelector('.messenger-chat-wrapper').style.display = 'flex'; // Show chat area if unlocked


     const inboxBody = document.querySelector('.messenger-inbox-body');
     inboxBody.innerHTML = '<div class="text-center p-3"><i class="fas fa-spinner fa-spin"></i> Loading messages...</div>';

     allThreads = {}; // Reset global thread state
     const myVKs = new Set(accounts.map(a => a.vk)); // Set of user's public keys
     const vkToIndexMap = new Map(accounts.map(a => [a.vk, a.index])); // Map VK to index for decryption
     const selectedVk = getSelectedVK();

     try {
        // 1. Load locally sent messages for the selected account
        const localSentData = await loadLocalMessages(selectedVk);
        for (const recipientVk in localSentData) {
            if (!allThreads[recipientVk]) {
                 allThreads[recipientVk] = { otherAddress: recipientVk, lastMessage: null, thread: [] };
            }
            localSentData[recipientVk].forEach(msg => {
                 // Add flag indicating it's a locally stored sent message
                 msg.isLocalSent = true;
                 allThreads[recipientVk].thread.push(msg);
            });
        }

        // 2. Fetch messages from the blockchain (using getVariable as GraphQL might be complex)
        // This part is inefficient and needs optimization or backend changes for production
         console.warn("Fetching all messages from chain. This can be slow.");
         const counter = await getVariable('con_msg_main', 'counter'); // Assuming 'counter' exists
         if (counter === null) throw new Error("Could not read message counter from contract.");

         const messageCount = parseInt(counter);
          if (isNaN(messageCount)) throw new Error("Invalid message counter value.");

         const messagePromises = [];
          // Fetch messages individually - VERY INEFFICIENT!
          for (let i = 1; i <= messageCount; i++) { // Fetch latest first? Or process oldest first? Let's do oldest first.
              messagePromises.push(
                  getVariable('con_msg_main', 'messages:' + i).then(messageJson => {
                       if (!messageJson) return null; // Skip if message fetch failed

                       try {
                            const message = JSON.parse(messageJson);
                            // Basic validation of message structure
                             if (!message || typeof message !== 'object' || !message.sender || !message.receiver || !message.message || !message.timestamp) {
                                 console.warn(`Skipping invalid message structure at index ${i}:`, messageJson);
                                 return null;
                             }
                             return { index: i, data: message }; // Return message with its index
                       } catch (parseError) {
                            console.warn(`Failed to parse message at index ${i}:`, parseError, messageJson);
                            return null; // Skip unparseable messages
                       }
                  })
              );
          }

          const fetchedMessages = (await Promise.all(messagePromises)).filter(Boolean); // Wait for all fetches and remove nulls


         // 3. Process Fetched Blockchain Messages
         fetchedMessages.forEach(({ index, data: message }) => {
             const sender = message.sender;
             const recipient = message.receiver;
             let otherPartyVk = null;
             let isReceived = false;
             let receivingAccountIndex = -1;

             // Determine if this message involves any of the user's accounts
             if (myVKs.has(recipient)) {
                 isReceived = true;
                 otherPartyVk = sender;
                 receivingAccountIndex = vkToIndexMap.get(recipient);
             } else if (myVKs.has(sender)) {
                  // This is a message sent by one of the user's accounts (potentially not the selected one)
                  // We only care about it if the *other* party is the one we're building the thread for.
                  otherPartyVk = recipient;
                  // We don't decrypt sent messages here, rely on local storage copy.
             } else {
                  return; // Message doesn't involve the user
             }

             // Initialize thread if needed
             if (!allThreads[otherPartyVk]) {
                  allThreads[otherPartyVk] = { otherAddress: otherPartyVk, lastMessage: null, thread: [] };
             }

             // Process timestamp (handle potential __time__ format)
              let timestamp;
              try {
                 if (message.timestamp && message.timestamp.__time__) {
                      const [y, M, d, h, m, s] = message.timestamp.__time__;
                      timestamp = new Date(Date.UTC(y, M - 1, d, h, m, s)).toISOString();
                 } else if (typeof message.timestamp === 'string') {
                      timestamp = new Date(message.timestamp).toISOString(); // Assume ISO string
                 } else {
                      timestamp = new Date(0).toISOString(); // Fallback
                 }
              } catch { timestamp = new Date(0).toISOString(); }


             let decryptedMessageText = "[Encrypted Message]"; // Default
             if (isReceived) {
                  // Attempt decryption using the correct account index
                  const decrypted = decrypt_nacl_box_seal_open(message.message, unencryptedMnemonic, receivingAccountIndex);
                  if (decrypted !== null) {
                       decryptedMessageText = decrypted;
                  } else {
                       decryptedMessageText = "[Decryption Failed]";
                  }
                  // Add received message to the thread
                  allThreads[otherPartyVk].thread.push({
                       sender: sender,
                       recipient: recipient,
                       message: decryptedMessageText,
                       timestamp: timestamp,
                       isReceived: true // Flag indicating it was received on-chain
                  });

             } else {
                  // This is a message sent by one of the user's accounts.
                   // Check if we already have a local copy for the *selected* account sending to this other party.
                   const selectedVk = getSelectedVK();
                   if (sender === selectedVk) {
                        const thread = allThreads[otherPartyVk].thread;
                         // Avoid adding duplicates if local copy already exists with same timestamp (or close enough)
                         const exists = thread.some(m => m.isLocalSent && Math.abs(new Date(m.timestamp) - new Date(timestamp)) < 5000); // 5 sec tolerance
                         if (!exists) {
                             // If no local copy found (e.g., sent from another device/session), add a placeholder.
                             // We can't decrypt sent messages without the recipient's private key.
                             thread.push({
                                 sender: sender,
                                 recipient: recipient,
                                 message: "[Sent Message - Content Unavailable]",
                                 timestamp: timestamp,
                                 isSentByOtherAccount: false // Sent by selected, but no local copy
                             });
                         }
                   } else {
                       // Sent by *another* of the user's accounts. Add placeholder.
                        allThreads[otherPartyVk].thread.push({
                            sender: sender,
                            recipient: recipient,
                            message: `[Sent by Account ${sender.substring(0,4)}...]`,
                            timestamp: timestamp,
                            isSentByOtherAccount: true // Flag it
                        });
                   }
             }
         });

        // 4. Sort Threads and Determine Last Message
        for (const vk in allThreads) {
             allThreads[vk].thread.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
             const lastMsgObj = allThreads[vk].thread[allThreads[vk].thread.length - 1];
             allThreads[vk].lastMessage = lastMsgObj ? lastMsgObj.message : null;
             allThreads[vk].lastTimestamp = lastMsgObj ? new Date(lastMsgObj.timestamp) : new Date(0);
        }

        // 5. Render Inbox
        renderInbox();

     } catch (error) {
          console.error("Error loading messenger data:", error);
          inboxBody.innerHTML = `<div class="alert alert-danger">Failed to load messages: ${error.message}</div>`;
          toast('danger', `Failed to load messages: ${error.message}`);
     }
}

function renderInbox() {
    const inboxBody = document.querySelector('.messenger-inbox-body');
    if (!inboxBody) return;
    inboxBody.innerHTML = ''; // Clear loading/previous

    // Convert threads object to array and sort by last message timestamp (most recent first)
    const sortedThreads = Object.values(allThreads).sort((a, b) => b.lastTimestamp - a.lastTimestamp);

    if (sortedThreads.length === 0) {
        inboxBody.innerHTML = '<div class="text-center text-muted p-3">No chats found. Start a new one!</div>';
        return;
    }

    sortedThreads.forEach(threadData => {
         renderInboxItem(threadData.otherAddress, threadData.lastMessage, threadData.lastTimestamp);
    });

     // Automatically select the most recent chat if none is selected or current selection is invalid
     const currentChatVk = document.getElementById('address_chat')?.innerText;
      if (!currentChatVk || !allThreads[currentChatVk]) {
         if (sortedThreads.length > 0) {
              switchChat(sortedThreads[0].otherAddress);
         } else {
             // Hide chat window if absolutely no threads exist
              document.querySelector('.messenger-chat').style.display = 'none';
         }
      } else {
          // Re-render the currently selected chat to ensure it's up-to-date
           switchChat(currentChatVk);
      }
}

function renderInboxItem(otherPartyVk, lastMessage, lastTimestamp, addClickListener = true) {
    const inboxBody = document.querySelector('.messenger-inbox-body');
    const selectedVk = getSelectedVK(); // Get currently selected account VK

    const inboxItem = document.createElement('div');
    inboxItem.className = 'messenger-inbox-item';
    inboxItem.dataset.chat = otherPartyVk; // Store VK for switching

    const contentDiv = document.createElement('div');
    contentDiv.className = 'messenger-inbox-item-content';

    const addressH3 = document.createElement('h3');
    // Display truncated VK, add tooltip for full VK
    addressH3.textContent = `${otherPartyVk.substring(0, 6)}...${otherPartyVk.substring(otherPartyVk.length - 4)}`;
    addressH3.title = otherPartyVk; // Show full address on hover
    contentDiv.appendChild(addressH3);

    const lastMsgP = document.createElement('p');
    sanitizeHTML(lastMessage || 'No messages yet').then(sanitized => lastMsgP.innerHTML = sanitized);
    contentDiv.appendChild(lastMsgP);

     // Add relative timestamp
     const timeAgo = formatTimeAgo(lastTimestamp);
     const timeSpan = document.createElement('small');
     timeSpan.className = 'text-muted d-block mt-1';
     timeSpan.textContent = timeAgo;
     contentDiv.appendChild(timeSpan);


    inboxItem.appendChild(contentDiv);

    // Highlight if it's the currently selected chat partner
    const currentChatPartner = document.getElementById('address_chat')?.innerText;
    if (otherPartyVk === currentChatPartner) {
        inboxItem.classList.add('messenger-inbox-item-active');
    }

    if (addClickListener) {
        inboxItem.addEventListener('click', () => switchChat(otherPartyVk));
    }

    inboxBody.appendChild(inboxItem); // Append to the container
}

// Helper to format time difference
function formatTimeAgo(timestamp) {
    if (!timestamp) return '';
    const now = new Date();
    const past = new Date(timestamp);
    const diffInSeconds = Math.floor((now - past) / 1000);
    const diffInMinutes = Math.floor(diffInSeconds / 60);
    const diffInHours = Math.floor(diffInMinutes / 60);
    const diffInDays = Math.floor(diffInHours / 24);

    if (diffInSeconds < 60) return `${diffInSeconds}s ago`;
    if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
    if (diffInHours < 24) return `${diffInHours}h ago`;
    if (diffInDays === 1) return `Yesterday`;
    if (diffInDays < 7) return `${diffInDays}d ago`;
    return past.toLocaleDateString(); // Older than a week, show date
}


// --- Initial Load ---
loadMessengerData(); // Load data when the messenger page is displayed

======================================================================
File: xian-web-wallet/templates/page_js/governance.js
======================================================================
// Keep existing functions: getValidatorState, getDAOBalance, getProposals, getProposal, buildProposalTable, getRewardPercentages, etc.

// --- Estimate Vote Stamps (Modified for HD) ---
async function estimateVoteStamps(proposal_id, voteBool) { // Made async
    // Check lock state FIRST
    if (locked || !unencryptedMnemonic) {
        toast('warning', 'Wallet locked. Cannot estimate vote fee.');
        return null; // Return null to indicate failure
    }
    const selectedAccount = getSelectedAccount();
    if (!selectedAccount) {
         toast('danger', 'No account selected for voting.');
        return null;
    }

    const voteString = voteBool ? "yes" : "no";

    let transaction = {
        payload: {
            // chain_id, nonce, sender added by signTransaction
            contract: "masternodes",
            function: "vote",
            kwargs: {
                proposal_id: proposal_id,
                vote: voteString
            },
            stamps_supplied: 100000 // High default
        },
        metadata: { signature: "" }
    };

    try {
        // Sign for estimation using selected account
        const signedTxForEstimation = await signTransaction(transaction, unencryptedMnemonic, selectedAccount.index);
        // Estimate
        const stampResult = await estimateStamps(signedTxForEstimation);

        if (stampResult.stamps === null || !stampResult.success) {
             console.error(`Vote fee estimation failed: ${stampResult.tx_result || 'Unknown error'}`);
             toast('warning', `Fee estimation failed: ${stampResult.tx_result || 'Unknown'}`);
            return null; // Indicate failure
        }
        return stampResult.stamps; // Return estimated stamps

    } catch (error) {
        console.error("Error estimating vote stamps:", error);
        toast('danger', `Error estimating vote fee: ${error.message}`);
        return null;
    }
}

// --- Vote Proposal (Modified for HD) ---
async function voteProposal(proposal_id, voteBool) { // Made async
     const voteString = voteBool ? "yes" : "no";
     const voteButton = document.querySelector(`.vote-${voteString}[data-id="${proposal_id}"]`); // Find the specific button

     // Check lock state
     if (locked || !unencryptedMnemonic) {
         toast('warning', 'Wallet locked. Please unlock to vote.');
         return;
     }
      const selectedAccount = getSelectedAccount();
      if (!selectedAccount) {
          toast('danger', 'No account selected for voting.');
          return;
      }
      // Check if the selected account is actually a validator (UI should ideally prevent this button showing otherwise)
       if (!isValidator) { // Assumes 'isValidator' is correctly set based on selectedAccount.vk
            toast('warning', 'Only validators can vote.');
            return;
       }


     // Disable button during process
     if (voteButton) {
        voteButton.disabled = true;
        voteButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Voting...';
     }

     // --- Estimate Fee ---
     let stampsRequired = await estimateVoteStamps(proposal_id, voteBool);
     if (stampsRequired === null) {
         // Error already toasted in estimateVoteStamps
         if (voteButton) { // Re-enable button if estimation failed
             voteButton.disabled = false;
             voteButton.innerHTML = `Vote ${voteString.charAt(0).toUpperCase() + voteString.slice(1)}`;
         }
         return; // Stop if estimation failed
     }
     stampsRequired += 50; // Add buffer

     // --- Check Fee Balance ---
     try {
         const nativeBalanceStr = await execute_balance_of('currency', selectedAccount.vk);
         const nativeBalance = parseFloat(nativeBalanceStr);
         const stampRate = await getStampRate();
         if (isNaN(nativeBalance) || !stampRate || (stampsRequired / stampRate) > nativeBalance) {
              toast('danger', `Insufficient XIAN balance for voting fee (${(stampsRequired / stampRate).toFixed(4)} Xian needed).`);
              if (voteButton) { voteButton.disabled = false; voteButton.innerHTML = `Vote ${voteString.charAt(0).toUpperCase() + voteString.slice(1)}`; }
              return;
         }
     } catch (e) {
          toast('danger', `Error checking balance for voting fee: ${e.message}`);
           if (voteButton) { voteButton.disabled = false; voteButton.innerHTML = `Vote ${voteString.charAt(0).toUpperCase() + voteString.slice(1)}`; }
          return;
     }
     // --- End Fee Check ---


     // --- Confirmation ---
     let conf = confirm(`Vote ${voteString.toUpperCase()} on proposal #${proposal_id}? Fee: ~${(stampsRequired / await getStampRate()).toFixed(4)} Xian`);
     if (!conf) {
          if (voteButton) {
               voteButton.disabled = false;
               voteButton.innerHTML = `Vote ${voteString.charAt(0).toUpperCase() + voteString.slice(1)}`;
          }
          return;
     }
     // --- End Confirmation ---


     // Create transaction payload
    let transaction = {
        payload: {
            chain_id: CHAIN_ID,
            contract: "masternodes",
            function: "vote",
            kwargs: {
                proposal_id: parseInt(proposal_id), // Ensure proposal_id is int
                vote: voteString
            },
            stamps_supplied: stampsRequired
            // nonce, sender added by signTransaction
        },
        metadata: { signature: "" }
    };

    // Sign and Broadcast
    try {
        const signedTx = await signTransaction(transaction, unencryptedMnemonic, selectedAccount.index);
        const response = await broadcastTransaction(signedTx);

        // Handle response
         if (response.error === 'timeout') {
              toast('warning', 'Vote broadcast timed out. Check Explorer.');
               prependToTransactionHistory("TIMEOUT", 'masternodes', 'vote', transaction.payload.kwargs, 'pending', new Date().toLocaleString());
         } else if (response && response.result && response.result.hash) {
            const hash = response.result.hash;
            let status = 'pending';
            let logMessage = response.result.log || "";

            if (response.result.code !== 0) {
                status = 'error';
                toast('danger', `Vote failed: ${logMessage.substring(0,100)}...`);
            } else {
                toast('success', `Vote sent successfully: ${hash.substring(0,10)}...`);
                // Refresh the proposal list after a short delay to allow block processing
                 setTimeout(() => {
                    // Check if still on the governance page before refreshing
                    if (app_page === 'insights' || app_page === 'governance') { // Adjust page name if needed
                         buildProposalTable(); // Refresh proposals UI
                    }
                 }, 4000); // Delay might need adjustment
            }
             prependToTransactionHistory(hash, 'masternodes', 'vote', transaction.payload.kwargs, status, new Date().toLocaleString());
        } else {
            throw new Error('Unexpected response from network during voting.');
        }

    } catch (error) {
        console.error("Error voting on proposal:", error);
        toast('danger', `Error voting: ${error.message}`);
    } finally {
        // Re-enable button (might be slightly delayed if refresh happens)
         if (voteButton) {
             voteButton.disabled = false;
             voteButton.innerHTML = `Vote ${voteString.charAt(0).toUpperCase() + voteString.slice(1)}`;
         }
    }
}

// --- Keep existing event listener for vote buttons ---
document.addEventListener("click", async (event) => {
    const target = event.target.closest('.vote-yes, .vote-no'); // Check closest button ancestor
    if (!target) return;

    const proposal_id = target.dataset.id;
    if (!proposal_id) return;


    if (target.classList.contains("vote-yes")) {
        await voteProposal(proposal_id, true); // Call async function
    } else if (target.classList.contains("vote-no")) { // Ensure class is vote-no
         await voteProposal(proposal_id, false); // Call async function
    }
});

// Modify getValidatorState to check the SELECTED account
function getValidatorState() {
     const selectedAccount = getSelectedAccount();
     const displayElement = document.getElementById('validator-state');
     const proposalButton = document.getElementById('new-proposal'); // Assuming this ID exists

     if (!displayElement) return;
     displayElement.innerHTML = "<span><i class='fas fa-spinner fa-spin'></i> Checking validator status...</span>"; // Loading state
      proposalButton.style.display = "none"; // Hide button initially
      isValidator = false; // Reset flag


     if (!selectedAccount) {
         displayElement.innerHTML = "<span>Wallet locked or no account selected.</span>";
         return;
     }

    getVariable("masternodes", "nodes")
        .then(validator_list_str => {
            let built_html = "<span>You (<span class='text-muted' title='"+selectedAccount.vk+"'>"+selectedAccount.vk.substring(0,6)+"...</span>) are currently ";
             let isSelectedValidator = false;
             try {
                 const validator_list = validator_list_str ? JSON.parse(validator_list_str) : [];
                  if (Array.isArray(validator_list) && validator_list.includes(selectedAccount.vk)) {
                       isSelectedValidator = true;
                       isValidator = true; // Update global flag
                  }
                  // Update validator count display if element exists
                  const countElement = document.getElementById('number-of-validators-governance');
                  if (countElement) countElement.textContent = validator_list.length;

             } catch (e) {
                  console.error("Failed to parse validator list:", e);
                   built_html += "<span class='text-warning'>unable to determine status (parse error)</span>";
                   const countElement = document.getElementById('number-of-validators-governance');
                   if (countElement) countElement.textContent = "ERR";
             }


            if (isSelectedValidator) {
                if (proposalButton) proposalButton.style.display = "block"; // Show proposal button
                built_html += "<span class='text-success'>a Validator</span>";
            } else {
                built_html += "<span class='text-danger'>not a Validator</span>";
            }
            built_html += ".</span>";
            displayElement.innerHTML = built_html;

             // Rebuild proposal table AFTER checking validator status for the selected account
             buildProposalTable();

        })
        .catch(error => {
            console.error("Error getting validator state:", error);
            displayElement.innerHTML = "<span>Error checking validator status.</span>";
            const countElement = document.getElementById('number-of-validators-governance');
            if (countElement) countElement.textContent = "ERR";
        });
}

// Ensure getValidatorState is called when the page loads or account changes
// This might need to be triggered from the main router/page load logic for governance page.
// For now, assume it's called correctly on page load.

// --- Initial Load (Governance Page) ---
// (Keep existing load calls, but ensure getValidatorState runs)
// getDAOBalance();
// getRewardPercentages();
// loadStampRate(); // Assuming loadStampRate exists or is defined elsewhere
// getValidatorState(); // This will now also trigger buildProposalTable after check

======================================================================
File: xian-web-wallet/templates/page_js/password-input.js
======================================================================
async function unlockWallet() { // Made async
    const password = document.getElementById('unlock_password').value;
    const passwordError = document.getElementById('passwordError');
    const unlockButton = document.getElementById('btn-password-input-unlock-wallet');

    passwordError.style.display = 'none'; // Reset error

    if (password === "") {
        passwordError.innerHTML = 'Please enter your password.';
        passwordError.style.display = 'block';
        return;
    }

    // Disable button during decryption attempt
    unlockButton.disabled = true;
    unlockButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Unlocking...';


    try {
        // 1. Read necessary data from storage
        const storedEncryptedSeed = await readEncryptedSeed();
        const storedAccounts = await readAccounts(); // Read accounts to ensure state consistency
        const storedSelectedIndex = await readSelectedAccountIndex(); // Read index

        if (!storedEncryptedSeed) {
            // This case should ideally not happen if password-input page is shown,
            // but handle it defensively.
            console.error("Encrypted seed not found in storage during unlock attempt.");
            passwordError.innerHTML = 'Wallet data not found. Please try importing again.';
            passwordError.style.display = 'block';
            // Redirect to get-started as the wallet state is broken
            changePage('get-started');
            return; // Exit the function
        }

        // 2. Attempt to decrypt the seed
        const decryptedMnemonic = decryptSeed(storedEncryptedSeed, password); // From xian.js

        if (decryptedMnemonic === null) {
            // Decryption failed (likely wrong password)
            passwordError.innerHTML = 'Incorrect password!';
            passwordError.style.display = 'block';
            // Re-enable button
            unlockButton.disabled = false;
            unlockButton.innerHTML = 'Unlock Wallet';
            document.getElementById('unlock_password').value = ''; // Clear password field on failure
            document.getElementById('unlock_password').focus();   // Set focus back to password field
            return; // Stop execution
        }

        // 3. Decryption Successful: Update Global State
        window.unencryptedMnemonic = decryptedMnemonic; // Store the decrypted mnemonic globally
        window.encryptedSeed = storedEncryptedSeed; // Ensure global encryptedSeed is up-to-date
        window.accounts = storedAccounts;           // Ensure global accounts are up-to-date
        window.selectedAccountIndex = storedSelectedIndex; // Ensure global index is up-to-date
        window.locked = false;                      // Set wallet to unlocked state

        // Clear password field immediately after successful unlock
        document.getElementById('unlock_password').value = '';

        // 4. Navigate to the main wallet page
        changePage('wallet');

    } catch (error) {
        console.error("Error during wallet unlock:", error);
        passwordError.innerHTML = 'An error occurred during unlock. Please try again.';
        passwordError.style.display = 'block';
        // Re-enable button on unexpected errors
        unlockButton.disabled = false;
        unlockButton.innerHTML = 'Unlock Wallet';
    }
}

// --- Remove Wallet Function (Needs Adaptation) ---
async function removeWallet() { // Made async
    let confirm_delete = confirm("Are you sure you want to remove the wallet from this browser? This cannot be undone without your recovery phrase.");
    if (!confirm_delete) {
        return;
    }

    try {
        // Remove all HD wallet related data
        await removeEncryptedSeed();
        await removeAccounts();
        await removeSelectedAccountIndex();
        // Also clear transaction history associated with this wallet instance
        localStorage.removeItem('tx_history'); // Assuming tx_history is global to the install

        // Reset global state variables
        window.unencryptedMnemonic = null;
        window.encryptedSeed = null;
        window.accounts = [];
        window.selectedAccountIndex = 0;
        window.locked = true;
        window.tx_history = []; // Reset local copy too

        toast('success', 'Wallet removed successfully.');
        changePage('get-started');

    } catch (error) {
        console.error("Error removing wallet:", error);
        toast('danger', 'Failed to remove wallet data completely.');
        // Still try to navigate away
        changePage('get-started');
    }
}

// --- Event Listeners ---

// Unlock button click
document.getElementById('btn-password-input-unlock-wallet').addEventListener('click', function() {
    unlockWallet();
});

// Remove wallet button click
document.getElementById('btn-password-input-remove-wallet').addEventListener('click', function() {
    removeWallet();
});

// Enter key press in password field
document.getElementById('unlock_password').addEventListener('keyup', function(event) {
    if (event.keyCode === 13) { // Enter key
        event.preventDefault();
        unlockWallet();
    }
});

// Auto-focus password field when page loads
document.getElementById('unlock_password').focus();

======================================================================
File: xian-web-wallet/templates/page_js/receive-token.js
======================================================================
document.getElementById('receive-token-back').addEventListener('click', function() {
    goToWallet();
});

document.getElementById('yourAddressReceive').addEventListener('click', function() {
    copyToClipboard('yourAddressReceive');
});

function loadReceiveTokenPage() {
    Promise.all([
        readSecureCookie('publicKey')]
    ).then((values) => {
        document.getElementById("yourAddressReceive").innerHTML = values[0];
    });
}

loadReceiveTokenPage();

======================================================================
File: xian-web-wallet/templates/page_js/create-wallet.js
======================================================================
function inputValidation() {
    const passwordInput = document.getElementById('password'); // Renamed variable for clarity
    const confirmPassword = document.getElementById('confirmPassword');
    const createWalletError = document.getElementById('createWalletError');

    // Clear error on input start
    passwordInput.addEventListener('input', () => createWalletError.style.display = 'none');
    confirmPassword.addEventListener('input', () => createWalletError.style.display = 'none');

    // Validate password length (on blur or submit is often better UX than on every input)
    passwordInput.addEventListener("blur", checkPasswordLength); // Check on losing focus
    // Validate password match (on blur of confirm field or submit)
    confirmPassword.addEventListener("blur", matchPasswords); // Check on losing focus

    function checkPasswordLength() {
        const passwordValue = passwordInput.value;
        if (passwordValue.length > 0 && passwordValue.length < 6) {
            createWalletError.innerHTML = 'Password must be at least 6 characters long!';
            createWalletError.style.display = 'block';
            return false; // Indicate failure
        }
        // createWalletError.style.display = 'none'; // Only hide if valid? Or let matchPasswords handle it.
        return true; // Indicate success
    }

    function matchPasswords() {
        const confirmPasswordValue = confirmPassword.value;
        if (passwordInput.value !== confirmPasswordValue) {
            createWalletError.innerHTML = 'Passwords do not match!';
            createWalletError.style.display = 'block';
            return false; // Indicate failure
        }
        // If match, check length again in case confirm was blurred first
        if (!checkPasswordLength()) return false;

        createWalletError.style.display = 'none'; // Hide error only if both checks pass
        return true; // Indicate success
    }

    // Return validation functions if needed elsewhere, or just rely on blur/submit checks
    return { checkPasswordLength, matchPasswords };
}

async function createHdWallet() { // Renamed function and made async
    const password = document.getElementById('password').value;
    const confirmPasswordVal = document.getElementById('confirmPassword').value; // Renamed variable
    const createWalletError = document.getElementById('createWalletError');
    const createButton = document.getElementById('btn-create-wallet-create');

    createWalletError.style.display = 'none'; // Reset error display

    // --- Validation ---
    if (password.length < 6) {
        createWalletError.innerHTML = 'Password must be at least 6 characters long!';
        createWalletError.style.display = 'block';
        return;
    }
    if (password !== confirmPasswordVal) {
        createWalletError.innerHTML = 'Passwords do not match!';
        createWalletError.style.display = 'block';
        return;
    }
    // --- End Validation ---

    // Disable button during creation
    createButton.disabled = true;
    createButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';


    try {
        // 1. Create Master Seed (generates mnemonic, derives first key, encrypts mnemonic)
        const newWalletData = createMasterSeed(password); // From xian.js

        // 2. Prepare initial account data
        const initialAccount = {
            index: 0,
            vk: newWalletData.publicKey, // VK of the first account (index 0)
            name: "Account 1" // Default name for the first account
        };

        // 3. Update Global State (in router.js scope)
        // Note: Direct modification of globals isn't ideal, but follows existing pattern.
        // Consider passing these back or using a state management approach later.
        window.encryptedSeed = newWalletData.encryptedSeed;
        window.unencryptedMnemonic = newWalletData.unencryptedMnemonic; // Store temporarily for immediate use
        window.accounts = [initialAccount];
        window.selectedAccountIndex = 0;
        window.locked = false; // Wallet is created and immediately unlocked

        // 4. Save State to Storage (using async functions from cookietoolz.js)
        await saveEncryptedSeed(window.encryptedSeed);
        await saveAccounts(window.accounts);
        await saveSelectedAccountIndex(window.selectedAccountIndex);

        // Clear password fields after successful creation for security
        document.getElementById('password').value = '';
        document.getElementById('confirmPassword').value = '';


        // 5. Navigate to Wallet Page
        toast('success', 'Wallet created successfully! Remember to back up your seed phrase in Settings.');
        changePage('wallet');

    } catch (error) {
        console.error("Error creating HD wallet:", error);
        createWalletError.innerHTML = 'Failed to create wallet. Please try again. ' + error.message;
        createWalletError.style.display = 'block';
        // Re-enable button on error
        createButton.disabled = false;
        createButton.innerHTML = 'Create Wallet';

    }
    // Re-enable button if successful navigation didn't happen (though it should)
    // createButton.disabled = false;
    // createButton.innerHTML = 'Create Wallet';
}

// Initialize validation listeners
inputValidation();

// Add Enter key listener to confirm password field for convenience
document.getElementById('confirmPassword').addEventListener('keyup', function(event) {
    if (event.keyCode === 13) { // 13 is the Enter key
        event.preventDefault(); // Prevent default form submission if applicable
        createHdWallet(); // Call the async creation function
    }
});

// Add click listener to the create button
document.getElementById('btn-create-wallet-create').addEventListener('click', function() {
    createHdWallet(); // Call the async creation function
});

// Add click listener to the back button
document.getElementById('btn-create-wallet-back').addEventListener('click', function() {
    changePage('get-started');
});

======================================================================
File: xian-web-wallet/templates/page_js/request-signature.js
======================================================================
// State variables for the popup context
let callbackKey = null;
let messageToSign = null;
let isActionTaken = false; // Flag to prevent double actions
let selectedVk = null; // To display which account is making the request

// --- Initialization and Message Handling ---

// Listen for messages from the main window (router.js)
window.addEventListener("message", (event) => {
    // Optional origin check
    // if (event.origin !== "chrome-extension://your-extension-id") return;

    console.log("Signature Popup received message:", event.data);

    if (event.data.type === "INITIAL_STATE") {
        selectedVk = event.data.state.selectedVk;
        // You could display the selectedVk here if needed
        // e.g., document.getElementById('signingAccount').textContent = `Signing as: ${selectedVk.substring(0,6)}...`;
    }

    if (event.data.type === "REQUEST_SIGNATURE") {
        callbackKey = event.data.callbackKey;
        messageToSign = event.data.data.message; // Extract the message string

        // Populate the UI
        const messageElement = document.getElementById('requestSignatureMessage');
        if (messageElement) {
            // Display the message safely (escape HTML)
             messageElement.textContent = messageToSign || '[Empty Message]';
        } else {
             console.error("Message display element not found.");
        }

        // Enable buttons now that data is loaded
        document.getElementById('request-signature-accept').disabled = false;
        document.getElementById('request-signature-reject').disabled = false;
    }
});

// --- Action Handlers ---

function acceptRequest() {
    if (!callbackKey || isActionTaken || messageToSign === null) return;
    isActionTaken = true; // Set flag

    console.log("Popup: Signature Request Accepted");

    // Send acceptance and the message *back* to the main window for actual signing
    window.opener.postMessage({
        type: 'REQUEST_SIGNATURE_RESPONSE', // Specific response type
        data: {
            confirmed: true,
            message: messageToSign // Send the message that needs signing
        },
        callbackKey: callbackKey
    }, '*'); // Use specific origin in production

    window.close(); // Close the popup
}

function rejectRequest() {
    if (!callbackKey || isActionTaken) return;
    isActionTaken = true; // Set flag

    console.log("Popup: Signature Request Rejected");

    // Send rejection back to the main window
    window.opener.postMessage({
        type: 'REQUEST_SIGNATURE_RESPONSE', // Specific response type
        data: {
            confirmed: false,
            signature: null, // Indicate rejection by null signature
            errors: ['rejected']
        },
        callbackKey: callbackKey
    }, '*'); // Use specific origin in production

    window.close(); // Close the popup
}

// Handle the user closing the window directly
window.addEventListener('beforeunload', () => {
    if (!isActionTaken) {
        console.log("Popup: Window closed by user, rejecting signature request.");
        rejectRequest(); // Attempt to send rejection
    }
});

// --- Attach Event Listeners ---
document.getElementById('request-signature-accept')?.addEventListener('click', acceptRequest);
document.getElementById('request-signature-reject')?.addEventListener('click', rejectRequest);

// Initial button state (disabled until data arrives)
document.getElementById('request-signature-accept').disabled = true;
document.getElementById('request-signature-reject').disabled = true;

// Signal readiness to opener window
if (window.opener) {
    window.opener.postMessage({ type: "POPUP_READY" }, "*");
} else {
    console.error("Popup: Cannot communicate with opener window.");
    document.body.innerHTML = '<div class="alert alert-danger m-3">Error: Could not connect to the main wallet window. Please close this window and try again.</div>';
}

======================================================================
File: xian-web-wallet/templates/page_js/advanced-transaction.js
======================================================================
// Assumes global vars: selectedAccountIndex, unencryptedMnemonic, locked, accounts, CHAIN_ID, EXPLORER, RPC
// Assumes functions: getSelectedAccount, signTransaction, estimateStamps, broadcastTransaction,
//                    prependToTransactionHistory, changePage, toast, getContractFunctions, getStampRate

// --- Main Send Function ---
async function sendAdvTx() { // Made async
    // Check lock state
    if (locked || !unencryptedMnemonic) {
        toast('warning', 'Wallet is locked. Please unlock to send transactions.');
        return;
    }
    const selectedAccount = getSelectedAccount();
    if (!selectedAccount) {
        toast('danger', 'Error: No account selected.');
        return;
    }

    const contractName = document.getElementById("contractName").value.trim();
    const functionName = document.getElementById("functionName").value;
    const errorMsg = document.getElementById("sendAdvTxError"); // Renamed for clarity
    const successMsg = document.getElementById("sendAdvTxSuccess"); // Renamed for clarity
    const sendButton = document.getElementById('btn-adv-tx-send');
    const argsContainer = document.getElementById("adv_kwargs"); // Container for arg inputs

    errorMsg.style.display = "none";
    successMsg.style.display = "none";

    // Basic validation
    if (!contractName || !functionName) {
        errorMsg.innerHTML = "Contract name and function are required.";
        errorMsg.style.display = "block";
        return;
    }

    // --- Build Kwargs ---
    let kwargs = {};
    let functionInfo;
    let validationError = false;
    try {
         functionInfo = await getContractFunctions(contractName);
         if (!functionInfo || !functionInfo.methods) {
              throw new Error(`Could not retrieve methods for contract '${contractName}'.`);
         }
         const selectedFunctionInfo = functionInfo.methods.find(func => func.name === functionName);
         if (!selectedFunctionInfo) {
             throw new Error(`Function '${functionName}' not found in contract '${contractName}'.`);
         }

        // Iterate through arguments defined for the selected function
        for (const arg of selectedFunctionInfo.arguments) {
            const inputElement = document.getElementById(arg.name); // Assuming IDs match arg names
            if (!inputElement) {
                console.error(`Input element not found for argument: ${arg.name}`);
                validationError = true;
                errorMsg.innerHTML = `Missing input field for argument '${arg.name}'.`;
                break; // Stop processing if an input is missing
            }
            const valueStr = inputElement.value; // Don't trim here, might be intentional space in string

            // Validate and parse based on expected type
            let parsedValue;
            try {
                 parsedValue = parseArgumentValue(valueStr, arg.type, arg.name); // Use helper function
                 kwargs[arg.name] = parsedValue;
            } catch (e) {
                 validationError = true;
                 errorMsg.innerHTML = e.message; // Show specific validation error
                 break;
            }
        }
    } catch (error) {
         console.error("Error preparing arguments:", error);
         errorMsg.innerHTML = `Error preparing arguments: ${error.message}`;
         errorMsg.style.display = "block";
         return; // Stop if we can't get function info or parse args
    }

    if (validationError) {
        errorMsg.style.display = "block";
        return; // Stop if any argument validation failed
    }
    // --- End Build Kwargs ---


    // --- Fee Check ---
    let stampsRequired;
    try {
        stampsRequired = parseInt(document.getElementById("tokenFee").textContent, 10);
        if (isNaN(stampsRequired)) {
            toast('warning', 'Transaction fee not estimated. Please wait or provide arguments.');
             await estimateSendStampsAdv(); // Try re-estimating
             stampsRequired = parseInt(document.getElementById("tokenFee").textContent, 10);
             if (isNaN(stampsRequired)) {
                throw new Error("Fee estimation failed.");
             }
        }
    } catch (e) {
        errorMsg.innerHTML = 'Could not determine transaction fee. ' + e.message;
        errorMsg.style.display = 'block';
        return;
    }
    // Check for sufficient native balance to pay fee (add this check)
    try {
         const nativeBalanceStr = await execute_balance_of('currency', selectedAccount.vk); // Assume execute_balance_of exists
         const nativeBalance = parseFloat(nativeBalanceStr);
         const stampRate = await getStampRate();
         if (isNaN(nativeBalance) || !stampRate || (stampsRequired / stampRate) > nativeBalance) {
              errorMsg.innerHTML = `Insufficient XIAN balance to pay the transaction fee (${(stampsRequired / stampRate).toFixed(4)} Xian needed).`;
              errorMsg.style.display = 'block';
              return;
         }
    } catch (e) {
         console.error("Error checking fee balance:", e);
         errorMsg.innerHTML = 'Error checking balance for fee: ' + e.message;
         errorMsg.style.display = 'block';
         return;
    }
    // --- End Fee Check ---


    // Disable button
    sendButton.disabled = true;
    sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

    // --- Transaction Creation & Signing ---
    let payload = {
        payload: {
            chain_id: CHAIN_ID,
            contract: contractName,
            function: functionName,
            kwargs: kwargs,
            stamps_supplied: stampsRequired
            // nonce and sender will be added by signTransaction
        },
        metadata: {
            signature: "",
        }
    };

    try {
        // Sign using selected account
        const signedTx = await signTransaction(payload, unencryptedMnemonic, selectedAccount.index);

        let conf = confirm(`Execute ${contractName}.${functionName} with provided arguments? Fee: ~${(stampsRequired / await getStampRate()).toFixed(4)} Xian`);
        if (!conf) {
             sendButton.disabled = false;
             sendButton.innerHTML = 'Send Transaction';
             return;
        }

        // Broadcast
        const response = await broadcastTransaction(signedTx); // Pass signed object

        // --- Handle Response ---
         if (response.error === 'timeout') {
            successMsg.innerHTML = 'Transaction broadcast timed out. It might still succeed. Check Explorer.';
            successMsg.style.display = 'block';
            prependToTransactionHistory("TIMEOUT", contractName, functionName, kwargs, 'pending', new Date().toLocaleString());
         } else if (response && response.result && response.result.hash) {
            const hash = response.result.hash;
            let status = 'pending';
            let logMessage = response.result.log || "";

            if (response.result.code !== 0) {
                status = 'error';
                errorMsg.innerHTML = `Transaction failed: ${logMessage}`;
                errorMsg.style.display = 'block';
                 toast('danger', `Transaction failed: ${logMessage.substring(0,100)}...`);
            } else {
                 successMsg.innerHTML = `Transaction sent! Hash: <a class='explorer-url text-light' href='${EXPLORER}/tx/${hash}' target='_blank' rel='noopener noreferrer'>${hash}</a>`;
                 successMsg.style.display = 'block';
                 toast('success', `Transaction sent: ${hash.substring(0,10)}...`);
                 // Optionally clear args on success
                 // argsContainer.querySelectorAll('input').forEach(input => input.value = '');
            }
            prependToTransactionHistory(hash, contractName, functionName, kwargs, status, new Date().toLocaleString());
         } else {
            console.error("Unexpected broadcast response:", response);
            throw new Error('Unexpected response from network.');
         }
        // --- End Handle Response ---

    } catch (error) {
        console.error('Error sending advanced transaction:', error);
        errorMsg.innerHTML = `Error sending transaction: ${error.message}`;
        errorMsg.style.display = 'block';
         toast('danger', `Error: ${error.message}`);
    } finally {
        // Re-enable button
        sendButton.disabled = false;
        sendButton.innerHTML = 'Send Transaction';
    }
}

// --- Argument Parsing Helper ---
function parseArgumentValue(valueStr, expectedType, argName) {
    // Trim only if not expecting a string where spaces might matter
    // const trimmedValue = (expectedType === 'str') ? valueStr : valueStr.trim();
    const trimmedValue = valueStr.trim(); // Trim generally for robustness unless specific need not to

    if (trimmedValue === "") {
        throw new Error(`Value for argument '${argName}' cannot be empty.`);
    }

    try {
        switch (expectedType) {
            case "int":
                const intVal = parseInt(trimmedValue, 10);
                if (isNaN(intVal) || String(intVal) !== trimmedValue) { // Strict check
                    throw new Error(); // Use generic error, message set below
                }
                return intVal;
            case "float":
            case "decimal.Decimal": // Treat decimal.Decimal like float for input
                 // Allow scientific notation for floats
                 const floatVal = parseFloat(trimmedValue);
                 if (isNaN(floatVal)) {
                      throw new Error();
                 }
                 // Check if the input was just a number, potentially with decimals or E notation
                  if (!/^-?\d+(\.\d+)?([eE][+-]?\d+)?$/.test(trimmedValue)) {
                    //   throw new Error(`Invalid characters for type ${expectedType}`);
                  }

                 return floatVal; // Return as standard JS number
            case "bool":
                if (trimmedValue.toLowerCase() === "true") return true;
                if (trimmedValue.toLowerCase() === "false") return false;
                throw new Error();
            case "str":
                return valueStr; // Return original string, including spaces
            case "dict":
            case "list":
            case "Any": // Treat Any initially as JSON
                try {
                    return JSON.parse(trimmedValue); // Try parsing as JSON first
                } catch (e) {
                    if (expectedType === "Any") {
                        // If JSON parsing fails for Any, treat as string
                        return valueStr; // Return original string if not valid JSON for Any type
                    } else {
                         throw new Error(`Invalid JSON format for type ${expectedType}`);
                    }
                }
            default:
                 console.warn(`Unsupported argument type '${expectedType}' for '${argName}'. Treating as string.`);
                return valueStr; // Default to string if type is unknown/unhandled
        }
    } catch (e) {
        // Throw a more specific error message
        throw new Error(`Invalid value for argument '${argName}'. Expected type '${expectedType}'. ${e.message || ''}`);
    }
}


// --- Load Page & Function/Argument Display ---
async function loadAdvancedTransactionPage() { // Made async
    const contractInput = document.getElementById("contractName");
    const functionSelect = document.getElementById("functionName");
    const argsSection = document.getElementById("adv_args");
    const argsContainer = document.getElementById("adv_kwargs");
    const errorMsg = document.getElementById("sendAdvTxError");
    const successMsg = document.getElementById("sendAdvTxSuccess");
    const feeContainer = document.getElementById('tokenFeeContainer');

    // Reset UI elements
    argsSection.style.display = "none";
    argsContainer.innerHTML = "";
    errorMsg.style.display = "none";
    successMsg.style.display = "none";
    feeContainer.style.display = "none";
    functionSelect.innerHTML = "<option value=''>--- Select Contract First ---</option>"; // Clear options
    functionSelect.disabled = true;
    document.getElementById('btn-adv-tx-send').disabled = true; // Disable send initially

    // Event listener for contract name input (on blur)
    contractInput.addEventListener("blur", async function () {
        const contractName = contractInput.value.trim();
        errorMsg.style.display = "none";
        successMsg.style.display = "none";
        functionSelect.innerHTML = "<option value=''>Loading Functions...</option>";
        functionSelect.disabled = true;
        argsSection.style.display = "none";
        argsContainer.innerHTML = "";
        feeContainer.style.display = 'none'; // Hide fee on contract change
        document.getElementById('btn-adv-tx-send').disabled = true;

        if (!contractName) {
            functionSelect.innerHTML = "<option value=''>--- Enter Contract Name ---</option>";
            return;
        }

        try {
            const functionsInfo = await getContractFunctions(contractName);
            if (functionsInfo === null || !functionsInfo.methods || functionsInfo.methods.length === 0) {
                errorMsg.innerHTML = `Contract '${contractName}' not found or has no public methods.`;
                errorMsg.style.display = "block";
                functionSelect.innerHTML = "<option value=''>--- Contract Not Found ---</option>";
                return;
            }

            functionSelect.innerHTML = "<option value=''>--- Select Function ---</option>"; // Default option
            // Filter out internal/private methods if necessary (e.g., starting with '_')
            functionsInfo.methods
                .filter(func => !func.name.startsWith('_')) // Example filter
                .sort((a, b) => a.name.localeCompare(b.name)) // Sort alphabetically
                .forEach((func) => {
                    functionSelect.innerHTML += `<option value="${func.name}">${func.name}</option>`;
                });
            functionSelect.disabled = false; // Enable function selection

        } catch (error) {
            console.error('Error fetching contract functions:', error);
            errorMsg.innerHTML = `RPC Error: Could not fetch functions for ${contractName}.`;
            errorMsg.style.display = "block";
            functionSelect.innerHTML = "<option value=''>--- Error Loading ---</option>";
        }
    });

    // Event listener for function selection change
    functionSelect.addEventListener("change", async function () {
        const contractName = contractInput.value.trim();
        const functionName = functionSelect.value;
        errorMsg.style.display = "none";
        successMsg.style.display = "none";
        argsContainer.innerHTML = ""; // Clear previous args
        argsSection.style.display = "none";
        feeContainer.style.display = 'none'; // Hide fee
        document.getElementById('btn-adv-tx-send').disabled = true; // Disable send


        if (!contractName || !functionName) {
            return; // Do nothing if contract or function isn't selected
        }

        argsSection.style.display = "block"; // Show the args section container

        try {
            const functionsInfo = await getContractFunctions(contractName); // Fetch again or cache
            if (functionsInfo !== null) {
                const selectedFunctionInfo = functionsInfo.methods.find(func => func.name === functionName);
                if (selectedFunctionInfo && selectedFunctionInfo.arguments) {
                    if (selectedFunctionInfo.arguments.length === 0) {
                         argsContainer.innerHTML = "<p class='text-muted small'>This function takes no arguments.</p>";
                    } else {
                        selectedFunctionInfo.arguments.forEach((arg) => {
                            // Create label and input for each argument
                            const formGroup = document.createElement('div');
                            formGroup.className = 'form-group mb-2'; // Spacing between args

                            const label = document.createElement('label');
                            label.htmlFor = arg.name;
                            label.textContent = `${arg.name} (${arg.type})`;
                            label.className = 'form-label small'; // Smaller label

                            const input = document.createElement('input');
                            input.type = 'text'; // Use text for all, parsing happens on send
                            input.className = 'form-control form-control-sm'; // Smaller input
                            input.id = arg.name;
                            input.placeholder = `Enter value for ${arg.name}`;
                            // Add listener to estimate stamps when args change
                            input.addEventListener('input', debouncedEstimateSendStampsAdv);

                            formGroup.appendChild(label);
                            formGroup.appendChild(input);
                            argsContainer.appendChild(formGroup);
                        });
                    }
                    // After arguments are displayed (or if none), estimate stamps
                    await estimateSendStampsAdv();
                } else {
                     argsContainer.innerHTML = "<p class='text-danger small'>Could not find argument details for this function.</p>";
                }
            } else {
                 argsContainer.innerHTML = "<p class='text-danger small'>Could not load contract details.</p>";
            }
        } catch (error) {
            console.error('Error processing function selection:', error);
            errorMsg.innerHTML = `Error loading arguments: ${error.message}`;
            errorMsg.style.display = "block";
        }
    });
}


// --- Debounce Helper (Keep as is) ---
function debounce(func, delay) {
    let timeout;
    return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), delay);
    };
}

// Debounced version of the estimation function
const debouncedEstimateSendStampsAdv = debounce(estimateSendStampsAdv, 500); // Increased debounce slightly

// --- Estimate Stamps (Modified for HD & Async) ---
async function estimateSendStampsAdv() { // Renamed to avoid global conflicts, made async
    const errorMsg = document.getElementById('sendAdvTxError');
    const successMsg = document.getElementById('sendAdvTxSuccess');
    const estimation_loading = document.getElementById('estimation-loading');
    const estimation_finished = document.getElementById('estimation-result');
    const feeContainer = document.getElementById('tokenFeeContainer');
    const feeElement = document.getElementById('tokenFee');
    const feeXianElement = document.getElementById('tokenFeeXian');
    const send_btn = document.getElementById('btn-adv-tx-send');

    // Reset UI elements related to fee/status
    feeContainer.style.display = 'none';
    estimation_loading.style.display = 'inline-block';
    estimation_finished.style.display = 'none';
    send_btn.disabled = true; // Disable send button until estimation succeeds
    // Don't hide general error/success messages here, only fee-related ones if needed

    // Check lock state and basic inputs
    if (locked || !unencryptedMnemonic) {
        toast('warning', 'Wallet locked. Cannot estimate fees.');
        estimation_loading.style.display = 'none'; // Hide loader
        return;
    }
    const selectedAccount = getSelectedAccount();
    if (!selectedAccount) {
        toast('danger', 'No account selected.');
        estimation_loading.style.display = 'none';
        return;
    }

    const contractName = document.getElementById('contractName').value.trim();
    const functionName = document.getElementById('functionName').value;

    if (!contractName || !functionName) {
        estimation_loading.style.display = 'none';
        return; // Not enough info to estimate
    }


    // --- Build Kwargs for Estimation ---
    let kwargs = {};
    let functionInfo;
    let validationError = false;
    try {
        functionInfo = await getContractFunctions(contractName);
         if (!functionInfo || !functionInfo.methods) {
             throw new Error("Could not get contract methods.");
         }
        const selectedFunctionInfo = functionInfo.methods.find(func => func.name === functionName);
         if (!selectedFunctionInfo) {
              throw new Error("Selected function not found.");
         }

        // Try to parse all arguments for estimation, but don't block if some are empty/invalid yet
         for (const arg of selectedFunctionInfo.arguments) {
             const inputElement = document.getElementById(arg.name);
             if (!inputElement) continue; // Skip if element missing
             const valueStr = inputElement.value;
             try {
                 // Use the parser, but don't throw fatal error here, just skip bad args for estimation
                 kwargs[arg.name] = parseArgumentValue(valueStr, arg.type, arg.name);
             } catch (e) {
                 // console.warn(`Skipping arg ${arg.name} for estimation due to parse error: ${e.message}`);
                  validationError = true; // Mark that there was an issue
                  // Optionally provide feedback near the input field instead of global error
             }
         }
         // If validation failed for *any* argument, don't proceed with estimation yet
          if (validationError) {
               // toast('info', 'Please fill all arguments correctly to estimate fee.');
               estimation_loading.style.display = 'none'; // Hide loader
               return;
          }

    } catch (error) {
         console.error("Error preparing args for estimation:", error);
         estimation_loading.style.display = 'none';
         // Maybe show a subtle error near the contract/function selectors
         return;
    }
    // --- End Build Kwargs for Estimation ---


    // --- Create Transaction Payload for Estimation ---
    let transaction = {
        payload: {
            // chain_id, nonce, sender will be added by signTransaction
            contract: contractName,
            function: functionName,
            kwargs: kwargs,
            stamps_supplied: 200000 // High default for estimation
        },
        metadata: {
            signature: "", // Placeholder
        }
    };

    // --- Sign and Estimate ---
    try {
        // Sign first
        const signedTxForEstimation = await signTransaction(transaction, unencryptedMnemonic, selectedAccount.index);

        // Then estimate
        const stampResult = await estimateStamps(signedTxForEstimation); // Use global estimateStamps

        estimation_loading.style.display = 'none';
        feeContainer.style.display = 'block'; // Show fee container
        estimation_finished.style.display = 'inline-block'; // Show result part

        if (stampResult.stamps === null || stampResult.success === false) {
            feeElement.innerHTML = 'Error';
            feeXianElement.innerHTML = 'N/A';
             // Display the error from the estimation result if available
             errorMsg.innerHTML = `Transaction will likely fail: ${stampResult.tx_result || 'Estimation error'}`;
             errorMsg.style.display = 'block';
             send_btn.disabled = true; // Keep send disabled
        } else {
            const stamps = stampResult.stamps;
            const stamp_rate = await getStampRate();
            if (stamp_rate) {
                feeElement.innerHTML = stamps;
                feeXianElement.innerHTML = (stamps / stamp_rate).toFixed(8);
                send_btn.disabled = false; // Enable send button on successful estimation
                 errorMsg.style.display = 'none'; // Hide error message if estimation succeeds
            } else {
                feeElement.innerHTML = 'Error';
                feeXianElement.innerHTML = 'N/A';
                errorMsg.innerHTML = 'Could not retrieve stamp rate.';
                 errorMsg.style.display = 'block';
                send_btn.disabled = true;
            }
        }
    } catch (error) {
        console.error("Error during stamp estimation process:", error);
        estimation_loading.style.display = 'none';
        feeContainer.style.display = 'block'; // Show container even on error
        estimation_finished.style.display = 'inline-block';
        feeElement.innerHTML = 'Error';
        feeXianElement.innerHTML = 'N/A';
         errorMsg.innerHTML = `Fee estimation error: ${error.message}`;
         errorMsg.style.display = 'block';
        send_btn.disabled = true;
    }
}


// --- Initialize Page ---
document.getElementById('btn-adv-tx-send')?.addEventListener('click', sendAdvTx);
loadAdvancedTransactionPage(); // Run setup function

======================================================================
File: xian-web-wallet/templates/page_js/settings.js
======================================================================
// Assumes global vars: unencryptedMnemonic, locked, accounts, selectedAccountIndex, RPC, EXPLORER
// Assumes functions: readEncryptedSeed, decryptSeed, saveAccounts, saveSelectedAccountIndex,
//                    deriveKeyPairFromMnemonic, changePage, toast, readData, saveData, removeData, ping, getChainID
// Assumes bip39 library is loaded

var customRPCs = JSON.parse(localStorage.getItem('customRPCs')) || [];
var renameModalInstance = null; // To hold the Bootstrap Modal instance

// --- RPC Management (Largely unchanged, minor tweaks) ---

function saveSettings() {
    let settingsSuccess = document.getElementById('settingsSuccess');
    let settingsError = document.getElementById('settingsError');
    settingsSuccess.style.display = 'none';
    settingsError.style.display = 'none';

    let selectedOptionValue = document.getElementById('rpc_select').value;
    let [rpc, explorer] = selectedOptionValue.split(','); // Destructure assignment

    if (!rpc || !explorer) {
        settingsError.innerHTML = 'Invalid network selection.';
        settingsError.style.display = 'block';
        return;
    }

    // Validation (already present, keep it)
    if (!rpc.startsWith('http')) { /* ... */ return; }
    if (rpc.endsWith('/')) { /* ... */ return; }
    if (!explorer.startsWith('http')) { /* ... */ return; }
    if (explorer.endsWith('/')) { /* ... */ return; }

    // Save to localStorage (still okay for non-sensitive RPC/Explorer URLs)
    localStorage.setItem("explorer", explorer);
    localStorage.setItem("rpc", rpc);
    RPC = rpc; // Update global RPC
    EXPLORER = explorer; // Update global Explorer

    // Update Online Status Indicator
    let online_status_element = document.getElementById("onlineStatus");
    if (online_status_element) {
        online_status_element.innerHTML = `<div class='mt-1px'><div class='grey-circle' title='Checking Status...'></div></div> <div>${RPC.replace("https://", "").replace("http://", "")}</div>`; // Initial state
        ping().then(online_status => {
            const statusIndicator = online_status
                ? "<div class='mt-1px'><div class='online-circle' title='Node is Online'></div></div>"
                : "<div class='mt-1px'><div class='offline-circle' title='Node is Offline'></div></div>";
            online_status_element.innerHTML = `${statusIndicator} <div>${RPC.replace("https://", "").replace("http://", "")}</div>`;
        }).catch(error => {
            online_status_element.innerHTML = "<div class='mt-1px'><div class='offline-circle' title='Node is Offline'></div></div> <div>" + RPC.replace("https://", "").replace("http://", "") + "</div>";
        });
    }

    // Verify Chain ID after changing RPC
    getChainID().then(chain_id => { // This will update global CHAIN_ID
        if (chain_id === null) {
            settingsError.style.display = 'block';
            settingsError.innerHTML = 'Error getting chain ID from the new RPC. Please check the URL.';
        } else {
            settingsSuccess.style.display = 'block';
            settingsSuccess.innerHTML = 'Network changed successfully!';
            // Optionally reload parts of the UI that depend on Chain ID or RPC data
            // e.g., reload wallet page if balance/tokens might differ
            if (app_page === 'wallet') {
                 loadWalletPage(); // If wallet page has this function globally accessible
            } else {
                 // Maybe just refresh balances if possible without full page reload
            }
        }
    });
}

function addCustomRPC() {
    let settingsSuccess = document.getElementById('settingsSuccess');
    let settingsError = document.getElementById('settingsError');
    settingsSuccess.style.display = 'none';
    settingsError.style.display = 'none';
    let customrpc_input = document.getElementById('add_rpc_input');
    let explorer_input = document.getElementById('add_explorer_input');
    let rpc = customrpc_input.value.trim();
    let explorer = explorer_input.value.trim();

    // Validation... (keep existing validation)
    if (rpc === "" || explorer === "") { /* ... */ return; }
    if (!rpc.startsWith('http')) { /* ... */ return; }
    if (rpc.endsWith('/')) { /* ... */ return; }
    if (!explorer.startsWith('http')) { /* ... */ return; }
    if (explorer.endsWith('/')) { /* ... */ return; }

    // Check if RPC already exists
    const exists = [...customRPCs, ["https://node.xian.org","dummy"], ["https://testnet.xian.org","dummy"]] // Include defaults for check
                     .some(network => network[0] === rpc);
    if (exists) {
        settingsError.innerHTML = 'This RPC URL is already in the list.';
        settingsError.style.display = 'block';
        return;
    }

    customRPCs.push([rpc, explorer]);
    localStorage.setItem('customRPCs', JSON.stringify(customRPCs)); // Save updated list
    customrpc_input.value = '';
    explorer_input.value = '';

    // Add to dropdown and select it
    let rpc_select = document.getElementById('rpc_select');
    let option = document.createElement('option');
    // Extract a user-friendly name from the URL
    let networkName = rpc.replace("https://", "").replace("http://", "").split('.')[0] || 'Custom';
    option.text = `Custom - ${networkName}`;
    option.value = `${rpc},${explorer}`;
    rpc_select.add(option);
    rpc_select.value = option.value; // Select the newly added option

    saveSettings(); // Trigger save and status update
    toast('success', 'Custom network added.');
}

function removeCustomRPC() {
    let settingsSuccess = document.getElementById('settingsSuccess');
    let settingsError = document.getElementById('settingsError');
    settingsSuccess.style.display = 'none';
    settingsError.style.display = 'none';
    let rpc_select = document.getElementById('rpc_select');
    let selectedValue = rpc_select.value;
    let [rpcToRemove, explorerToRemove] = selectedValue.split(',');

    // Prevent removing default networks
    if (rpcToRemove === "https://node.xian.org" || rpcToRemove === "https://testnet.xian.org") {
        settingsError.innerHTML = 'Standard networks cannot be removed.';
        settingsError.style.display = 'block';
        return;
    }

    // Find and remove from customRPCs array
    let initialLength = customRPCs.length;
    customRPCs = customRPCs.filter(network => network[0] !== rpcToRemove);

    if (customRPCs.length === initialLength) {
        settingsError.innerHTML = 'Selected network not found in custom list.'; // Should not happen if defaults check passed
        settingsError.style.display = 'block';
        return;
    }

    localStorage.setItem('customRPCs', JSON.stringify(customRPCs)); // Save updated list

    // Remove from dropdown
    for (let i = 0; i < rpc_select.options.length; i++) {
        if (rpc_select.options[i].value === selectedValue) {
            rpc_select.remove(i);
            break;
        }
    }

    // Select the first option (Mainnet) as default after removal
    rpc_select.selectedIndex = 0;
    saveSettings(); // Trigger save and status update for Mainnet
    toast('info', 'Custom network removed.');
}


// --- View Recovery Phrase ---
function setupRecoveryPhraseView() {
    const viewLink = document.getElementById('view_recovery_phrase_link');
    const confirmationDiv = document.getElementById('recovery_phrase_confirmation');
    const passwordInput = document.getElementById('recovery_phrase_password');
    const confirmButton = document.getElementById('confirm_view_recovery_phrase');
    const cancelButton = document.getElementById('cancel_view_recovery_phrase');
    const displayArea = document.getElementById('recovery_phrase_display_area');
    const phraseTextSpan = document.getElementById('recovery_phrase_text');
    const hideButton = document.getElementById('hide_recovery_phrase');
    const settingsError = document.getElementById('settingsError');

    viewLink.addEventListener('click', (e) => {
        e.preventDefault();
        settingsError.style.display = 'none'; // Clear previous errors
        // Hide display area if it was somehow left open
        displayArea.style.display = 'none';
        phraseTextSpan.textContent = '';
        // Show confirmation section
        confirmationDiv.style.display = 'block';
        passwordInput.value = ''; // Clear password field
        passwordInput.focus();
    });

    cancelButton.addEventListener('click', () => {
        confirmationDiv.style.display = 'none';
        passwordInput.value = '';
    });

    hideButton.addEventListener('click', () => {
        displayArea.style.display = 'none';
        phraseTextSpan.textContent = '';
    });

    confirmButton.addEventListener('click', async () => {
        const password = passwordInput.value;
        if (!password) {
            settingsError.innerHTML = 'Password is required.';
            settingsError.style.display = 'block';
            return;
        }

        confirmButton.disabled = true;
        confirmButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
        settingsError.style.display = 'none';


        try {
            const storedEncryptedSeed = await readEncryptedSeed();
            if (!storedEncryptedSeed) {
                throw new Error("Encrypted seed not found.");
            }

            // Attempt decryption
            const decryptedMnemonic = decryptSeed(storedEncryptedSeed, password);

            if (decryptedMnemonic === null) {
                settingsError.innerHTML = 'Incorrect password.';
                settingsError.style.display = 'block';
                passwordInput.value = ''; // Clear password on failure
                passwordInput.focus();
            } else {
                // Success! Display the phrase
                phraseTextSpan.textContent = decryptedMnemonic;
                displayArea.style.display = 'block';
                confirmationDiv.style.display = 'none'; // Hide confirmation
                passwordInput.value = '';
            }
        } catch (error) {
            console.error("Error viewing recovery phrase:", error);
            settingsError.innerHTML = 'Failed to retrieve recovery phrase. ' + error.message;
            settingsError.style.display = 'block';
        } finally {
            // Re-enable button
            confirmButton.disabled = false;
            confirmButton.innerHTML = 'Confirm';
        }
    });
}

// --- Account Management ---

async function loadAccountsList() {
    const listContainer = document.getElementById('account-list-settings');
    const loadingIndicator = document.getElementById('accounts-loading');

    if (!listContainer) return;

    // Show loading indicator
    loadingIndicator.style.display = 'block';
    // Clear previous list items except loading indicator
    listContainer.querySelectorAll('.list-group-item:not(#accounts-loading)').forEach(item => item.remove());

    try {
        accounts = await readAccounts(); // Refresh global accounts from storage
        selectedAccountIndex = await readSelectedAccountIndex(); // Refresh selected index

        if (accounts.length === 0) {
             listContainer.innerHTML = '<div class="list-group-item text-muted">No accounts found. Create one!</div>'; // Handle empty state
             return;
        }

        loadingIndicator.style.display = 'none'; // Hide loading

        accounts.sort((a, b) => a.index - b.index); // Ensure accounts are sorted by index

        accounts.forEach(account => {
            const item = document.createElement('div');
            item.className = 'list-group-item d-flex justify-content-between align-items-center';
            if (account.index === selectedAccountIndex) {
                item.classList.add('active'); // Highlight selected account
            }

            const nameAndAddressDiv = document.createElement('div');
            nameAndAddressDiv.style.overflow = 'hidden'; // Prevent long names/addresses from breaking layout

            const nameSpan = document.createElement('span');
            nameSpan.textContent = account.name || `Account ${account.index + 1}`; // Display name or default
            nameSpan.className = 'fw-bold'; // Make name bold

            const addressSpan = document.createElement('span');
            addressSpan.textContent = `${account.vk.substring(0, 6)}...${account.vk.substring(account.vk.length - 4)}`; // Truncated address
            addressSpan.className = 'text-muted small ms-2'; // Styling for address
            addressSpan.title = account.vk; // Show full address on hover

            nameAndAddressDiv.appendChild(nameSpan);
            nameAndAddressDiv.appendChild(addressSpan);

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'btn-group btn-group-sm'; // Group buttons

            const renameButton = document.createElement('button');
            renameButton.className = 'btn btn-sm btn-outline-secondary';
            renameButton.innerHTML = '<i class="fas fa-pencil-alt"></i>';
            renameButton.title = 'Rename Account';
            renameButton.addEventListener('click', () => openRenameModal(account.index, account.name));

            const switchButton = document.createElement('button');
            switchButton.className = 'btn btn-sm btn-outline-primary';
            switchButton.innerHTML = '<i class="fas fa-sign-in-alt"></i>';
            switchButton.title = 'Switch to this Account';
             if (account.index === selectedAccountIndex) {
                 switchButton.disabled = true; // Disable switch for already selected account
             }
            switchButton.addEventListener('click', async () => {
                await saveSelectedAccountIndex(account.index);
                selectedAccountIndex = account.index; // Update global state
                toast('info', `Switched to account ${account.name || `Account ${account.index + 1}`}`);
                loadAccountsList(); // Refresh list highlighting
                 // Optionally reload main wallet view: changePage('wallet');
            });

            actionsDiv.appendChild(renameButton);
            actionsDiv.appendChild(switchButton);

            item.appendChild(nameAndAddressDiv);
            item.appendChild(actionsDiv);

            listContainer.appendChild(item);
        });

    } catch (error) {
        console.error("Error loading accounts list:", error);
        loadingIndicator.textContent = 'Error loading accounts.';
        toast('danger', 'Failed to load accounts.');
    }
}


async function createNewAccountSettings() {
    const createButton = document.getElementById('setting-create-account-btn');
    const settingsWarning = document.getElementById('settingsWarning');
    settingsWarning.style.display = 'none'; // Hide warning

    // Check if wallet is unlocked by checking for the unencryptedMnemonic
    if (locked || !window.unencryptedMnemonic) {
        settingsWarning.innerHTML = 'Please unlock your wallet to create a new account.';
        settingsWarning.style.display = 'block';
        // Optionally redirect to unlock page:
        // changePage('password-input');
        return;
    }

    createButton.disabled = true;
    createButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';

    try {
        // Determine the next index
        const nextIndex = accounts.length > 0 ? Math.max(...accounts.map(a => a.index)) + 1 : 0;

        // Derive the key pair for the new index
        const newKeyPair = deriveKeyPairFromMnemonic(window.unencryptedMnemonic, nextIndex); // Use global mnemonic

        const newAccount = {
            index: nextIndex,
            vk: toHexString(newKeyPair.vk),
            name: `Account ${nextIndex + 1}` // Default name
        };

        // Add to global accounts array and save
        accounts.push(newAccount);
        await saveAccounts(accounts);

        toast('success', `Account "${newAccount.name}" created.`);
        loadAccountsList(); // Refresh the list in settings

    } catch (error) {
        console.error("Error creating new account:", error);
        toast('danger', 'Failed to create new account: ' + error.message);
    } finally {
        createButton.disabled = false;
        createButton.innerHTML = '<i class="fas fa-plus"></i> Create New Account';
    }
}

function openRenameModal(index, currentName) {
     // Initialize modal if it hasn't been already
     if (!renameModalInstance) {
        const modalElement = document.getElementById('renameAccountModal');
         if (modalElement) {
            renameModalInstance = new bootstrap.Modal(modalElement);
         } else {
             console.error("Rename modal element not found");
             return;
         }
     }

    document.getElementById('renameAccountIndex').value = index;
    document.getElementById('renameAccountName').value = currentName || `Account ${index + 1}`;
    renameModalInstance.show();
    // Focus the input field when modal is shown
     document.getElementById('renameAccountModal').addEventListener('shown.bs.modal', function () {
        document.getElementById('renameAccountName').focus();
        document.getElementById('renameAccountName').select();
    }, { once: true }); // Use 'once' to avoid attaching multiple listeners
}

async function saveNewAccountName() {
    const indexToRename = parseInt(document.getElementById('renameAccountIndex').value, 10);
    const newName = document.getElementById('renameAccountName').value.trim();

    if (isNaN(indexToRename)) {
        toast('danger', 'Invalid account index for rename.');
        return;
    }
    if (!newName) {
        toast('warning', 'Account name cannot be empty.');
        return;
    }
     if (newName.length > 32) { // Add a reasonable length limit
         toast('warning', 'Account name is too long (max 32 characters).');
         return;
     }


    try {
        // Find the account and update its name
        const accountIndexInArray = accounts.findIndex(acc => acc.index === indexToRename);
        if (accountIndexInArray === -1) {
            throw new Error("Account to rename not found in the list.");
        }

        accounts[accountIndexInArray].name = newName;

        // Save the updated accounts array
        await saveAccounts(accounts);

        toast('success', 'Account renamed successfully.');
        renameModalInstance.hide(); // Close the modal
        loadAccountsList(); // Refresh the list to show the new name

         // Also update the name in the main wallet header if it was the selected account
         if (indexToRename === selectedAccountIndex && typeof updateSelectedAccountDisplay === 'function') {
            updateSelectedAccountDisplay(); // Assumes a function exists to update header/wallet view name
         }


    } catch (error) {
        console.error("Error renaming account:", error);
        toast('danger', 'Failed to rename account: ' + error.message);
    }
}


// --- Remove Wallet (HD Version) ---
async function removeWalletHD() { // Renamed to avoid conflict if old one is kept temporarily
    let confirm_delete = confirm("Are you sure you want to remove the wallet from this browser? This action will erase your encrypted recovery phrase and all derived accounts from this device. It cannot be undone without your original recovery phrase.");
    if (!confirm_delete) {
        return;
    }

    try {
        // Remove all HD wallet related data using async functions
        await removeEncryptedSeed();
        await removeAccounts();
        await removeSelectedAccountIndex();
        // Clear transaction history (kept in localStorage for now)
        localStorage.removeItem('tx_history');

        // Reset global state variables immediately
        window.unencryptedMnemonic = null;
        window.encryptedSeed = null;
        window.accounts = [];
        window.selectedAccountIndex = 0;
        window.locked = true;
        window.tx_history = [];

        toast('success', 'Wallet removed successfully.');
        changePage('get-started'); // Navigate to the initial setup page

    } catch (error) {
        console.error("Error removing wallet:", error);
        toast('danger', 'Failed to remove all wallet data.');
        // Still attempt to navigate away even if removal failed partially
        changePage('get-started');
    }
}

// --- Version Loading (Unchanged) ---
function readTextFile(file) {
    try {
        var rawFile = new XMLHttpRequest();
        var allText = null;
        rawFile.open("GET", file, false); // Synchronous request
        rawFile.onreadystatechange = function () {
            if (rawFile.readyState === 4) {
                if (rawFile.status === 200 || rawFile.status == 0) { // Allow 0 for local file access
                    allText = rawFile.responseText;
                } else {
                    console.error("Error reading file " + file + ": Status " + rawFile.status);
                }
            }
        }
        rawFile.send(null);
        return allText;
    } catch (e) {
        console.error("Exception reading file " + file + ":", e);
        return null; // Return null on error
    }
}

function loadWalletVersion() {
     const versionElement = document.getElementById('version');
     if (!versionElement) return;

     if (runningAsExtension()) {
         // Get version from extension manifest
         try {
             const manifest = chrome.runtime.getManifest();
             versionElement.innerHTML = manifest.version || 'N/A';
         } catch (e) {
             console.error("Could not get extension manifest:", e);
             versionElement.innerHTML = 'Error';
         }
     } else {
         // Attempt to fetch manifest.json (might fail due to CORS or path issues in web context)
         // Best practice for web would be to embed version during build process
         fetch('manifest.json') // Adjust path if needed
             .then(response => {
                 if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                 return response.json();
             })
             .then(manifest => {
                 versionElement.innerHTML = manifest.version || 'N/A';
             })
             .catch(error => {
                 console.warn("Could not fetch manifest.json for version:", error);
                 versionElement.innerHTML = 'N/A'; // Fallback for web
             });
     }
}


// --- Initial Load and Event Listeners ---
function loadSettingsPage() {
    // Load custom RPCs into dropdown
    let rpc_select = document.getElementById('rpc_select');
    // Clear existing custom options before adding new ones
    rpc_select.querySelectorAll('option').forEach(opt => {
         if (!opt.value.includes("node.xian.org") && !opt.value.includes("testnet.xian.org")) {
             opt.remove();
         }
     });
    if (customRPCs.length > 0) {
        customRPCs.forEach(rpcData => {
            let option = document.createElement('option');
            let networkName = rpcData[0].replace("https://", "").replace("http://", "").split('.')[0] || 'Custom';
            option.text = `Custom - ${networkName}`; // Display format
            option.value = `${rpcData[0]},${rpcData[1]}`;
            rpc_select.add(option);
        });
    }

    // Set selected RPC option
    const currentRPCValue = `${RPC},${EXPLORER}`;
    if ([...rpc_select.options].some(opt => opt.value === currentRPCValue)) {
         rpc_select.value = currentRPCValue;
    } else {
        // If current RPC isn't in list (e.g., removed custom), default to Mainnet
         console.warn("Current RPC not found in options, defaulting to Mainnet.");
         rpc_select.selectedIndex = 0; // Select Mainnet
         saveSettings(); // Update storage and global state
    }


    loadWalletVersion(); // Load and display wallet version
    setupRecoveryPhraseView(); // Set up listeners for recovery phrase section
    loadAccountsList(); // Load and display accounts

    // Initialize rename modal instance (if not already done)
     if (!renameModalInstance) {
        const modalElement = document.getElementById('renameAccountModal');
         if (modalElement) {
            renameModalInstance = new bootstrap.Modal(modalElement);
         }
     }
}

// Attach event listeners
document.getElementById('rpc_select')?.addEventListener('change', saveSettings);
document.getElementById('add_rpc_button')?.addEventListener('click', addCustomRPC);
document.getElementById('remove_rpc_button')?.addEventListener('click', removeCustomRPC);
document.getElementById('remove_wallet_export')?.addEventListener('click', removeWalletHD);
document.getElementById('setting-create-account-btn')?.addEventListener('click', createNewAccountSettings);
document.getElementById('saveAccountNameBtn')?.addEventListener('click', saveNewAccountName);


// Initial load
loadSettingsPage();

======================================================================
File: xian-web-wallet/templates/page_js/send-token.js
======================================================================
// Assumes global vars: selectedAccountIndex, unencryptedMnemonic, locked, accounts, CHAIN_ID, EXPLORER, RPC
// Assumes functions: getSelectedAccount, execute_balance_of, signTransaction, estimateStamps, broadcastTransaction,
//                    prependToTransactionHistory, changePage, toast, readSecureCookie (if still used anywhere, though likely not needed here),
//                    getTokenInfo, getStampRate, execute_get_main_name_to_address

async function sendToken() { // Made async
    // Check if wallet is locked
    if (locked || !unencryptedMnemonic) {
        toast('warning', 'Wallet is locked. Please unlock to send tokens.');
        // Optionally redirect to unlock page or just return
        // changePage('password-input');
        return;
    }

    const selectedAccount = getSelectedAccount(); // Get { index, vk, name }
    if (!selectedAccount) {
        toast('danger', 'Error: No account selected or found.');
        return; // Should not happen if unlocked, but good practice
    }

    const contract = document.getElementById('tokenName').innerHTML; // Contract being sent
    let recipient = document.getElementById('toAddress').value.trim();
    const amountInput = document.getElementById('tokenAmount').value;
    const successMsg = document.getElementById('sendTokenSuccess');
    const errorMsg = document.getElementById('sendTokenError');
    const sendButton = document.getElementById('send-token-send-token');
    const xnsFoundAddressSpan = document.getElementById('xnsFoundAddress');

    successMsg.style.display = 'none';
    errorMsg.style.display = 'none';

    // --- Recipient Resolution (XNS) ---
    let finalRecipient = recipient;
    if (xnsFoundAddressSpan.textContent && xnsFoundAddressSpan.textContent !== '') {
        finalRecipient = xnsFoundAddressSpan.textContent; // Use resolved address if available
        console.log(`Using resolved XNS address: ${finalRecipient} for ${recipient}`);
    }
    recipient = finalRecipient; // Use the resolved or original input

    // --- Validation ---
    if (!recipient || recipient.length !== 64 || !/^[0-9a-fA-F]+$/.test(recipient)) {
        errorMsg.innerHTML = 'Invalid recipient address format (must be 64 hex characters).';
        errorMsg.style.display = 'block';
        return;
    }
    if (recipient === selectedAccount.vk) {
         errorMsg.innerHTML = 'Cannot send tokens to yourself.';
         errorMsg.style.display = 'block';
         return;
    }

    // Validate amount
    if (amountInput.includes(',')) {
        errorMsg.innerHTML = 'Commas are not allowed in amount. Use a dot (.) for decimals.';
        errorMsg.style.display = 'block';
        return;
    }
    let amount;
    try {
        amount = parseFloat(amountInput); // Use parseFloat for decimals
         if (isNaN(amount) || amount <= 0) {
             throw new Error("Invalid amount");
         }
    } catch (e) {
        errorMsg.innerHTML = 'Invalid token amount. Please enter a positive number.';
        errorMsg.style.display = 'block';
        return;
    }
    // --- End Validation ---


    // --- Fee and Balance Check ---
    let stampsRequired;
    try {
         // Rely on estimateSendStamps to have calculated the fee and stored it
         stampsRequired = parseInt(document.getElementById('tokenFee').innerHTML, 10);
         if (isNaN(stampsRequired)) {
             toast('warning', 'Transaction fee not estimated. Please wait or try again.');
             await estimateSendStamps_(); // Try estimating again
             stampsRequired = parseInt(document.getElementById('tokenFee').innerHTML, 10); // Read again
             if (isNaN(stampsRequired)) {
                throw new Error("Fee estimation failed.");
             }
         }
    } catch (e) {
         errorMsg.innerHTML = 'Could not determine transaction fee. ' + e.message;
         errorMsg.style.display = 'block';
         return;
    }

     try {
        const balanceStr = await execute_balance_of(contract, selectedAccount.vk);
        const balance = parseFloat(balanceStr);

        if (isNaN(balance)) {
            throw new Error("Could not retrieve valid balance.");
        }

        if (amount > balance) {
            errorMsg.innerHTML = 'Insufficient balance.';
            errorMsg.style.display = 'block';
            return;
        }

         // Check if sufficient native currency (Xian) is available for fees
         if (contract !== 'currency') { // Only check if sending a token, not Xian itself
            const nativeBalanceStr = await execute_balance_of('currency', selectedAccount.vk);
            const nativeBalance = parseFloat(nativeBalanceStr);
            const stampRate = await getStampRate();
            if (isNaN(nativeBalance) || !stampRate || (stampsRequired / stampRate) > nativeBalance) {
                 errorMsg.innerHTML = `Insufficient XIAN balance to pay the transaction fee (${(stampsRequired / stampRate).toFixed(4)} Xian needed).`;
                 errorMsg.style.display = 'block';
                 return;
            }
         } else { // If sending Xian, check if balance covers amount + fee
              const stampRate = await getStampRate();
              if (!stampRate) throw new Error("Could not get stamp rate for fee calculation.");
              const feeInXian = stampsRequired / stampRate;
              if (amount + feeInXian > balance) {
                   errorMsg.innerHTML = `Insufficient balance to send ${amount} Xian and pay the ${feeInXian.toFixed(4)} Xian fee.`;
                   errorMsg.style.display = 'block';
                   return;
              }
         }


    } catch (e) {
         console.error("Error checking balance or fee:", e);
         errorMsg.innerHTML = 'Error checking balance or fee: ' + e.message;
         errorMsg.style.display = 'block';
         return;
    }
    // --- End Fee and Balance Check ---

    // Disable button
    sendButton.disabled = true;
    sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

    // --- Transaction Creation and Signing ---
    let transaction = {
        payload: {
            chain_id: CHAIN_ID,
            contract: contract,
            function: "transfer",
            kwargs: {
                to: recipient,
                amount: amount // Use the parsed float amount
            },
            stamps_supplied: stampsRequired // Use the estimated stamps
        },
        metadata: {
            signature: "", // Will be added by signTransaction
        }
    };

    try {
        // Sign using the selected account's derived key and mnemonic
        const signedTx = await signTransaction(transaction, unencryptedMnemonic, selectedAccount.index);

        // Optional: Confirmation dialog
        let conf = confirm(`Send ${amount} ${contract === 'currency' ? 'Xian' : contract} to ${recipient.substring(0, 6)}...? Fee: ~${(stampsRequired / await getStampRate()).toFixed(4)} Xian`);
        if (!conf) {
            sendButton.disabled = false;
            sendButton.innerHTML = 'Send Token';
            return;
        }

        // Broadcast the signed transaction
        const response = await broadcastTransaction(signedTx); // Pass the signed object

        // --- Handle Broadcast Response ---
        if (response.error === 'timeout') {
            // Handle timeout specifically (already toasted in broadcastTransaction)
             successMsg.innerHTML = 'Transaction broadcast timed out. It might still succeed. Check Explorer: <a class="explorer-url" href="' + EXPLORER + '/transactions" target="_blank">Recent Transactions</a>'; // Provide general link
             successMsg.style.display = 'block';
             // Consider adding to history as pending or unknown status
              prependToTransactionHistory("TIMEOUT", contract, 'transfer', { to: recipient, amount: amount }, 'pending', new Date().toLocaleString());

        } else if (response && response.result && response.result.hash) {
            const hash = response.result.hash;
            let status = 'pending'; // Assume pending initially
            let logMessage = response.result.log || "";

            if (response.result.code !== 0) { // Check Tendermint result code
                status = 'error';
                errorMsg.innerHTML = `Transaction failed: ${logMessage}`;
                errorMsg.style.display = 'block';
                 toast('danger', `Transaction failed: ${logMessage}`);
            } else {
                // Tendermint code 0 doesn't guarantee success yet, mark as pending
                 successMsg.innerHTML = 'Transaction sent successfully! Hash: <a class="explorer-url" href="' + EXPLORER + '/tx/' + hash + '" target="_blank">' + hash + '</a>';
                 successMsg.style.display = 'block';
                 toast('success', `Transaction sent: ${hash.substring(0,10)}...`);
                 // Clear inputs on success
                 document.getElementById('toAddress').value = '';
                 document.getElementById('tokenAmount').value = '';
                 document.querySelector('.xns-found').style.display = 'none';
                 document.getElementById('xnsFoundAddress').innerHTML = '';
                 document.getElementById('tokenFeeContainer').style.display = 'none'; // Hide fee
            }
            // Add to local history
            prependToTransactionHistory(hash, contract, 'transfer', { to: recipient, amount: amount }, status, new Date().toLocaleString());

        } else {
            // Handle unexpected response structure
            console.error("Unexpected broadcast response:", response);
            throw new Error('Unexpected response from network.');
        }
        // --- End Handle Broadcast Response ---

    } catch (error) {
        console.error("Error sending token:", error);
        errorMsg.innerHTML = `Error sending transaction: ${error.message}`;
        errorMsg.style.display = 'block';
         toast('danger', `Error: ${error.message}`);
    } finally {
        // Re-enable button
        sendButton.disabled = false;
        sendButton.innerHTML = 'Send Token';
    }
}

// --- Debounce Helper (Keep as is) ---
function debounce(func, delay) {
    let timeout;
    return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), delay);
    };
}

// --- Estimate Stamps (Modified for HD) ---
async function estimateSendStamps_() { // Renamed to avoid conflict with global estimateStamps if it exists elsewhere
    const recipientInput = document.getElementById('toAddress').value.trim();
    const amountInput = document.getElementById('tokenAmount').value;
    const contract = document.getElementById('tokenName').innerHTML;
    const send_btn = document.getElementById('send-token-send-token');
    const estimation_loading = document.getElementById('estimation-loading');
    const estimation_finished = document.getElementById('estimation-result');
    const feeContainer = document.getElementById('tokenFeeContainer');
    const feeElement = document.getElementById('tokenFee');
    const feeXianElement = document.getElementById('tokenFeeXian');
    const errorMsg = document.getElementById('sendTokenError');

    // Hide previous errors related to estimation
    errorMsg.style.display = 'none';


    // Early exit if inputs are invalid or wallet locked
    if (locked || !unencryptedMnemonic || recipientInput === '' || amountInput === '' || isNaN(parseFloat(amountInput))) {
        feeContainer.style.display = 'none';
        send_btn.disabled = true; // Keep disabled if inputs invalid
        return;
    }

    const selectedAccount = getSelectedAccount();
    if (!selectedAccount) {
        feeContainer.style.display = 'none';
        send_btn.disabled = true;
        return;
    }

    // Show loading, disable button
    estimation_loading.style.display = 'inline-block';
    estimation_finished.style.display = 'none';
    feeContainer.style.display = 'block'; // Show container while loading
    send_btn.disabled = true;

     // Resolve XNS name if needed
     let recipient = recipientInput;
     const xnsFoundAddressSpan = document.getElementById('xnsFoundAddress');
     if (xnsFoundAddressSpan.textContent && xnsFoundAddressSpan.textContent !== '') {
         recipient = xnsFoundAddressSpan.textContent;
     }


    let amount;
     try {
         amount = parseFloat(amountInput);
         if (isNaN(amount) || amount <= 0) throw new Error();
     } catch {
         // Handled by early exit, but keep for safety
         estimation_loading.style.display = 'none';
         feeContainer.style.display = 'none';
         return;
     }

     // Check recipient format *before* signing for estimation
     if (!recipient || recipient.length !== 64 || !/^[0-9a-fA-F]+$/.test(recipient)) {
         estimation_loading.style.display = 'none';
         feeElement.innerHTML = "Invalid Address";
         estimation_finished.style.display = 'inline-block';
         feeContainer.style.display = 'block';
         // Don't enable send button
         return;
     }


    let transaction = {
        payload: {
            // Fields needed for signing, will be filled by signTransaction
            // chain_id, nonce, sender filled by signTransaction
            contract: contract,
            function: "transfer",
            kwargs: {
                to: recipient,
                amount: amount // Use parsed amount
            },
            stamps_supplied: 200000 // High value for estimation
        },
        metadata: {
            signature: "",
        }
    };

    try {
        // Sign the transaction *before* estimating stamps
        const signedTxForEstimation = await signTransaction(transaction, unencryptedMnemonic, selectedAccount.index);

        // Estimate stamps using the signed transaction
        const stampResult = await estimateStamps(signedTxForEstimation);

        estimation_loading.style.display = 'none';
        estimation_finished.style.display = 'inline-block'; // Show result area

        if (stampResult.stamps === null) {
             feeElement.innerHTML = 'Error';
             feeXianElement.innerHTML = 'N/A';
             errorMsg.innerHTML = `Fee estimation failed: ${stampResult.tx_result || 'Unknown error'}`;
             errorMsg.style.display = 'block';
        } else {
            const stamps = stampResult.stamps;
            const stamp_rate = await getStampRate();
            if (stamp_rate) {
                feeElement.innerHTML = stamps;
                feeXianElement.innerHTML = (stamps / stamp_rate).toFixed(8); // Show more precision
                send_btn.disabled = false; // Enable send only if estimation is successful
            } else {
                 feeElement.innerHTML = 'Error';
                 feeXianElement.innerHTML = 'N/A';
                 errorMsg.innerHTML = 'Could not retrieve stamp rate.';
                 errorMsg.style.display = 'block';
            }
        }
    } catch (error) {
        console.error("Error estimating stamps:", error);
        estimation_loading.style.display = 'none';
        estimation_finished.style.display = 'inline-block';
        feeElement.innerHTML = 'Error';
        feeXianElement.innerHTML = 'N/A';
         errorMsg.innerHTML = `Fee estimation error: ${error.message}`;
         errorMsg.style.display = 'block';
    }
}

// --- XNS Address Resolution (Unchanged, but ensure it's called correctly) ---
async function getXNSAddress(){
    let name = document.getElementById('toAddress').value.trim();
    let xns_found_div = document.querySelector('.xns-found');
    let xns_address_span = document.getElementById('xnsFoundAddress');

    xns_address_span.innerHTML = ''; // Clear previous result
    xns_found_div.style.display = 'none'; // Hide indicator

    // Basic validation for potential XNS names
    if (name === '' || name.length < 3 || name.length > 64 || !/^[a-zA-Z0-9_.-]+$/.test(name) || /^[0-9a-fA-F]{64}$/.test(name)) {
         // If it's empty, too short/long, contains invalid chars, or looks like a VK, don't query
        return;
    }

    try {
        // Show loading state? Optional.
        let address = await execute_get_main_name_to_address(name); // Assuming this function exists and works

        if (address !== "None" && address !== null) {
            xns_found_div.style.display = 'block'; // Show indicator
            xns_address_span.innerHTML = address; // Display resolved address (hidden)
             // Trigger stamp estimation again now that address is resolved
             debouncedEstimateSendStamps_();
        } else {
            // Name not found or error occurred in execute_get_main_name_to_address
        }
    } catch (error) {
        console.error(`Error resolving XNS name ${name}:`, error);
        // Don't show error to user unless necessary, just means name wasn't found
    }
}

// --- Page Load Logic ---
async function loadPage() {
    const tokenContractName = document.getElementById('tokenName').innerHTML;
    const selectedAccount = getSelectedAccount();

    if (!selectedAccount) {
        changePage('password-input'); // Redirect if locked or no account
        return;
    }

    // Fetch token info (name)
    try {
        const tokenInfo = await getTokenInfo(tokenContractName); // Assuming getTokenInfo is async
        document.getElementById('realTokenName').innerHTML = tokenInfo.name || tokenContractName; // Show contract if name fails
        document.getElementById('realTokenName').style.display = 'inline-block';
    } catch (error) {
        console.error("Failed to load token name:", error);
        document.getElementById('realTokenName').innerHTML = tokenContractName; // Fallback
        document.getElementById('realTokenName').style.display = 'inline-block';
    }

    // Fetch and display balance for the selected account
    try {
        const tokenBalance = await execute_balance_of(tokenContractName, selectedAccount.vk);
        let formattedBalance = "0.00000000"; // Default
        if (tokenBalance !== null && !isNaN(parseFloat(tokenBalance))) {
            formattedBalance = parseFloat(tokenBalance).toFixed(8); // Ensure 8 decimals
        }
        const maxAmountSpan = document.getElementById('maxTokenAmount');
        maxAmountSpan.innerHTML = formattedBalance;
        maxAmountSpan.style.display = 'inline-block';

        // Update click listener for max amount
        maxAmountSpan.removeEventListener('click', handleMaxAmountClick); // Remove old listener first
        maxAmountSpan.addEventListener('click', handleMaxAmountClick); // Add new one

    } catch (error) {
        console.error("Failed to load balance:", error);
        document.getElementById('maxTokenAmount').innerHTML = 'Error';
        document.getElementById('maxTokenAmount').style.display = 'inline-block';
    }
}

// Handler for clicking max amount (needs access to formattedBalance)
async function handleMaxAmountClick() {
    const maxAmountSpan = document.getElementById('maxTokenAmount');
    const amountInput = document.getElementById('tokenAmount');
    const formattedBalance = maxAmountSpan.textContent; // Get balance from span

    // Basic check if balance is valid before setting
    if (formattedBalance && formattedBalance !== 'Error' && !isNaN(parseFloat(formattedBalance))) {
        let maxSendable = parseFloat(formattedBalance);

        // If sending native currency, subtract estimated fee
        if (document.getElementById('tokenName').innerHTML === 'currency') {
            try {
                 // Ensure fee is estimated first
                 await estimateSendStamps_();
                 const feeXianElement = document.getElementById('tokenFeeXian');
                 if (feeXianElement && feeXianElement.textContent) {
                      const feeInXian = parseFloat(feeXianElement.textContent);
                      if (!isNaN(feeInXian) && maxSendable >= feeInXian) {
                           maxSendable -= feeInXian;
                           // Ensure it doesn't go below zero
                           maxSendable = Math.max(0, maxSendable);
                      }
                 }
            } catch (e) { console.error("Could not adjust max amount for fee:", e); }
        }
        // Set input value, possibly formatting to fewer decimals for display clarity
        amountInput.value = maxSendable.toFixed(8); // Use toFixed(8) to prevent scientific notation for small numbers
        // Trigger estimation again after setting amount
        await estimateSendStamps_();
    } else {
        amountInput.value = '0'; // Set to 0 if balance is invalid/error
    }
}

// --- Attach Event Listeners ---
document.getElementById('send-token-send-token')?.addEventListener('click', sendToken);
document.getElementById('send-token-cancel')?.addEventListener('click', () => changePage('wallet'));

// Debounced estimation listener
const debouncedEstimateSendStamps_ = debounce(estimateSendStamps_, 500);
document.getElementById('toAddress')?.addEventListener('input', () => {
    getXNSAddress(); // Resolve XNS on input change
    debouncedEstimateSendStamps_(); // Estimate fee after potential XNS resolution delay
});
document.getElementById('tokenAmount')?.addEventListener('input', debouncedEstimateSendStamps_);

// Initial page load execution
(async () => {
    await loadPage();
    // Optionally run initial stamp estimation if fields might be pre-filled
    // await estimateSendStamps_();
})();

======================================================================
File: xian-web-wallet/templates/page_js/add-to-token-list.js
======================================================================
function addToken() {
  let successMsg = document.getElementById("addTokenSuccess");
  let errorMsg = document.getElementById("addTokenError");
  let btnAddToken = document.getElementById("btn-add-token-add");
  document.getElementById("addTokenSuccess").style.display = "none";
  document.getElementById("addTokenError").style.display = "none";
  let contractNameAddToken = document.getElementById("contractNameAddToken").value;

  // only allow alphanumeric characters and underscores
  if (!/^[a-zA-Z0-9_]*$/.test(contractNameAddToken)) {
      errorMsg.style.display = "block";
      errorMsg.innerHTML = "Invalid contract name!";
      return;
  }

  btnAddToken.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Adding Token";


  getTokenInfo(contractNameAddToken)
      .then(token_info => {
          if (token_info.name === "\x9Eée" || token_info.symbol === "\x9Eée") {
              errorMsg.style.display = "block";
              errorMsg.innerHTML = "Token does not exist!";
              btnAddToken.innerHTML = "Add Token";
              return;
          }
          if(token_info.name === undefined || token_info.symbol === undefined){
              errorMsg.style.display = "block";
              errorMsg.innerHTML = "Error retrieving token info!";
              btnAddToken.innerHTML = "Add Token";
              return;
          }

          if (!token_list.includes(contractNameAddToken)) {
              token_list.push(contractNameAddToken);
              localStorage.setItem("token_list", JSON.stringify(token_list));
              successMsg.style.display = "block";
              successMsg.innerHTML = "Token added successfully!";
              btnAddToken.innerHTML = "Add Token";
          } else {
              errorMsg.style.display = "block";
              errorMsg.innerHTML = "Token already exists!";
              btnAddToken.innerHTML = "Add Token";
          }
      })
      .catch(error => {
          errorMsg.style.display = "block";
          errorMsg.innerHTML = "Error retrieving token info: " + error.message;
          btnAddToken.innerHTML = "Add Token";
      });
}
  
document.getElementById('btn-add-token-add').addEventListener('click', function() {
    addToken();
});
document.getElementById('btn-add-token-cancel').addEventListener('click', function() {
    goToWallet();
});

======================================================================
File: xian-web-wallet/templates/page_js/ide.js
======================================================================
// Assumes global vars: code_storage, current_tab, deployment_started (needs proper scoping if not global),
//                    editor, pyodide (from pyodide-linting.js), RPC, EXPLORER, CHAIN_ID,
//                    locked, unencryptedMnemonic, selectedAccountIndex, accounts, tx_history
// Assumes functions: saveCode, addTab, removeTab, changeTab, refreshTabList, showDropdown,
//                    getContractCode, getContractFunctions, getStampRate, signTransaction,
//                    broadcastTransaction, prependToTransactionHistory, changePage, toast,
//                    getSelectedAccount, execute_balance_of (needs to be available)

var code_storage = JSON.parse(localStorage.getItem('code_storage')) || { "contract.py": "@construct\ndef seed():\n    pass\n\n@export\ndef test():\n    return 'Hello, World!'" }; // Default with .py extension
var current_tab = Object.keys(code_storage)[0];
// Scope deployment_started properly if it's meant to be per-tab state persisted across sessions
var deployment_started = JSON.parse(sessionStorage.getItem('deployment_started')) || {}; // Use sessionStorage for temporary state


function saveCode() {
    if (editor && current_tab && !current_tab.endsWith('(Read-Only)')) { // Only save writable tabs
        code_storage[current_tab] = editor.getValue();
        localStorage.setItem('code_storage', JSON.stringify(code_storage));
    }
}

function saveDeploymentState() {
    sessionStorage.setItem('deployment_started', JSON.stringify(deployment_started));
}


function addTab(tab_name, code = '') {
    // Basic validation for tab name
    if (!tab_name || typeof tab_name !== 'string' || tab_name.trim().length === 0) {
        console.error("Invalid tab name provided.");
        return;
    }
    // Prevent adding duplicate names
     if (code_storage.hasOwnProperty(tab_name)) {
         console.warn(`Tab "${tab_name}" already exists.`);
         return;
     }
    code_storage[tab_name] = code;
    localStorage.setItem('code_storage', JSON.stringify(code_storage));
    // Reset deployment state for the new tab if it exists
    if (deployment_started.hasOwnProperty(tab_name)) {
        delete deployment_started[tab_name];
        saveDeploymentState();
    }
}

function removeTab(tab_name) {
    if (Object.keys(code_storage).length <= 1) {
        toast('warning', 'Cannot remove the last file.');
        return; // Don't remove the last tab
    }
    if (code_storage.hasOwnProperty(tab_name)) {
        delete code_storage[tab_name]; // Remove the tab
        localStorage.setItem('code_storage', JSON.stringify(code_storage)); // Update storage
         // Remove associated deployment state
         if (deployment_started.hasOwnProperty(tab_name)) {
             delete deployment_started[tab_name];
             saveDeploymentState();
         }
        return true; // Indicate success
    }
    return false; // Indicate tab not found
}


function changeTab(tab_name) {
     if (!code_storage.hasOwnProperty(tab_name)) {
          console.error(`Attempted to switch to non-existent tab: ${tab_name}`);
          // Optionally switch to the first available tab
          const firstTab = Object.keys(code_storage)[0];
          if (firstTab) {
             current_tab = firstTab;
             editor.setValue(code_storage[current_tab] || '');
          } else {
               // Handle case where there are no tabs left (shouldn't happen with removeTab check)
               editor.setValue(''); // Clear editor
               current_tab = null;
          }
     } else {
         current_tab = tab_name;
         editor.setValue(code_storage[current_tab]);
     }

    const isReadOnly = current_tab && current_tab.endsWith('(Read-Only)');
    const submissionForm = document.getElementById('submission-form');
    const functionBoxes = document.getElementById('function-boxes');
    const submitContractNameWrapper = document.getElementById('submitContractNameWrapper');
    const submitContractstampLimitWrapper = document.getElementById('submitContractstampLimitWrapper');
    const submitContractconstructorKwargsWrapper = document.getElementById('submitContractconstructorKwargsWrapper');
    const submitButton = document.getElementById('btn-ide-submit-contract');


    editor.setOption('readOnly', isReadOnly);
    // Disable linting for read-only as it might be irrelevant or slow
    editor.setOption('lint', !isReadOnly && typeof pythonLinter === 'function');

    submissionForm.style.display = isReadOnly ? 'none' : 'block';
    functionBoxes.style.display = isReadOnly ? 'flex' : 'none';
    functionBoxes.innerHTML = ''; // Clear previous function boxes

    if (isReadOnly) {
        buildFunctionBoxes(); // Build function boxes for read-only contracts
    } else {
        // Handle deployment state display for writable tabs
        if (deployment_started[current_tab]) {
            submitContractNameWrapper.style.display = 'block';
            // Pre-fill contract name based on tab name (remove .py if exists)
            document.getElementById("submitContractName").value = current_tab.replace(/\.py$/i, '');
            submitContractstampLimitWrapper.style.display = 'block';
            submitContractconstructorKwargsWrapper.style.display = 'block';
            submitButton.innerHTML = 'Deploy Contract';
        } else {
            submitContractNameWrapper.style.display = 'none';
            submitContractstampLimitWrapper.style.display = 'none';
            submitContractconstructorKwargsWrapper.style.display = 'none';
            submitButton.innerHTML = 'Start Deployment';
        }
    }

    refreshTabList(); // Update the visual state of tabs
}


function addNewTab() {
    let dropdown = document.querySelector('.dropdown-content');
    if (dropdown) dropdown.remove();

    let tab_name = prompt('Enter new file name (e.g., my_contract.py):');
    if (tab_name === null) return; // User cancelled

    tab_name = tab_name.trim();
    if (tab_name === '') {
        toast('warning', 'File name cannot be empty!');
        return;
    }
    // Suggest adding .py if not present
     if (!tab_name.toLowerCase().endsWith('.py')) {
         tab_name += '.py';
     }

    if (code_storage.hasOwnProperty(tab_name)) {
        toast('warning', `File "${tab_name}" already exists!`);
        return;
    }

    // Add with default code or empty string
    const defaultCode = "@construct\ndef seed():\n    pass\n\n@export\ndef my_function():\n    # Your code here\n    return 0";
    addTab(tab_name, defaultCode);
    changeTab(tab_name); // Switch to the new tab
    refreshTabList(); // Update UI
}

function addNewTokenTab() {
     let dropdown = document.querySelector('.dropdown-content');
     if (dropdown) dropdown.remove();

     let tab_name = prompt('Enter new token file name (e.g., my_token.py):');
     if (tab_name === null) return; // User cancelled

     tab_name = tab_name.trim();
      if (tab_name === '') {
         toast('warning', 'File name cannot be empty!');
         return;
     }
      if (!tab_name.toLowerCase().endsWith('.py')) {
         tab_name += '.py';
     }


     if (code_storage.hasOwnProperty(tab_name)) {
          toast('warning', `File "${tab_name}" already exists!`);
         return;
     }

     // Fetch standard token code
      fetch('https://raw.githubusercontent.com/xian-network/xian-standard-contracts/refs/heads/main/XSC001_standard_token/XSC0001.py')
          .then((response) => {
              if (!response.ok) {
                   throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.text();
          })
          .then((code) => {
              addTab(tab_name, code);
              changeTab(tab_name);
              refreshTabList();
               toast('success', 'Standard token contract loaded.');
          })
          .catch((error) => {
               console.error('Error loading standard token contract:', error);
               toast('danger', 'Error loading token template. Please try again.');
          });
}

function loadContractFromExplorer() {
    let dropdown = document.querySelector('.dropdown-content');
    if (dropdown) dropdown.remove();

    let contract = prompt('Enter contract name to load:');
    if (contract === null) return;

    contract = contract.trim();
    if (contract === '') {
         toast('warning', 'Contract name cannot be empty.');
        return;
    }

    const tab_name = contract + '(Read-Only)';
    if (code_storage.hasOwnProperty(tab_name)) {
        toast('warning', `Contract "${contract}" is already open (read-only).`);
         changeTab(tab_name); // Switch to existing tab
        return;
    }

     // Show loading indicator?
     toast('info', `Loading contract ${contract}...`);

    getContractCode(contract).then((contractCode) => { // Assumes getContractCode is async
        if (contractCode === null || contractCode === '' || contractCode === "\x9Eée") {
            toast('danger', `Contract "${contract}" not found or could not be loaded.`);
            return;
        }

        addTab(tab_name, contractCode);
        changeTab(tab_name); // Switch to the newly loaded tab
        refreshTabList();
        toast('success', `Contract ${contract} loaded (read-only).`);

    }).catch((error) => {
        console.error('Error loading contract:', error);
        toast('danger', `Error loading contract ${contract}: ${error.message}`);
    });
}

function showDropdown() {
    // Close existing dropdowns first
    const existingDropdown = document.querySelector('.dropdown-content');
    if (existingDropdown) {
        existingDropdown.remove();
    }

    const addButton = document.querySelector('.add-tab-button');
    if (!addButton) return;

    let dropdown = document.createElement('div');
    // Styling and positioning logic (keep as is, assuming it works)
    dropdown.className = 'dropdown-content';
    // ... (rest of the styling) ...
    dropdown.style.display = 'flex';
    dropdown.style.flexDirection = 'column';
    dropdown.style.gap = '10px';
    dropdown.style.position = 'absolute'; // Make sure it's absolute
    dropdown.style.backgroundColor = document.body.classList.contains('dark-mode') ? '#202020' : '#fff';
    dropdown.style.border = '1px solid #8a8b8e';
    dropdown.style.borderRadius = '8px';
    dropdown.style.padding = '0.5rem';
    dropdown.style.zIndex = '10000'; // High z-index
    dropdown.style.minWidth = '150px'; // Give it some min width


    let buttonRect = addButton.getBoundingClientRect();
    dropdown.style.left = `${buttonRect.left}px`;
    // Position below the button, accounting for scroll position
    dropdown.style.top = `${buttonRect.bottom + window.scrollY}px`;

    document.body.appendChild(dropdown); // Append to body

    // Adjust position if it goes off-screen (simple right edge check)
    const dropdownRect = dropdown.getBoundingClientRect();
    if (dropdownRect.right > window.innerWidth) {
        dropdown.style.left = 'auto';
        dropdown.style.right = '10px'; // Adjust with some padding
    }
     if (dropdownRect.bottom > window.innerHeight) {
          dropdown.style.top = 'auto';
          dropdown.style.bottom = '10px';
     }


    // Dropdown items
    let newTab = document.createElement('div');
    newTab.innerHTML = '<i class="fas fa-file fa-fw me-2"></i>New Blank File';
    newTab.addEventListener('click', addNewTab);
    newTab.style.cursor = 'pointer';
    newTab.className = 'dropdown-hover-item'; // Add class for hover effect if desired

    let newTokenTab = document.createElement('div');
    newTokenTab.innerHTML = '<i class="fas fa-coins fa-fw me-2"></i>New Token';
    newTokenTab.addEventListener('click', addNewTokenTab);
    newTokenTab.style.cursor = 'pointer';
    newTokenTab.className = 'dropdown-hover-item';

    let loadContract = document.createElement('div');
    loadContract.innerHTML = '<i class="fas fa-download fa-fw me-2"></i>Load Contract';
    loadContract.addEventListener('click', loadContractFromExplorer);
    loadContract.style.cursor = 'pointer';
    loadContract.className = 'dropdown-hover-item';

    dropdown.appendChild(newTab);
    dropdown.appendChild(newTokenTab);
    dropdown.appendChild(loadContract);

     // Close dropdown when clicking outside
     setTimeout(() => { // Use setTimeout to allow the current click event to finish
          document.addEventListener('click', handleOutsideClickForDropdown, { once: true });
     }, 0);
}

function handleOutsideClickForDropdown(event) {
    const dropdown = document.querySelector('.dropdown-content');
    const addButton = document.querySelector('.add-tab-button');
    // Check if click is outside dropdown AND outside the add button
    if (dropdown && !dropdown.contains(event.target) && addButton && !addButton.contains(event.target)) {
        dropdown.remove();
    } else if (dropdown) {
         // If click was inside, re-attach listener for the next click
         document.addEventListener('click', handleOutsideClickForDropdown, { once: true });
    }
}


// --- Linter Setup (assuming pyodide-linting.js handles this) ---
// Ensure pythonLinter is defined before CodeMirror initialization if lint:true is used.
// var pythonLinter = (text, options, cm) => { ... } // From pyodide-linting.js

var editor; // Declare editor globally within this script's scope

function initializeEditor() {
     if (editor) {
         console.log("Editor already initialized.");
         return; // Avoid re-initialization
     }
      const editorElement = document.querySelector('#editor');
      if (!editorElement) {
           console.error("Editor container element not found!");
           return;
      }

     editor = CodeMirror(editorElement, {
        value: code_storage[current_tab] || '', // Ensure there's a fallback value
        mode: 'python',
        lineNumbers: true,
        indentUnit: 4,
        gutters: ["CodeMirror-lint-markers"],
        // Enable linting only if the linter function is ready
        lint: typeof pythonLinter === 'function',
        // Other options...
        lineWrapping: true, // Optional: wrap long lines
        theme: document.body.classList.contains('dark-mode') ? 'material-darker' : 'default' // Example theme based on dark mode
     });
     // Override line number formatting and gutter marker (keep existing logic)
     // ... (line number mapping and gutter marker override code) ...
     editor.setSize('100%', '100%'); // Let the container control the height

     // Save code on change (debounced)
     editor.on('change', debounce(saveCode, 1000)); // Debounce saving

     // Initial setup based on current tab
     changeTab(current_tab);
}


// --- Function Box Building and Execution (Read-Only View) ---
async function buildFunctionBoxes() {
    const functionBoxesContainer = document.getElementById('function-boxes');
    if (!functionBoxesContainer) return;
    functionBoxesContainer.innerHTML = '<div class="text-center p-3"><i class="fas fa-spinner fa-spin"></i> Loading functions...</div>'; // Loading state

    const contractName = current_tab.replace('(Read-Only)', '');

    try {
        const functionsInfo = await getContractFunctions(contractName);
        functionBoxesContainer.innerHTML = ''; // Clear loading/previous

        if (!functionsInfo || !functionsInfo.methods || functionsInfo.methods.length === 0) {
            functionBoxesContainer.innerHTML = '<div class="text-center p-3 text-muted">No public functions found for this contract.</div>';
            return;
        }

        functionsInfo.methods
            .filter(func => !func.name.startsWith('_')) // Filter out private/internal
            .sort((a, b) => a.name.localeCompare(b.name)) // Sort
            .forEach((func) => {
                const functionBox = document.createElement('div');
                functionBox.className = 'function-box';
                functionBox.innerHTML = `<h5>${func.name}</h5>`; // Use h5 for title

                const functionArgs = document.createElement('div');
                functionArgs.className = 'function-args mb-2'; // Add margin

                // Add inputs for function arguments
                 if (func.arguments && func.arguments.length > 0) {
                    func.arguments.forEach((arg) => {
                        const argElement = document.createElement('div');
                        argElement.className = 'mb-2'; // Spacing between args
                        argElement.innerHTML = `
                             <label for="${contractName}-${func.name}-${arg.name}" class="form-label small mb-0">${arg.name} (${arg.type})</label>
                             <input type="text" class="function-arg-value form-control form-control-sm" id="${contractName}-${func.name}-${arg.name}" placeholder="Value for ${arg.name}">
                         `;
                        functionArgs.appendChild(argElement);
                    });
                 } else {
                      functionArgs.innerHTML = `<p class="text-muted small mb-2">No arguments required.</p>`;
                 }

                // Always add a stamp limit field
                const stampElement = document.createElement('div');
                 stampElement.className = 'mb-2';
                 stampElement.innerHTML = `
                     <label for="${contractName}-${func.name}-stamp_limit" class="form-label small mb-0">Stamp Limit (Optional)</label>
                     <input type="number" class="function-arg-value form-control form-control-sm" id="${contractName}-${func.name}-stamp_limit" placeholder="e.g., 50000">
                 `;
                functionArgs.appendChild(stampElement);
                functionBox.appendChild(functionArgs);

                // Execute button
                const functionButton = document.createElement('button');
                functionButton.className = 'btn btn-sm btn-primary w-100'; // Full width small button
                functionButton.innerHTML = 'Execute';
                functionButton.addEventListener('click', () => executeContractFunction(contractName, func, functionButton)); // Pass button for disabling

                functionBox.appendChild(functionButton);
                functionBoxesContainer.appendChild(functionBox);
            });
    } catch (error) {
        console.error(`Error building function boxes for ${contractName}:`, error);
        functionBoxesContainer.innerHTML = `<div class="alert alert-danger">Error loading functions for ${contractName}.</div>`;
    }
}

// --- Execute Function (Called from Read-Only View) ---
async function executeContractFunction(contractName, funcInfo, executeButton) {
    const errorContainer = document.getElementById('submitContractError'); // Use IDE's error display
    const successContainer = document.getElementById('submitContractSuccess');
    errorContainer.style.display = 'none';
    successContainer.style.display = 'none';

    // Check lock state
    if (locked || !unencryptedMnemonic) {
        toast('warning', 'Wallet is locked. Unlock to execute functions.');
        return;
    }
    const selectedAccount = getSelectedAccount();
    if (!selectedAccount) {
        toast('danger', 'No account selected.');
        return;
    }

    // --- Build Kwargs ---
    let kwargs = {};
    let validationError = false;
    try {
         if (funcInfo.arguments && funcInfo.arguments.length > 0) {
             for (const arg of funcInfo.arguments) {
                 const inputElement = document.getElementById(`${contractName}-${funcInfo.name}-${arg.name}`);
                 if (!inputElement) {
                      throw new Error(`Missing input for argument '${arg.name}'.`);
                 }
                 const valueStr = inputElement.value;
                 kwargs[arg.name] = parseArgumentValue(valueStr, arg.type, arg.name); // Use helper
             }
         }
    } catch (error) {
         validationError = true;
         errorContainer.innerHTML = error.message;
         errorContainer.style.display = 'block';
         window.scrollTo(0, 0); // Scroll to show error
         return;
    }
    // --- End Build Kwargs ---

    // --- Get Stamp Limit ---
    const stampLimitInput = document.getElementById(`${contractName}-${funcInfo.name}-stamp_limit`);
    let stampsSupplied = parseInt(stampLimitInput.value, 10);

    if (isNaN(stampsSupplied) || stampsSupplied <= 0) {
         toast('info', 'No stamp limit provided, attempting estimation...');
          // If no stamp limit, try to estimate
          try {
             // Need to create a dummy payload for signing, then estimate
             let estimationPayload = { payload: { chain_id: CHAIN_ID, contract: contractName, function: funcInfo.name, kwargs: kwargs, stamps_supplied: 200000 }, metadata: { signature: "" } };
             const signedForEst = await signTransaction(estimationPayload, unencryptedMnemonic, selectedAccount.index);
             const estimateResult = await estimateStamps(signedForEst);
             if (!estimateResult.success || estimateResult.stamps === null) {
                 throw new Error(`Estimation failed: ${estimateResult.tx_result || 'Unknown reason'}`);
             }
             stampsSupplied = estimateResult.stamps + 50; // Add buffer
             toast('success', `Estimated stamp cost: ${stampsSupplied}`);
             stampLimitInput.value = stampsSupplied; // Update input field
          } catch (estError) {
               errorContainer.innerHTML = `Cannot execute: Stamp limit required or estimation failed. ${estError.message}`;
               errorContainer.style.display = 'block';
               window.scrollTo(0, 0);
               return;
          }
    }
     // --- End Get Stamp Limit ---

     // Check balance for fee
     try {
          const nativeBalanceStr = await execute_balance_of('currency', selectedAccount.vk);
          const nativeBalance = parseFloat(nativeBalanceStr);
          const stampRate = await getStampRate();
          if (isNaN(nativeBalance) || !stampRate || (stampsSupplied / stampRate) > nativeBalance) {
               errorContainer.innerHTML = `Insufficient XIAN balance for fee (${(stampsSupplied / stampRate).toFixed(4)} Xian needed).`;
               errorContainer.style.display = 'block';
               window.scrollTo(0, 0);
               return;
          }
     } catch (e) {
          errorContainer.innerHTML = `Error checking balance for fee: ${e.message}`;
          errorContainer.style.display = 'block';
          window.scrollTo(0, 0);
          return;
     }


    // --- Confirmation and Execution ---
    let conf = confirm(`Execute ${contractName}.${funcInfo.name}? Fee: ~${(stampsSupplied / await getStampRate()).toFixed(4)} Xian`);
    if (!conf) return;

    executeButton.disabled = true;
    executeButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Executing...';
    window.scrollTo(0, 0); // Scroll to top to see status messages

    let payload = {
        payload: {
            chain_id: CHAIN_ID,
            contract: contractName,
            function: funcInfo.name,
            kwargs: kwargs,
            stamps_supplied: stampsSupplied
        },
        metadata: { signature: "" }
    };

    try {
        const signedTx = await signTransaction(payload, unencryptedMnemonic, selectedAccount.index);
        const response = await broadcastTransaction(signedTx);

         // Handle response (similar to sendAdvTx)
         if (response.error === 'timeout') {
             successContainer.innerHTML = 'Transaction broadcast timed out. Check Explorer.';
             successContainer.style.display = 'block';
             prependToTransactionHistory("TIMEOUT", contractName, funcInfo.name, kwargs, 'pending', new Date().toLocaleString());
         } else if (response && response.result && response.result.hash) {
            const hash = response.result.hash;
            let status = 'pending';
            let logMessage = response.result.log || "";

            if (response.result.code !== 0) {
                 status = 'error';
                 errorContainer.innerHTML = `Execution failed: ${logMessage}`;
                 errorContainer.style.display = 'block';
                 toast('danger', `Execution failed: ${logMessage.substring(0,100)}...`);
            } else {
                 successContainer.innerHTML = `Transaction sent! Hash: <a class='explorer-url text-light' href='${EXPLORER}/tx/${hash}' target='_blank' rel='noopener noreferrer'>${hash}</a>`;
                 successContainer.style.display = 'block';
                 toast('success', `Transaction sent: ${hash.substring(0,10)}...`);
            }
            prependToTransactionHistory(hash, contractName, funcInfo.name, kwargs, status, new Date().toLocaleString());
         } else {
            throw new Error('Unexpected response from network.');
         }

    } catch (error) {
        console.error("Error executing contract function:", error);
        errorContainer.innerHTML = `Error executing function: ${error.message}`;
        errorContainer.style.display = "block";
        toast('danger', `Error: ${error.message}`);
    } finally {
        executeButton.disabled = false;
        executeButton.innerHTML = 'Execute';
    }
}

// --- Submit Contract (Deployment) ---
async function submitContract() { // Made async
    const contractError = document.getElementById("submitContractError");
    const contractSuccess = document.getElementById("submitContractSuccess");
    const submitButton = document.getElementById('btn-ide-submit-contract');

    // Reset messages
    contractError.style.display = 'none';
    contractSuccess.style.display = 'none';
    window.scrollTo(0, 0); // Scroll to top

    // Check lock state
    if (locked || !unencryptedMnemonic) {
        contractError.innerHTML = 'Wallet is locked. Please unlock to deploy contracts.';
        contractError.style.display = 'block';
        return;
    }
    const selectedAccount = getSelectedAccount();
    if (!selectedAccount) {
        contractError.innerHTML = 'No account selected.';
        contractError.style.display = 'block';
        return;
    }

    // Get form values
    const contractNameInput = document.getElementById("submitContractName");
    const stampLimitInput = document.getElementById("submitContractstampLimit");
    const constructorKwargsInput = document.getElementById("submitContractconstructorKwargs");

    const contract = contractNameInput.value.trim();
    const stampLimitStr = stampLimitInput.value.trim();
    const constructorKwargsStr = constructorKwargsInput.value.trim();
    const contractCode = editor.getValue(); // Get code from CodeMirror

    // --- Validation ---
    if (contract === "" || !contract.startsWith('con_')) {
        contractError.innerHTML = 'Contract name is required and must start with "con_".';
        contractError.style.display = 'block';
        contractNameInput.focus();
        return;
    }
    if (stampLimitStr === "") {
        contractError.innerHTML = 'Stamp limit is required for deployment.';
        contractError.style.display = 'block';
        stampLimitInput.focus();
        return;
    }
    let stampLimit;
    try {
        stampLimit = parseInt(stampLimitStr, 10);
        if (isNaN(stampLimit) || stampLimit <= 0) throw new Error();
    } catch {
        contractError.innerHTML = 'Invalid stamp limit. Please enter a positive number.';
        contractError.style.display = 'block';
        stampLimitInput.focus();
        return;
    }
    let constructorKwargs = {};
    if (constructorKwargsStr !== "") {
        try {
            constructorKwargs = JSON.parse(constructorKwargsStr);
            if (typeof constructorKwargs !== 'object' || constructorKwargs === null) {
                 throw new Error("Constructor Kwargs must be a valid JSON object.");
            }
        } catch (error) {
            contractError.innerHTML = `Invalid constructor kwargs JSON: ${error.message}`;
            contractError.style.display = 'block';
            constructorKwargsInput.focus();
            return;
        }
    }
     // Check balance for deployment fee
     try {
          const nativeBalanceStr = await execute_balance_of('currency', selectedAccount.vk);
          const nativeBalance = parseFloat(nativeBalanceStr);
          const stampRate = await getStampRate();
          if (isNaN(nativeBalance) || !stampRate || (stampLimit / stampRate) > nativeBalance) {
               contractError.innerHTML = `Insufficient XIAN balance for deployment fee (${(stampLimit / stampRate).toFixed(4)} Xian needed).`;
               contractError.style.display = 'block';
               return;
          }
     } catch (e) {
          contractError.innerHTML = `Error checking balance for deployment fee: ${e.message}`;
          contractError.style.display = 'block';
          return;
     }
    // --- End Validation ---

    // Disable button
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deploying...';

    // --- Create Payload ---
    let payload = {
        payload: {
            chain_id: CHAIN_ID,
            contract: 'submission', // Target the submission contract
            function: 'submit_contract',
            kwargs: {
                name: contract,
                code: contractCode
            },
            stamps_supplied: stampLimit
            // nonce and sender added by signTransaction
        },
        metadata: { signature: "" }
    };
    // Add constructor args only if they were provided
    if (Object.keys(constructorKwargs).length > 0) {
        payload.payload.kwargs.constructor_args = constructorKwargs;
    }

    // --- Sign and Broadcast ---
    try {
        const signedTx = await signTransaction(payload, unencryptedMnemonic, selectedAccount.index);
        const response = await broadcastTransaction(signedTx);

         // Handle response (similar to other transactions)
          if (response.error === 'timeout') {
              successContainer.innerHTML = 'Deployment broadcast timed out. Check Explorer.';
              successContainer.style.display = 'block';
              prependToTransactionHistory("TIMEOUT", 'submission', 'submit_contract', { name: contract }, 'pending', new Date().toLocaleString()); // Simplified history for timeout
          } else if (response && response.result && response.result.hash) {
             const hash = response.result.hash;
             let status = 'pending';
             let logMessage = response.result.log || "";

             if (response.result.code !== 0) {
                  status = 'error';
                  contractError.innerHTML = `Deployment failed: ${logMessage}`;
                  contractError.style.display = 'block';
                  toast('danger', `Deployment failed: ${logMessage.substring(0,100)}...`);
             } else {
                  contractSuccess.innerHTML = `Deployment transaction sent! Hash: <a class='explorer-url text-light' href='${EXPLORER}/tx/${hash}' target='_blank' rel='noopener noreferrer'>${hash}</a>`;
                  contractSuccess.style.display = 'block';
                  toast('success', `Deployment sent: ${hash.substring(0,10)}...`);
                   // Optionally reset deployment state for this tab on success
                   delete deployment_started[current_tab];
                   saveDeploymentState();
                   changeTab(current_tab); // Refresh UI state
             }
             prependToTransactionHistory(hash, 'submission', 'submit_contract', { name: contract /* Optionally include code hash? */ }, status, new Date().toLocaleString());
          } else {
             throw new Error('Unexpected response from network during deployment.');
          }

    } catch (error) {
        console.error("Error submitting contract:", error);
        contractError.innerHTML = `Error submitting contract: ${error.message}`;
        contractError.style.display = "block";
        toast('danger', `Deployment Error: ${error.message}`);
    } finally {
        submitButton.disabled = false;
        // Restore button text based on deployment state AFTER potential failure
        submitButton.innerHTML = deployment_started[current_tab] ? 'Deploy Contract' : 'Start Deployment';
    }
}


// --- Stamp Rate Loading ---
function loadStampRate() {
     const stampRateElement = document.getElementById("stampRate");
     if (!stampRateElement) return;
     stampRateElement.innerHTML = "<i class='fas fa-spinner fa-spin fa-xs'></i>"; // Loading indicator

    getStampRate().then((rate) => {
        if (rate === null) {
            stampRateElement.innerHTML = "ERR";
            toast('warning', 'Could not fetch current stamp rate.');
        } else {
            stampRateElement.innerHTML = rate.toLocaleString(); // Format rate
        }
    }).catch((error) => {
        console.error("Error getting stamp rate:", error);
        stampRateElement.innerHTML = "ERR";
         toast('danger', 'Error fetching stamp rate.');
    });
}

// --- Tab List Refresh ---
function refreshTabList() {
    const tabsEditor = document.getElementById('tabs-editor');
    if (!tabsEditor) return;
    tabsEditor.innerHTML = ''; // Clear existing tabs

    // Add existing tabs from code_storage
    Object.keys(code_storage).forEach((tab) => {
        let tabElement = document.createElement('div');
        tabElement.className = 'tab-editor';
        if (tab === current_tab) {
            tabElement.classList.add('active'); // Highlight current tab
        }
        tabElement.title = tab; // Show full name on hover

        // Tab Name (truncated)
        let tabNameSpan = document.createElement('span');
         // Shorten name for display if needed
         let displayName = tab.length > 20 ? tab.substring(0, 18) + '...' : tab;
         tabNameSpan.textContent = displayName;
         tabNameSpan.style.overflow = 'hidden';
         tabNameSpan.style.textOverflow = 'ellipsis';
         tabNameSpan.style.whiteSpace = 'nowrap';
         tabNameSpan.style.cursor = 'pointer';
         tabNameSpan.addEventListener('click', function () {
             if (current_tab !== tab) { // Avoid unnecessary reloads
                 changeTab(tab);
             }
         });

         tabElement.appendChild(tabNameSpan);


        // Close Button
        let closeTab = document.createElement('i');
        closeTab.className = 'fas fa-times ms-2'; // Added margin start
        closeTab.style.cursor = 'pointer';
        closeTab.style.fontSize = '0.8em'; // Make smaller
        closeTab.title = `Close ${tab}`;
        closeTab.addEventListener('click', function (event) {
            event.stopPropagation(); // Prevent tab switch on close click

            if (Object.keys(code_storage).length <= 1) {
                toast('warning', 'Cannot close the last file!');
                return;
            }

            if (confirm(`Are you sure you want to close "${tab}"? Unsaved changes might be lost if auto-save failed.`)) {
                const removed = removeTab(tab); // Attempt removal
                 if (removed) {
                     // If the removed tab was the current one, switch to the first available tab
                     if (tab === current_tab) {
                         const firstTab = Object.keys(code_storage)[0];
                         changeTab(firstTab); // This will also refresh the list
                     } else {
                         refreshTabList(); // Just refresh the list if a different tab was closed
                     }
                     toast('info', `Closed file "${tab}".`);
                 }
            }
        });

        tabElement.appendChild(closeTab);
        tabsEditor.appendChild(tabElement);
    });

    // Add the '+' button
    let addTabButton = document.createElement('div');
    addTabButton.className = 'add-tab-button';
    addTabButton.innerHTML = '<i class="fas fa-plus"></i>';
    addTabButton.title = 'New/Load File';
    addTabButton.addEventListener('click', showDropdown); // Use existing function to show options
    tabsEditor.appendChild(addTabButton);
}


// --- Event Listeners ---
document.getElementById('btn-ide-submit-contract')?.addEventListener('click', function () {
    const nameWrapper = document.getElementById('submitContractNameWrapper');
    const submitButton = document.getElementById('btn-ide-submit-contract');

    if (locked) {
        toast('warning', 'Wallet locked. Unlock to deploy.');
        return;
    }

    if (nameWrapper.style.display === 'none' || !deployment_started[current_tab]) {
        // Transition to deployment details state
        document.getElementById('submitContractNameWrapper').style.display = 'block';
        document.getElementById("submitContractName").value = current_tab.replace(/\.py$/i, ''); // Pre-fill name
        document.getElementById('submitContractstampLimitWrapper').style.display = 'block';
        document.getElementById('submitContractconstructorKwargsWrapper').style.display = 'block';
        submitButton.innerHTML = 'Deploy Contract';
        deployment_started[current_tab] = true; // Mark this tab as started
        saveDeploymentState(); // Persist state
    } else {
        // Already in deployment state, trigger submission
        submitContract(); // Call async submission function
    }
});

document.getElementById('btn-ide-go-to-wallet')?.addEventListener('click', function () {
    changePage('wallet'); // Use changePage for navigation
});

document.getElementById('ide-send-adv-tx')?.addEventListener('click', function () {
    changePage('send-advanced-transaction');
});


// --- Initialization ---
initializeEditor(); // Initialize CodeMirror
loadStampRate(); // Load initial stamp rate
refreshTabList(); // Build initial tab list

// Optional: Add listener for dark mode changes to update editor theme
// document.body.addEventListener('classChanged', function(e) { // Assuming a custom event or MutationObserver
//     if (editor) {
//         editor.setOption('theme', document.body.classList.contains('dark-mode') ? 'material-darker' : 'default');
//     }
// });

======================================================================
File: xian-web-wallet/templates/page_js/ecosystem-news.js
======================================================================


function getLastTwentyRedditPosts() {
    let newsContainerElement = document.getElementById('news-container');
let redditApiUrl = 'https://www.reddit.com/r/xiannetwork.json';
    fetch(redditApiUrl)
        .then(response => response.json())
        .then(data => {
            newsContainerElement.innerHTML = '';  // Clear the news container before adding new posts
            const posts = data.data.children;
            for (let i = 0; i < data.data.children.length; i++) {
                const post = posts[i].data;
                if (post.author === 'lorythril') {
                    if (post.removed_by_category !== null) {
                        continue;
                    }
                    const postElement = createPostElement(post);
                    newsContainerElement.appendChild(postElement);
                }
            }
        });
}
function processText(text) {
    // Convert Markdown-style links [text](url) to HTML anchor tags
    text = text.replace(/\[(.*?)\]\((https?:\/\/[^\s]+)\)/g, '<a href="$2" target="_blank">$1</a>');
    
    // Convert plain URLs to HTML anchor tags if they are not already inside an anchor tag
    text = text.replace(/(^|\s)(https?:\/\/[^\s]+)/g, '$1<a href="$2" target="_blank">$2</a>');

    // Preserve line breaks by replacing newlines with <br>
    text = text.replace(/\n/g, '<br>');

    return text;
}

function createPostElement(post) {
    const postElement = document.createElement('div');
    let postTextUnprocessed = post.selftext.slice(0,400);
    let postText = processText(postTextUnprocessed);
    postElement.className = 'card mb-3';  // Bootstrap card with margin-bottom
    postElement.style.backgroundColor = 'unset';  // Remove the default card background color
    postElement.innerHTML = `
        <div class="card-body" style="padding-left: 0; padding-right: 0;">
            <a href="https://www.reddit.com${post.permalink}" target="_blank" class="text-decoration-none">
                <h5 class="card-title">${post.title}</h5>
            </a>
            <p class="card-text"><small class="text-muted">${new Date(post.created_utc * 1000).toLocaleString()}</small></p>
            <p class="card-text">${postText}...</p>
            <a href="https://www.reddit.com${post.permalink}" target="_blank" class="btn btn-primary btn-sm">Read more on Reddit</a>
        </div>
    `;
    return postElement;
}


getLastTwentyRedditPosts();

======================================================================
File: xian-web-wallet/templates/page_js/create-token.js
======================================================================
// Assumes global vars: CHAIN_ID, RPC, EXPLORER, locked, unencryptedMnemonic, selectedAccountIndex, accounts, token_list
// Assumes functions: getSelectedAccount, signTransaction, estimateStamps, broadcastTransaction,
//                    prependToTransactionHistory, changePage, toast, getStampRate, execute_balance_of

// Define tokenContract globally or ensure it's loaded/available
var tokenContract = `
balances = Hash(default_value=0)
metadata = Hash()
TransferEvent = LogEvent(event="Transfer", params={"from":{'type':str, 'idx':True}, "to": {'type':str, 'idx':True}, "amount": {'type':(int, float, decimal)}})
ApproveEvent = LogEvent(event="Approve", params={"from":{'type':str, 'idx':True}, "to": {'type':str, 'idx':True}, "amount": {'type':(int, float, decimal)}})


@construct
def seed():
    # Supply is dynamically set below
    balances[ctx.caller] = 0 # Start with 0, supply added below
    metadata['token_name'] = "TOKEN_NAME"       # Replaced by input
    metadata['token_symbol'] = "TOKEN_SYMBOL"   # Replaced by input
    metadata['token_logo_url'] = 'TOKEN_LOGO_URL' # Replaced by input
    metadata['token_website'] = 'TOKEN_WEBSITE'   # Replaced by input
    metadata['total_supply'] = 0               # Replaced by input
    metadata['operator'] = ctx.caller

    # Assign total supply to the creator
    balances[ctx.caller] = metadata['total_supply']


@export
def change_metadata(key: str, value: Any):
    assert ctx.caller == metadata['operator'], 'Only operator can set metadata!'
    metadata[key] = value


@export
def balance_of(address: str):
    # Added check for None return from Hash
    bal = balances[address]
    return bal if bal is not None else 0


@export
def transfer(amount: float, to: str):
    assert amount > 0, 'Cannot send negative balances!'
    sender = ctx.caller
    assert balances[sender] >= amount, 'Not enough coins to send!'

    balances[sender] -= amount
    # Ensure recipient balance exists before adding
    balances[to] = balances[to] + amount if balances[to] is not None else amount
    TransferEvent({"from": sender, "to": to, "amount": amount})


@export
def approve(amount: float, to: str):
    assert amount > 0, 'Cannot approve negative balances!'
    sender = ctx.caller
    balances[sender, to] = amount
    ApproveEvent({"from": sender, "to": to, "amount": amount})


@export
def transfer_from(amount: float, to: str, main_account: str):
    assert amount > 0, 'Cannot send negative balances!'
    sender = ctx.caller # The one calling this function (spender)
    approved_amount = balances[main_account, sender]

    assert approved_amount >= amount, f'Not enough coins approved to send! You have {approved_amount} and are trying to spend {amount}'
    assert balances[main_account] >= amount, 'Not enough coins in main account to send!'

    balances[main_account, sender] -= amount
    balances[main_account] -= amount
    balances[to] = balances[to] + amount if balances[to] is not None else amount
    TransferEvent({"from": main_account, "to": to, "amount": amount})
`;


// Debounce helper
function debounce(func, delay) {
    let timeout;
    return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), delay);
    };
}

// --- Estimate Stamps (Modified for HD) ---
async function estimateCreateTokenStamps() { // Renamed to be specific
    const estimation_loading = document.getElementById('estimation-loading');
    const estimation_finished = document.getElementById('estimation-result');
    const createTokenBtn = document.getElementById('btn-create-token-create');
    const feeContainer = document.getElementById('tokenFeeContainer');
    const feeElement = document.getElementById('tokenFee');
    const feeXianElement = document.getElementById('tokenFeeXian');
    const errorMsg = document.getElementById("createTokenError"); // Use error field for estimation errors too

    // Reset UI
    estimation_loading.style.display = 'inline-block';
    estimation_finished.style.display = 'none';
    feeContainer.style.display = 'block'; // Show container while loading
    createTokenBtn.disabled = true; // Disable create button during estimation
    errorMsg.style.display = 'none';


    // Check lock state
    if (locked || !unencryptedMnemonic) {
        estimation_loading.style.display = 'none'; // Hide loader
        feeElement.textContent = 'Locked';
        estimation_finished.style.display = 'inline-block';
        toast('warning', 'Wallet locked. Cannot estimate fees.');
        return;
    }
    const selectedAccount = getSelectedAccount();
    if (!selectedAccount) {
         estimation_loading.style.display = 'none';
         feeElement.textContent = 'Error';
         estimation_finished.style.display = 'inline-block';
         toast('danger', 'No account selected.');
         return;
    }

    // Get contract details (name is most relevant for estimation context)
    const contractName = document.getElementById("ContractNameCreateToken").value.trim();
    const name = document.getElementById("NameCreateToken").value.trim();
    const symbol = document.getElementById("SymbolCreateToken").value.trim();
    const supply = document.getElementById("SupplyCreateToken").value.trim();

    // Basic validation before estimation
    if (!contractName || !name || !symbol || !supply || isNaN(parseFloat(supply)) || parseFloat(supply) <= 0) {
        estimation_loading.style.display = 'none'; // Hide loader
        // Don't show error here, let main create function handle validation
        return;
    }

    // Prepare a dummy transaction for estimation (code isn't needed for stamp calc)
    let transaction = {
        payload: {
            // chain_id, nonce, sender added by signTransaction
            contract: "submission",
            function: "submit_contract",
            kwargs: {
                name: contractName,
                // Code is large, omit from estimation payload if possible,
                // otherwise include a placeholder or the actual code.
                // Stamp cost *might* depend on code size. Let's include it for accuracy.
                code: buildTokenContractCode(), // Build code with current inputs
            },
            stamps_supplied: 200000 // High default for estimation
        },
        metadata: { signature: "" }
    };

    try {
        // Sign for estimation
        const signedTxForEstimation = await signTransaction(transaction, unencryptedMnemonic, selectedAccount.index);
        // Estimate
        const stampResult = await estimateStamps(signedTxForEstimation);

        estimation_loading.style.display = 'none';
        estimation_finished.style.display = 'inline-block'; // Show result area

        if (stampResult.stamps === null || !stampResult.success) {
            feeElement.textContent = 'Error';
            feeXianElement.textContent = 'N/A';
             errorMsg.innerHTML = `Fee estimation failed: ${stampResult.tx_result || 'Unknown error'}`;
             errorMsg.style.display = 'block';
        } else {
            const stamps = stampResult.stamps;
            const stamp_rate = await getStampRate();
            if (stamp_rate) {
                feeElement.textContent = stamps;
                feeXianElement.textContent = (stamps / stamp_rate).toFixed(8);
                createTokenBtn.disabled = false; // Enable button ONLY on successful estimation
            } else {
                feeElement.textContent = 'Error';
                feeXianElement.textContent = 'N/A';
                 errorMsg.innerHTML = 'Could not retrieve stamp rate.';
                 errorMsg.style.display = 'block';
            }
        }
    } catch (error) {
        console.error("Error estimating token creation stamps:", error);
        estimation_loading.style.display = 'none';
        estimation_finished.style.display = 'inline-block';
        feeElement.textContent = 'Error';
        feeXianElement.textContent = 'N/A';
         errorMsg.innerHTML = `Fee estimation error: ${error.message}`;
         errorMsg.style.display = 'block';
    }
}

// Helper function to build the contract code with current inputs
function buildTokenContractCode() {
    let currentCode = tokenContract; // Start with the template
    const name = document.getElementById("NameCreateToken").value || "My Token";
    const symbol = document.getElementById("SymbolCreateToken").value || "TKN";
    const supply = parseFloat(document.getElementById("SupplyCreateToken").value) || 0;
    const logo = document.getElementById("LogoCreateToken").value || "";
    const website = document.getElementById("WebsiteCreateToken").value || "";

    // Replace placeholders carefully
    currentCode = currentCode.replace('"TOKEN_NAME"', JSON.stringify(name)); // Use JSON.stringify for proper escaping
    currentCode = currentCode.replace('"TOKEN_SYMBOL"', JSON.stringify(symbol));
    // Use a unique placeholder or regex for supply to avoid accidental replacement
    currentCode = currentCode.replace('metadata[\'total_supply\'] = 0', `metadata['total_supply'] = ${supply}`);
    currentCode = currentCode.replace('balances[ctx.caller] = 0', `balances[ctx.caller] = ${supply}`); // Assign supply to creator
    currentCode = currentCode.replace("'TOKEN_LOGO_URL'", JSON.stringify(logo));
    currentCode = currentCode.replace("'TOKEN_WEBSITE'", JSON.stringify(website));

    return currentCode;
}

// --- Create Token Function (Modified for HD) ---
async function createToken() { // Renamed and made async
    const createTokenError = document.getElementById("createTokenError");
    const createTokenSuccess = document.getElementById("createTokenSuccess");
    const createTokenBtn = document.getElementById("btn-create-token-create");

    // Reset messages
    createTokenError.style.display = "none";
    createTokenSuccess.style.display = "none";

    // Check lock state
    if (locked || !unencryptedMnemonic) {
        createTokenError.innerHTML = 'Wallet is locked. Please unlock to create a token.';
        createTokenError.style.display = 'block';
        return;
    }
    const selectedAccount = getSelectedAccount();
    if (!selectedAccount) {
         createTokenError.innerHTML = 'Error: No account selected.';
         createTokenError.style.display = 'block';
        return;
    }

    // --- Get and Validate Inputs ---
    const name = document.getElementById("NameCreateToken").value.trim();
    const symbol = document.getElementById("SymbolCreateToken").value.trim();
    const supplyStr = document.getElementById("SupplyCreateToken").value.trim();
    const contractName = document.getElementById("ContractNameCreateToken").value.trim();
    const logo = document.getElementById("LogoCreateToken").value.trim();
    const website = document.getElementById("WebsiteCreateToken").value.trim();

    if (!name || !symbol || !supplyStr || !contractName) {
        createTokenError.innerHTML = "Please fill out all required (*) fields.";
        createTokenError.style.display = "block";
        return;
    }
    if (!contractName.startsWith('con_')) {
         createTokenError.innerHTML = 'Contract name must start with "con_".';
         createTokenError.style.display = 'block';
         return;
    }
     // Validate supply format
     let supply;
     try {
         supply = parseFloat(supplyStr);
         if (isNaN(supply) || supply <= 0) throw new Error();
     } catch {
         createTokenError.innerHTML = "Invalid supply. Please enter a positive number.";
         createTokenError.style.display = "block";
         return;
     }
     // --- End Validation ---


    // --- Fee Check ---
    let stampLimit;
    try {
        stampLimit = parseInt(document.getElementById("tokenFee").textContent, 10);
        if (isNaN(stampLimit)) {
             // Attempt re-estimation if stamp value isn't valid
             toast('warning', 'Fee not estimated. Attempting estimation...');
             await estimateCreateTokenStamps();
             stampLimit = parseInt(document.getElementById("tokenFee").textContent, 10);
             if (isNaN(stampLimit)) { // Check again after re-estimation attempt
                throw new Error("Fee could not be estimated.");
             }
        }
         // Check balance for fee
          const nativeBalanceStr = await execute_balance_of('currency', selectedAccount.vk);
          const nativeBalance = parseFloat(nativeBalanceStr);
          const stampRate = await getStampRate();
          if (isNaN(nativeBalance) || !stampRate || (stampLimit / stampRate) > nativeBalance) {
               createTokenError.innerHTML = `Insufficient XIAN balance for creation fee (${(stampLimit / stampRate).toFixed(4)} Xian needed).`;
               createTokenError.style.display = 'block';
               return;
          }

    } catch (e) {
        createTokenError.innerHTML = `Could not determine transaction fee: ${e.message}`;
        createTokenError.style.display = "block";
        return;
    }
    // --- End Fee Check ---


    // Disable button during process
    createTokenBtn.disabled = true;
    createTokenBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';

    // Build final contract code
    const finalTokenContractCode = buildTokenContractCode();

    // Create transaction payload
    let payload = {
        payload: {
            chain_id: CHAIN_ID,
            contract: 'submission',
            function: 'submit_contract',
            kwargs: {
                name: contractName,
                code: finalTokenContractCode,
                // No constructor_args needed for this template
            },
            stamps_supplied: stampLimit
            // nonce, sender added by signTransaction
        },
        metadata: { signature: "" }
    };

    // Sign and Broadcast
    try {
        const signedTx = await signTransaction(payload, unencryptedMnemonic, selectedAccount.index);
        const response = await broadcastTransaction(signedTx);

        // Handle response (similar to advanced tx)
        if (response.error === 'timeout') {
              successMsg.innerHTML = 'Creation broadcast timed out. Check Explorer.';
              successMsg.style.display = 'block';
               prependToTransactionHistory("TIMEOUT", 'submission', 'submit_contract', { name: contractName }, 'pending', new Date().toLocaleString());
        } else if (response && response.result && response.result.hash) {
            const hash = response.result.hash;
            let status = 'pending';
            let logMessage = response.result.log || "";

            if (response.result.code !== 0) {
                status = 'error';
                createTokenError.innerHTML = `Token creation failed: ${logMessage}`;
                createTokenError.style.display = "block";
                toast('danger', `Creation failed: ${logMessage.substring(0,100)}...`);
            } else {
                 createTokenSuccess.innerHTML = `Token creation transaction sent! Hash: <a class='explorer-url text-light' href='${EXPLORER}/tx/${hash}' target='_blank' rel='noopener noreferrer'>${hash}</a>`;
                 createTokenSuccess.style.display = "block";
                 toast('success', 'Token creation sent successfully.');
                 // Add the new token to the user's list automatically
                 if (!token_list.includes(contractName)) {
                     token_list.push(contractName);
                     localStorage.setItem("token_list", JSON.stringify(token_list));
                     // Optionally, clear form or redirect
                     // document.getElementById("create-token-form").reset(); // If it's a form element
                 }
            }
             prependToTransactionHistory(hash, 'submission', 'submit_contract', { name: contractName }, status, new Date().toLocaleString());
        } else {
             throw new Error('Unexpected response from network during token creation.');
        }

    } catch (error) {
        console.error("Error creating token:", error);
        createTokenError.innerHTML = `Error creating token: ${error.message}`;
        createTokenError.style.display = "block";
         toast('danger', `Error: ${error.message}`);
    } finally {
        createTokenBtn.disabled = false; // Re-enable button
        createTokenBtn.innerHTML = "Create Token";
    }
}

// --- Event Listeners ---
document.getElementById("btn-create-token-cancel")?.addEventListener("click", function() {
    changePage("wallet"); // Navigate back to wallet
});

document.getElementById("btn-create-token-create")?.addEventListener("click", createToken);

// Auto-fill contract name based on token name
document.getElementById("NameCreateToken")?.addEventListener("input", function() {
    const name = document.getElementById("NameCreateToken").value;
    // Generate a contract name suggestion (simple example)
     const suggestedContractName = "con_" + name.trim().replace(/\s+/g, "_").replace(/[^a-zA-Z0-9_]/g, "").toLowerCase();
    document.getElementById("ContractNameCreateToken").value = suggestedContractName;
    // Trigger estimation when name changes (as contract name changes)
    debouncedEstimateCreateTokenStamps();
});

// Add listeners to other inputs to trigger debounced estimation
const debouncedEstimateCreateTokenStamps = debounce(estimateCreateTokenStamps, 500);
document.getElementById("SymbolCreateToken")?.addEventListener("input", debouncedEstimateCreateTokenStamps);
document.getElementById("SupplyCreateToken")?.addEventListener("input", debouncedEstimateCreateTokenStamps);
document.getElementById("ContractNameCreateToken")?.addEventListener("input", debouncedEstimateCreateTokenStamps);
document.getElementById("LogoCreateToken")?.addEventListener("input", debouncedEstimateCreateTokenStamps); // Code changes slightly based on these
document.getElementById("WebsiteCreateToken")?.addEventListener("input", debouncedEstimateCreateTokenStamps);

// Initial estimation attempt if fields might be pre-filled (less likely here)
// estimateCreateTokenStamps();

======================================================================
File: xian-web-wallet/templates/page_js/import-wallet.js
======================================================================
// Assumes bip39 library is loaded globally

async function importHdWallet() { // Renamed and made async
    const mnemonicInput = document.getElementById('import_mnemonic').value.trim(); // Get mnemonic and trim whitespace
    const password = document.getElementById('import_password').value;
    const confirmPassword = document.getElementById('import_confirmPassword').value;
    const importWalletError = document.getElementById('importWalletError');
    const importButton = document.getElementById('btn-import-wallet-import-wallet');

    importWalletError.style.display = 'none'; // Reset error

    // --- Validation ---
    // Normalize multiple spaces between words to single spaces
    const normalizedMnemonic = mnemonicInput.replace(/\s+/g, ' ');
    const words = normalizedMnemonic.split(' ');
    const wordCount = words.length;

    if (wordCount !== 12 && wordCount !== 24) {
         importWalletError.innerHTML = 'Recovery phrase must be 12 or 24 words long.';
         importWalletError.style.display = 'block';
         return;
    }

    // Validate mnemonic using bip39 library
    if (!bip39.validateMnemonic(normalizedMnemonic)) {
        importWalletError.innerHTML = 'Invalid recovery phrase. Please check your words and their order.';
        importWalletError.style.display = 'block';
        return;
    }

    if (password.length < 6) {
        importWalletError.innerHTML = 'Password must be at least 6 characters long!';
        importWalletError.style.display = 'block';
        return;
    }

    if (password !== confirmPassword) {
        importWalletError.innerHTML = 'Passwords do not match!';
        importWalletError.style.display = 'block';
        return;
    }
    // --- End Validation ---

    // Disable button during import
    importButton.disabled = true;
    importButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importing...';

    try {
        // 1. Import Master Seed (validates mnemonic, derives first key, encrypts mnemonic)
        // Use the normalized mnemonic
        const importedWalletData = importMasterSeedFromMnemonic(normalizedMnemonic, password); // From xian.js

        if (!importedWalletData) {
             // Should not happen if validation passed, but double-check
             throw new Error("Mnemonic validation passed but import failed.");
        }

        // 2. Prepare initial account data
        const initialAccount = {
            index: 0,
            vk: importedWalletData.publicKey, // VK of the first account (index 0)
            name: "Account 1" // Default name for the first account
        };

        // 3. Update Global State (in router.js scope)
        window.encryptedSeed = importedWalletData.encryptedSeed;
        window.unencryptedMnemonic = importedWalletData.unencryptedMnemonic; // Store temporarily
        window.accounts = [initialAccount]; // Start with just the first account
        window.selectedAccountIndex = 0;
        window.locked = false; // Wallet is imported and immediately unlocked

        // 4. Save State to Storage
        await saveEncryptedSeed(window.encryptedSeed);
        await saveAccounts(window.accounts);
        await saveSelectedAccountIndex(window.selectedAccountIndex);

        // Clear sensitive fields
        document.getElementById('import_mnemonic').value = '';
        document.getElementById('import_password').value = '';
        document.getElementById('import_confirmPassword').value = '';

        // 5. Navigate to Wallet Page
        toast('success', 'Wallet imported successfully!');
        changePage('wallet');

    } catch (error) {
        console.error("Error importing HD wallet:", error);
        importWalletError.innerHTML = 'Failed to import wallet. ' + error.message;
        importWalletError.style.display = 'block';
         // Re-enable button on error
         importButton.disabled = false;
         importButton.innerHTML = 'Import Wallet';
    }
     // importButton.disabled = false; // Might re-enable too early if changePage is fast
     // importButton.innerHTML = 'Import Wallet';
}

// Back button listener
document.getElementById('btn-import-wallet-back').addEventListener('click', function() {
    changePage('get-started');
});

// Import button listener
document.getElementById('btn-import-wallet-import-wallet').addEventListener('click', function() {
    importHdWallet(); // Call async function
});

// Input validation setup (similar to create-wallet, adapted for mnemonic)
function inputValidationImport() {
    const mnemonicInput = document.getElementById('import_mnemonic');
    const password = document.getElementById('import_password');
    const confirmPassword = document.getElementById('import_confirmPassword');
    const importWalletError = document.getElementById('importWalletError');

    // Clear error on input
    mnemonicInput.addEventListener('input', () => importWalletError.style.display = 'none');
    password.addEventListener('input', () => importWalletError.style.display = 'none');
    confirmPassword.addEventListener('input', () => importWalletError.style.display = 'none');

    // Basic validation on blur (full validation on submit)
    password.addEventListener("blur", checkPasswordLengthImport);
    confirmPassword.addEventListener("blur", matchPasswordsImport);

    function checkPasswordLengthImport(){
        const passwordValue = password.value;
        if (passwordValue.length > 0 && passwordValue.length < 6) {
            importWalletError.innerHTML = 'Password must be at least 6 characters long!';
            importWalletError.style.display = 'block';
        } else {
            // Don't hide error here, let submit handle final state
        }
    }

    function matchPasswordsImport(){
        const confirmPasswordValue = confirmPassword.value;
        if (password.value !== confirmPasswordValue && confirmPasswordValue !== '') { // Only show error if confirm has content and doesn't match
            importWalletError.innerHTML = 'Passwords do not match!';
            importWalletError.style.display = 'block';
        } else {
           // Don't hide error here
        }
    }
}

// Initialize validation listeners
inputValidationImport();

// Add Enter key listener to confirm password field
document.getElementById('import_confirmPassword').addEventListener('keyup', function(event) {
    if (event.keyCode === 13) { // Enter key
        event.preventDefault();
        importHdWallet();
    }
});

======================================================================
File: xian-web-wallet/css/lint.css
======================================================================
/* The lint marker gutter */
.CodeMirror-lint-markers {
    width: 16px;
  }
  
  .CodeMirror-lint-tooltip {
    background-color: #ffd;
    border: 1px solid black;
    border-radius: 4px 4px 4px 4px;
    color: black;
    font-family: monospace;
    font-size: 10pt;
    overflow: hidden;
    padding: 2px 5px;
    position: fixed;
    white-space: pre;
    white-space: pre-wrap;
    z-index: 100;
    max-width: 600px;
    opacity: 0;
    transition: opacity .4s;
    -moz-transition: opacity .4s;
    -webkit-transition: opacity .4s;
    -o-transition: opacity .4s;
    -ms-transition: opacity .4s;
  }
  
  .CodeMirror-lint-mark {
    background-position: left bottom;
    background-repeat: repeat-x;
  }
  
  .CodeMirror-lint-mark-warning {
    background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAYAAAC09K7GAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9sJFhQXEbhTg7YAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAAMklEQVQI12NkgIIvJ3QXMjAwdDN+OaEbysDA4MPAwNDNwMCwiOHLCd1zX07o6kBVGQEAKBANtobskNMAAAAASUVORK5CYII=");
  }
  
  .CodeMirror-lint-mark-error {
    background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAYAAAC09K7GAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9sJDw4cOCW1/KIAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAAHElEQVQI12NggIL/DAz/GdA5/xkY/qPKMDAwAADLZwf5rvm+LQAAAABJRU5ErkJggg==");
  }
  
  .CodeMirror-lint-marker {
    background-position: center center;
    background-repeat: no-repeat;
    cursor: pointer;
    display: inline-block;
    height: 16px;
    width: 16px;
    vertical-align: middle;
    position: relative;
  }
  
  .CodeMirror-lint-message {
    padding-left: 18px;
    background-position: top left;
    background-repeat: no-repeat;
  }
  
  .CodeMirror-lint-marker-warning, .CodeMirror-lint-message-warning {
    background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAANlBMVEX/uwDvrwD/uwD/uwD/uwD/uwD/uwD/uwD/uwD6twD/uwAAAADurwD2tQD7uAD+ugAAAAD/uwDhmeTRAAAADHRSTlMJ8mN1EYcbmiixgACm7WbuAAAAVklEQVR42n3PUQqAIBBFUU1LLc3u/jdbOJoW1P08DA9Gba8+YWJ6gNJoNYIBzAA2chBth5kLmG9YUoG0NHAUwFXwO9LuBQL1giCQb8gC9Oro2vp5rncCIY8L8uEx5ZkAAAAASUVORK5CYII=");
  }
  
  .CodeMirror-lint-marker-error, .CodeMirror-lint-message-error {
    background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAHlBMVEW7AAC7AACxAAC7AAC7AAAAAAC4AAC5AAD///+7AAAUdclpAAAABnRSTlMXnORSiwCK0ZKSAAAATUlEQVR42mWPOQ7AQAgDuQLx/z8csYRmPRIFIwRGnosRrpamvkKi0FTIiMASR3hhKW+hAN6/tIWhu9PDWiTGNEkTtIOucA5Oyr9ckPgAWm0GPBog6v4AAAAASUVORK5CYII=");
  }
  
  .CodeMirror-lint-marker-multiple {
    background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAcAAAAHCAMAAADzjKfhAAAACVBMVEUAAAAAAAC/v7914kyHAAAAAXRSTlMAQObYZgAAACNJREFUeNo1ioEJAAAIwmz/H90iFFSGJgFMe3gaLZ0od+9/AQZ0ADosbYraAAAAAElFTkSuQmCC");
    background-repeat: no-repeat;
    background-position: right bottom;
    width: 100%; height: 100%;
  }
  
  .CodeMirror-lint-line-error {
    background-color: rgba(183, 76, 81, 0.08);
  }
  
  .CodeMirror-lint-line-warning {
    background-color: rgba(255, 211, 0, 0.1);
  }

======================================================================
File: xian-web-wallet/css/custom.css
======================================================================
html{
    height: 100%;
    
}
body {
    min-height: 100%;
    margin: 0;
    background-color: #fff;
    font-family: 'Roboto Mono', sans-serif;
    color: #202020;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    font-smoothing: antialiased;
    font-weight: 500;
}
a{
    color: #06e6cb;
    text-decoration: none;
}

.btn{color: #202020;}

.top-0 {
    top: 0;
}

.toast.show {
    display: flex;
    opacity: 1;
}

.btn-close {
    box-sizing: content-box;
    width: 1em;
    height: 1em;
    padding: .25em .25em;
    color: #000;
    background: transparent url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3e%3cpath d='M.293.293a1 1 0 011.414 0L8 6.586 14.293.293a1 1 0 111.414 1.414L9.414 8l6.293 6.293a1 1 0 01-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 01-1.414-1.414L6.586 8 .293 1.707a1 1 0 010-1.414z'/%3e%3c/svg%3e") center/1em auto no-repeat;

    border: 0;
    border-radius: .25rem;
    opacity: .5;
    margin-left: 1rem;
}

.btn-close:hover {
    color: #000;
    text-decoration: none;
    opacity: .75;
}

.btn-close:focus {
    outline: 0;
    box-shadow: 0 0 0 .2rem rgba(0, 123, 255, .25);
}



.governance-section {
    display: flex;
    flex-direction: column;
}

.governance-section p {
    display: flex;
    justify-content: flex-start;
    align-items: center;
}
.governance-section-buttons button {
    background-color: #ffffff;
}

.governance-section-flex{
    display: flex;
    flex-direction: column;
}
.title-container-governance{
    margin-top:1rem;
}
.form-group label {
    display: block;
    font-weight: 600;
    letter-spacing: 0.03em;
    margin-bottom: 0.25rem;
}

.form-group p {
    margin: 0 0 0.5rem 0;
    line-height: 1.5;
}

.form-group a {
    color: #06e6cb;
    font-weight: 600;
    text-decoration: none;
}

.form-group a:hover {
    text-decoration: underline;
}
.label-gov {
    min-width: 250px; /* Adjust this value based on your longest label */
    margin-right: 10px; /* Space between the label and the value */
}

.value-gov {
    
}

a:hover{
    color: #06e6cb;
    text-decoration: underline;
}
.governance-sub-title{
    font-size: 1.25rem;
    margin-bottom: 1rem;
    margin-top: 1rem;
    text-decoration: underline;
}
.ide-icon{
    position: absolute;
    left: 0;
    font-size: 1.25rem;
    margin-bottom: 20px;
    color:#06e6cb;
    cursor: pointer;
}
.explorer-url{
    text-overflow: ellipsis;
    overflow: hidden;
    display: block;
}
/* Positioning the dark mode toggler */
.dark-mode-toggler {
    position: fixed;
    bottom: 1rem;
    right: 1rem;
    z-index: 1050; /* Ensures the toggler stays above most elements */
    border: 1px solid #ced4da;
    background: #fff;
    color: #202020;
}
.dark-mode .dark-mode-toggler {
    border: 1px solid #8a8b8e;
    background: #202020;
    color: #ffffff;
}

/* Dark mode specific styles */
.dark-mode {
    background-color: #202020; /* Dark background */
    color: #ffffff; /* Bright text */
}

.dark-mode .app-box {
    background-color: #202020; /* Darker background */
    border: 1px solid #8a8b8e; /* Darker border */
}


.dark-mode .cm-s-default .cm-keyword { color: #CC99CD; } /* Soft purple for keywords for better distinction */
.dark-mode .cm-s-default .cm-atom { color: #D6BF55; } /* Golden for atoms, standing out with warmth */
.dark-mode .cm-s-default .cm-number { color: #F08D49; } /* Soft orange for numbers, easy on the eyes */
.dark-mode .cm-s-default .cm-def { color: #6699CC; } /* Sky blue for definitions, for clarity */
.dark-mode .cm-s-default .cm-variable,
.dark-mode .cm-s-default .cm-punctuation,
.dark-mode .cm-s-default .cm-property,
.dark-mode .cm-s-default .cm-operator { color: #AAB2BF; } /* Lighter gray for variables, punctuations, properties, and operators for subtle differentiation */
.dark-mode .cm-s-default .cm-variable-2 { color: #7EC699; } /* Soft green for second-tier variables, for variety */
.dark-mode .cm-s-default .cm-variable-3,
.dark-mode .cm-s-default .cm-type { color: #67D8EF; } /* Cyan for type annotations and third-tier variables, for freshness */
.dark-mode .cm-s-default .cm-comment { color: #999; } /* Dimmed down for comments, reducing visual noise */
.dark-mode .cm-s-default .cm-string { color: #FFD479; } /* Soft yellow for strings, for warmth and visibility */
.dark-mode .cm-s-default .cm-string-2 { color: #FFD479; } /* Keeping string-2 the same as strings for consistency */
.dark-mode .cm-s-default .cm-meta { color: #555; } /* Darker gray for meta, less prominent */
.dark-mode .cm-s-default .cm-qualifier { color: #555; } /* Matching meta for qualifiers */
.dark-mode .cm-s-default .cm-builtin { color: #30A; } /* Soft blue for built-ins, distinguishable */
.dark-mode .cm-s-default .cm-bracket { color: #FFEE99; } /* Light yellow for brackets, subtle yet visible */
.dark-mode .cm-s-default .cm-tag { color: #E2777A; } /* Soft red for tags, clear and distinguishable */
.dark-mode .cm-s-default .cm-attribute { color: #E2777A; } /* Matching tags for attributes for consistency */
.dark-mode .cm-s-default .cm-hr { color: #999; } /* Grey for horizontal rules, minimal */
.dark-mode .cm-s-default .cm-link { color: #D6BF55; } /* Golden for links, standing out */
.dark-mode .cm-s-default .cm-error { color: #FF3333; } /* Bright red for errors, for immediate visibility */


.app-container {
    height: 100%;
    min-height: 100vh; /* Use viewport height to ensure full coverage */
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 80px !important;
    padding: 20px;
}

.token-icon {
    width: 32px; /* Adjust based on your icon's size */
    height: auto;
}

.wrap-app{
    display: flex; max-width: 100%;width: 100%;align-self: stretch;
}

@media (max-width: 768px) {
    .wrap-app{
        flex-direction: column;
    }
    
}

@media (min-width: 768px) {
    .token-list{
        height: 1px;
    }
    .token-actions{
        flex-direction: row;
    }
    .token-actions button {
        display: flex;
        flex-direction: row;
        gap: 10px;
        align-items: center;
    }
    .token-actions a {
        display: flex;
        flex-direction: row;
        gap: 10px;
        align-items: center;
    }
    .token-item {
        display: flex;
        flex-direction: row!important;
    }
    #local-activity{
        height: 1px;
    }
    .governance-section-wrapper{
        flex-direction: row;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .governance-section-buttons button {
        width: 16rem!important;
        max-width: 100%;
    }
    .governance-section-buttons-colored button {
        width: 8rem!important;
        max-width: 100%;
    }
}
.app-logo {
    width: 32px; /* Adjust based on your logo's size */
    height: auto;
}
.governance-section-buttons-colored {
    display: flex;
    gap: 10px;
}

.side-nav {
    flex-direction: column;
    gap: 10px;
    padding: 20px;
    border-radius: 8px;
    width: auto;
    border: 1px solid #ced4da;
    border-top-right-radius: 0px;
    border-bottom-right-radius: 0px;
    background-color: #fff;
    height: auto;
    min-width: 200px;
}
.side-nav-item {
    display: flex;
    align-items: center;
    cursor: pointer;
}

.side-nav-item i {
    width: 32px;
    height: auto;
}

.dark-mode .side-nav {
    border: 1px solid #8a8b8e;
    background-color: #202020;
}

.app-box {
    padding: 20px;
    border-radius: 8px;
    background-color: #fff;
    width: 100%;
    border: 1px solid #ced4da;
    overflow: auto;
}

.app-box-title {
    margin-bottom: 20px;
    font-size: 1.5rem;
    text-align: center;
}

.title-container {
    display: flex;
    justify-content: center; /* Center the title */
    align-items: center; /* Align items vertically */
    position: relative; /* Needed to position the cogwheel icon */
}

.token-title-container {
    display: flex;
    align-items: center; /* Align items vertically */
    position: relative; /* Needed to position the cogwheel icon */
    margin-top: 0px !important;
    gap: 1rem;
}

.token-title-container > .cogwheel-icon{
    margin-bottom: 0;
    margin-right: 0.5rem;
    position: relative;
}

.app-box .btn-group {
    gap: 10px;
    display: flex;
    flex-direction: row;
}

@media (max-width: 768px) {
    .app-box .btn-group {
        flex-direction: column;
        max-width: 100%;
    }
    
.token-item div {
    margin: 5px 0;
}
.token-details{width: unset!important;}
}
@media (min-width: 768px) {
    button {
        max-width: 15rem;
    }
    .form-control {
        max-width:30rem;
    }
    .token-item{
        gap: 2rem;
    }
    .remove-btn{
        padding: 10px;
    }
    
}

.kwarg-group{
    display: flex;
    gap: 10px;
    align-items: center;
}

.kwarg-group label{
    margin-bottom: 0;
}

.app-box button {
    width: 100%; /* Full-width buttons */
}

.online-status {
    display: flex;
    align-items: center;
    font-size: 0.75rem;
    gap: 10px;
}

.app-name, .app-description {
    text-align: center;
    width: 100%;
    max-width: 400px;
}
.app-name{
    color: unset;
    display: flex;
    gap: 1rem;
    align-items: center;
}

.app-name h2{
    font-size: 1.25rem;
    margin-bottom: 0;
}
.navbar-brand {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    margin-right: 0;
}
.online-circle {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: #28bdaa;
}
.toast.bg-success{
    color: #155724 !important;
}
.toast a{
    color: #06e6cb !important;
}
.toast.bg-danger{
    color: #721c24!important;
}
.mt-1px{
    margin-top: 1px;
}
.offline-circle {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: #dc3545;
}
.grey-circle {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: #6c757d;
}
.navbar {
    background-color: #fff;
    position: fixed;
    top: 0;
    width: 100%;
    z-index: 1030; /* Ensure it stays above other content */
    border-bottom: 1px solid #ced4da;
}
.dark-mode .navbar {
    background-color: #202020;
    border-bottom: 1px solid #8a8b8e;
}

.dark-mode .token-list {
}
.dark-mode .token-item {
    border: 1px solid #8a8b8e;
}
.dark-mode input, .dark-mode select, .dark-mode textarea {
    background-color: #202020;
    color: #ffffff;
    border: 1px solid #8a8b8e;
}
.dark-mode input:focus, .dark-mode select:focus, .dark-mode textarea:focus {
    background-color: #202020;
    color: #ffffff;
}
.stamp-rate{margin-top: 10px;}
.bottom-0 {
    bottom: 0;
}

.end-0 {
    right: 0;
}

.cogwheel-icon {
    position: absolute; /* Position the icon relative to the title container */
    right: 0; /* Align it to the right */
    /* Adjust the size and padding as needed */
    font-size: 1.25rem;
    margin-bottom: 20px;
    cursor: pointer;
    color: #06e6cb;
}

.cogwheel-icon:hover, .ide-icon:hover {
   text-decoration: underline;
}
#local-activity{
    padding-top: 20px;
    padding-bottom: 20px;
}

#local-activity-list {
    display: flex;
    flex-direction: column;
    gap: 20px; /* Adjusts the space between activity items */
}

.activity-item {
    display: flex;
    flex-direction: column; /* Stacks the details and actions on top of each other */
    border-radius: 5px;
    overflow: hidden; /* Ensures the content fits within the borders */
    border: 1px solid #ced4da;
}
.dark-mode .activity-item {
    border: 1px solid #8a8b8e;
}

.activity-details, .activity-actions {
    padding: 15px;
    display: flex;
    flex-wrap: wrap; /* Allows items to wrap onto the next line on smaller screens */
    gap: 10px; /* Adjusts spacing between details and actions */
}

.activity-details > div, .activity-actions > a {
    flex: 1 1 200px; /* Allows flex items to grow and shrink but not smaller than 200px */
    text-overflow: ellipsis;
    overflow: hidden;
    white-space: nowrap; /* Ensures the text is on one line and cuts off with ellipsis if too long */
}

.activity-actions {
    justify-content: flex-end; /* Aligns actions to the right */
    border-top: 1px solid #dee2e6; /* Adds a separator between details and actions */
}

.activity-actions a {
    display: flex;
    align-items: center; /* Centers the icon and text vertically */
    gap: 5px; /* Adds space between the icon and text */
}

/* Optional: Enhance visibility for clickable actions */
.activity-actions a:hover {
    text-decoration: underline;
    color: #06e6cb;
}

.wallet-tabs {
    display: flex;
    gap: 10px; /* Space between tabs */
    padding-top: 20px;
    justify-content: center; /* Aligns tabs to the center */
}

.wallet-tabs a {
    text-decoration: none;
    color: #06e6cb; /* Primary color for consistency */
    padding: 10px 20px;
    border: 1px solid transparent; /* Ensures the layout doesn't shift when border is added on hover or focus */
    border-radius: 5px 5px 0 0; /* Rounded corners at the top */
    transition: color 0.3s ease-in-out, background-color 0.3s ease-in-out;
}

.wallet-tabs a:hover, .wallet-tabs a:focus {

}

/* Active tab style */
.wallet-tabs a.active {
    border-color: #ced4da #ced4da transparent; /* Borders on the sides and top, transparent at the bottom */
    
    border-bottom: 1px solid #ced4da;
    border-top: 0px;
    border-left:0px;
    border-right:0px;
    margin-bottom: -1px; /* Aligns the active tab with the content box */
}


#walletAddress {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    cursor: pointer;
    color: #06e6cb;
    display: block;
}

#walletAddress:hover {
    text-decoration: underline;
}

#yourAddressReceive {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    cursor: pointer;
    color: #06e6cb;
    display: block;
}
#yourAddressReceive:hover {
    text-decoration: underline;
}

.btn-group>.btn-group:not(:last-child)>.btn, .btn-group>.btn:not(:last-child):not(.dropdown-toggle) {
    border-top-right-radius: .25rem!important;
    border-bottom-right-radius: .25rem!important;
}

.btn-group>.btn-group:not(:first-child)>.btn, .btn-group>.btn:not(:first-child):not(.dropdown-toggle) {
    border-top-left-radius: .25rem!important;
    border-bottom-left-radius: .25rem!important;
}

.token-list {
    padding-top: 20px;
    padding-bottom: 20px;
}

.token-item:last-child {
    margin-bottom: 0;
}

.token-item {
    display: flex;
    flex-direction: column;
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    
}
#validator-state{
    margin-bottom: 1rem;
}
.token-list-title {
    font-size: 1.25rem;
    margin-bottom: 20px;
    text-align: center;
}

.create-token-link{
    position: absolute;
    left: 0;
    font-size: 1.25rem;
    margin-bottom: 20px;
    cursor: pointer;
    color: #06e6cb;
}

.token-name span, .token-symbol span, .token-balance span {
    font-weight: bold;
}

.token-balance{
    display: flex;
    align-items: center;
}

.token-details {
    display: flex;
    flex-direction: column;
    margin-top: 0px !important;
    width: 10rem;
}

.token-actions {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 10px;
    flex-grow: 1;
}

.token-actions button {
    background-color: #ffffff;
    width: unset;
}

.token-actions a {
    background-color: #ffffff;
    width: unset;
}

.token-actions button:hover {
    background-color: #ffffff;
}

.token-actions a:hover {
    background-color: #ffffff;
}

.github-link {
    text-align: center;
    margin-top: 10px; /* Adjust spacing as needed */
}

.github-link a {
    color: #202020; /* Dark color for light mode */
    font-weight: bold;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px; /* Space between icon and text */
}

.github-link a:hover {
    text-decoration: underline; /* Optional: highlight on hover */
}

.dark-mode .github-link a {
    color: #ffffff; /* Light color for dark mode */
}

.app-box-description {
    margin-bottom: 10px!important;
}

.dropdown-content{
    background-color: #fff;
    border: 1px solid #ced4da;
}
.dark-mode .dropdown-content{
    background-color: #202020;
    border: 1px solid #8a8b8e;
}
.governance-section-buttons{
    display: flex;
    justify-content: flex-end;
}
.token-name{overflow: hidden;
    text-overflow: ellipsis;}
@media screen and (max-width: 450px) {
    
    .btn-group
    {
        width: 100%!important;
    }
    #wallet-tokens>.title-container{
        justify-content: space-between;
        flex-direction: column;
    }
    #wallet-adv-btns{
        flex-wrap: wrap;
    GAP: 1rem;

    }
    .token-actions>.btn{
        padding: .375rem .3rem;
    }
    .online-status{
        font-size: 0;
    }
    .label-gov{
        min-width: unset;
    }
    .create-token-link{
        align-self: start;
        position: relative;
    }
}



.active-side-nav:before {
    content: "";
    display: block;
    position: absolute;
    height: 1.5rem;
    width: .1875rem;
    background: #06e6cb;
    z-index: 10;
    margin-left: -10px;
}

.wallet-info-card{
    padding: 20px;
    border-radius: 5px;
    border: 1px solid #8a8b8e;
    overflow: auto;
    width: 100%;
    max-width: fit-content;
}

.wallet-info-title{
    position: absolute;
    margin-top: -32.5px;
    background: #202020;
    padding-left: 0.5rem;
    padding-right: 0.5rem;
}

.wallet-info-address{
    display: flex;
    flex-direction: row;
    gap: 10px;
}

.messenger-inbox {
    width: 30%;
    flex-direction: column;
    display: flex
;
    max-width: 300px;
    border-top: 1px solid #8a8b8e;
    border-left: 1px solid #8a8b8e;
    border-bottom: 1px solid #8a8b8e;
    border-top-left-radius: 5px;
    border-bottom-left-radius: 5px;
    padding: 10px;
    overflow-y: auto;
    height: 100%;
    box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
}

.messenger-inbox-header {
    font-size: 1.25rem;
    font-weight: bold;
    padding-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.messenger-inbox-header h5{
    margin-bottom: 0;
}

.messenger-inbox-body {
    display: flex
    ;
        flex-direction: column;
        gap: 10px;
        padding-top: 10px;
        flex-grow: 1;
        height: 0;
        overflow-y: auto;
}
.messenger-inbox-item-active {
    background-color: #494a50;
}

.messenger-inbox-item {
    display: flex;
    gap: 10px;
    align-items: center;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #8a8b8e;
    cursor: pointer;
    transition: box-shadow 0.3s ease-in-out, background-color 0.3s ease-in-out, transform 0.3s ease-in-out;
}
.messenger-inbox-item-content{
    width: 100%;
}
.messenger-inbox-item:hover {
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.messenger-inbox-item-avatar img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.messenger-inbox-item-content h3 {
    font-size: 1rem;
    font-weight: bold;
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.messenger-inbox-item-content p {
    font-size: 0.9rem;
    color: #6c757d;
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}


.messenger-chat-wrapper {
    border: 1px solid #8a8b8e;
    border-top-right-radius: 5px;
    border-bottom-right-radius: 5px;
    padding: 10px;
    display: flex
;
    flex: 1;
    overflow: hidden;
}

.messenger-chat-header {
    font-size: 1.25rem;
    font-weight: bold;
    text-align: center;
    padding-bottom: 10px;
    border-bottom: 1px solid #8a8b8e;
}

.messenger-chat-header h5{
    text-overflow: ellipsis;
    overflow: hidden;
    width: 100%;
}

.messenger-chat {
    display: flex;
    flex-direction: column;
    height: 100%; /* Ensures the chat area takes the full height of its parent */
    overflow: hidden; /* Prevent any growth beyond the container */
    flex: 1;
}

.messenger-chat-body {
    flex-grow: 1; /* Allow it to take available space within its container */
    overflow-y: auto; /* Adds a scrollbar if content exceeds the height */
    max-height: 100%; /* Prevents it from growing beyond its parent's height */
    padding: 10px; /* Maintain consistent spacing inside */
    display: flex;
    flex-direction: column;
    gap: 10px;
    overflow-y: auto;
    height: 0;
}

.messenger-chat-item-me {
    display: flex;
    align-items: flex-end;
    justify-content: flex-end;
    gap: 10px;
}
.messenger-chat-item-you {
    display: flex;
    align-items: flex-end;
    justify-content: flex-start;
    gap: 10px;
}

.messenger-chat-item-avatar img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.flex-grow-1 {
    flex-grow: 1;
}


.messenger-chat-item-content {
    max-width: 70%;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #8a8b8e;
    font-size: 0.9rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}


.messenger-chat-item-content p {
    margin: 0;
}

.messenger-chat-footer {
    display: flex;
    gap: 10px;
    border-top: 1px solid #8a8b8e;
    padding-top: 10px;
}

.messenger-chat-footer input {
    flex: 1;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #8a8b8e;
    font-size: 1rem;
    outline: none;
    transition: border-color 0.3s ease-in-out;
}

.messenger-chat-footer input:focus {
    border-color: #93e8e1;
}

.messenger-chat-footer button {
    padding: 10px 20px;
    background-color: #93e8e1;
    color: #202020;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease-in-out;
}
.messenger-chat-footer button:focus {
    outline: none;
}


/* Responsive adjustments */
@media (max-width: 768px) {
    .messenger-inbox {
        width: 100%;
        max-width: unset;
        height: auto;
        border-right: none;
        border-bottom: 1px solid #ced4da;
    }

    .messenger-chat {
        height: auto;
    }
    .column-mobile{
        flex-direction: column;
        gap: 20px;
    }
    .messenger-chat-wrapper {
        border-top-left-radius: 5px;
        border-bottom-left-radius: 5px;
    }
    .messenger-inbox{
        border-right: 1px solid #8a8b8e;
        border-top-right-radius: 5px;
        border-bottom-right-radius: 5px;
    }
}

======================================================================
File: xian-web-wallet/css/codemirror.css
======================================================================
/* BASICS */

.CodeMirror {
  /* Set height, width, borders, and global font properties here */
  font-family: monospace;
  height: 300px;
  color: black;
  direction: ltr;
}

/* PADDING */

.CodeMirror-lines {
  padding: 4px 0; /* Vertical padding around content */
}
.CodeMirror pre.CodeMirror-line,
.CodeMirror pre.CodeMirror-line-like {
  padding: 0 4px; /* Horizontal padding of content */
}

.CodeMirror-scrollbar-filler, .CodeMirror-gutter-filler {
  background-color: white; /* The little square between H and V scrollbars */
}

/* GUTTER */

.CodeMirror-gutters {
  border-right: 1px solid #ddd;
  background-color: #f7f7f7;
  white-space: nowrap;
}
.CodeMirror-linenumbers {}
.CodeMirror-linenumber {
  padding: 0 3px 0 5px;
  min-width: 20px;
  text-align: right;
  color: #999;
  white-space: nowrap;
}

.CodeMirror-guttermarker { color: black; }
.CodeMirror-guttermarker-subtle { color: #999; }

/* CURSOR */

.CodeMirror-cursor {
  border-left: 1px solid black;
  border-right: none;
  width: 0;
}
/* Shown when moving in bi-directional text */
.CodeMirror div.CodeMirror-secondarycursor {
  border-left: 1px solid silver;
}
.cm-fat-cursor .CodeMirror-cursor {
  width: auto;
  border: 0 !important;
  background: #7e7;
}
.cm-fat-cursor div.CodeMirror-cursors {
  z-index: 1;
}
.cm-fat-cursor .CodeMirror-line::selection,
.cm-fat-cursor .CodeMirror-line > span::selection, 
.cm-fat-cursor .CodeMirror-line > span > span::selection { background: transparent; }
.cm-fat-cursor .CodeMirror-line::-moz-selection,
.cm-fat-cursor .CodeMirror-line > span::-moz-selection,
.cm-fat-cursor .CodeMirror-line > span > span::-moz-selection { background: transparent; }
.cm-fat-cursor { caret-color: transparent; }
@-moz-keyframes blink {
  0% {}
  50% { background-color: transparent; }
  100% {}
}
@-webkit-keyframes blink {
  0% {}
  50% { background-color: transparent; }
  100% {}
}
@keyframes blink {
  0% {}
  50% { background-color: transparent; }
  100% {}
}

/* Can style cursor different in overwrite (non-insert) mode */
.CodeMirror-overwrite .CodeMirror-cursor {}

.cm-tab { display: inline-block; text-decoration: inherit; }

.CodeMirror-rulers {
  position: absolute;
  left: 0; right: 0; top: -50px; bottom: 0;
  overflow: hidden;
}
.CodeMirror-ruler {
  border-left: 1px solid #ccc;
  top: 0; bottom: 0;
  position: absolute;
}

/* DEFAULT THEME */

.cm-s-default .cm-header {color: blue;}
.cm-s-default .cm-quote {color: #090;}
.cm-negative {color: #d44;}
.cm-positive {color: #292;}
.cm-header, .cm-strong {font-weight: bold;}
.cm-em {font-style: italic;}
.cm-link {text-decoration: underline;}
.cm-strikethrough {text-decoration: line-through;}

.cm-s-default .cm-keyword {color: #708;}
.cm-s-default .cm-atom {color: #219;}
.cm-s-default .cm-number {color: #164;}
.cm-s-default .cm-def {color: #00f;}
.cm-s-default .cm-variable,
.cm-s-default .cm-punctuation,
.cm-s-default .cm-property,
.cm-s-default .cm-operator {}
.cm-s-default .cm-variable-2 {color: #05a;}
.cm-s-default .cm-variable-3, .cm-s-default .cm-type {color: #085;}
.cm-s-default .cm-comment {color: #a50;}
.cm-s-default .cm-string {color: #a11;}
.cm-s-default .cm-string-2 {color: #f50;}
.cm-s-default .cm-meta {color: #555;}
.cm-s-default .cm-qualifier {color: #555;}
.cm-s-default .cm-builtin {color: #30a;}
.cm-s-default .cm-bracket {color: #997;}
.cm-s-default .cm-tag {color: #170;}
.cm-s-default .cm-attribute {color: #00c;}
.cm-s-default .cm-hr {color: #999;}
.cm-s-default .cm-link {color: #00c;}

.cm-s-default .cm-error {color: #f00;}
.cm-invalidchar {color: #f00;}

.CodeMirror-composing { border-bottom: 2px solid; }

/* Default styles for common addons */

div.CodeMirror span.CodeMirror-matchingbracket {color: #0b0;}
div.CodeMirror span.CodeMirror-nonmatchingbracket {color: #a22;}
.CodeMirror-matchingtag { background: rgba(255, 150, 0, .3); }
.CodeMirror-activeline-background {background: #e8f2ff;}

/* STOP */

/* The rest of this file contains styles related to the mechanics of
   the editor. You probably shouldn't touch them. */

.CodeMirror {
  position: relative;
  overflow: hidden;
  background: white;
}

.CodeMirror-scroll {
  overflow: scroll !important; /* Things will break if this is overridden */
  /* 50px is the magic margin used to hide the element's real scrollbars */
  /* See overflow: hidden in .CodeMirror */
  margin-bottom: -50px; margin-right: -50px;
  padding-bottom: 50px;
  height: 100%;
  outline: none; /* Prevent dragging from highlighting the element */
  position: relative;
  z-index: 0;
}
.CodeMirror-sizer {
  position: relative;
  border-right: 50px solid transparent;
}

/* The fake, visible scrollbars. Used to force redraw during scrolling
   before actual scrolling happens, thus preventing shaking and
   flickering artifacts. */
.CodeMirror-vscrollbar, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-gutter-filler {
  position: absolute;
  z-index: 6;
  display: none;
  outline: none;
}
.CodeMirror-vscrollbar {
  right: 0; top: 0;
  overflow-x: hidden;
  overflow-y: scroll;
}
.CodeMirror-hscrollbar {
  bottom: 0; left: 0;
  overflow-y: hidden;
  overflow-x: scroll;
}
.CodeMirror-scrollbar-filler {
  right: 0; bottom: 0;
}
.CodeMirror-gutter-filler {
  left: 0; bottom: 0;
}

.CodeMirror-gutters {
  position: absolute; left: 0; top: 0;
  min-height: 100%;
  z-index: 3;
}
.CodeMirror-gutter {
  white-space: normal;
  height: 100%;
  display: inline-block;
  vertical-align: top;
  margin-bottom: -50px;
}
.CodeMirror-gutter-wrapper {
  position: absolute;
  z-index: 4;
  background: none !important;
  border: none !important;
}
.CodeMirror-gutter-background {
  position: absolute;
  top: 0; bottom: 0;
  z-index: 4;
}
.CodeMirror-gutter-elt {
  position: absolute;
  cursor: default;
  z-index: 4;
}
.CodeMirror-gutter-wrapper ::selection { background-color: transparent }
.CodeMirror-gutter-wrapper ::-moz-selection { background-color: transparent }

.CodeMirror-lines {
  cursor: text;
  min-height: 1px; /* prevents collapsing before first draw */
}
.CodeMirror pre.CodeMirror-line,
.CodeMirror pre.CodeMirror-line-like {
  /* Reset some styles that the rest of the page might have set */
  -moz-border-radius: 0; -webkit-border-radius: 0; border-radius: 0;
  border-width: 0;
  background: transparent;
  font-family: inherit;
  font-size: inherit;
  margin: 0;
  white-space: pre;
  word-wrap: normal;
  line-height: inherit;
  color: inherit;
  z-index: 2;
  position: relative;
  overflow: visible;
  -webkit-tap-highlight-color: transparent;
  -webkit-font-variant-ligatures: contextual;
  font-variant-ligatures: contextual;
}
.CodeMirror-wrap pre.CodeMirror-line,
.CodeMirror-wrap pre.CodeMirror-line-like {
  word-wrap: break-word;
  white-space: pre-wrap;
  word-break: normal;
}

.CodeMirror-linebackground {
  position: absolute;
  left: 0; right: 0; top: 0; bottom: 0;
  z-index: 0;
}

.CodeMirror-linewidget {
  position: relative;
  z-index: 2;
  padding: 0.1px; /* Force widget margins to stay inside of the container */
}

.CodeMirror-widget {}

.CodeMirror-rtl pre { direction: rtl; }

.CodeMirror-code {
  outline: none;
}

/* Force content-box sizing for the elements where we expect it */
.CodeMirror-scroll,
.CodeMirror-sizer,
.CodeMirror-gutter,
.CodeMirror-gutters,
.CodeMirror-linenumber {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
}

.CodeMirror-measure {
  position: absolute;
  width: 100%;
  height: 0;
  overflow: hidden;
  visibility: hidden;
}

.CodeMirror-cursor {
  position: absolute;
  pointer-events: none;
}
.CodeMirror-measure pre { position: static; }

div.CodeMirror-cursors {
  visibility: hidden;
  position: relative;
  z-index: 3;
}
div.CodeMirror-dragcursors {
  visibility: visible;
}

.CodeMirror-focused div.CodeMirror-cursors {
  visibility: visible;
}

.CodeMirror-selected { background: #d9d9d9; }
.CodeMirror-focused .CodeMirror-selected { background: #d7d4f0; }
.CodeMirror-crosshair { cursor: crosshair; }
.CodeMirror-line::selection, .CodeMirror-line > span::selection, .CodeMirror-line > span > span::selection { background: #d7d4f0; }
.CodeMirror-line::-moz-selection, .CodeMirror-line > span::-moz-selection, .CodeMirror-line > span > span::-moz-selection { background: #d7d4f0; }

.cm-searching {
  background-color: #ffa;
  background-color: rgba(255, 255, 0, .4);
}

/* Used to force a border model for a node */
.cm-force-border { padding-right: .1px; }

@media print {
  /* Hide the cursor when printing */
  .CodeMirror div.CodeMirror-cursors {
    visibility: hidden;
  }
}

/* See issue #2901 */
.cm-tab-wrap-hack:after { content: ''; }

/* Help users use markselection to safely style text background */
span.CodeMirror-selectedtext { background: none; }

======================================================================
File: xian-web-wallet/css/style.css
======================================================================
:root {
    --blue: #ffffff;
    --indigo: #6610f2;
    --purple: #6f42c1;
    --pink: #e83e8c;
    --red: #dc3545;
    --orange: #fd7e14;
    --yellow: #ffc107;
    --green: #d4edda;
    --teal: #20c997;
    --cyan: #17a2b8;
    --white: #fff;
    --gray: #6c757d;
    --gray-dark: #343a40;
    --primary: #93e8e1;
    --secondary: #ffffff;
    --success: #d4edda;
    --info: #17a2b8;
    --warning: #ffc107;
    --danger: #dc3545;
    --light: #f8f9fa;
    --dark: #343a40;
    --breakpoint-xs: 0;
    --breakpoint-sm: 576px;
    --breakpoint-md: 768px;
    --breakpoint-lg: 992px;
    --breakpoint-xl: 1200px;
    --font-family-sans-serif: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    --font-family-monospace: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace
}

*,
::after,
::before {
    box-sizing: border-box
}

html {
    font-family: sans-serif;
    line-height: 1.15;
    -webkit-text-size-adjust: 100%;
    -webkit-tap-highlight-color: transparent
}

article,
aside,
figcaption,
figure,
footer,
header,
hgroup,
main,
nav,
section {
    display: block
}

body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    font-size: 1rem;
    font-weight: 400;
    line-height: 1.5;
    color: #212529;
    text-align: left;
    background-color: #fff
}

[tabindex="-1"]:focus:not(:focus-visible) {
    outline: 0 !important
}

hr {
    box-sizing: content-box;
    height: 0;
    overflow: visible
}

h1,
h2,
h3,
h4,
h5,
h6 {
    margin-top: 0;
    margin-bottom: .5rem
}

p {
    margin-top: 0;
    margin-bottom: 1rem
}

abbr[data-original-title],
abbr[title] {
    text-decoration: underline;
    text-decoration: underline dotted;
    cursor: help;
    border-bottom: 0;
    text-decoration-skip-ink: none
}

address {
    margin-bottom: 1rem;
    font-style: normal;
    line-height: inherit
}

dl,
ol,
ul {
    margin-top: 0;
    margin-bottom: 1rem
}

ol ol,
ol ul,
ul ol,
ul ul {
    margin-bottom: 0
}

dt {
    font-weight: 700
}

dd {
    margin-bottom: .5rem;
    margin-left: 0
}

blockquote {
    margin: 0 0 1rem
}

b,
strong {
    font-weight: bolder
}

small {
    font-size: 80%
}

sub,
sup {
    position: relative;
    font-size: 75%;
    line-height: 0;
    vertical-align: baseline
}

sub {
    bottom: -.25em
}

sup {
    top: -.5em
}

a {
    color: #93e8e1;
    text-decoration: none;
    background-color: transparent
}

a:hover {
    color: #e34902;
    text-decoration: underline
}

a:not([href]) {
    color: inherit;
    text-decoration: none
}

a:not([href]):hover {
    color: inherit;
    text-decoration: none
}

code,
kbd,
pre,
samp {
    font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 1em
}

pre {
    margin-top: 0;
    margin-bottom: 1rem;
    overflow: auto;
    -ms-overflow-style: scrollbar
}

figure {
    margin: 0 0 1rem
}

img {
    vertical-align: middle;
    border-style: none
}

svg {
    overflow: hidden;
    vertical-align: middle
}

table {
    border-collapse: collapse
}

caption {
    padding-top: .75rem;
    padding-bottom: .75rem;
    color: #6c757d;
    text-align: left;
    caption-side: bottom
}

th {
    text-align: inherit
}

label {
    display: inline-block;
    margin-bottom: .5rem
}

button {
    border-radius: 0
}

button:focus {
    outline: 1px dotted;
    outline: 5px auto -webkit-focus-ring-color
}

button,
input,
optgroup,
select,
textarea {
    margin: 0;
    font-family: inherit;
    font-size: inherit;
    line-height: inherit
}

button,
input {
    overflow: visible
}

button,
select {
    text-transform: none
}

[role=button] {
    cursor: pointer
}

select {
    word-wrap: normal
}

[type=button],
[type=reset],
[type=submit],
button {
    -webkit-appearance: button
}

[type=button]:not(:disabled),
[type=reset]:not(:disabled),
[type=submit]:not(:disabled),
button:not(:disabled) {
    cursor: pointer
}

[type=button]::-moz-focus-inner,
[type=reset]::-moz-focus-inner,
[type=submit]::-moz-focus-inner,
button::-moz-focus-inner {
    padding: 0;
    border-style: none
}

input[type=checkbox],
input[type=radio] {
    box-sizing: border-box;
    padding: 0
}

textarea {
    overflow: auto;
    resize: vertical
}

fieldset {
    min-width: 0;
    padding: 0;
    margin: 0;
    border: 0
}

legend {
    display: block;
    width: 100%;
    max-width: 100%;
    padding: 0;
    margin-bottom: .5rem;
    font-size: 1.5rem;
    line-height: inherit;
    color: inherit;
    white-space: normal
}

@media (max-width:1200px) {
    legend {
        font-size: calc(1.275rem + .3vw)
    }
}

progress {
    vertical-align: baseline
}

[type=number]::-webkit-inner-spin-button,
[type=number]::-webkit-outer-spin-button {
    height: auto
}

[type=search] {
    outline-offset: -2px;
    -webkit-appearance: none
}

[type=search]::-webkit-search-decoration {
    -webkit-appearance: none
}

::-webkit-file-upload-button {
    font: inherit;
    -webkit-appearance: button
}

output {
    display: inline-block
}

summary {
    display: list-item;
    cursor: pointer
}

template {
    display: none
}

[hidden] {
    display: none !important
}

.h1,
.h2,
.h3,
.h4,
.h5,
.h6,
h1,
h2,
h3,
h4,
h5,
h6 {
    margin-bottom: .5rem;
    font-weight: 500;
    line-height: 1.2
}

.h1,
h1 {
    font-size: 2.5rem
}

@media (max-width:1200px) {

    .h1,
    h1 {
        font-size: calc(1.375rem + 1.5vw)
    }
}

.h2,
h2 {
    font-size: 2rem
}

@media (max-width:1200px) {

    .h2,
    h2 {
        font-size: calc(1.325rem + .9vw)
    }
}

.h3,
h3 {
    font-size: 1.75rem
}

@media (max-width:1200px) {

    .h3,
    h3 {
        font-size: calc(1.3rem + .6vw)
    }
}

.h4,
h4 {
    font-size: 1.5rem
}

@media (max-width:1200px) {

    .h4,
    h4 {
        font-size: calc(1.275rem + .3vw)
    }
}

.h5,
h5 {
    font-size: 1.25rem
}

.h6,
h6 {
    font-size: 1rem
}

.lead {
    font-size: 1.25rem;
    font-weight: 300
}

.display-1 {
    font-size: 6rem;
    font-weight: 300;
    line-height: 1.2
}

@media (max-width:1200px) {
    .display-1 {
        font-size: calc(1.725rem + 5.7vw)
    }
}

.display-2 {
    font-size: 5.5rem;
    font-weight: 300;
    line-height: 1.2
}

@media (max-width:1200px) {
    .display-2 {
        font-size: calc(1.675rem + 5.1vw)
    }
}

.display-3 {
    font-size: 4.5rem;
    font-weight: 300;
    line-height: 1.2
}

@media (max-width:1200px) {
    .display-3 {
        font-size: calc(1.575rem + 3.9vw)
    }
}

.display-4 {
    font-size: 3.5rem;
    font-weight: 300;
    line-height: 1.2
}

@media (max-width:1200px) {
    .display-4 {
        font-size: calc(1.475rem + 2.7vw)
    }
}

hr {
    margin-top: 1rem;
    margin-bottom: 1rem;
    border: 0;
    border-top: 1px solid rgba(0, 0, 0, .1)
}

.small,
small {
    font-size: 80%;
    font-weight: 400
}

.mark,
mark {
    padding: .2em;
    background-color: #fcf8e3
}

.list-unstyled {
    padding-left: 0;
    list-style: none
}

.list-inline {
    padding-left: 0;
    list-style: none
}

.list-inline-item {
    display: inline-block
}

.list-inline-item:not(:last-child) {
    margin-right: .5rem
}

.initialism {
    font-size: 90%;
    text-transform: uppercase
}

.blockquote {
    margin-bottom: 1rem;
    font-size: 1.25rem
}

.blockquote-footer {
    display: block;
    font-size: 80%;
    color: #6c757d
}

.blockquote-footer::before {
    content: "\2014\00A0"
}

.img-fluid {
    max-width: 100%;
    height: auto
}

.img-thumbnail {
    padding: .25rem;
    background-color: #fff;
    border: 1px solid #dee2e6;
    border-radius: .25rem;
    max-width: 100%;
    height: auto
}

.figure {
    display: inline-block
}

.figure-img {
    margin-bottom: .5rem;
    line-height: 1
}

.figure-caption {
    font-size: 90%;
    color: #6c757d
}

code {
    font-size: 87.5%;
    color: #e83e8c;
    word-wrap: break-word
}

a>code {
    color: inherit
}

kbd {
    padding: .2rem .4rem;
    font-size: 87.5%;
    color: #fff;
    background-color: #212529;
    border-radius: .2rem
}

kbd kbd {
    padding: 0;
    font-size: 100%;
    font-weight: 700
}

pre {
    display: block;
    font-size: 87.5%;
    color: #212529
}

pre code {
    font-size: inherit;
    color: inherit;
    word-break: normal
}

.pre-scrollable {
    max-height: 340px;
    overflow-y: scroll
}

.container {
    width: 100%;
    padding-right: 15px;
    padding-left: 15px;
    margin-right: auto;
    margin-left: auto
}

@media (min-width:576px) {
    .container {
        max-width: 540px
    }
}

@media (min-width:768px) {
    .container {
        max-width: 720px
    }
}

@media (min-width:992px) {
    .container {
        max-width: 960px
    }
}

@media (min-width:1200px) {
    .container {
        max-width: 1140px
    }
}

.container-fluid,
.container-lg,
.container-md,
.container-sm,
.container-xl {
    width: 100%;
    padding-right: 15px;
    padding-left: 15px;
    margin-right: auto;
    margin-left: auto
}

@media (min-width:576px) {

    .container,
    .container-sm {
        max-width: 540px
    }
}

@media (min-width:768px) {

    .container,
    .container-md,
    .container-sm {
        max-width: 720px
    }
}

@media (min-width:992px) {

    .container,
    .container-lg,
    .container-md,
    .container-sm {
        max-width: 960px
    }
}

@media (min-width:1200px) {

    .container,
    .container-lg,
    .container-md,
    .container-sm,
    .container-xl {
        max-width: 1140px
    }
}

.row {
    display: flex;
    flex-wrap: wrap;
    margin-right: -15px;
    margin-left: -15px
}

.no-gutters {
    margin-right: 0;
    margin-left: 0
}

.no-gutters>.col,
.no-gutters>[class*=col-] {
    padding-right: 0;
    padding-left: 0
}

.col,
.col-1,
.col-10,
.col-11,
.col-12,
.col-2,
.col-3,
.col-4,
.col-5,
.col-6,
.col-7,
.col-8,
.col-9,
.col-auto,
.col-lg,
.col-lg-1,
.col-lg-10,
.col-lg-11,
.col-lg-12,
.col-lg-2,
.col-lg-3,
.col-lg-4,
.col-lg-5,
.col-lg-6,
.col-lg-7,
.col-lg-8,
.col-lg-9,
.col-lg-auto,
.col-md,
.col-md-1,
.col-md-10,
.col-md-11,
.col-md-12,
.col-md-2,
.col-md-3,
.col-md-4,
.col-md-5,
.col-md-6,
.col-md-7,
.col-md-8,
.col-md-9,
.col-md-auto,
.col-sm,
.col-sm-1,
.col-sm-10,
.col-sm-11,
.col-sm-12,
.col-sm-2,
.col-sm-3,
.col-sm-4,
.col-sm-5,
.col-sm-6,
.col-sm-7,
.col-sm-8,
.col-sm-9,
.col-sm-auto,
.col-xl,
.col-xl-1,
.col-xl-10,
.col-xl-11,
.col-xl-12,
.col-xl-2,
.col-xl-3,
.col-xl-4,
.col-xl-5,
.col-xl-6,
.col-xl-7,
.col-xl-8,
.col-xl-9,
.col-xl-auto {
    position: relative;
    width: 100%;
    padding-right: 15px;
    padding-left: 15px
}

.col {
    flex-basis: 0;
    flex-grow: 1;
    min-width: 0;
    max-width: 100%
}

.row-cols-1>* {
    flex: 0 0 100%;
    max-width: 100%
}

.row-cols-2>* {
    flex: 0 0 50%;
    max-width: 50%
}

.row-cols-3>* {
    flex: 0 0 33.33333%;
    max-width: 33.33333%
}

.row-cols-4>* {
    flex: 0 0 25%;
    max-width: 25%
}

.row-cols-5>* {
    flex: 0 0 20%;
    max-width: 20%
}

.row-cols-6>* {
    flex: 0 0 16.66667%;
    max-width: 16.66667%
}

.col-auto {
    flex: 0 0 auto;
    width: auto;
    max-width: 100%
}

.col-1 {
    flex: 0 0 8.33333%;
    max-width: 8.33333%
}

.col-2 {
    flex: 0 0 16.66667%;
    max-width: 16.66667%
}

.col-3 {
    flex: 0 0 25%;
    max-width: 25%
}

.col-4 {
    flex: 0 0 33.33333%;
    max-width: 33.33333%
}

.col-5 {
    flex: 0 0 41.66667%;
    max-width: 41.66667%
}

.col-6 {
    flex: 0 0 50%;
    max-width: 50%
}

.col-7 {
    flex: 0 0 58.33333%;
    max-width: 58.33333%
}

.col-8 {
    flex: 0 0 66.66667%;
    max-width: 66.66667%
}

.col-9 {
    flex: 0 0 75%;
    max-width: 75%
}

.col-10 {
    flex: 0 0 83.33333%;
    max-width: 83.33333%
}

.col-11 {
    flex: 0 0 91.66667%;
    max-width: 91.66667%
}

.col-12 {
    flex: 0 0 100%;
    max-width: 100%
}

.order-first {
    order: -1
}

.order-last {
    order: 13
}

.order-0 {
    order: 0
}

.order-1 {
    order: 1
}

.order-2 {
    order: 2
}

.order-3 {
    order: 3
}

.order-4 {
    order: 4
}

.order-5 {
    order: 5
}

.order-6 {
    order: 6
}

.order-7 {
    order: 7
}

.order-8 {
    order: 8
}

.order-9 {
    order: 9
}

.order-10 {
    order: 10
}

.order-11 {
    order: 11
}

.order-12 {
    order: 12
}

.offset-1 {
    margin-left: 8.33333%
}

.offset-2 {
    margin-left: 16.66667%
}

.offset-3 {
    margin-left: 25%
}

.offset-4 {
    margin-left: 33.33333%
}

.offset-5 {
    margin-left: 41.66667%
}

.offset-6 {
    margin-left: 50%
}

.offset-7 {
    margin-left: 58.33333%
}

.offset-8 {
    margin-left: 66.66667%
}

.offset-9 {
    margin-left: 75%
}

.offset-10 {
    margin-left: 83.33333%
}

.offset-11 {
    margin-left: 91.66667%
}

@media (min-width:576px) {
    .col-sm {
        flex-basis: 0;
        flex-grow: 1;
        min-width: 0;
        max-width: 100%
    }

    .row-cols-sm-1>* {
        flex: 0 0 100%;
        max-width: 100%
    }

    .row-cols-sm-2>* {
        flex: 0 0 50%;
        max-width: 50%
    }

    .row-cols-sm-3>* {
        flex: 0 0 33.33333%;
        max-width: 33.33333%
    }

    .row-cols-sm-4>* {
        flex: 0 0 25%;
        max-width: 25%
    }

    .row-cols-sm-5>* {
        flex: 0 0 20%;
        max-width: 20%
    }

    .row-cols-sm-6>* {
        flex: 0 0 16.66667%;
        max-width: 16.66667%
    }

    .col-sm-auto {
        flex: 0 0 auto;
        width: auto;
        max-width: 100%
    }

    .col-sm-1 {
        flex: 0 0 8.33333%;
        max-width: 8.33333%
    }

    .col-sm-2 {
        flex: 0 0 16.66667%;
        max-width: 16.66667%
    }

    .col-sm-3 {
        flex: 0 0 25%;
        max-width: 25%
    }

    .col-sm-4 {
        flex: 0 0 33.33333%;
        max-width: 33.33333%
    }

    .col-sm-5 {
        flex: 0 0 41.66667%;
        max-width: 41.66667%
    }

    .col-sm-6 {
        flex: 0 0 50%;
        max-width: 50%
    }

    .col-sm-7 {
        flex: 0 0 58.33333%;
        max-width: 58.33333%
    }

    .col-sm-8 {
        flex: 0 0 66.66667%;
        max-width: 66.66667%
    }

    .col-sm-9 {
        flex: 0 0 75%;
        max-width: 75%
    }

    .col-sm-10 {
        flex: 0 0 83.33333%;
        max-width: 83.33333%
    }

    .col-sm-11 {
        flex: 0 0 91.66667%;
        max-width: 91.66667%
    }

    .col-sm-12 {
        flex: 0 0 100%;
        max-width: 100%
    }

    .order-sm-first {
        order: -1
    }

    .order-sm-last {
        order: 13
    }

    .order-sm-0 {
        order: 0
    }

    .order-sm-1 {
        order: 1
    }

    .order-sm-2 {
        order: 2
    }

    .order-sm-3 {
        order: 3
    }

    .order-sm-4 {
        order: 4
    }

    .order-sm-5 {
        order: 5
    }

    .order-sm-6 {
        order: 6
    }

    .order-sm-7 {
        order: 7
    }

    .order-sm-8 {
        order: 8
    }

    .order-sm-9 {
        order: 9
    }

    .order-sm-10 {
        order: 10
    }

    .order-sm-11 {
        order: 11
    }

    .order-sm-12 {
        order: 12
    }

    .offset-sm-0 {
        margin-left: 0
    }

    .offset-sm-1 {
        margin-left: 8.33333%
    }

    .offset-sm-2 {
        margin-left: 16.66667%
    }

    .offset-sm-3 {
        margin-left: 25%
    }

    .offset-sm-4 {
        margin-left: 33.33333%
    }

    .offset-sm-5 {
        margin-left: 41.66667%
    }

    .offset-sm-6 {
        margin-left: 50%
    }

    .offset-sm-7 {
        margin-left: 58.33333%
    }

    .offset-sm-8 {
        margin-left: 66.66667%
    }

    .offset-sm-9 {
        margin-left: 75%
    }

    .offset-sm-10 {
        margin-left: 83.33333%
    }

    .offset-sm-11 {
        margin-left: 91.66667%
    }
}

@media (min-width:768px) {
    .col-md {
        flex-basis: 0;
        flex-grow: 1;
        min-width: 0;
        max-width: 100%
    }

    .row-cols-md-1>* {
        flex: 0 0 100%;
        max-width: 100%
    }

    .row-cols-md-2>* {
        flex: 0 0 50%;
        max-width: 50%
    }

    .row-cols-md-3>* {
        flex: 0 0 33.33333%;
        max-width: 33.33333%
    }

    .row-cols-md-4>* {
        flex: 0 0 25%;
        max-width: 25%
    }

    .row-cols-md-5>* {
        flex: 0 0 20%;
        max-width: 20%
    }

    .row-cols-md-6>* {
        flex: 0 0 16.66667%;
        max-width: 16.66667%
    }

    .col-md-auto {
        flex: 0 0 auto;
        width: auto;
        max-width: 100%
    }

    .col-md-1 {
        flex: 0 0 8.33333%;
        max-width: 8.33333%
    }

    .col-md-2 {
        flex: 0 0 16.66667%;
        max-width: 16.66667%
    }

    .col-md-3 {
        flex: 0 0 25%;
        max-width: 25%
    }

    .col-md-4 {
        flex: 0 0 33.33333%;
        max-width: 33.33333%
    }

    .col-md-5 {
        flex: 0 0 41.66667%;
        max-width: 41.66667%
    }

    .col-md-6 {
        flex: 0 0 50%;
        max-width: 50%
    }

    .col-md-7 {
        flex: 0 0 58.33333%;
        max-width: 58.33333%
    }

    .col-md-8 {
        flex: 0 0 66.66667%;
        max-width: 66.66667%
    }

    .col-md-9 {
        flex: 0 0 75%;
        max-width: 75%
    }

    .col-md-10 {
        flex: 0 0 83.33333%;
        max-width: 83.33333%
    }

    .col-md-11 {
        flex: 0 0 91.66667%;
        max-width: 91.66667%
    }

    .col-md-12 {
        flex: 0 0 100%;
        max-width: 100%
    }

    .order-md-first {
        order: -1
    }

    .order-md-last {
        order: 13
    }

    .order-md-0 {
        order: 0
    }

    .order-md-1 {
        order: 1
    }

    .order-md-2 {
        order: 2
    }

    .order-md-3 {
        order: 3
    }

    .order-md-4 {
        order: 4
    }

    .order-md-5 {
        order: 5
    }

    .order-md-6 {
        order: 6
    }

    .order-md-7 {
        order: 7
    }

    .order-md-8 {
        order: 8
    }

    .order-md-9 {
        order: 9
    }

    .order-md-10 {
        order: 10
    }

    .order-md-11 {
        order: 11
    }

    .order-md-12 {
        order: 12
    }

    .offset-md-0 {
        margin-left: 0
    }

    .offset-md-1 {
        margin-left: 8.33333%
    }

    .offset-md-2 {
        margin-left: 16.66667%
    }

    .offset-md-3 {
        margin-left: 25%
    }

    .offset-md-4 {
        margin-left: 33.33333%
    }

    .offset-md-5 {
        margin-left: 41.66667%
    }

    .offset-md-6 {
        margin-left: 50%
    }

    .offset-md-7 {
        margin-left: 58.33333%
    }

    .offset-md-8 {
        margin-left: 66.66667%
    }

    .offset-md-9 {
        margin-left: 75%
    }

    .offset-md-10 {
        margin-left: 83.33333%
    }

    .offset-md-11 {
        margin-left: 91.66667%
    }
}

@media (min-width:992px) {
    .col-lg {
        flex-basis: 0;
        flex-grow: 1;
        min-width: 0;
        max-width: 100%
    }

    .row-cols-lg-1>* {
        flex: 0 0 100%;
        max-width: 100%
    }

    .row-cols-lg-2>* {
        flex: 0 0 50%;
        max-width: 50%
    }

    .row-cols-lg-3>* {
        flex: 0 0 33.33333%;
        max-width: 33.33333%
    }

    .row-cols-lg-4>* {
        flex: 0 0 25%;
        max-width: 25%
    }

    .row-cols-lg-5>* {
        flex: 0 0 20%;
        max-width: 20%
    }

    .row-cols-lg-6>* {
        flex: 0 0 16.66667%;
        max-width: 16.66667%
    }

    .col-lg-auto {
        flex: 0 0 auto;
        width: auto;
        max-width: 100%
    }

    .col-lg-1 {
        flex: 0 0 8.33333%;
        max-width: 8.33333%
    }

    .col-lg-2 {
        flex: 0 0 16.66667%;
        max-width: 16.66667%
    }

    .col-lg-3 {
        flex: 0 0 25%;
        max-width: 25%
    }

    .col-lg-4 {
        flex: 0 0 33.33333%;
        max-width: 33.33333%
    }

    .col-lg-5 {
        flex: 0 0 41.66667%;
        max-width: 41.66667%
    }

    .col-lg-6 {
        flex: 0 0 50%;
        max-width: 50%
    }

    .col-lg-7 {
        flex: 0 0 58.33333%;
        max-width: 58.33333%
    }

    .col-lg-8 {
        flex: 0 0 66.66667%;
        max-width: 66.66667%
    }

    .col-lg-9 {
        flex: 0 0 75%;
        max-width: 75%
    }

    .col-lg-10 {
        flex: 0 0 83.33333%;
        max-width: 83.33333%
    }

    .col-lg-11 {
        flex: 0 0 91.66667%;
        max-width: 91.66667%
    }

    .col-lg-12 {
        flex: 0 0 100%;
        max-width: 100%
    }

    .order-lg-first {
        order: -1
    }

    .order-lg-last {
        order: 13
    }

    .order-lg-0 {
        order: 0
    }

    .order-lg-1 {
        order: 1
    }

    .order-lg-2 {
        order: 2
    }

    .order-lg-3 {
        order: 3
    }

    .order-lg-4 {
        order: 4
    }

    .order-lg-5 {
        order: 5
    }

    .order-lg-6 {
        order: 6
    }

    .order-lg-7 {
        order: 7
    }

    .order-lg-8 {
        order: 8
    }

    .order-lg-9 {
        order: 9
    }

    .order-lg-10 {
        order: 10
    }

    .order-lg-11 {
        order: 11
    }

    .order-lg-12 {
        order: 12
    }

    .offset-lg-0 {
        margin-left: 0
    }

    .offset-lg-1 {
        margin-left: 8.33333%
    }

    .offset-lg-2 {
        margin-left: 16.66667%
    }

    .offset-lg-3 {
        margin-left: 25%
    }

    .offset-lg-4 {
        margin-left: 33.33333%
    }

    .offset-lg-5 {
        margin-left: 41.66667%
    }

    .offset-lg-6 {
        margin-left: 50%
    }

    .offset-lg-7 {
        margin-left: 58.33333%
    }

    .offset-lg-8 {
        margin-left: 66.66667%
    }

    .offset-lg-9 {
        margin-left: 75%
    }

    .offset-lg-10 {
        margin-left: 83.33333%
    }

    .offset-lg-11 {
        margin-left: 91.66667%
    }
}

@media (min-width:1200px) {
    .col-xl {
        flex-basis: 0;
        flex-grow: 1;
        min-width: 0;
        max-width: 100%
    }

    .row-cols-xl-1>* {
        flex: 0 0 100%;
        max-width: 100%
    }

    .row-cols-xl-2>* {
        flex: 0 0 50%;
        max-width: 50%
    }

    .row-cols-xl-3>* {
        flex: 0 0 33.33333%;
        max-width: 33.33333%
    }

    .row-cols-xl-4>* {
        flex: 0 0 25%;
        max-width: 25%
    }

    .row-cols-xl-5>* {
        flex: 0 0 20%;
        max-width: 20%
    }

    .row-cols-xl-6>* {
        flex: 0 0 16.66667%;
        max-width: 16.66667%
    }

    .col-xl-auto {
        flex: 0 0 auto;
        width: auto;
        max-width: 100%
    }

    .col-xl-1 {
        flex: 0 0 8.33333%;
        max-width: 8.33333%
    }

    .col-xl-2 {
        flex: 0 0 16.66667%;
        max-width: 16.66667%
    }

    .col-xl-3 {
        flex: 0 0 25%;
        max-width: 25%
    }

    .col-xl-4 {
        flex: 0 0 33.33333%;
        max-width: 33.33333%
    }

    .col-xl-5 {
        flex: 0 0 41.66667%;
        max-width: 41.66667%
    }

    .col-xl-6 {
        flex: 0 0 50%;
        max-width: 50%
    }

    .col-xl-7 {
        flex: 0 0 58.33333%;
        max-width: 58.33333%
    }

    .col-xl-8 {
        flex: 0 0 66.66667%;
        max-width: 66.66667%
    }

    .col-xl-9 {
        flex: 0 0 75%;
        max-width: 75%
    }

    .col-xl-10 {
        flex: 0 0 83.33333%;
        max-width: 83.33333%
    }

    .col-xl-11 {
        flex: 0 0 91.66667%;
        max-width: 91.66667%
    }

    .col-xl-12 {
        flex: 0 0 100%;
        max-width: 100%
    }

    .order-xl-first {
        order: -1
    }

    .order-xl-last {
        order: 13
    }

    .order-xl-0 {
        order: 0
    }

    .order-xl-1 {
        order: 1
    }

    .order-xl-2 {
        order: 2
    }

    .order-xl-3 {
        order: 3
    }

    .order-xl-4 {
        order: 4
    }

    .order-xl-5 {
        order: 5
    }

    .order-xl-6 {
        order: 6
    }

    .order-xl-7 {
        order: 7
    }

    .order-xl-8 {
        order: 8
    }

    .order-xl-9 {
        order: 9
    }

    .order-xl-10 {
        order: 10
    }

    .order-xl-11 {
        order: 11
    }

    .order-xl-12 {
        order: 12
    }

    .offset-xl-0 {
        margin-left: 0
    }

    .offset-xl-1 {
        margin-left: 8.33333%
    }

    .offset-xl-2 {
        margin-left: 16.66667%
    }

    .offset-xl-3 {
        margin-left: 25%
    }

    .offset-xl-4 {
        margin-left: 33.33333%
    }

    .offset-xl-5 {
        margin-left: 41.66667%
    }

    .offset-xl-6 {
        margin-left: 50%
    }

    .offset-xl-7 {
        margin-left: 58.33333%
    }

    .offset-xl-8 {
        margin-left: 66.66667%
    }

    .offset-xl-9 {
        margin-left: 75%
    }

    .offset-xl-10 {
        margin-left: 83.33333%
    }

    .offset-xl-11 {
        margin-left: 91.66667%
    }
}

.table {
    width: 100%;
    margin-bottom: 1rem;
    color: #212529
}

.table td,
.table th {
    padding: .75rem;
    vertical-align: top;
    border-top: 1px solid #dee2e6
}

.table thead th {
    vertical-align: bottom;
    border-bottom: 2px solid #dee2e6
}

.table tbody+tbody {
    border-top: 2px solid #dee2e6
}

.table-sm td,
.table-sm th {
    padding: .3rem
}

.table-bordered {
    border: 1px solid #dee2e6
}

.table-bordered td,
.table-bordered th {
    border: 1px solid #dee2e6
}

.table-bordered thead td,
.table-bordered thead th {
    border-bottom-width: 2px
}

.table-borderless tbody+tbody,
.table-borderless td,
.table-borderless th,
.table-borderless thead th {
    border: 0
}

.table-striped tbody tr:nth-of-type(odd) {
    background-color: rgba(0, 0, 0, .05)
}

.table-hover tbody tr:hover {
    color: #212529;
    background-color: rgba(0, 0, 0, .075)
}

.table-primary,
.table-primary>td,
.table-primary>th {
    background-color: #fed8c6
}

.table-primary tbody+tbody,
.table-primary td,
.table-primary th,
.table-primary thead th {
    border-color: #feb796
}

.table-hover .table-primary:hover {
    background-color: #fec7ad
}

.table-hover .table-primary:hover>td,
.table-hover .table-primary:hover>th {
    background-color: #fec7ad
}

.table-secondary,
.table-secondary>td,
.table-secondary>th {
    background-color: #b8daff
}

.table-secondary tbody+tbody,
.table-secondary td,
.table-secondary th,
.table-secondary thead th {
    border-color: #7abaff
}

.table-hover .table-secondary:hover {
    background-color: #9fcdff
}

.table-hover .table-secondary:hover>td,
.table-hover .table-secondary:hover>th {
    background-color: #9fcdff
}

.table-success,
.table-success>td,
.table-success>th {
    background-color: #c3e6cb
}

.table-success tbody+tbody,
.table-success td,
.table-success th,
.table-success thead th {
    border-color: #8fd19e
}

.table-hover .table-success:hover {
    background-color: #b1dfbb
}

.table-hover .table-success:hover>td,
.table-hover .table-success:hover>th {
    background-color: #b1dfbb
}

.table-info,
.table-info>td,
.table-info>th {
    background-color: #bee5eb
}

.table-info tbody+tbody,
.table-info td,
.table-info th,
.table-info thead th {
    border-color: #86cfda
}

.table-hover .table-info:hover {
    background-color: #abdde5
}

.table-hover .table-info:hover>td,
.table-hover .table-info:hover>th {
    background-color: #abdde5
}

.table-warning,
.table-warning>td,
.table-warning>th {
    background-color: #ffeeba
}

.table-warning tbody+tbody,
.table-warning td,
.table-warning th,
.table-warning thead th {
    border-color: #ffdf7e
}

.table-hover .table-warning:hover {
    background-color: #ffe8a1
}

.table-hover .table-warning:hover>td,
.table-hover .table-warning:hover>th {
    background-color: #ffe8a1
}

.table-danger,
.table-danger>td,
.table-danger>th {
    background-color: #f5c6cb
}

.table-danger tbody+tbody,
.table-danger td,
.table-danger th,
.table-danger thead th {
    border-color: #ed969e
}

.table-hover .table-danger:hover {
    background-color: #f1b0b7
}

.table-hover .table-danger:hover>td,
.table-hover .table-danger:hover>th {
    background-color: #f1b0b7
}

.table-light,
.table-light>td,
.table-light>th {
    background-color: #fdfdfe
}

.table-light tbody+tbody,
.table-light td,
.table-light th,
.table-light thead th {
    border-color: #fbfcfc
}

.table-hover .table-light:hover {
    background-color: #ececf6
}

.table-hover .table-light:hover>td,
.table-hover .table-light:hover>th {
    background-color: #ececf6
}

.table-dark,
.table-dark>td,
.table-dark>th {
    background-color: #c6c8ca
}

.table-dark tbody+tbody,
.table-dark td,
.table-dark th,
.table-dark thead th {
    border-color: #95999c
}

.table-hover .table-dark:hover {
    background-color: #b9bbbe
}

.table-hover .table-dark:hover>td,
.table-hover .table-dark:hover>th {
    background-color: #b9bbbe
}

.table-active,
.table-active>td,
.table-active>th {
    background-color: rgba(0, 0, 0, .075)
}

.table-hover .table-active:hover {
    background-color: rgba(0, 0, 0, .075)
}

.table-hover .table-active:hover>td,
.table-hover .table-active:hover>th {
    background-color: rgba(0, 0, 0, .075)
}

.table .thead-dark th {
    color: #fff;
    background-color: #343a40;
    border-color: #454d55
}

.table .thead-light th {
    color: #495057;
    background-color: #e9ecef;
    border-color: #dee2e6
}

.table-dark {
    color: #fff;
    background-color: #343a40
}

.table-dark td,
.table-dark th,
.table-dark thead th {
    border-color: #454d55
}

.table-dark.table-bordered {
    border: 0
}

.table-dark.table-striped tbody tr:nth-of-type(odd) {
    background-color: rgba(255, 255, 255, .05)
}

.table-dark.table-hover tbody tr:hover {
    color: #fff;
    background-color: rgba(255, 255, 255, .075)
}

@media (max-width:575.98px) {
    .table-responsive-sm {
        display: block;
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch
    }

    .table-responsive-sm>.table-bordered {
        border: 0
    }
}

@media (max-width:767.98px) {
    .table-responsive-md {
        display: block;
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch
    }

    .table-responsive-md>.table-bordered {
        border: 0
    }
}

@media (max-width:991.98px) {
    .table-responsive-lg {
        display: block;
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch
    }

    .table-responsive-lg>.table-bordered {
        border: 0
    }
}

@media (max-width:1199.98px) {
    .table-responsive-xl {
        display: block;
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch
    }

    .table-responsive-xl>.table-bordered {
        border: 0
    }
}

.table-responsive {
    display: block;
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch
}

.table-responsive>.table-bordered {
    border: 0
}

.form-control {
    display: block;
    width: 100%;
    height: calc(1.5em + .75rem + 2px);
    padding: .375rem .75rem;
    font-size: 1rem;
    font-weight: 400;
    line-height: 1.5;
    color: #495057;
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid #ced4da;
    border-radius: .25rem;
    transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out
}

@media (prefers-reduced-motion:reduce) {
    .form-control {
        transition: none
    }
}

.form-control::-ms-expand {
    background-color: transparent;
    border: 0
}

.form-control:-moz-focusring {
    color: transparent;
    text-shadow: 0 0 0 #495057
}

.form-control:focus {
    color: #495057;
    background-color: #fff;
    border-color: #93e8e1;
    outline: 0;
    
}

.form-control::placeholder {
    color: #6c757d;
    opacity: 1
}

.form-control:disabled,
.form-control[readonly] {
    background-color: #e9ecef;
    opacity: 1
}

input[type=date].form-control,
input[type=datetime-local].form-control,
input[type=month].form-control,
input[type=time].form-control {
    appearance: none
}

select.form-control:focus::-ms-value {
    color: #495057;
    background-color: #fff
}

.form-control-file,
.form-control-range {
    display: block;
    width: 100%
}

.col-form-label {
    padding-top: calc(.375rem + 1px);
    padding-bottom: calc(.375rem + 1px);
    margin-bottom: 0;
    font-size: inherit;
    line-height: 1.5
}

.col-form-label-lg {
    padding-top: calc(.5rem + 1px);
    padding-bottom: calc(.5rem + 1px);
    font-size: 1.25rem;
    line-height: 1.5
}

.col-form-label-sm {
    padding-top: calc(.25rem + 1px);
    padding-bottom: calc(.25rem + 1px);
    font-size: .875rem;
    line-height: 1.5
}

.form-control-plaintext {
    display: block;
    width: 100%;
    padding: .375rem 0;
    margin-bottom: 0;
    font-size: 1rem;
    line-height: 1.5;
    color: #212529;
    background-color: transparent;
    border: solid transparent;
    border-width: 1px 0
}

.form-control-plaintext.form-control-lg,
.form-control-plaintext.form-control-sm {
    padding-right: 0;
    padding-left: 0
}

.form-control-sm {
    height: calc(1.5em + .5rem + 2px);
    padding: .25rem .5rem;
    font-size: .875rem;
    line-height: 1.5;
    border-radius: .2rem
}

.form-control-lg {
    height: calc(1.5em + 1rem + 2px);
    padding: .5rem 1rem;
    font-size: 1.25rem;
    line-height: 1.5;
    border-radius: .3rem
}

select.form-control[multiple],
select.form-control[size] {
    height: auto
}

textarea.form-control {
    height: auto
}

.form-group {
    margin-bottom: 1rem
}

.form-text {
    display: block;
    margin-top: .25rem
}

.form-row {
    display: flex;
    flex-wrap: wrap;
    margin-right: -5px;
    margin-left: -5px
}

.form-row>.col,
.form-row>[class*=col-] {
    padding-right: 5px;
    padding-left: 5px
}

.form-check {
    position: relative;
    display: block;
    padding-left: 1.25rem
}

.form-check-input {
    position: absolute;
    margin-top: .3rem;
    margin-left: -1.25rem
}

.form-check-input:disabled~.form-check-label,
.form-check-input[disabled]~.form-check-label {
    color: #6c757d
}

.form-check-label {
    margin-bottom: 0
}

.form-check-inline {
    display: inline-flex;
    align-items: center;
    padding-left: 0;
    margin-right: .75rem
}

.form-check-inline .form-check-input {
    position: static;
    margin-top: 0;
    margin-right: .3125rem;
    margin-left: 0
}

.valid-feedback {
    display: none;
    width: 100%;
    margin-top: .25rem;
    font-size: 80%;
    color: #d4edda
}

.valid-tooltip {
    position: absolute;
    top: 100%;
    z-index: 5;
    display: none;
    max-width: 100%;
    padding: .25rem .5rem;
    margin-top: .1rem;
    font-size: .875rem;
    line-height: 1.5;
    color: #fff;
    background-color: rgba(40, 167, 69, .9);
    border-radius: .25rem
}

.is-valid~.valid-feedback,
.is-valid~.valid-tooltip,
.was-validated :valid~.valid-feedback,
.was-validated :valid~.valid-tooltip {
    display: block
}

.form-control.is-valid,
.was-validated .form-control:valid {
    border-color: #d4edda;
    padding-right: calc(1.5em + .75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 8 8'%3e%3cpath fill='%2328a745' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(.375em + .1875rem) center;
    background-size: calc(.75em + .375rem) calc(.75em + .375rem)
}

.form-control.is-valid:focus,
.was-validated .form-control:valid:focus {
    border-color: #d4edda;
    box-shadow: 0 0 0 .2rem rgba(40, 167, 69, .25)
}

.was-validated textarea.form-control:valid,
textarea.form-control.is-valid {
    padding-right: calc(1.5em + .75rem);
    background-position: top calc(.375em + .1875rem) right calc(.375em + .1875rem)
}

.custom-select.is-valid,
.was-validated .custom-select:valid {
    border-color: #d4edda;
    padding-right: calc(.75em + 2.3125rem);
    background: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='4' height='5' viewBox='0 0 4 5'%3e%3cpath fill='%23343a40' d='M2 0L0 2h4zm0 5L0 3h4z'/%3e%3c/svg%3e") no-repeat right .75rem center/8px 10px, url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 8 8'%3e%3cpath fill='%2328a745' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e") #fff no-repeat center right 1.75rem/calc(.75em + .375rem) calc(.75em + .375rem)
}

.custom-select.is-valid:focus,
.was-validated .custom-select:valid:focus {
    border-color: #d4edda;
    box-shadow: 0 0 0 .2rem rgba(40, 167, 69, .25)
}

.form-check-input.is-valid~.form-check-label,
.was-validated .form-check-input:valid~.form-check-label {
    color: #d4edda
}

.form-check-input.is-valid~.valid-feedback,
.form-check-input.is-valid~.valid-tooltip,
.was-validated .form-check-input:valid~.valid-feedback,
.was-validated .form-check-input:valid~.valid-tooltip {
    display: block
}

.custom-control-input.is-valid~.custom-control-label,
.was-validated .custom-control-input:valid~.custom-control-label {
    color: #d4edda
}

.custom-control-input.is-valid~.custom-control-label::before,
.was-validated .custom-control-input:valid~.custom-control-label::before {
    border-color: #d4edda
}

.custom-control-input.is-valid:checked~.custom-control-label::before,
.was-validated .custom-control-input:valid:checked~.custom-control-label::before {
    border-color: #34ce57;
    background-color: #34ce57
}

.custom-control-input.is-valid:focus~.custom-control-label::before,
.was-validated .custom-control-input:valid:focus~.custom-control-label::before {
    box-shadow: 0 0 0 .2rem rgba(40, 167, 69, .25)
}

.custom-control-input.is-valid:focus:not(:checked)~.custom-control-label::before,
.was-validated .custom-control-input:valid:focus:not(:checked)~.custom-control-label::before {
    border-color: #d4edda
}

.custom-file-input.is-valid~.custom-file-label,
.was-validated .custom-file-input:valid~.custom-file-label {
    border-color: #d4edda
}

.custom-file-input.is-valid:focus~.custom-file-label,
.was-validated .custom-file-input:valid:focus~.custom-file-label {
    border-color: #d4edda;
    box-shadow: 0 0 0 .2rem rgba(40, 167, 69, .25)
}

.invalid-feedback {
    display: none;
    width: 100%;
    margin-top: .25rem;
    font-size: 80%;
    color: #dc3545
}

.invalid-tooltip {
    position: absolute;
    top: 100%;
    z-index: 5;
    display: none;
    max-width: 100%;
    padding: .25rem .5rem;
    margin-top: .1rem;
    font-size: .875rem;
    line-height: 1.5;
    color: #fff;
    background-color: rgba(220, 53, 69, .9);
    border-radius: .25rem
}

.is-invalid~.invalid-feedback,
.is-invalid~.invalid-tooltip,
.was-validated :invalid~.invalid-feedback,
.was-validated :invalid~.invalid-tooltip {
    display: block
}

.form-control.is-invalid,
.was-validated .form-control:invalid {
    border-color: #dc3545;
    padding-right: calc(1.5em + .75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='none' stroke='%23dc3545' viewBox='0 0 12 12'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(.375em + .1875rem) center;
    background-size: calc(.75em + .375rem) calc(.75em + .375rem)
}

.form-control.is-invalid:focus,
.was-validated .form-control:invalid:focus {
    border-color: #dc3545;
    box-shadow: 0 0 0 .2rem rgba(220, 53, 69, .25)
}

.was-validated textarea.form-control:invalid,
textarea.form-control.is-invalid {
    padding-right: calc(1.5em + .75rem);
    background-position: top calc(.375em + .1875rem) right calc(.375em + .1875rem)
}

.custom-select.is-invalid,
.was-validated .custom-select:invalid {
    border-color: #dc3545;
    padding-right: calc(.75em + 2.3125rem);
    background: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='4' height='5' viewBox='0 0 4 5'%3e%3cpath fill='%23343a40' d='M2 0L0 2h4zm0 5L0 3h4z'/%3e%3c/svg%3e") no-repeat right .75rem center/8px 10px, url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='none' stroke='%23dc3545' viewBox='0 0 12 12'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e") #fff no-repeat center right 1.75rem/calc(.75em + .375rem) calc(.75em + .375rem)
}

.custom-select.is-invalid:focus,
.was-validated .custom-select:invalid:focus {
    border-color: #dc3545;
    box-shadow: 0 0 0 .2rem rgba(220, 53, 69, .25)
}

.form-check-input.is-invalid~.form-check-label,
.was-validated .form-check-input:invalid~.form-check-label {
    color: #dc3545
}

.form-check-input.is-invalid~.invalid-feedback,
.form-check-input.is-invalid~.invalid-tooltip,
.was-validated .form-check-input:invalid~.invalid-feedback,
.was-validated .form-check-input:invalid~.invalid-tooltip {
    display: block
}

.custom-control-input.is-invalid~.custom-control-label,
.was-validated .custom-control-input:invalid~.custom-control-label {
    color: #dc3545
}

.custom-control-input.is-invalid~.custom-control-label::before,
.was-validated .custom-control-input:invalid~.custom-control-label::before {
    border-color: #dc3545
}

.custom-control-input.is-invalid:checked~.custom-control-label::before,
.was-validated .custom-control-input:invalid:checked~.custom-control-label::before {
    border-color: #e4606d;
    background-color: #e4606d
}

.custom-control-input.is-invalid:focus~.custom-control-label::before,
.was-validated .custom-control-input:invalid:focus~.custom-control-label::before {
    box-shadow: 0 0 0 .2rem rgba(220, 53, 69, .25)
}

.custom-control-input.is-invalid:focus:not(:checked)~.custom-control-label::before,
.was-validated .custom-control-input:invalid:focus:not(:checked)~.custom-control-label::before {
    border-color: #dc3545
}

.custom-file-input.is-invalid~.custom-file-label,
.was-validated .custom-file-input:invalid~.custom-file-label {
    border-color: #dc3545
}

.custom-file-input.is-invalid:focus~.custom-file-label,
.was-validated .custom-file-input:invalid:focus~.custom-file-label {
    border-color: #dc3545;
    box-shadow: 0 0 0 .2rem rgba(220, 53, 69, .25)
}

.form-inline {
    display: flex;
    flex-flow: row wrap;
    align-items: center
}

.form-inline .form-check {
    width: 100%
}

@media (min-width:576px) {
    .form-inline label {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0
    }

    .form-inline .form-group {
        display: flex;
        flex: 0 0 auto;
        flex-flow: row wrap;
        align-items: center;
        margin-bottom: 0
    }

    .form-inline .form-control {
        display: inline-block;
        width: auto;
        vertical-align: middle
    }

    .form-inline .form-control-plaintext {
        display: inline-block
    }

    .form-inline .custom-select,
    .form-inline .input-group {
        width: auto
    }

    .form-inline .form-check {
        display: flex;
        align-items: center;
        justify-content: center;
        width: auto;
        padding-left: 0
    }

    .form-inline .form-check-input {
        position: relative;
        flex-shrink: 0;
        margin-top: 0;
        margin-right: .25rem;
        margin-left: 0
    }

    .form-inline .custom-control {
        align-items: center;
        justify-content: center
    }

    .form-inline .custom-control-label {
        margin-bottom: 0
    }
}

.btn {
    display: inline-block;
    font-weight: 400;
    color: #212529;
    text-align: center;
    vertical-align: middle;
    user-select: none;
    background-color: transparent;
    border: 1px solid transparent;
    padding: .375rem .75rem;
    font-size: 1rem;
    line-height: 1.5;
    border-radius: .25rem;
    transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out
}

@media (prefers-reduced-motion:reduce) {
    .btn {
        transition: none
    }
}

.btn:hover {
    color: #212529;
    text-decoration: none
}

.btn.focus,
.btn:focus {
    outline: 0;
    
}

.btn.disabled,
.btn:disabled {
    opacity: .65
}

.btn:not(:disabled):not(.disabled) {
    cursor: pointer
}

a.btn.disabled,
fieldset:disabled a.btn {
    pointer-events: none
}

.btn-primary {
    color: #fff;
    background-color: #93e8e1;
    border-color: #93e8e1
}

.btn-primary:hover {
    color: #202020;
    background-color: #93e8e1;
    border-color: #93e8e1
}

.btn-primary.focus,
.btn-primary:focus {
    color: #202020;
    background-color: #93e8e1;
    border-color: #93e8e1;
}

.btn-primary.disabled,
.btn-primary:disabled {
    color: #202020;
    background-color: #93e8e1;
    border-color: #93e8e1
}

.btn-primary:not(:disabled):not(.disabled).active,
.btn-primary:not(:disabled):not(.disabled):active,
.show>.btn-primary.dropdown-toggle {
    color: #202020;
    background-color: #93e8e1;
    border-color: #93e8e1
}

.btn-primary:not(:disabled):not(.disabled).active:focus,
.btn-primary:not(:disabled):not(.disabled):active:focus,
.show>.btn-primary.dropdown-toggle:focus {
}

.btn-secondary {
    color: #202020;
    background-color: #ffffff;
    border-color: #ffffff
}

.btn-secondary:hover {
    color: #202020;
    background-color: #fff;
    border-color: #fff
}

.btn-secondary.focus,
.btn-secondary:focus {
    color: #202020;
    background-color: #fff;
    border-color: #fff;
    box-shadow: 0 0 0 .2rem rgba(38, 143, 255, .5)
}

.btn-secondary.disabled,
.btn-secondary:disabled {
    color: #202020;
    background-color: #ffffff;
    border-color: #ffffff
}

.btn-secondary:not(:disabled):not(.disabled).active,
.btn-secondary:not(:disabled):not(.disabled):active,
.show>.btn-secondary.dropdown-toggle {
    color: #202020;
    background-color: #fff;
    border-color: #fff;
}

.btn-secondary:not(:disabled):not(.disabled).active:focus,
.btn-secondary:not(:disabled):not(.disabled):active:focus,
.show>.btn-secondary.dropdown-toggle:focus {
    box-shadow: 0 0 0 .2rem rgba(38, 143, 255, .5)
}

.btn-success {
    color: #fff;
    background-color: #d4edda;
    border-color: #d4edda
}

.btn-success:hover {
    color: #fff;
    background-color: #218838;
    border-color: #1e7e34
}

.btn-success.focus,
.btn-success:focus {
    color: #fff;
    background-color: #218838;
    border-color: #1e7e34;
    box-shadow: 0 0 0 .2rem rgba(72, 180, 97, .5)
}

.btn-success.disabled,
.btn-success:disabled {
    color: #fff;
    background-color: #d4edda;
    border-color: #d4edda
}

.btn-success:not(:disabled):not(.disabled).active,
.btn-success:not(:disabled):not(.disabled):active,
.show>.btn-success.dropdown-toggle {
    color: #fff;
    background-color: #1e7e34;
    border-color: #1c7430
}

.btn-success:not(:disabled):not(.disabled).active:focus,
.btn-success:not(:disabled):not(.disabled):active:focus,
.show>.btn-success.dropdown-toggle:focus {
    box-shadow: 0 0 0 .2rem rgba(72, 180, 97, .5)
}

.btn-info {
    color: #fff;
    background-color: #17a2b8;
    border-color: #17a2b8
}

.btn-info:hover {
    color: #fff;
    background-color: #138496;
    border-color: #117a8b
}

.btn-info.focus,
.btn-info:focus {
    color: #fff;
    background-color: #138496;
    border-color: #117a8b;
    box-shadow: 0 0 0 .2rem rgba(58, 176, 195, .5)
}

.btn-info.disabled,
.btn-info:disabled {
    color: #fff;
    background-color: #17a2b8;
    border-color: #17a2b8
}

.btn-info:not(:disabled):not(.disabled).active,
.btn-info:not(:disabled):not(.disabled):active,
.show>.btn-info.dropdown-toggle {
    color: #fff;
    background-color: #117a8b;
    border-color: #10707f
}

.btn-info:not(:disabled):not(.disabled).active:focus,
.btn-info:not(:disabled):not(.disabled):active:focus,
.show>.btn-info.dropdown-toggle:focus {
    box-shadow: 0 0 0 .2rem rgba(58, 176, 195, .5)
}

.btn-warning {
    color: #212529;
    background-color: #ffc107;
    border-color: #ffc107
}

.btn-warning:hover {
    color: #212529;
    background-color: #e0a800;
    border-color: #d39e00
}

.btn-warning.focus,
.btn-warning:focus {
    color: #212529;
    background-color: #e0a800;
    border-color: #d39e00;
    box-shadow: 0 0 0 .2rem rgba(222, 170, 12, .5)
}

.btn-warning.disabled,
.btn-warning:disabled {
    color: #212529;
    background-color: #ffc107;
    border-color: #ffc107
}

.btn-warning:not(:disabled):not(.disabled).active,
.btn-warning:not(:disabled):not(.disabled):active,
.show>.btn-warning.dropdown-toggle {
    color: #212529;
    background-color: #d39e00;
    border-color: #c69500
}

.btn-warning:not(:disabled):not(.disabled).active:focus,
.btn-warning:not(:disabled):not(.disabled):active:focus,
.show>.btn-warning.dropdown-toggle:focus {
    box-shadow: 0 0 0 .2rem rgba(222, 170, 12, .5)
}

.btn-danger {
    color: #fff;
    background-color: #dc3545;
    border-color: #dc3545
}

.btn-danger:hover {
    color: #fff;
    background-color: #c82333;
    border-color: #bd2130
}

.btn-danger.focus,
.btn-danger:focus {
    color: #fff;
    background-color: #c82333;
    border-color: #bd2130;
    box-shadow: 0 0 0 .2rem rgba(225, 83, 97, .5)
}

.btn-danger.disabled,
.btn-danger:disabled {
    color: #fff;
    background-color: #dc3545;
    border-color: #dc3545
}

.btn-danger:not(:disabled):not(.disabled).active,
.btn-danger:not(:disabled):not(.disabled):active,
.show>.btn-danger.dropdown-toggle {
    color: #fff;
    background-color: #bd2130;
    border-color: #b21f2d
}

.btn-danger:not(:disabled):not(.disabled).active:focus,
.btn-danger:not(:disabled):not(.disabled):active:focus,
.show>.btn-danger.dropdown-toggle:focus {
    box-shadow: 0 0 0 .2rem rgba(225, 83, 97, .5)
}

.btn-light {
    color: #212529;
    background-color: #f8f9fa;
    border-color: #f8f9fa
}

.btn-light:hover {
    color: #212529;
    background-color: #e2e6ea;
    border-color: #dae0e5
}

.btn-light.focus,
.btn-light:focus {
    color: #212529;
    background-color: #e2e6ea;
    border-color: #dae0e5;
    box-shadow: 0 0 0 .2rem rgba(216, 217, 219, .5)
}

.btn-light.disabled,
.btn-light:disabled {
    color: #212529;
    background-color: #f8f9fa;
    border-color: #f8f9fa
}

.btn-light:not(:disabled):not(.disabled).active,
.btn-light:not(:disabled):not(.disabled):active,
.show>.btn-light.dropdown-toggle {
    color: #212529;
    background-color: #dae0e5;
    border-color: #d3d9df
}

.btn-light:not(:disabled):not(.disabled).active:focus,
.btn-light:not(:disabled):not(.disabled):active:focus,
.show>.btn-light.dropdown-toggle:focus {
    box-shadow: 0 0 0 .2rem rgba(216, 217, 219, .5)
}

.btn-dark {
    color: #fff;
    background-color: #343a40;
    border-color: #343a40
}

.btn-dark:hover {
    color: #fff;
    background-color: #23272b;
    border-color: #1d2124
}

.btn-dark.focus,
.btn-dark:focus {
    color: #fff;
    background-color: #23272b;
    border-color: #1d2124;
    box-shadow: 0 0 0 .2rem rgba(82, 88, 93, .5)
}

.btn-dark.disabled,
.btn-dark:disabled {
    color: #fff;
    background-color: #343a40;
    border-color: #343a40
}

.btn-dark:not(:disabled):not(.disabled).active,
.btn-dark:not(:disabled):not(.disabled):active,
.show>.btn-dark.dropdown-toggle {
    color: #fff;
    background-color: #1d2124;
    border-color: #171a1d
}

.btn-dark:not(:disabled):not(.disabled).active:focus,
.btn-dark:not(:disabled):not(.disabled):active:focus,
.show>.btn-dark.dropdown-toggle:focus {
    box-shadow: 0 0 0 .2rem rgba(82, 88, 93, .5)
}

.btn-outline-primary {
    color: #93e8e1;
    border-color: #93e8e1
}

.btn-outline-primary:hover {
    color: #fff;
    background-color: #93e8e1;
    border-color: #93e8e1
}

.btn-outline-primary.focus,
.btn-outline-primary:focus {
    box-shadow: 0 0 0 .2rem rgba(253, 116, 53, .5)
}

.btn-outline-primary.disabled,
.btn-outline-primary:disabled {
    color: #93e8e1;
    background-color: transparent
}

.btn-outline-primary:not(:disabled):not(.disabled).active,
.btn-outline-primary:not(:disabled):not(.disabled):active,
.show>.btn-outline-primary.dropdown-toggle {
    color: #fff;
    background-color: #93e8e1;
    border-color: #93e8e1
}

.btn-outline-primary:not(:disabled):not(.disabled).active:focus,
.btn-outline-primary:not(:disabled):not(.disabled):active:focus,
.show>.btn-outline-primary.dropdown-toggle:focus {
    box-shadow: 0 0 0 .2rem rgba(253, 116, 53, .5)
}

.btn-outline-secondary {
    color: #ffffff;
    border-color: #ffffff
}

.btn-outline-secondary:hover {
    color: #fff;
    background-color: #ffffff;
    border-color: #ffffff
}

.btn-outline-secondary.focus,
.btn-outline-secondary:focus {
    box-shadow: 0 0 0 .2rem rgba(0, 123, 255, .5)
}

.btn-outline-secondary.disabled,
.btn-outline-secondary:disabled {
    color: #ffffff;
    background-color: transparent
}

.btn-outline-secondary:not(:disabled):not(.disabled).active,
.btn-outline-secondary:not(:disabled):not(.disabled):active,
.show>.btn-outline-secondary.dropdown-toggle {
    color: #fff;
    background-color: #ffffff;
    border-color: #ffffff
}

.btn-outline-secondary:not(:disabled):not(.disabled).active:focus,
.btn-outline-secondary:not(:disabled):not(.disabled):active:focus,
.show>.btn-outline-secondary.dropdown-toggle:focus {
    box-shadow: 0 0 0 .2rem rgba(0, 123, 255, .5)
}

.btn-outline-success {
    color: #d4edda;
    border-color: #d4edda
}

.btn-outline-success:hover {
    color: #fff;
    background-color: #d4edda;
    border-color: #d4edda
}

.btn-outline-success.focus,
.btn-outline-success:focus {
    box-shadow: 0 0 0 .2rem rgba(40, 167, 69, .5)
}

.btn-outline-success.disabled,
.btn-outline-success:disabled {
    color: #d4edda;
    background-color: transparent
}

.btn-outline-success:not(:disabled):not(.disabled).active,
.btn-outline-success:not(:disabled):not(.disabled):active,
.show>.btn-outline-success.dropdown-toggle {
    color: #fff;
    background-color: #d4edda;
    border-color: #d4edda
}

.btn-outline-success:not(:disabled):not(.disabled).active:focus,
.btn-outline-success:not(:disabled):not(.disabled):active:focus,
.show>.btn-outline-success.dropdown-toggle:focus {
    box-shadow: 0 0 0 .2rem rgba(40, 167, 69, .5)
}

.btn-outline-info {
    color: #17a2b8;
    border-color: #17a2b8
}

.btn-outline-info:hover {
    color: #fff;
    background-color: #17a2b8;
    border-color: #17a2b8
}

.btn-outline-info.focus,
.btn-outline-info:focus {
    box-shadow: 0 0 0 .2rem rgba(23, 162, 184, .5)
}

.btn-outline-info.disabled,
.btn-outline-info:disabled {
    color: #17a2b8;
    background-color: transparent
}

.btn-outline-info:not(:disabled):not(.disabled).active,
.btn-outline-info:not(:disabled):not(.disabled):active,
.show>.btn-outline-info.dropdown-toggle {
    color: #fff;
    background-color: #17a2b8;
    border-color: #17a2b8
}

.btn-outline-info:not(:disabled):not(.disabled).active:focus,
.btn-outline-info:not(:disabled):not(.disabled):active:focus,
.show>.btn-outline-info.dropdown-toggle:focus {
    box-shadow: 0 0 0 .2rem rgba(23, 162, 184, .5)
}

.btn-outline-warning {
    color: #ffc107;
    border-color: #ffc107
}

.btn-outline-warning:hover {
    color: #212529;
    background-color: #ffc107;
    border-color: #ffc107
}

.btn-outline-warning.focus,
.btn-outline-warning:focus {
    box-shadow: 0 0 0 .2rem rgba(255, 193, 7, .5)
}

.btn-outline-warning.disabled,
.btn-outline-warning:disabled {
    color: #ffc107;
    background-color: transparent
}

.btn-outline-warning:not(:disabled):not(.disabled).active,
.btn-outline-warning:not(:disabled):not(.disabled):active,
.show>.btn-outline-warning.dropdown-toggle {
    color: #212529;
    background-color: #ffc107;
    border-color: #ffc107
}

.btn-outline-warning:not(:disabled):not(.disabled).active:focus,
.btn-outline-warning:not(:disabled):not(.disabled):active:focus,
.show>.btn-outline-warning.dropdown-toggle:focus {
    box-shadow: 0 0 0 .2rem rgba(255, 193, 7, .5)
}

.btn-outline-danger {
    color: #dc3545;
    border-color: #dc3545
}

.btn-outline-danger:hover {
    color: #fff;
    background-color: #dc3545;
    border-color: #dc3545
}

.btn-outline-danger.focus,
.btn-outline-danger:focus {
    box-shadow: 0 0 0 .2rem rgba(220, 53, 69, .5)
}

.btn-outline-danger.disabled,
.btn-outline-danger:disabled {
    color: #dc3545;
    background-color: transparent
}

.btn-outline-danger:not(:disabled):not(.disabled).active,
.btn-outline-danger:not(:disabled):not(.disabled):active,
.show>.btn-outline-danger.dropdown-toggle {
    color: #fff;
    background-color: #dc3545;
    border-color: #dc3545
}

.btn-outline-danger:not(:disabled):not(.disabled).active:focus,
.btn-outline-danger:not(:disabled):not(.disabled):active:focus,
.show>.btn-outline-danger.dropdown-toggle:focus {
    box-shadow: 0 0 0 .2rem rgba(220, 53, 69, .5)
}

.btn-outline-light {
    color: #f8f9fa;
    border-color: #f8f9fa
}

.btn-outline-light:hover {
    color: #212529;
    background-color: #f8f9fa;
    border-color: #f8f9fa
}

.btn-outline-light.focus,
.btn-outline-light:focus {
    box-shadow: 0 0 0 .2rem rgba(248, 249, 250, .5)
}

.btn-outline-light.disabled,
.btn-outline-light:disabled {
    color: #f8f9fa;
    background-color: transparent
}

.btn-outline-light:not(:disabled):not(.disabled).active,
.btn-outline-light:not(:disabled):not(.disabled):active,
.show>.btn-outline-light.dropdown-toggle {
    color: #212529;
    background-color: #f8f9fa;
    border-color: #f8f9fa
}

.btn-outline-light:not(:disabled):not(.disabled).active:focus,
.btn-outline-light:not(:disabled):not(.disabled):active:focus,
.show>.btn-outline-light.dropdown-toggle:focus {
    box-shadow: 0 0 0 .2rem rgba(248, 249, 250, .5)
}

.btn-outline-dark {
    color: #343a40;
    border-color: #343a40
}

.btn-outline-dark:hover {
    color: #fff;
    background-color: #343a40;
    border-color: #343a40
}

.btn-outline-dark.focus,
.btn-outline-dark:focus {
    box-shadow: 0 0 0 .2rem rgba(52, 58, 64, .5)
}

.btn-outline-dark.disabled,
.btn-outline-dark:disabled {
    color: #343a40;
    background-color: transparent
}

.btn-outline-dark:not(:disabled):not(.disabled).active,
.btn-outline-dark:not(:disabled):not(.disabled):active,
.show>.btn-outline-dark.dropdown-toggle {
    color: #fff;
    background-color: #343a40;
    border-color: #343a40
}

.btn-outline-dark:not(:disabled):not(.disabled).active:focus,
.btn-outline-dark:not(:disabled):not(.disabled):active:focus,
.show>.btn-outline-dark.dropdown-toggle:focus {
    box-shadow: 0 0 0 .2rem rgba(52, 58, 64, .5)
}

.btn-link {
    font-weight: 400;
    color: #93e8e1;
    text-decoration: none
}

.btn-link:hover {
    color: #e34902;
    text-decoration: underline
}

.btn-link.focus,
.btn-link:focus {
    text-decoration: underline
}

.btn-link.disabled,
.btn-link:disabled {
    color: #6c757d;
    pointer-events: none
}

.btn-group-lg>.btn,
.btn-lg {
    padding: .5rem 1rem;
    font-size: 1.25rem;
    line-height: 1.5;
    border-radius: .3rem
}

.btn-group-sm>.btn,
.btn-sm {
    padding: .25rem .5rem;
    font-size: .875rem;
    line-height: 1.5;
    border-radius: .2rem
}

.btn-block {
    display: block;
    width: 100%
}

.btn-block+.btn-block {
    margin-top: .5rem
}

input[type=button].btn-block,
input[type=reset].btn-block,
input[type=submit].btn-block {
    width: 100%
}

.fade {
    transition: opacity .15s linear
}

@media (prefers-reduced-motion:reduce) {
    .fade {
        transition: none
    }
}

.fade:not(.show) {
    opacity: 0
}

.collapse:not(.show) {
    display: none
}

.collapsing {
    position: relative;
    height: 0;
    overflow: hidden;
    transition: height .35s ease
}

@media (prefers-reduced-motion:reduce) {
    .collapsing {
        transition: none
    }
}

.dropdown,
.dropleft,
.dropright,
.dropup {
    position: relative
}

.dropdown-toggle {
    white-space: nowrap
}

.dropdown-toggle::after {
    display: inline-block;
    margin-left: .255em;
    vertical-align: .255em;
    content: "";
    border-top: .3em solid;
    border-right: .3em solid transparent;
    border-bottom: 0;
    border-left: .3em solid transparent
}

.dropdown-toggle:empty::after {
    margin-left: 0
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1000;
    display: none;
    float: left;
    min-width: 10rem;
    padding: .5rem 0;
    margin: .125rem 0 0;
    font-size: 1rem;
    color: #212529;
    text-align: left;
    list-style: none;
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid rgba(0, 0, 0, .15);
    border-radius: .25rem
}

.dropdown-menu-left {
    right: auto;
    left: 0
}

.dropdown-menu-right {
    right: 0;
    left: auto
}

@media (min-width:576px) {
    .dropdown-menu-sm-left {
        right: auto;
        left: 0
    }

    .dropdown-menu-sm-right {
        right: 0;
        left: auto
    }
}

@media (min-width:768px) {
    .dropdown-menu-md-left {
        right: auto;
        left: 0
    }

    .dropdown-menu-md-right {
        right: 0;
        left: auto
    }
}

@media (min-width:992px) {
    .dropdown-menu-lg-left {
        right: auto;
        left: 0
    }

    .dropdown-menu-lg-right {
        right: 0;
        left: auto
    }
}

@media (min-width:1200px) {
    .dropdown-menu-xl-left {
        right: auto;
        left: 0
    }

    .dropdown-menu-xl-right {
        right: 0;
        left: auto
    }
}

.dropup .dropdown-menu {
    top: auto;
    bottom: 100%;
    margin-top: 0;
    margin-bottom: .125rem
}

.dropup .dropdown-toggle::after {
    display: inline-block;
    margin-left: .255em;
    vertical-align: .255em;
    content: "";
    border-top: 0;
    border-right: .3em solid transparent;
    border-bottom: .3em solid;
    border-left: .3em solid transparent
}

.dropup .dropdown-toggle:empty::after {
    margin-left: 0
}

.dropright .dropdown-menu {
    top: 0;
    right: auto;
    left: 100%;
    margin-top: 0;
    margin-left: .125rem
}

.dropright .dropdown-toggle::after {
    display: inline-block;
    margin-left: .255em;
    vertical-align: .255em;
    content: "";
    border-top: .3em solid transparent;
    border-right: 0;
    border-bottom: .3em solid transparent;
    border-left: .3em solid
}

.dropright .dropdown-toggle:empty::after {
    margin-left: 0
}

.dropright .dropdown-toggle::after {
    vertical-align: 0
}

.dropleft .dropdown-menu {
    top: 0;
    right: 100%;
    left: auto;
    margin-top: 0;
    margin-right: .125rem
}

.dropleft .dropdown-toggle::after {
    display: inline-block;
    margin-left: .255em;
    vertical-align: .255em;
    content: ""
}

.dropleft .dropdown-toggle::after {
    display: none
}

.dropleft .dropdown-toggle::before {
    display: inline-block;
    margin-right: .255em;
    vertical-align: .255em;
    content: "";
    border-top: .3em solid transparent;
    border-right: .3em solid;
    border-bottom: .3em solid transparent
}

.dropleft .dropdown-toggle:empty::after {
    margin-left: 0
}

.dropleft .dropdown-toggle::before {
    vertical-align: 0
}

.dropdown-menu[x-placement^=bottom],
.dropdown-menu[x-placement^=left],
.dropdown-menu[x-placement^=right],
.dropdown-menu[x-placement^=top] {
    right: auto;
    bottom: auto
}

.dropdown-divider {
    height: 0;
    margin: .5rem 0;
    overflow: hidden;
    border-top: 1px solid #e9ecef
}

.dropdown-item {
    display: block;
    width: 100%;
    padding: .25rem 1.5rem;
    clear: both;
    font-weight: 400;
    color: #212529;
    text-align: inherit;
    white-space: nowrap;
    background-color: transparent;
    border: 0
}

.dropdown-item:focus,
.dropdown-item:hover {
    color: #16181b;
    text-decoration: none;
    background-color: #f8f9fa
}

.dropdown-item.active,
.dropdown-item:active {
    color: #fff;
    text-decoration: none;
    background-color: #93e8e1
}

.dropdown-item.disabled,
.dropdown-item:disabled {
    color: #6c757d;
    pointer-events: none;
    background-color: transparent
}

.dropdown-menu.show {
    display: block
}

.dropdown-header {
    display: block;
    padding: .5rem 1.5rem;
    margin-bottom: 0;
    font-size: .875rem;
    color: #6c757d;
    white-space: nowrap
}

.dropdown-item-text {
    display: block;
    padding: .25rem 1.5rem;
    color: #212529
}

.btn-group,
.btn-group-vertical {
    position: relative;
    display: inline-flex;
    vertical-align: middle
}

.btn-group-vertical>.btn,
.btn-group>.btn {
    position: relative;
    flex: 1 1 auto
}

.btn-group-vertical>.btn:hover,
.btn-group>.btn:hover {
    z-index: 1
}

.btn-group-vertical>.btn.active,
.btn-group-vertical>.btn:active,
.btn-group-vertical>.btn:focus,
.btn-group>.btn.active,
.btn-group>.btn:active,
.btn-group>.btn:focus {
    z-index: 1
}

.btn-toolbar {
    display: flex;
    flex-wrap: wrap;
    justify-content: flex-start
}

.btn-toolbar .input-group {
    width: auto
}

.btn-group>.btn-group:not(:first-child),
.btn-group>.btn:not(:first-child) {
    margin-left: -1px
}

.btn-group>.btn-group:not(:last-child)>.btn,
.btn-group>.btn:not(:last-child):not(.dropdown-toggle) {
    border-top-right-radius: 0;
    border-bottom-right-radius: 0
}

.btn-group>.btn-group:not(:first-child)>.btn,
.btn-group>.btn:not(:first-child) {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0
}

.dropdown-toggle-split {
    padding-right: .5625rem;
    padding-left: .5625rem
}

.dropdown-toggle-split::after,
.dropright .dropdown-toggle-split::after,
.dropup .dropdown-toggle-split::after {
    margin-left: 0
}

.dropleft .dropdown-toggle-split::before {
    margin-right: 0
}

.btn-group-sm>.btn+.dropdown-toggle-split,
.btn-sm+.dropdown-toggle-split {
    padding-right: .375rem;
    padding-left: .375rem
}

.btn-group-lg>.btn+.dropdown-toggle-split,
.btn-lg+.dropdown-toggle-split {
    padding-right: .75rem;
    padding-left: .75rem
}

.btn-group-vertical {
    flex-direction: column;
    align-items: flex-start;
    justify-content: center
}

.btn-group-vertical>.btn,
.btn-group-vertical>.btn-group {
    width: 100%
}

.btn-group-vertical>.btn-group:not(:first-child),
.btn-group-vertical>.btn:not(:first-child) {
    margin-top: -1px
}

.btn-group-vertical>.btn-group:not(:last-child)>.btn,
.btn-group-vertical>.btn:not(:last-child):not(.dropdown-toggle) {
    border-bottom-right-radius: 0;
    border-bottom-left-radius: 0
}

.btn-group-vertical>.btn-group:not(:first-child)>.btn,
.btn-group-vertical>.btn:not(:first-child) {
    border-top-left-radius: 0;
    border-top-right-radius: 0
}

.btn-group-toggle>.btn,
.btn-group-toggle>.btn-group>.btn {
    margin-bottom: 0
}

.btn-group-toggle>.btn input[type=checkbox],
.btn-group-toggle>.btn input[type=radio],
.btn-group-toggle>.btn-group>.btn input[type=checkbox],
.btn-group-toggle>.btn-group>.btn input[type=radio] {
    position: absolute;
    clip: rect(0, 0, 0, 0);
    pointer-events: none
}

.input-group {
    position: relative;
    display: flex;
    flex-wrap: wrap;
    align-items: stretch;
    width: 100%
}

.input-group>.custom-file,
.input-group>.custom-select,
.input-group>.form-control,
.input-group>.form-control-plaintext {
    position: relative;
    flex: 1 1 auto;
    width: 1%;
    min-width: 0;
    margin-bottom: 0
}

.input-group>.custom-file+.custom-file,
.input-group>.custom-file+.custom-select,
.input-group>.custom-file+.form-control,
.input-group>.custom-select+.custom-file,
.input-group>.custom-select+.custom-select,
.input-group>.custom-select+.form-control,
.input-group>.form-control+.custom-file,
.input-group>.form-control+.custom-select,
.input-group>.form-control+.form-control,
.input-group>.form-control-plaintext+.custom-file,
.input-group>.form-control-plaintext+.custom-select,
.input-group>.form-control-plaintext+.form-control {
    margin-left: -1px
}

.input-group>.custom-file .custom-file-input:focus~.custom-file-label,
.input-group>.custom-select:focus,
.input-group>.form-control:focus {
    z-index: 3
}

.input-group>.custom-file .custom-file-input:focus {
    z-index: 4
}

.input-group>.custom-select:not(:last-child),
.input-group>.form-control:not(:last-child) {
    border-top-right-radius: 0;
    border-bottom-right-radius: 0
}

.input-group>.custom-select:not(:first-child),
.input-group>.form-control:not(:first-child) {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0
}

.input-group>.custom-file {
    display: flex;
    align-items: center
}

.input-group>.custom-file:not(:last-child) .custom-file-label,
.input-group>.custom-file:not(:last-child) .custom-file-label::after {
    border-top-right-radius: 0;
    border-bottom-right-radius: 0
}

.input-group>.custom-file:not(:first-child) .custom-file-label {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0
}

.input-group-append,
.input-group-prepend {
    display: flex
}

.input-group-append .btn,
.input-group-prepend .btn {
    position: relative;
    z-index: 2
}

.input-group-append .btn:focus,
.input-group-prepend .btn:focus {
    z-index: 3
}

.input-group-append .btn+.btn,
.input-group-append .btn+.input-group-text,
.input-group-append .input-group-text+.btn,
.input-group-append .input-group-text+.input-group-text,
.input-group-prepend .btn+.btn,
.input-group-prepend .btn+.input-group-text,
.input-group-prepend .input-group-text+.btn,
.input-group-prepend .input-group-text+.input-group-text {
    margin-left: -1px
}

.input-group-prepend {
    margin-right: -1px
}

.input-group-append {
    margin-left: -1px
}

.input-group-text {
    display: flex;
    align-items: center;
    padding: .375rem .75rem;
    margin-bottom: 0;
    font-size: 1rem;
    font-weight: 400;
    line-height: 1.5;
    color: #495057;
    text-align: center;
    white-space: nowrap;
    background-color: #e9ecef;
    border: 1px solid #ced4da;
    border-radius: .25rem
}

.input-group-text input[type=checkbox],
.input-group-text input[type=radio] {
    margin-top: 0
}

.input-group-lg>.custom-select,
.input-group-lg>.form-control:not(textarea) {
    height: calc(1.5em + 1rem + 2px)
}

.input-group-lg>.custom-select,
.input-group-lg>.form-control,
.input-group-lg>.input-group-append>.btn,
.input-group-lg>.input-group-append>.input-group-text,
.input-group-lg>.input-group-prepend>.btn,
.input-group-lg>.input-group-prepend>.input-group-text {
    padding: .5rem 1rem;
    font-size: 1.25rem;
    line-height: 1.5;
    border-radius: .3rem
}

.input-group-sm>.custom-select,
.input-group-sm>.form-control:not(textarea) {
    height: calc(1.5em + .5rem + 2px)
}

.input-group-sm>.custom-select,
.input-group-sm>.form-control,
.input-group-sm>.input-group-append>.btn,
.input-group-sm>.input-group-append>.input-group-text,
.input-group-sm>.input-group-prepend>.btn,
.input-group-sm>.input-group-prepend>.input-group-text {
    padding: .25rem .5rem;
    font-size: .875rem;
    line-height: 1.5;
    border-radius: .2rem
}

.input-group-lg>.custom-select,
.input-group-sm>.custom-select {
    padding-right: 1.75rem
}

.input-group>.input-group-append:last-child>.btn:not(:last-child):not(.dropdown-toggle),
.input-group>.input-group-append:last-child>.input-group-text:not(:last-child),
.input-group>.input-group-append:not(:last-child)>.btn,
.input-group>.input-group-append:not(:last-child)>.input-group-text,
.input-group>.input-group-prepend>.btn,
.input-group>.input-group-prepend>.input-group-text {
    border-top-right-radius: 0;
    border-bottom-right-radius: 0
}

.input-group>.input-group-append>.btn,
.input-group>.input-group-append>.input-group-text,
.input-group>.input-group-prepend:first-child>.btn:not(:first-child),
.input-group>.input-group-prepend:first-child>.input-group-text:not(:first-child),
.input-group>.input-group-prepend:not(:first-child)>.btn,
.input-group>.input-group-prepend:not(:first-child)>.input-group-text {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0
}

.custom-control {
    position: relative;
    display: block;
    min-height: 1.5rem;
    padding-left: 1.5rem
}

.custom-control-inline {
    display: inline-flex;
    margin-right: 1rem
}

.custom-control-input {
    position: absolute;
    left: 0;
    z-index: -1;
    width: 1rem;
    height: 1.25rem;
    opacity: 0
}

.custom-control-input:checked~.custom-control-label::before {
    color: #fff;
    border-color: #93e8e1;
    background-color: #93e8e1
}

.custom-control-input:focus~.custom-control-label::before {
    
}

.custom-control-input:focus:not(:checked)~.custom-control-label::before {
    border-color: #fecbb3
}

.custom-control-input:not(:disabled):active~.custom-control-label::before {
    color: #fff;
    background-color: #ffeee6;
    border-color: #ffeee6
}

.custom-control-input:disabled~.custom-control-label,
.custom-control-input[disabled]~.custom-control-label {
    color: #6c757d
}

.custom-control-input:disabled~.custom-control-label::before,
.custom-control-input[disabled]~.custom-control-label::before {
    background-color: #e9ecef
}

.custom-control-label {
    position: relative;
    margin-bottom: 0;
    vertical-align: top
}

.custom-control-label::before {
    position: absolute;
    top: .25rem;
    left: -1.5rem;
    display: block;
    width: 1rem;
    height: 1rem;
    pointer-events: none;
    content: "";
    background-color: #fff;
    border: #adb5bd solid 1px
}

.custom-control-label::after {
    position: absolute;
    top: .25rem;
    left: -1.5rem;
    display: block;
    width: 1rem;
    height: 1rem;
    content: "";
    background: no-repeat 50%/50% 50%
}

.custom-checkbox .custom-control-label::before {
    border-radius: .25rem
}

.custom-checkbox .custom-control-input:checked~.custom-control-label::after {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 8 8'%3e%3cpath fill='%23fff' d='M6.564.75l-3.59 3.612-1.538-1.55L0 4.26l2.974 2.99L8 2.193z'/%3e%3c/svg%3e")
}

.custom-checkbox .custom-control-input:indeterminate~.custom-control-label::before {
    border-color: #93e8e1;
    background-color: #93e8e1
}

.custom-checkbox .custom-control-input:indeterminate~.custom-control-label::after {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='4' height='4' viewBox='0 0 4 4'%3e%3cpath stroke='%23fff' d='M0 2h4'/%3e%3c/svg%3e")
}

.custom-checkbox .custom-control-input:disabled:checked~.custom-control-label::before {
    background-color: rgba(253, 116, 53, .5)
}

.custom-checkbox .custom-control-input:disabled:indeterminate~.custom-control-label::before {
    background-color: rgba(253, 116, 53, .5)
}

.custom-radio .custom-control-label::before {
    border-radius: 50%
}

.custom-radio .custom-control-input:checked~.custom-control-label::after {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e")
}

.custom-radio .custom-control-input:disabled:checked~.custom-control-label::before {
    background-color: rgba(253, 116, 53, .5)
}

.custom-switch {
    padding-left: 2.25rem
}

.custom-switch .custom-control-label::before {
    left: -2.25rem;
    width: 1.75rem;
    pointer-events: all;
    border-radius: .5rem
}

.custom-switch .custom-control-label::after {
    top: calc(.25rem + 2px);
    left: calc(-2.25rem + 2px);
    width: calc(1rem - 4px);
    height: calc(1rem - 4px);
    background-color: #adb5bd;
    border-radius: .5rem;
    transition: transform .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out
}

@media (prefers-reduced-motion:reduce) {
    .custom-switch .custom-control-label::after {
        transition: none
    }
}

.custom-switch .custom-control-input:checked~.custom-control-label::after {
    background-color: #fff;
    transform: translateX(.75rem)
}

.custom-switch .custom-control-input:disabled:checked~.custom-control-label::before {
    background-color: rgba(253, 116, 53, .5)
}

.custom-select {
    display: inline-block;
    width: 100%;
    height: calc(1.5em + .75rem + 2px);
    padding: .375rem 1.75rem .375rem .75rem;
    font-size: 1rem;
    font-weight: 400;
    line-height: 1.5;
    color: #495057;
    vertical-align: middle;
    background: #fff url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='4' height='5' viewBox='0 0 4 5'%3e%3cpath fill='%23343a40' d='M2 0L0 2h4zm0 5L0 3h4z'/%3e%3c/svg%3e") no-repeat right .75rem center/8px 10px;
    border: 1px solid #ced4da;
    border-radius: .25rem;
    appearance: none
}

.custom-select:focus {
    border-color: #fecbb3;
    outline: 0;
    
}

.custom-select:focus::-ms-value {
    color: #495057;
    background-color: #fff
}

.custom-select[multiple],
.custom-select[size]:not([size="1"]) {
    height: auto;
    padding-right: .75rem;
    background-image: none
}

.custom-select:disabled {
    color: #6c757d;
    background-color: #e9ecef
}

.custom-select::-ms-expand {
    display: none
}

.custom-select:-moz-focusring {
    color: transparent;
    text-shadow: 0 0 0 #495057
}

.custom-select-sm {
    height: calc(1.5em + .5rem + 2px);
    padding-top: .25rem;
    padding-bottom: .25rem;
    padding-left: .5rem;
    font-size: .875rem
}

.custom-select-lg {
    height: calc(1.5em + 1rem + 2px);
    padding-top: .5rem;
    padding-bottom: .5rem;
    padding-left: 1rem;
    font-size: 1.25rem
}

.custom-file {
    position: relative;
    display: inline-block;
    width: 100%;
    height: calc(1.5em + .75rem + 2px);
    margin-bottom: 0
}

.custom-file-input {
    position: relative;
    z-index: 2;
    width: 100%;
    height: calc(1.5em + .75rem + 2px);
    margin: 0;
    opacity: 0
}

.custom-file-input:focus~.custom-file-label {
    border-color: #fecbb3;
    
}

.custom-file-input:disabled~.custom-file-label,
.custom-file-input[disabled]~.custom-file-label {
    background-color: #e9ecef
}

.custom-file-input:lang(en)~.custom-file-label::after {
    content: "Browse"
}

.custom-file-input~.custom-file-label[data-browse]::after {
    content: attr(data-browse)
}

.custom-file-label {
    position: absolute;
    top: 0;
    right: 0;
    left: 0;
    z-index: 1;
    height: calc(1.5em + .75rem + 2px);
    padding: .375rem .75rem;
    font-weight: 400;
    line-height: 1.5;
    color: #495057;
    background-color: #fff;
    border: 1px solid #ced4da;
    border-radius: .25rem
}

.custom-file-label::after {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    z-index: 3;
    display: block;
    height: calc(1.5em + .75rem);
    padding: .375rem .75rem;
    line-height: 1.5;
    color: #495057;
    content: "Browse";
    background-color: #e9ecef;
    border-left: inherit;
    border-radius: 0 .25rem .25rem 0
}

.custom-range {
    width: 100%;
    height: 1.4rem;
    padding: 0;
    background-color: transparent;
    appearance: none
}

.custom-range:focus {
    outline: 0
}

.custom-range:focus::-webkit-slider-thumb {
    box-shadow: 0 0 0 1px #fff, 0 0 0 .2rem rgba(253, 116, 53, .25)
}

.custom-range:focus::-moz-range-thumb {
    box-shadow: 0 0 0 1px #fff, 0 0 0 .2rem rgba(253, 116, 53, .25)
}

.custom-range:focus::-ms-thumb {
    box-shadow: 0 0 0 1px #fff, 0 0 0 .2rem rgba(253, 116, 53, .25)
}

.custom-range::-moz-focus-outer {
    border: 0
}

.custom-range::-webkit-slider-thumb {
    width: 1rem;
    height: 1rem;
    margin-top: -.25rem;
    background-color: #93e8e1;
    border: 0;
    border-radius: 1rem;
    transition: background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;
    appearance: none
}

@media (prefers-reduced-motion:reduce) {
    .custom-range::-webkit-slider-thumb {
        transition: none
    }
}

.custom-range::-webkit-slider-thumb:active {
    background-color: #ffeee6
}

.custom-range::-webkit-slider-runnable-track {
    width: 100%;
    height: .5rem;
    color: transparent;
    cursor: pointer;
    background-color: #dee2e6;
    border-color: transparent;
    border-radius: 1rem
}

.custom-range::-moz-range-thumb {
    width: 1rem;
    height: 1rem;
    background-color: #93e8e1;
    border: 0;
    border-radius: 1rem;
    transition: background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;
    appearance: none
}

@media (prefers-reduced-motion:reduce) {
    .custom-range::-moz-range-thumb {
        transition: none
    }
}

.custom-range::-moz-range-thumb:active {
    background-color: #ffeee6
}

.custom-range::-moz-range-track {
    width: 100%;
    height: .5rem;
    color: transparent;
    cursor: pointer;
    background-color: #dee2e6;
    border-color: transparent;
    border-radius: 1rem
}

.custom-range::-ms-thumb {
    width: 1rem;
    height: 1rem;
    margin-top: 0;
    margin-right: .2rem;
    margin-left: .2rem;
    background-color: #93e8e1;
    border: 0;
    border-radius: 1rem;
    transition: background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;
    appearance: none
}

@media (prefers-reduced-motion:reduce) {
    .custom-range::-ms-thumb {
        transition: none
    }
}

.custom-range::-ms-thumb:active {
    background-color: #ffeee6
}

.custom-range::-ms-track {
    width: 100%;
    height: .5rem;
    color: transparent;
    cursor: pointer;
    background-color: transparent;
    border-color: transparent;
    border-width: .5rem
}

.custom-range::-ms-fill-lower {
    background-color: #dee2e6;
    border-radius: 1rem
}

.custom-range::-ms-fill-upper {
    margin-right: 15px;
    background-color: #dee2e6;
    border-radius: 1rem
}

.custom-range:disabled::-webkit-slider-thumb {
    background-color: #adb5bd
}

.custom-range:disabled::-webkit-slider-runnable-track {
    cursor: default
}

.custom-range:disabled::-moz-range-thumb {
    background-color: #adb5bd
}

.custom-range:disabled::-moz-range-track {
    cursor: default
}

.custom-range:disabled::-ms-thumb {
    background-color: #adb5bd
}

.custom-control-label::before,
.custom-file-label,
.custom-select {
    transition: background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out
}

@media (prefers-reduced-motion:reduce) {

    .custom-control-label::before,
    .custom-file-label,
    .custom-select {
        transition: none
    }
}

.nav {
    display: flex;
    flex-wrap: wrap;
    padding-left: 0;
    margin-bottom: 0;
    list-style: none
}

.nav-link {
    display: block;
    padding: .5rem 1rem
}

.nav-link:focus,
.nav-link:hover {
    text-decoration: none
}

.nav-link.disabled {
    color: #6c757d;
    pointer-events: none;
    cursor: default
}

.nav-tabs {
    border-bottom: 1px solid #dee2e6
}

.nav-tabs .nav-item {
    margin-bottom: -1px
}

.nav-tabs .nav-link {
    border: 1px solid transparent;
    border-top-left-radius: .25rem;
    border-top-right-radius: .25rem
}

.nav-tabs .nav-link:focus,
.nav-tabs .nav-link:hover {
    border-color: #e9ecef #e9ecef #dee2e6
}

.nav-tabs .nav-link.disabled {
    color: #6c757d;
    background-color: transparent;
    border-color: transparent
}

.nav-tabs .nav-item.show .nav-link,
.nav-tabs .nav-link.active {
    color: #495057;
    background-color: #fff;
    border-color: #dee2e6 #dee2e6 #fff
}

.nav-tabs .dropdown-menu {
    margin-top: -1px;
    border-top-left-radius: 0;
    border-top-right-radius: 0
}

.nav-pills .nav-link {
    border-radius: .25rem
}

.nav-pills .nav-link.active,
.nav-pills .show>.nav-link {
    color: #fff;
    background-color: #93e8e1
}

.nav-fill .nav-item {
    flex: 1 1 auto;
    text-align: center
}

.nav-justified .nav-item {
    flex-basis: 0;
    flex-grow: 1;
    text-align: center
}

.tab-content>.tab-pane {
    display: none
}

.tab-content>.active {
    display: block
}

.navbar {
    position: relative;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    padding: .5rem 1rem
}

.navbar .container,
.navbar .container-fluid,
.navbar .container-lg,
.navbar .container-md,
.navbar .container-sm,
.navbar .container-xl {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between
}

.navbar-brand {
    display: inline-block;
    padding-top: .3125rem;
    padding-bottom: .3125rem;
    margin-right: 1rem;
    font-size: 1.25rem;
    line-height: inherit;
    white-space: nowrap
}

.navbar-brand:focus,
.navbar-brand:hover {
    text-decoration: none
}

.navbar-nav {
    display: flex;
    flex-direction: column;
    padding-left: 0;
    margin-bottom: 0;
    list-style: none
}

.navbar-nav .nav-link {
    padding-right: 0;
    padding-left: 0
}

.navbar-nav .dropdown-menu {
    position: static;
    float: none
}

.navbar-text {
    display: inline-block;
    padding-top: .5rem;
    padding-bottom: .5rem
}

.navbar-collapse {
    flex-basis: 100%;
    flex-grow: 1;
    align-items: center
}

.navbar-toggler {
    padding: .25rem .75rem;
    font-size: 1.25rem;
    line-height: 1;
    background-color: transparent;
    border: 1px solid transparent;
    border-radius: .25rem
}

.navbar-toggler:focus,
.navbar-toggler:hover {
    text-decoration: none
}

.navbar-toggler-icon {
    display: inline-block;
    width: 1.5em;
    height: 1.5em;
    vertical-align: middle;
    content: "";
    background: no-repeat center center;
    background-size: 100% 100%
}

@media (max-width:575.98px) {

    .navbar-expand-sm>.container,
    .navbar-expand-sm>.container-fluid,
    .navbar-expand-sm>.container-lg,
    .navbar-expand-sm>.container-md,
    .navbar-expand-sm>.container-sm,
    .navbar-expand-sm>.container-xl {
        padding-right: 0;
        padding-left: 0
    }
}

@media (min-width:576px) {
    .navbar-expand-sm {
        flex-flow: row nowrap;
        justify-content: flex-start
    }

    .navbar-expand-sm .navbar-nav {
        flex-direction: row
    }

    .navbar-expand-sm .navbar-nav .dropdown-menu {
        position: absolute
    }

    .navbar-expand-sm .navbar-nav .nav-link {
        padding-right: .5rem;
        padding-left: .5rem
    }

    .navbar-expand-sm>.container,
    .navbar-expand-sm>.container-fluid,
    .navbar-expand-sm>.container-lg,
    .navbar-expand-sm>.container-md,
    .navbar-expand-sm>.container-sm,
    .navbar-expand-sm>.container-xl {
        flex-wrap: nowrap
    }

    .navbar-expand-sm .navbar-collapse {
        display: flex !important;
        flex-basis: auto
    }

    .navbar-expand-sm .navbar-toggler {
        display: none
    }
}

@media (max-width:767.98px) {

    .navbar-expand-md>.container,
    .navbar-expand-md>.container-fluid,
    .navbar-expand-md>.container-lg,
    .navbar-expand-md>.container-md,
    .navbar-expand-md>.container-sm,
    .navbar-expand-md>.container-xl {
        padding-right: 0;
        padding-left: 0
    }
}

@media (min-width:768px) {
    .navbar-expand-md {
        flex-flow: row nowrap;
        justify-content: flex-start
    }

    .navbar-expand-md .navbar-nav {
        flex-direction: row
    }

    .navbar-expand-md .navbar-nav .dropdown-menu {
        position: absolute
    }

    .navbar-expand-md .navbar-nav .nav-link {
        padding-right: .5rem;
        padding-left: .5rem
    }

    .navbar-expand-md>.container,
    .navbar-expand-md>.container-fluid,
    .navbar-expand-md>.container-lg,
    .navbar-expand-md>.container-md,
    .navbar-expand-md>.container-sm,
    .navbar-expand-md>.container-xl {
        flex-wrap: nowrap
    }

    .navbar-expand-md .navbar-collapse {
        display: flex !important;
        flex-basis: auto
    }

    .navbar-expand-md .navbar-toggler {
        display: none
    }
}

@media (max-width:991.98px) {

    .navbar-expand-lg>.container,
    .navbar-expand-lg>.container-fluid,
    .navbar-expand-lg>.container-lg,
    .navbar-expand-lg>.container-md,
    .navbar-expand-lg>.container-sm,
    .navbar-expand-lg>.container-xl {
        padding-right: 0;
        padding-left: 0
    }
}

@media (min-width:992px) {
    .navbar-expand-lg {
        flex-flow: row nowrap;
        justify-content: flex-start
    }

    .navbar-expand-lg .navbar-nav {
        flex-direction: row
    }

    .navbar-expand-lg .navbar-nav .dropdown-menu {
        position: absolute
    }

    .navbar-expand-lg .navbar-nav .nav-link {
        padding-right: .5rem;
        padding-left: .5rem
    }

    .navbar-expand-lg>.container,
    .navbar-expand-lg>.container-fluid,
    .navbar-expand-lg>.container-lg,
    .navbar-expand-lg>.container-md,
    .navbar-expand-lg>.container-sm,
    .navbar-expand-lg>.container-xl {
        flex-wrap: nowrap
    }

    .navbar-expand-lg .navbar-collapse {
        display: flex !important;
        flex-basis: auto
    }

    .navbar-expand-lg .navbar-toggler {
        display: none
    }
}

@media (max-width:1199.98px) {

    .navbar-expand-xl>.container,
    .navbar-expand-xl>.container-fluid,
    .navbar-expand-xl>.container-lg,
    .navbar-expand-xl>.container-md,
    .navbar-expand-xl>.container-sm,
    .navbar-expand-xl>.container-xl {
        padding-right: 0;
        padding-left: 0
    }
}

@media (min-width:1200px) {
    .navbar-expand-xl {
        flex-flow: row nowrap;
        justify-content: flex-start
    }

    .navbar-expand-xl .navbar-nav {
        flex-direction: row
    }

    .navbar-expand-xl .navbar-nav .dropdown-menu {
        position: absolute
    }

    .navbar-expand-xl .navbar-nav .nav-link {
        padding-right: .5rem;
        padding-left: .5rem
    }

    .navbar-expand-xl>.container,
    .navbar-expand-xl>.container-fluid,
    .navbar-expand-xl>.container-lg,
    .navbar-expand-xl>.container-md,
    .navbar-expand-xl>.container-sm,
    .navbar-expand-xl>.container-xl {
        flex-wrap: nowrap
    }

    .navbar-expand-xl .navbar-collapse {
        display: flex !important;
        flex-basis: auto
    }

    .navbar-expand-xl .navbar-toggler {
        display: none
    }
}

.navbar-expand {
    flex-flow: row nowrap;
    justify-content: flex-start
}

.navbar-expand>.container,
.navbar-expand>.container-fluid,
.navbar-expand>.container-lg,
.navbar-expand>.container-md,
.navbar-expand>.container-sm,
.navbar-expand>.container-xl {
    padding-right: 0;
    padding-left: 0
}

.navbar-expand .navbar-nav {
    flex-direction: row
}

.navbar-expand .navbar-nav .dropdown-menu {
    position: absolute
}

.navbar-expand .navbar-nav .nav-link {
    padding-right: .5rem;
    padding-left: .5rem
}

.navbar-expand>.container,
.navbar-expand>.container-fluid,
.navbar-expand>.container-lg,
.navbar-expand>.container-md,
.navbar-expand>.container-sm,
.navbar-expand>.container-xl {
    flex-wrap: nowrap
}

.navbar-expand .navbar-collapse {
    display: flex !important;
    flex-basis: auto
}

.navbar-expand .navbar-toggler {
    display: none
}

.navbar-light .navbar-brand {
    color: rgba(0, 0, 0, .9)
}

.navbar-light .navbar-brand:focus,
.navbar-light .navbar-brand:hover {
    color: rgba(0, 0, 0, .9)
}

.navbar-light .navbar-nav .nav-link {
    color: rgba(0, 0, 0, .5)
}

.navbar-light .navbar-nav .nav-link:focus,
.navbar-light .navbar-nav .nav-link:hover {
    color: rgba(0, 0, 0, .7)
}

.navbar-light .navbar-nav .nav-link.disabled {
    color: rgba(0, 0, 0, .3)
}

.navbar-light .navbar-nav .active>.nav-link,
.navbar-light .navbar-nav .nav-link.active,
.navbar-light .navbar-nav .nav-link.show,
.navbar-light .navbar-nav .show>.nav-link {
    color: rgba(0, 0, 0, .9)
}

.navbar-light .navbar-toggler {
    color: rgba(0, 0, 0, .5);
    border-color: rgba(0, 0, 0, .1)
}

.navbar-light .navbar-toggler-icon {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='30' height='30' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%280, 0, 0, 0.5%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e")
}

.navbar-light .navbar-text {
    color: rgba(0, 0, 0, .5)
}

.navbar-light .navbar-text a {
    color: rgba(0, 0, 0, .9)
}

.navbar-light .navbar-text a:focus,
.navbar-light .navbar-text a:hover {
    color: rgba(0, 0, 0, .9)
}

.navbar-dark .navbar-brand {
    color: #fff
}

.navbar-dark .navbar-brand:focus,
.navbar-dark .navbar-brand:hover {
    color: #fff
}

.navbar-dark .navbar-nav .nav-link {
    color: rgba(255, 255, 255, .5)
}

.navbar-dark .navbar-nav .nav-link:focus,
.navbar-dark .navbar-nav .nav-link:hover {
    color: rgba(255, 255, 255, .75)
}

.navbar-dark .navbar-nav .nav-link.disabled {
    color: rgba(255, 255, 255, .25)
}

.navbar-dark .navbar-nav .active>.nav-link,
.navbar-dark .navbar-nav .nav-link.active,
.navbar-dark .navbar-nav .nav-link.show,
.navbar-dark .navbar-nav .show>.nav-link {
    color: #fff
}

.navbar-dark .navbar-toggler {
    color: rgba(255, 255, 255, .5);
    border-color: rgba(255, 255, 255, .1)
}

.navbar-dark .navbar-toggler-icon {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='30' height='30' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 0.5%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e")
}

.navbar-dark .navbar-text {
    color: rgba(255, 255, 255, .5)
}

.navbar-dark .navbar-text a {
    color: #fff
}

.navbar-dark .navbar-text a:focus,
.navbar-dark .navbar-text a:hover {
    color: #fff
}

.card {
    position: relative;
    display: flex;
    flex-direction: column;
    min-width: 0;
    word-wrap: break-word;
    background-color: #fff;
    background-clip: border-box;
    border: 1px solid rgba(0, 0, 0, .125);
    border-radius: .25rem
}

.card>hr {
    margin-right: 0;
    margin-left: 0
}

.card>.list-group {
    border-top: inherit;
    border-bottom: inherit
}

.card>.list-group:first-child {
    border-top-width: 0;
    border-top-left-radius: calc(.25rem - 1px);
    border-top-right-radius: calc(.25rem - 1px)
}

.card>.list-group:last-child {
    border-bottom-width: 0;
    border-bottom-right-radius: calc(.25rem - 1px);
    border-bottom-left-radius: calc(.25rem - 1px)
}

.card-body {
    flex: 1 1 auto;
    min-height: 1px;
    padding: 1.25rem
}

.card-title {
    margin-bottom: .75rem
}

.card-subtitle {
    margin-top: -.375rem;
    margin-bottom: 0
}

.card-text:last-child {
    margin-bottom: 0
}

.card-link:hover {
    text-decoration: none
}

.card-link+.card-link {
    margin-left: 1.25rem
}

.card-header {
    padding: .75rem 1.25rem;
    margin-bottom: 0;
    background-color: rgba(0, 0, 0, .03);
    border-bottom: 1px solid rgba(0, 0, 0, .125)
}

.card-header:first-child {
    border-radius: calc(.25rem - 1px) calc(.25rem - 1px) 0 0
}

.card-header+.list-group .list-group-item:first-child {
    border-top: 0
}

.card-footer {
    padding: .75rem 1.25rem;
    background-color: rgba(0, 0, 0, .03);
    border-top: 1px solid rgba(0, 0, 0, .125)
}

.card-footer:last-child {
    border-radius: 0 0 calc(.25rem - 1px) calc(.25rem - 1px)
}

.card-header-tabs {
    margin-right: -.625rem;
    margin-bottom: -.75rem;
    margin-left: -.625rem;
    border-bottom: 0
}

.card-header-pills {
    margin-right: -.625rem;
    margin-left: -.625rem
}

.card-img-overlay {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    padding: 1.25rem
}

.card-img,
.card-img-bottom,
.card-img-top {
    flex-shrink: 0;
    width: 100%
}

.card-img,
.card-img-top {
    border-top-left-radius: calc(.25rem - 1px);
    border-top-right-radius: calc(.25rem - 1px)
}

.card-img,
.card-img-bottom {
    border-bottom-right-radius: calc(.25rem - 1px);
    border-bottom-left-radius: calc(.25rem - 1px)
}

.card-deck .card {
    margin-bottom: 15px
}

@media (min-width:576px) {
    .card-deck {
        display: flex;
        flex-flow: row wrap;
        margin-right: -15px;
        margin-left: -15px
    }

    .card-deck .card {
        flex: 1 0 0%;
        margin-right: 15px;
        margin-bottom: 0;
        margin-left: 15px
    }
}

.card-group>.card {
    margin-bottom: 15px
}

@media (min-width:576px) {
    .card-group {
        display: flex;
        flex-flow: row wrap
    }

    .card-group>.card {
        flex: 1 0 0%;
        margin-bottom: 0
    }

    .card-group>.card+.card {
        margin-left: 0;
        border-left: 0
    }

    .card-group>.card:not(:last-child) {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0
    }

    .card-group>.card:not(:last-child) .card-header,
    .card-group>.card:not(:last-child) .card-img-top {
        border-top-right-radius: 0
    }

    .card-group>.card:not(:last-child) .card-footer,
    .card-group>.card:not(:last-child) .card-img-bottom {
        border-bottom-right-radius: 0
    }

    .card-group>.card:not(:first-child) {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0
    }

    .card-group>.card:not(:first-child) .card-header,
    .card-group>.card:not(:first-child) .card-img-top {
        border-top-left-radius: 0
    }

    .card-group>.card:not(:first-child) .card-footer,
    .card-group>.card:not(:first-child) .card-img-bottom {
        border-bottom-left-radius: 0
    }
}

.card-columns .card {
    margin-bottom: .75rem
}

@media (min-width:576px) {
    .card-columns {
        column-count: 3;
        column-gap: 1.25rem;
        orphans: 1;
        widows: 1
    }

    .card-columns .card {
        display: inline-block;
        width: 100%
    }
}

.accordion>.card {
    overflow: hidden
}

.accordion>.card:not(:last-of-type) {
    border-bottom: 0;
    border-bottom-right-radius: 0;
    border-bottom-left-radius: 0
}

.accordion>.card:not(:first-of-type) {
    border-top-left-radius: 0;
    border-top-right-radius: 0
}

.accordion>.card>.card-header {
    border-radius: 0;
    margin-bottom: -1px
}

.breadcrumb {
    display: flex;
    flex-wrap: wrap;
    padding: .75rem 1rem;
    margin-bottom: 1rem;
    list-style: none;
    background-color: #e9ecef;
    border-radius: .25rem
}

.breadcrumb-item {
    display: flex
}

.breadcrumb-item+.breadcrumb-item {
    padding-left: .5rem
}

.breadcrumb-item+.breadcrumb-item::before {
    display: inline-block;
    padding-right: .5rem;
    color: #6c757d;
    content: "/"
}

.breadcrumb-item+.breadcrumb-item:hover::before {
    text-decoration: underline
}

.breadcrumb-item+.breadcrumb-item:hover::before {
    text-decoration: none
}

.breadcrumb-item.active {
    color: #6c757d
}

.pagination {
    display: flex;
    padding-left: 0;
    list-style: none;
    border-radius: .25rem
}

.page-link {
    position: relative;
    display: block;
    padding: .5rem .75rem;
    margin-left: -1px;
    line-height: 1.25;
    color: #93e8e1;
    background-color: #fff;
    border: 1px solid #dee2e6
}

.page-link:hover {
    z-index: 2;
    color: #e34902;
    text-decoration: none;
    background-color: #e9ecef;
    border-color: #dee2e6
}

.page-link:focus {
    z-index: 3;
    outline: 0;
    
}

.page-item:first-child .page-link {
    margin-left: 0;
    border-top-left-radius: .25rem;
    border-bottom-left-radius: .25rem
}

.page-item:last-child .page-link {
    border-top-right-radius: .25rem;
    border-bottom-right-radius: .25rem
}

.page-item.active .page-link {
    z-index: 3;
    color: #fff;
    background-color: #93e8e1;
    border-color: #93e8e1
}

.page-item.disabled .page-link {
    color: #6c757d;
    pointer-events: none;
    cursor: auto;
    background-color: #fff;
    border-color: #dee2e6
}

.pagination-lg .page-link {
    padding: .75rem 1.5rem;
    font-size: 1.25rem;
    line-height: 1.5
}

.pagination-lg .page-item:first-child .page-link {
    border-top-left-radius: .3rem;
    border-bottom-left-radius: .3rem
}

.pagination-lg .page-item:last-child .page-link {
    border-top-right-radius: .3rem;
    border-bottom-right-radius: .3rem
}

.pagination-sm .page-link {
    padding: .25rem .5rem;
    font-size: .875rem;
    line-height: 1.5
}

.pagination-sm .page-item:first-child .page-link {
    border-top-left-radius: .2rem;
    border-bottom-left-radius: .2rem
}

.pagination-sm .page-item:last-child .page-link {
    border-top-right-radius: .2rem;
    border-bottom-right-radius: .2rem
}

.badge {
    display: inline-block;
    padding: .25em .4em;
    font-size: 75%;
    font-weight: 700;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: .25rem;
    transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out
}

@media (prefers-reduced-motion:reduce) {
    .badge {
        transition: none
    }
}

a.badge:focus,
a.badge:hover {
    text-decoration: none
}

.badge:empty {
    display: none
}

.btn .badge {
    position: relative;
    top: -1px
}

.badge-pill {
    padding-right: .6em;
    padding-left: .6em;
    border-radius: 10rem
}

.badge-primary {
    color: #fff;
    background-color: #93e8e1
}

a.badge-primary:focus,
a.badge-primary:hover {
    color: #fff;
    background-color: #93e8e1
}

a.badge-primary.focus,
a.badge-primary:focus {
    outline: 0;
    box-shadow: 0 0 0 .2rem rgba(253, 116, 53, .5)
}

.badge-secondary {
    color: #fff;
    background-color: #ffffff
}

a.badge-secondary:focus,
a.badge-secondary:hover {
    color: #fff;
    background-color: #fff
}

a.badge-secondary.focus,
a.badge-secondary:focus {
    outline: 0;
    box-shadow: 0 0 0 .2rem rgba(0, 123, 255, .5)
}

.badge-success {
    color: #fff;
    background-color: #d4edda
}

a.badge-success:focus,
a.badge-success:hover {
    color: #fff;
    background-color: #1e7e34
}

a.badge-success.focus,
a.badge-success:focus {
    outline: 0;
    box-shadow: 0 0 0 .2rem rgba(40, 167, 69, .5)
}

.badge-info {
    color: #fff;
    background-color: #17a2b8
}

a.badge-info:focus,
a.badge-info:hover {
    color: #fff;
    background-color: #117a8b
}

a.badge-info.focus,
a.badge-info:focus {
    outline: 0;
    box-shadow: 0 0 0 .2rem rgba(23, 162, 184, .5)
}

.badge-warning {
    color: #212529;
    background-color: #ffc107
}

a.badge-warning:focus,
a.badge-warning:hover {
    color: #212529;
    background-color: #d39e00
}

a.badge-warning.focus,
a.badge-warning:focus {
    outline: 0;
    box-shadow: 0 0 0 .2rem rgba(255, 193, 7, .5)
}

.badge-danger {
    color: #fff;
    background-color: #dc3545
}

a.badge-danger:focus,
a.badge-danger:hover {
    color: #fff;
    background-color: #bd2130
}

a.badge-danger.focus,
a.badge-danger:focus {
    outline: 0;
    box-shadow: 0 0 0 .2rem rgba(220, 53, 69, .5)
}

.badge-light {
    color: #212529;
    background-color: #f8f9fa
}

a.badge-light:focus,
a.badge-light:hover {
    color: #212529;
    background-color: #dae0e5
}

a.badge-light.focus,
a.badge-light:focus {
    outline: 0;
    box-shadow: 0 0 0 .2rem rgba(248, 249, 250, .5)
}

.badge-dark {
    color: #fff;
    background-color: #343a40
}

a.badge-dark:focus,
a.badge-dark:hover {
    color: #fff;
    background-color: #1d2124
}

a.badge-dark.focus,
a.badge-dark:focus {
    outline: 0;
    box-shadow: 0 0 0 .2rem rgba(52, 58, 64, .5)
}

.jumbotron {
    padding: 2rem 1rem;
    margin-bottom: 2rem;
    background-color: #e9ecef;
    border-radius: .3rem
}

@media (min-width:576px) {
    .jumbotron {
        padding: 4rem 2rem
    }
}

.jumbotron-fluid {
    padding-right: 0;
    padding-left: 0;
    border-radius: 0
}

.alert {
    position: relative;
    padding: .75rem 1.25rem;
    margin-bottom: 1rem;
    border: 1px solid transparent;
    border-radius: .25rem
}

.alert-heading {
    color: inherit
}

.alert-link {
    font-weight: 700
}

.alert-dismissible {
    padding-right: 4rem
}

.alert-dismissible .close {
    position: absolute;
    top: 0;
    right: 0;
    padding: .75rem 1.25rem;
    color: inherit
}

.alert-primary {
    color: #843c1c;
    background-color: #ffe3d7;
    border-color: #fed8c6
}

.alert-primary hr {
    border-top-color: #fec7ad
}

.alert-primary .alert-link {
    color: #5a2913
}

.alert-secondary {
    color: #004085;
    background-color: #cce5ff;
    border-color: #b8daff
}

.alert-secondary hr {
    border-top-color: #9fcdff
}

.alert-secondary .alert-link {
    color: #002752
}

.alert-success {
    color: #155724;
    background-color: #d4edda;
    border-color: #c3e6cb
}

.alert-success hr {
    border-top-color: #b1dfbb
}

.alert-success .alert-link {
    color: #0b2e13
}

.alert-info {
    color: #0c5460;
    background-color: #d1ecf1;
    border-color: #bee5eb
}

.alert-info hr {
    border-top-color: #abdde5
}

.alert-info .alert-link {
    color: #062c33
}

.alert-warning {
    color: #856404;
    background-color: #fff3cd;
    border-color: #ffeeba
}

.alert-warning hr {
    border-top-color: #ffe8a1
}

.alert-warning .alert-link {
    color: #533f03
}

.alert-danger {
    color: #721c24;
    background-color: #f8d7da;
    border-color: #f5c6cb
}

.alert-danger hr {
    border-top-color: #f1b0b7
}

.alert-danger .alert-link {
    color: #491217
}

.alert-light {
    color: #818182;
    background-color: #fefefe;
    border-color: #fdfdfe
}

.alert-light hr {
    border-top-color: #ececf6
}

.alert-light .alert-link {
    color: #686868
}

.alert-dark {
    color: #1b1e21;
    background-color: #d6d8d9;
    border-color: #c6c8ca
}

.alert-dark hr {
    border-top-color: #b9bbbe
}

.alert-dark .alert-link {
    color: #040505
}

@keyframes progress-bar-stripes {
    from {
        background-position: 1rem 0
    }

    to {
        background-position: 0 0
    }
}

.progress {
    display: flex;
    height: 1rem;
    overflow: hidden;
    line-height: 0;
    font-size: .75rem;
    background-color: #e9ecef;
    border-radius: .25rem
}

.progress-bar {
    display: flex;
    flex-direction: column;
    justify-content: center;
    overflow: hidden;
    color: #fff;
    text-align: center;
    white-space: nowrap;
    background-color: #93e8e1;
    transition: width .6s ease
}

@media (prefers-reduced-motion:reduce) {
    .progress-bar {
        transition: none
    }
}

.progress-bar-striped {
    background-image: linear-gradient(45deg, rgba(255, 255, 255, .15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, .15) 50%, rgba(255, 255, 255, .15) 75%, transparent 75%, transparent);
    background-size: 1rem 1rem
}

.progress-bar-animated {
    animation: progress-bar-stripes 1s linear infinite
}

@media (prefers-reduced-motion:reduce) {
    .progress-bar-animated {
        animation: none
    }
}

.media {
    display: flex;
    align-items: flex-start
}

.media-body {
    flex: 1
}

.list-group {
    display: flex;
    flex-direction: column;
    padding-left: 0;
    margin-bottom: 0;
    border-radius: .25rem
}

.list-group-item-action {
    width: 100%;
    color: #495057;
    text-align: inherit
}

.list-group-item-action:focus,
.list-group-item-action:hover {
    z-index: 1;
    color: #495057;
    text-decoration: none;
    background-color: #f8f9fa
}

.list-group-item-action:active {
    color: #212529;
    background-color: #e9ecef
}

.list-group-item {
    position: relative;
    display: block;
    padding: .75rem 1.25rem;
    background-color: #fff;
    border: 1px solid rgba(0, 0, 0, .125)
}

.list-group-item:first-child {
    border-top-left-radius: inherit;
    border-top-right-radius: inherit
}

.list-group-item:last-child {
    border-bottom-right-radius: inherit;
    border-bottom-left-radius: inherit
}

.list-group-item.disabled,
.list-group-item:disabled {
    color: #6c757d;
    pointer-events: none;
    background-color: #fff
}

.list-group-item.active {
    z-index: 2;
    color: #fff;
    background-color: #93e8e1;
    border-color: #93e8e1
}

.list-group-item+.list-group-item {
    border-top-width: 0
}

.list-group-item+.list-group-item.active {
    margin-top: -1px;
    border-top-width: 1px
}

.list-group-horizontal {
    flex-direction: row
}

.list-group-horizontal>.list-group-item:first-child {
    border-bottom-left-radius: .25rem;
    border-top-right-radius: 0
}

.list-group-horizontal>.list-group-item:last-child {
    border-top-right-radius: .25rem;
    border-bottom-left-radius: 0
}

.list-group-horizontal>.list-group-item.active {
    margin-top: 0
}

.list-group-horizontal>.list-group-item+.list-group-item {
    border-top-width: 1px;
    border-left-width: 0
}

.list-group-horizontal>.list-group-item+.list-group-item.active {
    margin-left: -1px;
    border-left-width: 1px
}

@media (min-width:576px) {
    .list-group-horizontal-sm {
        flex-direction: row
    }

    .list-group-horizontal-sm>.list-group-item:first-child {
        border-bottom-left-radius: .25rem;
        border-top-right-radius: 0
    }

    .list-group-horizontal-sm>.list-group-item:last-child {
        border-top-right-radius: .25rem;
        border-bottom-left-radius: 0
    }

    .list-group-horizontal-sm>.list-group-item.active {
        margin-top: 0
    }

    .list-group-horizontal-sm>.list-group-item+.list-group-item {
        border-top-width: 1px;
        border-left-width: 0
    }

    .list-group-horizontal-sm>.list-group-item+.list-group-item.active {
        margin-left: -1px;
        border-left-width: 1px
    }
}

@media (min-width:768px) {
    .list-group-horizontal-md {
        flex-direction: row
    }

    .list-group-horizontal-md>.list-group-item:first-child {
        border-bottom-left-radius: .25rem;
        border-top-right-radius: 0
    }

    .list-group-horizontal-md>.list-group-item:last-child {
        border-top-right-radius: .25rem;
        border-bottom-left-radius: 0
    }

    .list-group-horizontal-md>.list-group-item.active {
        margin-top: 0
    }

    .list-group-horizontal-md>.list-group-item+.list-group-item {
        border-top-width: 1px;
        border-left-width: 0
    }

    .list-group-horizontal-md>.list-group-item+.list-group-item.active {
        margin-left: -1px;
        border-left-width: 1px
    }
}

@media (min-width:992px) {
    .list-group-horizontal-lg {
        flex-direction: row
    }

    .list-group-horizontal-lg>.list-group-item:first-child {
        border-bottom-left-radius: .25rem;
        border-top-right-radius: 0
    }

    .list-group-horizontal-lg>.list-group-item:last-child {
        border-top-right-radius: .25rem;
        border-bottom-left-radius: 0
    }

    .list-group-horizontal-lg>.list-group-item.active {
        margin-top: 0
    }

    .list-group-horizontal-lg>.list-group-item+.list-group-item {
        border-top-width: 1px;
        border-left-width: 0
    }

    .list-group-horizontal-lg>.list-group-item+.list-group-item.active {
        margin-left: -1px;
        border-left-width: 1px
    }
}

@media (min-width:1200px) {
    .list-group-horizontal-xl {
        flex-direction: row
    }

    .list-group-horizontal-xl>.list-group-item:first-child {
        border-bottom-left-radius: .25rem;
        border-top-right-radius: 0
    }

    .list-group-horizontal-xl>.list-group-item:last-child {
        border-top-right-radius: .25rem;
        border-bottom-left-radius: 0
    }

    .list-group-horizontal-xl>.list-group-item.active {
        margin-top: 0
    }

    .list-group-horizontal-xl>.list-group-item+.list-group-item {
        border-top-width: 1px;
        border-left-width: 0
    }

    .list-group-horizontal-xl>.list-group-item+.list-group-item.active {
        margin-left: -1px;
        border-left-width: 1px
    }
}

.list-group-flush {
    border-radius: 0
}

.list-group-flush>.list-group-item {
    border-width: 0 0 1px
}

.list-group-flush>.list-group-item:last-child {
    border-bottom-width: 0
}

.list-group-item-primary {
    color: #843c1c;
    background-color: #fed8c6
}

.list-group-item-primary.list-group-item-action:focus,
.list-group-item-primary.list-group-item-action:hover {
    color: #843c1c;
    background-color: #fec7ad
}

.list-group-item-primary.list-group-item-action.active {
    color: #fff;
    background-color: #843c1c;
    border-color: #843c1c
}

.list-group-item-secondary {
    color: #004085;
    background-color: #b8daff
}

.list-group-item-secondary.list-group-item-action:focus,
.list-group-item-secondary.list-group-item-action:hover {
    color: #004085;
    background-color: #9fcdff
}

.list-group-item-secondary.list-group-item-action.active {
    color: #fff;
    background-color: #004085;
    border-color: #004085
}

.list-group-item-success {
    color: #155724;
    background-color: #c3e6cb
}

.list-group-item-success.list-group-item-action:focus,
.list-group-item-success.list-group-item-action:hover {
    color: #155724;
    background-color: #b1dfbb
}

.list-group-item-success.list-group-item-action.active {
    color: #fff;
    background-color: #155724;
    border-color: #155724
}

.list-group-item-info {
    color: #0c5460;
    background-color: #bee5eb
}

.list-group-item-info.list-group-item-action:focus,
.list-group-item-info.list-group-item-action:hover {
    color: #0c5460;
    background-color: #abdde5
}

.list-group-item-info.list-group-item-action.active {
    color: #fff;
    background-color: #0c5460;
    border-color: #0c5460
}

.list-group-item-warning {
    color: #856404;
    background-color: #ffeeba
}

.list-group-item-warning.list-group-item-action:focus,
.list-group-item-warning.list-group-item-action:hover {
    color: #856404;
    background-color: #ffe8a1
}

.list-group-item-warning.list-group-item-action.active {
    color: #fff;
    background-color: #856404;
    border-color: #856404
}

.list-group-item-danger {
    color: #721c24;
    background-color: #f5c6cb
}

.list-group-item-danger.list-group-item-action:focus,
.list-group-item-danger.list-group-item-action:hover {
    color: #721c24;
    background-color: #f1b0b7
}

.list-group-item-danger.list-group-item-action.active {
    color: #fff;
    background-color: #721c24;
    border-color: #721c24
}

.list-group-item-light {
    color: #818182;
    background-color: #fdfdfe
}

.list-group-item-light.list-group-item-action:focus,
.list-group-item-light.list-group-item-action:hover {
    color: #818182;
    background-color: #ececf6
}

.list-group-item-light.list-group-item-action.active {
    color: #fff;
    background-color: #818182;
    border-color: #818182
}

.list-group-item-dark {
    color: #1b1e21;
    background-color: #c6c8ca
}

.list-group-item-dark.list-group-item-action:focus,
.list-group-item-dark.list-group-item-action:hover {
    color: #1b1e21;
    background-color: #b9bbbe
}

.list-group-item-dark.list-group-item-action.active {
    color: #fff;
    background-color: #1b1e21;
    border-color: #1b1e21
}

.close {
    float: right;
    font-size: 1.5rem;
    font-weight: 700;
    line-height: 1;
    color: #000;
    text-shadow: 0 1px 0 #fff;
    opacity: .5
}

@media (max-width:1200px) {
    .close {
        font-size: calc(1.275rem + .3vw)
    }
}

.close:hover {
    color: #000;
    text-decoration: none
}

.close:not(:disabled):not(.disabled):focus,
.close:not(:disabled):not(.disabled):hover {
    opacity: .75
}

button.close {
    padding: 0;
    background-color: transparent;
    border: 0
}

a.close.disabled {
    pointer-events: none
}

.toast {
    max-width: 350px;
    overflow: hidden;
    font-size: .875rem;
    background-color: rgba(255, 255, 255, .85);
    background-clip: padding-box;
    border: 1px solid rgba(0, 0, 0, .1);
    box-shadow: 0 .25rem .75rem rgba(0, 0, 0, .1);
    backdrop-filter: blur(10px);
    opacity: 0;
    border-radius: .25rem
}

.toast:not(:last-child) {
    margin-bottom: .75rem
}

.toast.showing {
    opacity: 1
}

.toast.show {
    display: block;
    opacity: 1
}

.toast.hide {
    display: none
}

.toast-header {
    display: flex;
    align-items: center;
    padding: .25rem .75rem;
    color: #6c757d;
    background-color: rgba(255, 255, 255, .85);
    background-clip: padding-box;
    border-bottom: 1px solid rgba(0, 0, 0, .05)
}

.toast-body {
    padding: .75rem
}

.modal-open {
    overflow: hidden
}

.modal-open .modal {
    overflow-x: hidden;
    overflow-y: auto
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1050;
    display: none;
    width: 100%;
    height: 100%;
    overflow: hidden;
    outline: 0
}

.modal-dialog {
    position: relative;
    width: auto;
    margin: .5rem;
    pointer-events: none
}

.modal.fade .modal-dialog {
    transition: transform .3s ease-out;
    transform: translate(0, -50px)
}

@media (prefers-reduced-motion:reduce) {
    .modal.fade .modal-dialog {
        transition: none
    }
}

.modal.show .modal-dialog {
    transform: none
}

.modal.modal-static .modal-dialog {
    transform: scale(1.02)
}

.modal-dialog-scrollable {
    display: flex;
    max-height: calc(100% - 1rem)
}

.modal-dialog-scrollable .modal-content {
    max-height: calc(100vh - 1rem);
    overflow: hidden
}

.modal-dialog-scrollable .modal-footer,
.modal-dialog-scrollable .modal-header {
    flex-shrink: 0
}

.modal-dialog-scrollable .modal-body {
    overflow-y: auto
}

.modal-dialog-centered {
    display: flex;
    align-items: center;
    min-height: calc(100% - 1rem)
}

.modal-dialog-centered::before {
    display: block;
    height: calc(100vh - 1rem);
    height: min-content;
    content: ""
}

.modal-dialog-centered.modal-dialog-scrollable {
    flex-direction: column;
    justify-content: center;
    height: 100%
}

.modal-dialog-centered.modal-dialog-scrollable .modal-content {
    max-height: none
}

.modal-dialog-centered.modal-dialog-scrollable::before {
    content: none
}

.modal-content {
    position: relative;
    display: flex;
    flex-direction: column;
    width: 100%;
    pointer-events: auto;
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid rgba(0, 0, 0, .2);
    border-radius: .3rem;
    outline: 0
}

.modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1040;
    width: 100vw;
    height: 100vh;
    background-color: #000
}

.modal-backdrop.fade {
    opacity: 0
}

.modal-backdrop.show {
    opacity: .5
}

.modal-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    padding: 1rem 1rem;
    border-bottom: 1px solid #dee2e6;
    border-top-left-radius: calc(.3rem - 1px);
    border-top-right-radius: calc(.3rem - 1px)
}

.modal-header .close {
    padding: 1rem 1rem;
    margin: -1rem -1rem -1rem auto
}

.modal-title {
    margin-bottom: 0;
    line-height: 1.5
}

.modal-body {
    position: relative;
    flex: 1 1 auto;
    padding: 1rem
}

.modal-footer {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: flex-end;
    padding: .75rem;
    border-top: 1px solid #dee2e6;
    border-bottom-right-radius: calc(.3rem - 1px);
    border-bottom-left-radius: calc(.3rem - 1px)
}

.modal-footer>* {
    margin: .25rem
}

.modal-scrollbar-measure {
    position: absolute;
    top: -9999px;
    width: 50px;
    height: 50px;
    overflow: scroll
}

@media (min-width:576px) {
    .modal-dialog {
        max-width: 500px;
        margin: 1.75rem auto
    }

    .modal-dialog-scrollable {
        max-height: calc(100% - 3.5rem)
    }

    .modal-dialog-scrollable .modal-content {
        max-height: calc(100vh - 3.5rem)
    }

    .modal-dialog-centered {
        min-height: calc(100% - 3.5rem)
    }

    .modal-dialog-centered::before {
        height: calc(100vh - 3.5rem);
        height: min-content
    }

    .modal-sm {
        max-width: 300px
    }
}

@media (min-width:992px) {

    .modal-lg,
    .modal-xl {
        max-width: 800px
    }
}

@media (min-width:1200px) {
    .modal-xl {
        max-width: 1140px
    }
}

.tooltip {
    position: absolute;
    z-index: 1070;
    display: block;
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    font-style: normal;
    font-weight: 400;
    line-height: 1.5;
    text-align: left;
    text-align: start;
    text-decoration: none;
    text-shadow: none;
    text-transform: none;
    letter-spacing: normal;
    word-break: normal;
    word-spacing: normal;
    white-space: normal;
    line-break: auto;
    font-size: .875rem;
    word-wrap: break-word;
    opacity: 0
}

.tooltip.show {
    opacity: .9
}

.tooltip .arrow {
    position: absolute;
    display: block;
    width: .8rem;
    height: .4rem
}

.tooltip .arrow::before {
    position: absolute;
    content: "";
    border-color: transparent;
    border-style: solid
}

.bs-tooltip-auto[x-placement^=top],
.bs-tooltip-top {
    padding: .4rem 0
}

.bs-tooltip-auto[x-placement^=top] .arrow,
.bs-tooltip-top .arrow {
    bottom: 0
}

.bs-tooltip-auto[x-placement^=top] .arrow::before,
.bs-tooltip-top .arrow::before {
    top: 0;
    border-width: .4rem .4rem 0;
    border-top-color: #000
}

.bs-tooltip-auto[x-placement^=right],
.bs-tooltip-right {
    padding: 0 .4rem
}

.bs-tooltip-auto[x-placement^=right] .arrow,
.bs-tooltip-right .arrow {
    left: 0;
    width: .4rem;
    height: .8rem
}

.bs-tooltip-auto[x-placement^=right] .arrow::before,
.bs-tooltip-right .arrow::before {
    right: 0;
    border-width: .4rem .4rem .4rem 0;
    border-right-color: #000
}

.bs-tooltip-auto[x-placement^=bottom],
.bs-tooltip-bottom {
    padding: .4rem 0
}

.bs-tooltip-auto[x-placement^=bottom] .arrow,
.bs-tooltip-bottom .arrow {
    top: 0
}

.bs-tooltip-auto[x-placement^=bottom] .arrow::before,
.bs-tooltip-bottom .arrow::before {
    bottom: 0;
    border-width: 0 .4rem .4rem;
    border-bottom-color: #000
}

.bs-tooltip-auto[x-placement^=left],
.bs-tooltip-left {
    padding: 0 .4rem
}

.bs-tooltip-auto[x-placement^=left] .arrow,
.bs-tooltip-left .arrow {
    right: 0;
    width: .4rem;
    height: .8rem
}

.bs-tooltip-auto[x-placement^=left] .arrow::before,
.bs-tooltip-left .arrow::before {
    left: 0;
    border-width: .4rem 0 .4rem .4rem;
    border-left-color: #000
}

.tooltip-inner {
    max-width: 200px;
    padding: .25rem .5rem;
    color: #fff;
    text-align: center;
    background-color: #000;
    border-radius: .25rem
}

.popover {
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1060;
    display: block;
    max-width: 276px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    font-style: normal;
    font-weight: 400;
    line-height: 1.5;
    text-align: left;
    text-align: start;
    text-decoration: none;
    text-shadow: none;
    text-transform: none;
    letter-spacing: normal;
    word-break: normal;
    word-spacing: normal;
    white-space: normal;
    line-break: auto;
    font-size: .875rem;
    word-wrap: break-word;
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid rgba(0, 0, 0, .2);
    border-radius: .3rem
}

.popover .arrow {
    position: absolute;
    display: block;
    width: 1rem;
    height: .5rem;
    margin: 0 .3rem
}

.popover .arrow::after,
.popover .arrow::before {
    position: absolute;
    display: block;
    content: "";
    border-color: transparent;
    border-style: solid
}

.bs-popover-auto[x-placement^=top],
.bs-popover-top {
    margin-bottom: .5rem
}

.bs-popover-auto[x-placement^=top]>.arrow,
.bs-popover-top>.arrow {
    bottom: calc(-.5rem - 1px)
}

.bs-popover-auto[x-placement^=top]>.arrow::before,
.bs-popover-top>.arrow::before {
    bottom: 0;
    border-width: .5rem .5rem 0;
    border-top-color: rgba(0, 0, 0, .25)
}

.bs-popover-auto[x-placement^=top]>.arrow::after,
.bs-popover-top>.arrow::after {
    bottom: 1px;
    border-width: .5rem .5rem 0;
    border-top-color: #fff
}

.bs-popover-auto[x-placement^=right],
.bs-popover-right {
    margin-left: .5rem
}

.bs-popover-auto[x-placement^=right]>.arrow,
.bs-popover-right>.arrow {
    left: calc(-.5rem - 1px);
    width: .5rem;
    height: 1rem;
    margin: .3rem 0
}

.bs-popover-auto[x-placement^=right]>.arrow::before,
.bs-popover-right>.arrow::before {
    left: 0;
    border-width: .5rem .5rem .5rem 0;
    border-right-color: rgba(0, 0, 0, .25)
}

.bs-popover-auto[x-placement^=right]>.arrow::after,
.bs-popover-right>.arrow::after {
    left: 1px;
    border-width: .5rem .5rem .5rem 0;
    border-right-color: #fff
}

.bs-popover-auto[x-placement^=bottom],
.bs-popover-bottom {
    margin-top: .5rem
}

.bs-popover-auto[x-placement^=bottom]>.arrow,
.bs-popover-bottom>.arrow {
    top: calc(-.5rem - 1px)
}

.bs-popover-auto[x-placement^=bottom]>.arrow::before,
.bs-popover-bottom>.arrow::before {
    top: 0;
    border-width: 0 .5rem .5rem .5rem;
    border-bottom-color: rgba(0, 0, 0, .25)
}

.bs-popover-auto[x-placement^=bottom]>.arrow::after,
.bs-popover-bottom>.arrow::after {
    top: 1px;
    border-width: 0 .5rem .5rem .5rem;
    border-bottom-color: #fff
}

.bs-popover-auto[x-placement^=bottom] .popover-header::before,
.bs-popover-bottom .popover-header::before {
    position: absolute;
    top: 0;
    left: 50%;
    display: block;
    width: 1rem;
    margin-left: -.5rem;
    content: "";
    border-bottom: 1px solid #f7f7f7
}

.bs-popover-auto[x-placement^=left],
.bs-popover-left {
    margin-right: .5rem
}

.bs-popover-auto[x-placement^=left]>.arrow,
.bs-popover-left>.arrow {
    right: calc(-.5rem - 1px);
    width: .5rem;
    height: 1rem;
    margin: .3rem 0
}

.bs-popover-auto[x-placement^=left]>.arrow::before,
.bs-popover-left>.arrow::before {
    right: 0;
    border-width: .5rem 0 .5rem .5rem;
    border-left-color: rgba(0, 0, 0, .25)
}

.bs-popover-auto[x-placement^=left]>.arrow::after,
.bs-popover-left>.arrow::after {
    right: 1px;
    border-width: .5rem 0 .5rem .5rem;
    border-left-color: #fff
}

.popover-header {
    padding: .5rem .75rem;
    margin-bottom: 0;
    font-size: 1rem;
    background-color: #f7f7f7;
    border-bottom: 1px solid #ebebeb;
    border-top-left-radius: calc(.3rem - 1px);
    border-top-right-radius: calc(.3rem - 1px)
}

.popover-header:empty {
    display: none
}

.popover-body {
    padding: .5rem .75rem;
    color: #212529
}

.carousel {
    position: relative
}

.carousel.pointer-event {
    touch-action: pan-y
}

.carousel-inner {
    position: relative;
    width: 100%;
    overflow: hidden
}

.carousel-inner::after {
    display: block;
    clear: both;
    content: ""
}

.carousel-item {
    position: relative;
    display: none;
    float: left;
    width: 100%;
    margin-right: -100%;
    backface-visibility: hidden;
    transition: transform .6s ease-in-out
}

@media (prefers-reduced-motion:reduce) {
    .carousel-item {
        transition: none
    }
}

.carousel-item-next,
.carousel-item-prev,
.carousel-item.active {
    display: block
}

.active.carousel-item-right,
.carousel-item-next:not(.carousel-item-left) {
    transform: translateX(100%)
}

.active.carousel-item-left,
.carousel-item-prev:not(.carousel-item-right) {
    transform: translateX(-100%)
}

.carousel-fade .carousel-item {
    opacity: 0;
    transition-property: opacity;
    transform: none
}

.carousel-fade .carousel-item-next.carousel-item-left,
.carousel-fade .carousel-item-prev.carousel-item-right,
.carousel-fade .carousel-item.active {
    z-index: 1;
    opacity: 1
}

.carousel-fade .active.carousel-item-left,
.carousel-fade .active.carousel-item-right {
    z-index: 0;
    opacity: 0;
    transition: opacity 0s .6s
}

@media (prefers-reduced-motion:reduce) {

    .carousel-fade .active.carousel-item-left,
    .carousel-fade .active.carousel-item-right {
        transition: none
    }
}

.carousel-control-next,
.carousel-control-prev {
    position: absolute;
    top: 0;
    bottom: 0;
    z-index: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 15%;
    color: #fff;
    text-align: center;
    opacity: .5;
    transition: opacity .15s ease
}

@media (prefers-reduced-motion:reduce) {

    .carousel-control-next,
    .carousel-control-prev {
        transition: none
    }
}

.carousel-control-next:focus,
.carousel-control-next:hover,
.carousel-control-prev:focus,
.carousel-control-prev:hover {
    color: #fff;
    text-decoration: none;
    outline: 0;
    opacity: .9
}

.carousel-control-prev {
    left: 0
}

.carousel-control-next {
    right: 0
}

.carousel-control-next-icon,
.carousel-control-prev-icon {
    display: inline-block;
    width: 20px;
    height: 20px;
    background: no-repeat 50%/100% 100%
}

.carousel-control-prev-icon {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='%23fff' width='8' height='8' viewBox='0 0 8 8'%3e%3cpath d='M5.25 0l-4 4 4 4 1.5-1.5L4.25 4l2.5-2.5L5.25 0z'/%3e%3c/svg%3e")
}

.carousel-control-next-icon {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='%23fff' width='8' height='8' viewBox='0 0 8 8'%3e%3cpath d='M2.75 0l-1.5 1.5L3.75 4l-2.5 2.5L2.75 8l4-4-4-4z'/%3e%3c/svg%3e")
}

.carousel-indicators {
    position: absolute;
    right: 0;
    bottom: 0;
    left: 0;
    z-index: 15;
    display: flex;
    justify-content: center;
    padding-left: 0;
    margin-right: 15%;
    margin-left: 15%;
    list-style: none
}

.carousel-indicators li {
    box-sizing: content-box;
    flex: 0 1 auto;
    width: 30px;
    height: 3px;
    margin-right: 3px;
    margin-left: 3px;
    text-indent: -999px;
    cursor: pointer;
    background-color: #fff;
    background-clip: padding-box;
    border-top: 10px solid transparent;
    border-bottom: 10px solid transparent;
    opacity: .5;
    transition: opacity .6s ease
}

@media (prefers-reduced-motion:reduce) {
    .carousel-indicators li {
        transition: none
    }
}

.carousel-indicators .active {
    opacity: 1
}

.carousel-caption {
    position: absolute;
    right: 15%;
    bottom: 20px;
    left: 15%;
    z-index: 10;
    padding-top: 20px;
    padding-bottom: 20px;
    color: #fff;
    text-align: center
}

@keyframes spinner-border {
    to {
        transform: rotate(360deg)
    }
}

.spinner-border {
    display: inline-block;
    width: 2rem;
    height: 2rem;
    vertical-align: text-bottom;
    border: .25em solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: spinner-border .75s linear infinite
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
    border-width: .2em
}

@keyframes spinner-grow {
    0% {
        transform: scale(0)
    }

    50% {
        opacity: 1;
        transform: none
    }
}

.spinner-grow {
    display: inline-block;
    width: 2rem;
    height: 2rem;
    vertical-align: text-bottom;
    background-color: currentColor;
    border-radius: 50%;
    opacity: 0;
    animation: spinner-grow .75s linear infinite
}

.spinner-grow-sm {
    width: 1rem;
    height: 1rem
}

.align-baseline {
    vertical-align: baseline !important
}

.align-top {
    vertical-align: top !important
}

.align-middle {
    vertical-align: middle !important
}

.align-bottom {
    vertical-align: bottom !important
}

.align-text-bottom {
    vertical-align: text-bottom !important
}

.align-text-top {
    vertical-align: text-top !important
}

.bg-primary {
    background-color: #93e8e1 !important
}

a.bg-primary:focus,
a.bg-primary:hover,
button.bg-primary:focus,
button.bg-primary:hover {
    background-color: #93e8e1 !important
}

.bg-secondary {
    background-color: #ffffff !important
}

a.bg-secondary:focus,
a.bg-secondary:hover,
button.bg-secondary:focus,
button.bg-secondary:hover {
    background-color: #fff !important
}

.bg-success {
    background-color: #d4edda !important
}

a.bg-success:focus,
a.bg-success:hover,
button.bg-success:focus,
button.bg-success:hover {
    background-color: #1e7e34 !important
}

.bg-info {
    background-color: #17a2b8 !important
}

a.bg-info:focus,
a.bg-info:hover,
button.bg-info:focus,
button.bg-info:hover {
    background-color: #117a8b !important
}

.bg-warning {
    background-color: #ffc107 !important
}

a.bg-warning:focus,
a.bg-warning:hover,
button.bg-warning:focus,
button.bg-warning:hover {
    background-color: #d39e00 !important
}

.bg-danger {
    background-color: #f8d7da !important;
    color: #721c24;
}

a.bg-danger:focus,
a.bg-danger:hover,
button.bg-danger:focus,
button.bg-danger:hover {
    background-color: #bd2130 !important
}

.bg-light {
    background-color: #f8f9fa !important
}

a.bg-light:focus,
a.bg-light:hover,
button.bg-light:focus,
button.bg-light:hover {
    background-color: #dae0e5 !important
}

.bg-dark {
    background-color: #343a40 !important
}

a.bg-dark:focus,
a.bg-dark:hover,
button.bg-dark:focus,
button.bg-dark:hover {
    background-color: #1d2124 !important
}

.bg-white {
    background-color: #fff !important
}

.bg-transparent {
    background-color: transparent !important
}

.border {
    border: 1px solid #dee2e6 !important
}

.border-top {
    border-top: 1px solid #dee2e6 !important
}

.border-right {
    border-right: 1px solid #dee2e6 !important
}

.border-bottom {
    border-bottom: 1px solid #dee2e6 !important
}

.border-left {
    border-left: 1px solid #dee2e6 !important
}

.border-0 {
    border: 0 !important
}

.border-top-0 {
    border-top: 0 !important
}

.border-right-0 {
    border-right: 0 !important
}

.border-bottom-0 {
    border-bottom: 0 !important
}

.border-left-0 {
    border-left: 0 !important
}

.border-primary {
    border-color: #93e8e1 !important
}

.border-secondary {
    border-color: #ffffff !important
}

.border-success {
    border-color: #d4edda !important
}

.border-info {
    border-color: #17a2b8 !important
}

.border-warning {
    border-color: #ffc107 !important
}

.border-danger {
    border-color: #dc3545 !important
}

.border-light {
    border-color: #f8f9fa !important
}

.border-dark {
    border-color: #343a40 !important
}

.border-white {
    border-color: #fff !important
}

.rounded-sm {
    border-radius: .2rem !important
}

.rounded {
    border-radius: .25rem !important
}

.rounded-top {
    border-top-left-radius: .25rem !important;
    border-top-right-radius: .25rem !important
}

.rounded-right {
    border-top-right-radius: .25rem !important;
    border-bottom-right-radius: .25rem !important
}

.rounded-bottom {
    border-bottom-right-radius: .25rem !important;
    border-bottom-left-radius: .25rem !important
}

.rounded-left {
    border-top-left-radius: .25rem !important;
    border-bottom-left-radius: .25rem !important
}

.rounded-lg {
    border-radius: .3rem !important
}

.rounded-circle {
    border-radius: 50% !important
}

.rounded-pill {
    border-radius: 50rem !important
}

.rounded-0 {
    border-radius: 0 !important
}

.clearfix::after {
    display: block;
    clear: both;
    content: ""
}

.d-none {
    display: none !important
}

.d-inline {
    display: inline !important
}

.d-inline-block {
    display: inline-block !important
}

.d-block {
    display: block !important
}

.d-table {
    display: table !important
}

.d-table-row {
    display: table-row !important
}

.d-table-cell {
    display: table-cell !important
}

.d-flex {
    display: flex !important
}

.d-inline-flex {
    display: inline-flex !important
}

@media (min-width:576px) {
    .d-sm-none {
        display: none !important
    }

    .d-sm-inline {
        display: inline !important
    }

    .d-sm-inline-block {
        display: inline-block !important
    }

    .d-sm-block {
        display: block !important
    }

    .d-sm-table {
        display: table !important
    }

    .d-sm-table-row {
        display: table-row !important
    }

    .d-sm-table-cell {
        display: table-cell !important
    }

    .d-sm-flex {
        display: flex !important
    }

    .d-sm-inline-flex {
        display: inline-flex !important
    }
}

@media (min-width:768px) {
    .d-md-none {
        display: none !important
    }

    .d-md-inline {
        display: inline !important
    }

    .d-md-inline-block {
        display: inline-block !important
    }

    .d-md-block {
        display: block !important
    }

    .d-md-table {
        display: table !important
    }

    .d-md-table-row {
        display: table-row !important
    }

    .d-md-table-cell {
        display: table-cell !important
    }

    .d-md-flex {
        display: flex !important
    }

    .d-md-inline-flex {
        display: inline-flex !important
    }
}

@media (min-width:992px) {
    .d-lg-none {
        display: none !important
    }

    .d-lg-inline {
        display: inline !important
    }

    .d-lg-inline-block {
        display: inline-block !important
    }

    .d-lg-block {
        display: block !important
    }

    .d-lg-table {
        display: table !important
    }

    .d-lg-table-row {
        display: table-row !important
    }

    .d-lg-table-cell {
        display: table-cell !important
    }

    .d-lg-flex {
        display: flex !important
    }

    .d-lg-inline-flex {
        display: inline-flex !important
    }
}

@media (min-width:1200px) {
    .d-xl-none {
        display: none !important
    }

    .d-xl-inline {
        display: inline !important
    }

    .d-xl-inline-block {
        display: inline-block !important
    }

    .d-xl-block {
        display: block !important
    }

    .d-xl-table {
        display: table !important
    }

    .d-xl-table-row {
        display: table-row !important
    }

    .d-xl-table-cell {
        display: table-cell !important
    }

    .d-xl-flex {
        display: flex !important
    }

    .d-xl-inline-flex {
        display: inline-flex !important
    }
}

@media print {
    .d-print-none {
        display: none !important
    }

    .d-print-inline {
        display: inline !important
    }

    .d-print-inline-block {
        display: inline-block !important
    }

    .d-print-block {
        display: block !important
    }

    .d-print-table {
        display: table !important
    }

    .d-print-table-row {
        display: table-row !important
    }

    .d-print-table-cell {
        display: table-cell !important
    }

    .d-print-flex {
        display: flex !important
    }

    .d-print-inline-flex {
        display: inline-flex !important
    }
}

.embed-responsive {
    position: relative;
    display: block;
    width: 100%;
    padding: 0;
    overflow: hidden
}

.embed-responsive::before {
    display: block;
    content: ""
}

.embed-responsive .embed-responsive-item,
.embed-responsive embed,
.embed-responsive iframe,
.embed-responsive object,
.embed-responsive video {
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 0
}

.embed-responsive-21by9::before {
    padding-top: 42.85714%
}

.embed-responsive-16by9::before {
    padding-top: 56.25%
}

.embed-responsive-4by3::before {
    padding-top: 75%
}

.embed-responsive-1by1::before {
    padding-top: 100%
}

.flex-row {
    flex-direction: row !important
}

.flex-column {
    flex-direction: column !important
}

.flex-row-reverse {
    flex-direction: row-reverse !important
}

.flex-column-reverse {
    flex-direction: column-reverse !important
}

.flex-wrap {
    flex-wrap: wrap !important
}

.flex-nowrap {
    flex-wrap: nowrap !important
}

.flex-wrap-reverse {
    flex-wrap: wrap-reverse !important
}

.flex-fill {
    flex: 1 1 auto !important
}

.flex-grow-0 {
    flex-grow: 0 !important
}

.flex-grow-1 {
    flex-grow: 1 !important
}

.flex-shrink-0 {
    flex-shrink: 0 !important
}

.flex-shrink-1 {
    flex-shrink: 1 !important
}

.justify-content-start {
    justify-content: flex-start !important
}

.justify-content-end {
    justify-content: flex-end !important
}

.justify-content-center {
    justify-content: center !important
}

.justify-content-between {
    justify-content: space-between !important
}

.justify-content-around {
    justify-content: space-around !important
}

.align-items-start {
    align-items: flex-start !important
}

.align-items-end {
    align-items: flex-end !important
}

.align-items-center {
    align-items: center !important
}

.align-items-baseline {
    align-items: baseline !important
}

.align-items-stretch {
    align-items: stretch !important
}

.align-content-start {
    align-content: flex-start !important
}

.align-content-end {
    align-content: flex-end !important
}

.align-content-center {
    align-content: center !important
}

.align-content-between {
    align-content: space-between !important
}

.align-content-around {
    align-content: space-around !important
}

.align-content-stretch {
    align-content: stretch !important
}

.align-self-auto {
    align-self: auto !important
}

.align-self-start {
    align-self: flex-start !important
}

.align-self-end {
    align-self: flex-end !important
}

.align-self-center {
    align-self: center !important
}

.align-self-baseline {
    align-self: baseline !important
}

.align-self-stretch {
    align-self: stretch !important
}

@media (min-width:576px) {
    .flex-sm-row {
        flex-direction: row !important
    }

    .flex-sm-column {
        flex-direction: column !important
    }

    .flex-sm-row-reverse {
        flex-direction: row-reverse !important
    }

    .flex-sm-column-reverse {
        flex-direction: column-reverse !important
    }

    .flex-sm-wrap {
        flex-wrap: wrap !important
    }

    .flex-sm-nowrap {
        flex-wrap: nowrap !important
    }

    .flex-sm-wrap-reverse {
        flex-wrap: wrap-reverse !important
    }

    .flex-sm-fill {
        flex: 1 1 auto !important
    }

    .flex-sm-grow-0 {
        flex-grow: 0 !important
    }

    .flex-sm-grow-1 {
        flex-grow: 1 !important
    }

    .flex-sm-shrink-0 {
        flex-shrink: 0 !important
    }

    .flex-sm-shrink-1 {
        flex-shrink: 1 !important
    }

    .justify-content-sm-start {
        justify-content: flex-start !important
    }

    .justify-content-sm-end {
        justify-content: flex-end !important
    }

    .justify-content-sm-center {
        justify-content: center !important
    }

    .justify-content-sm-between {
        justify-content: space-between !important
    }

    .justify-content-sm-around {
        justify-content: space-around !important
    }

    .align-items-sm-start {
        align-items: flex-start !important
    }

    .align-items-sm-end {
        align-items: flex-end !important
    }

    .align-items-sm-center {
        align-items: center !important
    }

    .align-items-sm-baseline {
        align-items: baseline !important
    }

    .align-items-sm-stretch {
        align-items: stretch !important
    }

    .align-content-sm-start {
        align-content: flex-start !important
    }

    .align-content-sm-end {
        align-content: flex-end !important
    }

    .align-content-sm-center {
        align-content: center !important
    }

    .align-content-sm-between {
        align-content: space-between !important
    }

    .align-content-sm-around {
        align-content: space-around !important
    }

    .align-content-sm-stretch {
        align-content: stretch !important
    }

    .align-self-sm-auto {
        align-self: auto !important
    }

    .align-self-sm-start {
        align-self: flex-start !important
    }

    .align-self-sm-end {
        align-self: flex-end !important
    }

    .align-self-sm-center {
        align-self: center !important
    }

    .align-self-sm-baseline {
        align-self: baseline !important
    }

    .align-self-sm-stretch {
        align-self: stretch !important
    }
}

@media (min-width:768px) {
    .flex-md-row {
        flex-direction: row !important
    }

    .flex-md-column {
        flex-direction: column !important
    }

    .flex-md-row-reverse {
        flex-direction: row-reverse !important
    }

    .flex-md-column-reverse {
        flex-direction: column-reverse !important
    }

    .flex-md-wrap {
        flex-wrap: wrap !important
    }

    .flex-md-nowrap {
        flex-wrap: nowrap !important
    }

    .flex-md-wrap-reverse {
        flex-wrap: wrap-reverse !important
    }

    .flex-md-fill {
        flex: 1 1 auto !important
    }

    .flex-md-grow-0 {
        flex-grow: 0 !important
    }

    .flex-md-grow-1 {
        flex-grow: 1 !important
    }

    .flex-md-shrink-0 {
        flex-shrink: 0 !important
    }

    .flex-md-shrink-1 {
        flex-shrink: 1 !important
    }

    .justify-content-md-start {
        justify-content: flex-start !important
    }

    .justify-content-md-end {
        justify-content: flex-end !important
    }

    .justify-content-md-center {
        justify-content: center !important
    }

    .justify-content-md-between {
        justify-content: space-between !important
    }

    .justify-content-md-around {
        justify-content: space-around !important
    }

    .align-items-md-start {
        align-items: flex-start !important
    }

    .align-items-md-end {
        align-items: flex-end !important
    }

    .align-items-md-center {
        align-items: center !important
    }

    .align-items-md-baseline {
        align-items: baseline !important
    }

    .align-items-md-stretch {
        align-items: stretch !important
    }

    .align-content-md-start {
        align-content: flex-start !important
    }

    .align-content-md-end {
        align-content: flex-end !important
    }

    .align-content-md-center {
        align-content: center !important
    }

    .align-content-md-between {
        align-content: space-between !important
    }

    .align-content-md-around {
        align-content: space-around !important
    }

    .align-content-md-stretch {
        align-content: stretch !important
    }

    .align-self-md-auto {
        align-self: auto !important
    }

    .align-self-md-start {
        align-self: flex-start !important
    }

    .align-self-md-end {
        align-self: flex-end !important
    }

    .align-self-md-center {
        align-self: center !important
    }

    .align-self-md-baseline {
        align-self: baseline !important
    }

    .align-self-md-stretch {
        align-self: stretch !important
    }
}

@media (min-width:992px) {
    .flex-lg-row {
        flex-direction: row !important
    }

    .flex-lg-column {
        flex-direction: column !important
    }

    .flex-lg-row-reverse {
        flex-direction: row-reverse !important
    }

    .flex-lg-column-reverse {
        flex-direction: column-reverse !important
    }

    .flex-lg-wrap {
        flex-wrap: wrap !important
    }

    .flex-lg-nowrap {
        flex-wrap: nowrap !important
    }

    .flex-lg-wrap-reverse {
        flex-wrap: wrap-reverse !important
    }

    .flex-lg-fill {
        flex: 1 1 auto !important
    }

    .flex-lg-grow-0 {
        flex-grow: 0 !important
    }

    .flex-lg-grow-1 {
        flex-grow: 1 !important
    }

    .flex-lg-shrink-0 {
        flex-shrink: 0 !important
    }

    .flex-lg-shrink-1 {
        flex-shrink: 1 !important
    }

    .justify-content-lg-start {
        justify-content: flex-start !important
    }

    .justify-content-lg-end {
        justify-content: flex-end !important
    }

    .justify-content-lg-center {
        justify-content: center !important
    }

    .justify-content-lg-between {
        justify-content: space-between !important
    }

    .justify-content-lg-around {
        justify-content: space-around !important
    }

    .align-items-lg-start {
        align-items: flex-start !important
    }

    .align-items-lg-end {
        align-items: flex-end !important
    }

    .align-items-lg-center {
        align-items: center !important
    }

    .align-items-lg-baseline {
        align-items: baseline !important
    }

    .align-items-lg-stretch {
        align-items: stretch !important
    }

    .align-content-lg-start {
        align-content: flex-start !important
    }

    .align-content-lg-end {
        align-content: flex-end !important
    }

    .align-content-lg-center {
        align-content: center !important
    }

    .align-content-lg-between {
        align-content: space-between !important
    }

    .align-content-lg-around {
        align-content: space-around !important
    }

    .align-content-lg-stretch {
        align-content: stretch !important
    }

    .align-self-lg-auto {
        align-self: auto !important
    }

    .align-self-lg-start {
        align-self: flex-start !important
    }

    .align-self-lg-end {
        align-self: flex-end !important
    }

    .align-self-lg-center {
        align-self: center !important
    }

    .align-self-lg-baseline {
        align-self: baseline !important
    }

    .align-self-lg-stretch {
        align-self: stretch !important
    }
}

@media (min-width:1200px) {
    .flex-xl-row {
        flex-direction: row !important
    }

    .flex-xl-column {
        flex-direction: column !important
    }

    .flex-xl-row-reverse {
        flex-direction: row-reverse !important
    }

    .flex-xl-column-reverse {
        flex-direction: column-reverse !important
    }

    .flex-xl-wrap {
        flex-wrap: wrap !important
    }

    .flex-xl-nowrap {
        flex-wrap: nowrap !important
    }

    .flex-xl-wrap-reverse {
        flex-wrap: wrap-reverse !important
    }

    .flex-xl-fill {
        flex: 1 1 auto !important
    }

    .flex-xl-grow-0 {
        flex-grow: 0 !important
    }

    .flex-xl-grow-1 {
        flex-grow: 1 !important
    }

    .flex-xl-shrink-0 {
        flex-shrink: 0 !important
    }

    .flex-xl-shrink-1 {
        flex-shrink: 1 !important
    }

    .justify-content-xl-start {
        justify-content: flex-start !important
    }

    .justify-content-xl-end {
        justify-content: flex-end !important
    }

    .justify-content-xl-center {
        justify-content: center !important
    }

    .justify-content-xl-between {
        justify-content: space-between !important
    }

    .justify-content-xl-around {
        justify-content: space-around !important
    }

    .align-items-xl-start {
        align-items: flex-start !important
    }

    .align-items-xl-end {
        align-items: flex-end !important
    }

    .align-items-xl-center {
        align-items: center !important
    }

    .align-items-xl-baseline {
        align-items: baseline !important
    }

    .align-items-xl-stretch {
        align-items: stretch !important
    }

    .align-content-xl-start {
        align-content: flex-start !important
    }

    .align-content-xl-end {
        align-content: flex-end !important
    }

    .align-content-xl-center {
        align-content: center !important
    }

    .align-content-xl-between {
        align-content: space-between !important
    }

    .align-content-xl-around {
        align-content: space-around !important
    }

    .align-content-xl-stretch {
        align-content: stretch !important
    }

    .align-self-xl-auto {
        align-self: auto !important
    }

    .align-self-xl-start {
        align-self: flex-start !important
    }

    .align-self-xl-end {
        align-self: flex-end !important
    }

    .align-self-xl-center {
        align-self: center !important
    }

    .align-self-xl-baseline {
        align-self: baseline !important
    }

    .align-self-xl-stretch {
        align-self: stretch !important
    }
}

.float-left {
    float: left !important
}

.float-right {
    float: right !important
}

.float-none {
    float: none !important
}

@media (min-width:576px) {
    .float-sm-left {
        float: left !important
    }

    .float-sm-right {
        float: right !important
    }

    .float-sm-none {
        float: none !important
    }
}

@media (min-width:768px) {
    .float-md-left {
        float: left !important
    }

    .float-md-right {
        float: right !important
    }

    .float-md-none {
        float: none !important
    }
}

@media (min-width:992px) {
    .float-lg-left {
        float: left !important
    }

    .float-lg-right {
        float: right !important
    }

    .float-lg-none {
        float: none !important
    }
}

@media (min-width:1200px) {
    .float-xl-left {
        float: left !important
    }

    .float-xl-right {
        float: right !important
    }

    .float-xl-none {
        float: none !important
    }
}

.user-select-all {
    user-select: all !important
}

.user-select-auto {
    user-select: auto !important
}

.user-select-none {
    user-select: none !important
}

.overflow-auto {
    overflow: auto !important
}

.overflow-hidden {
    overflow: hidden !important
}

.position-static {
    position: static !important
}

.position-relative {
    position: relative !important
}

.position-absolute {
    position: absolute !important
}

.position-fixed {
    position: fixed !important
}

.position-sticky {
    position: sticky !important
}

.fixed-top {
    position: fixed;
    top: 0;
    right: 0;
    left: 0;
    z-index: 1030
}

.fixed-bottom {
    position: fixed;
    right: 0;
    bottom: 0;
    left: 0;
    z-index: 1030
}

@supports (position:sticky) {
    .sticky-top {
        position: sticky;
        top: 0;
        z-index: 1020
    }
}

.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0
}

.sr-only-focusable:active,
.sr-only-focusable:focus {
    position: static;
    width: auto;
    height: auto;
    overflow: visible;
    clip: auto;
    white-space: normal
}

.shadow-sm {
    box-shadow: 0 .125rem .25rem rgba(0, 0, 0, .075) !important
}

.shadow {
    box-shadow: 0 .5rem 1rem rgba(0, 0, 0, .15) !important
}

.shadow-lg {
    box-shadow: 0 1rem 3rem rgba(0, 0, 0, .175) !important
}

.shadow-none {
    box-shadow: none !important
}

.w-25 {
    width: 25% !important
}

.w-50 {
    width: 50% !important
}

.w-75 {
    width: 75% !important
}

.w-100 {
    width: 100% !important
}

.w-auto {
    width: auto !important
}

.h-25 {
    height: 25% !important
}

.h-50 {
    height: 50% !important
}

.h-75 {
    height: 75% !important
}

.h-100 {
    height: 100% !important
}

.h-auto {
    height: auto !important
}

.mw-100 {
    max-width: 100% !important
}

.mh-100 {
    max-height: 100% !important
}

.min-vw-100 {
    min-width: 100vw !important
}

.min-vh-100 {
    min-height: 100vh !important
}

.vw-100 {
    width: 100vw !important
}

.vh-100 {
    height: 100vh !important
}

.m-0 {
    margin: 0 !important
}

.mt-0,
.my-0 {
    margin-top: 0 !important
}

.mr-0,
.mx-0 {
    margin-right: 0 !important
}

.mb-0,
.my-0 {
    margin-bottom: 0 !important
}

.ml-0,
.mx-0 {
    margin-left: 0 !important
}

.m-1 {
    margin: .25rem !important
}

.mt-1,
.my-1 {
    margin-top: .25rem !important
}

.mr-1,
.mx-1 {
    margin-right: .25rem !important
}

.mb-1,
.my-1 {
    margin-bottom: .25rem !important
}

.ml-1,
.mx-1 {
    margin-left: .25rem !important
}

.m-2 {
    margin: .5rem !important
}

.mt-2,
.my-2 {
    margin-top: .5rem !important
}

.mr-2,
.mx-2 {
    margin-right: .5rem !important
}

.mb-2,
.my-2 {
    margin-bottom: .5rem !important
}

.ml-2,
.mx-2 {
    margin-left: .5rem !important
}

.m-3 {
    margin: 1rem !important
}

.mt-3,
.my-3 {
    margin-top: 1rem !important
}

.mr-3,
.mx-3 {
    margin-right: 1rem !important
}

.mb-3,
.my-3 {
    margin-bottom: 1rem !important
}

.ml-3,
.mx-3 {
    margin-left: 1rem !important
}

.m-4 {
    margin: 1.5rem !important
}

.mt-4,
.my-4 {
    margin-top: 1.5rem !important
}

.mr-4,
.mx-4 {
    margin-right: 1.5rem !important
}

.mb-4,
.my-4 {
    margin-bottom: 1.5rem !important
}

.ml-4,
.mx-4 {
    margin-left: 1.5rem !important
}

.m-5 {
    margin: 3rem !important
}

.mt-5,
.my-5 {
    margin-top: 3rem !important
}

.mr-5,
.mx-5 {
    margin-right: 3rem !important
}

.mb-5,
.my-5 {
    margin-bottom: 3rem !important
}

.ml-5,
.mx-5 {
    margin-left: 3rem !important
}

.p-0 {
    padding: 0 !important
}

.pt-0,
.py-0 {
    padding-top: 0 !important
}

.pr-0,
.px-0 {
    padding-right: 0 !important
}

.pb-0,
.py-0 {
    padding-bottom: 0 !important
}

.pl-0,
.px-0 {
    padding-left: 0 !important
}

.p-1 {
    padding: .25rem !important
}

.pt-1,
.py-1 {
    padding-top: .25rem !important
}

.pr-1,
.px-1 {
    padding-right: .25rem !important
}

.pb-1,
.py-1 {
    padding-bottom: .25rem !important
}

.pl-1,
.px-1 {
    padding-left: .25rem !important
}

.p-2 {
    padding: .5rem !important
}

.pt-2,
.py-2 {
    padding-top: .5rem !important
}

.pr-2,
.px-2 {
    padding-right: .5rem !important
}

.pb-2,
.py-2 {
    padding-bottom: .5rem !important
}

.pl-2,
.px-2 {
    padding-left: .5rem !important
}

.p-3 {
    padding: 1rem !important
}

.pt-3,
.py-3 {
    padding-top: 1rem !important
}

.pr-3,
.px-3 {
    padding-right: 1rem !important
}

.pb-3,
.py-3 {
    padding-bottom: 1rem !important
}

.pl-3,
.px-3 {
    padding-left: 1rem !important
}

.p-4 {
    padding: 1.5rem !important
}

.pt-4,
.py-4 {
    padding-top: 1.5rem !important
}

.pr-4,
.px-4 {
    padding-right: 1.5rem !important
}

.pb-4,
.py-4 {
    padding-bottom: 1.5rem !important
}

.pl-4,
.px-4 {
    padding-left: 1.5rem !important
}

.p-5 {
    padding: 3rem !important
}

.pt-5,
.py-5 {
    padding-top: 3rem !important
}

.pr-5,
.px-5 {
    padding-right: 3rem !important
}

.pb-5,
.py-5 {
    padding-bottom: 3rem !important
}

.pl-5,
.px-5 {
    padding-left: 3rem !important
}

.m-n1 {
    margin: -.25rem !important
}

.mt-n1,
.my-n1 {
    margin-top: -.25rem !important
}

.mr-n1,
.mx-n1 {
    margin-right: -.25rem !important
}

.mb-n1,
.my-n1 {
    margin-bottom: -.25rem !important
}

.ml-n1,
.mx-n1 {
    margin-left: -.25rem !important
}

.m-n2 {
    margin: -.5rem !important
}

.mt-n2,
.my-n2 {
    margin-top: -.5rem !important
}

.mr-n2,
.mx-n2 {
    margin-right: -.5rem !important
}

.mb-n2,
.my-n2 {
    margin-bottom: -.5rem !important
}

.ml-n2,
.mx-n2 {
    margin-left: -.5rem !important
}

.m-n3 {
    margin: -1rem !important
}

.mt-n3,
.my-n3 {
    margin-top: -1rem !important
}

.mr-n3,
.mx-n3 {
    margin-right: -1rem !important
}

.mb-n3,
.my-n3 {
    margin-bottom: -1rem !important
}

.ml-n3,
.mx-n3 {
    margin-left: -1rem !important
}

.m-n4 {
    margin: -1.5rem !important
}

.mt-n4,
.my-n4 {
    margin-top: -1.5rem !important
}

.mr-n4,
.mx-n4 {
    margin-right: -1.5rem !important
}

.mb-n4,
.my-n4 {
    margin-bottom: -1.5rem !important
}

.ml-n4,
.mx-n4 {
    margin-left: -1.5rem !important
}

.m-n5 {
    margin: -3rem !important
}

.mt-n5,
.my-n5 {
    margin-top: -3rem !important
}

.mr-n5,
.mx-n5 {
    margin-right: -3rem !important
}

.mb-n5,
.my-n5 {
    margin-bottom: -3rem !important
}

.ml-n5,
.mx-n5 {
    margin-left: -3rem !important
}

.m-auto {
    margin: auto !important
}

.mt-auto,
.my-auto {
    margin-top: auto !important
}

.mr-auto,
.mx-auto {
    margin-right: auto !important
}

.mb-auto,
.my-auto {
    margin-bottom: auto !important
}

.ml-auto,
.mx-auto {
    margin-left: auto !important
}

@media (min-width:576px) {
    .m-sm-0 {
        margin: 0 !important
    }

    .mt-sm-0,
    .my-sm-0 {
        margin-top: 0 !important
    }

    .mr-sm-0,
    .mx-sm-0 {
        margin-right: 0 !important
    }

    .mb-sm-0,
    .my-sm-0 {
        margin-bottom: 0 !important
    }

    .ml-sm-0,
    .mx-sm-0 {
        margin-left: 0 !important
    }

    .m-sm-1 {
        margin: .25rem !important
    }

    .mt-sm-1,
    .my-sm-1 {
        margin-top: .25rem !important
    }

    .mr-sm-1,
    .mx-sm-1 {
        margin-right: .25rem !important
    }

    .mb-sm-1,
    .my-sm-1 {
        margin-bottom: .25rem !important
    }

    .ml-sm-1,
    .mx-sm-1 {
        margin-left: .25rem !important
    }

    .m-sm-2 {
        margin: .5rem !important
    }

    .mt-sm-2,
    .my-sm-2 {
        margin-top: .5rem !important
    }

    .mr-sm-2,
    .mx-sm-2 {
        margin-right: .5rem !important
    }

    .mb-sm-2,
    .my-sm-2 {
        margin-bottom: .5rem !important
    }

    .ml-sm-2,
    .mx-sm-2 {
        margin-left: .5rem !important
    }

    .m-sm-3 {
        margin: 1rem !important
    }

    .mt-sm-3,
    .my-sm-3 {
        margin-top: 1rem !important
    }

    .mr-sm-3,
    .mx-sm-3 {
        margin-right: 1rem !important
    }

    .mb-sm-3,
    .my-sm-3 {
        margin-bottom: 1rem !important
    }

    .ml-sm-3,
    .mx-sm-3 {
        margin-left: 1rem !important
    }

    .m-sm-4 {
        margin: 1.5rem !important
    }

    .mt-sm-4,
    .my-sm-4 {
        margin-top: 1.5rem !important
    }

    .mr-sm-4,
    .mx-sm-4 {
        margin-right: 1.5rem !important
    }

    .mb-sm-4,
    .my-sm-4 {
        margin-bottom: 1.5rem !important
    }

    .ml-sm-4,
    .mx-sm-4 {
        margin-left: 1.5rem !important
    }

    .m-sm-5 {
        margin: 3rem !important
    }

    .mt-sm-5,
    .my-sm-5 {
        margin-top: 3rem !important
    }

    .mr-sm-5,
    .mx-sm-5 {
        margin-right: 3rem !important
    }

    .mb-sm-5,
    .my-sm-5 {
        margin-bottom: 3rem !important
    }

    .ml-sm-5,
    .mx-sm-5 {
        margin-left: 3rem !important
    }

    .p-sm-0 {
        padding: 0 !important
    }

    .pt-sm-0,
    .py-sm-0 {
        padding-top: 0 !important
    }

    .pr-sm-0,
    .px-sm-0 {
        padding-right: 0 !important
    }

    .pb-sm-0,
    .py-sm-0 {
        padding-bottom: 0 !important
    }

    .pl-sm-0,
    .px-sm-0 {
        padding-left: 0 !important
    }

    .p-sm-1 {
        padding: .25rem !important
    }

    .pt-sm-1,
    .py-sm-1 {
        padding-top: .25rem !important
    }

    .pr-sm-1,
    .px-sm-1 {
        padding-right: .25rem !important
    }

    .pb-sm-1,
    .py-sm-1 {
        padding-bottom: .25rem !important
    }

    .pl-sm-1,
    .px-sm-1 {
        padding-left: .25rem !important
    }

    .p-sm-2 {
        padding: .5rem !important
    }

    .pt-sm-2,
    .py-sm-2 {
        padding-top: .5rem !important
    }

    .pr-sm-2,
    .px-sm-2 {
        padding-right: .5rem !important
    }

    .pb-sm-2,
    .py-sm-2 {
        padding-bottom: .5rem !important
    }

    .pl-sm-2,
    .px-sm-2 {
        padding-left: .5rem !important
    }

    .p-sm-3 {
        padding: 1rem !important
    }

    .pt-sm-3,
    .py-sm-3 {
        padding-top: 1rem !important
    }

    .pr-sm-3,
    .px-sm-3 {
        padding-right: 1rem !important
    }

    .pb-sm-3,
    .py-sm-3 {
        padding-bottom: 1rem !important
    }

    .pl-sm-3,
    .px-sm-3 {
        padding-left: 1rem !important
    }

    .p-sm-4 {
        padding: 1.5rem !important
    }

    .pt-sm-4,
    .py-sm-4 {
        padding-top: 1.5rem !important
    }

    .pr-sm-4,
    .px-sm-4 {
        padding-right: 1.5rem !important
    }

    .pb-sm-4,
    .py-sm-4 {
        padding-bottom: 1.5rem !important
    }

    .pl-sm-4,
    .px-sm-4 {
        padding-left: 1.5rem !important
    }

    .p-sm-5 {
        padding: 3rem !important
    }

    .pt-sm-5,
    .py-sm-5 {
        padding-top: 3rem !important
    }

    .pr-sm-5,
    .px-sm-5 {
        padding-right: 3rem !important
    }

    .pb-sm-5,
    .py-sm-5 {
        padding-bottom: 3rem !important
    }

    .pl-sm-5,
    .px-sm-5 {
        padding-left: 3rem !important
    }

    .m-sm-n1 {
        margin: -.25rem !important
    }

    .mt-sm-n1,
    .my-sm-n1 {
        margin-top: -.25rem !important
    }

    .mr-sm-n1,
    .mx-sm-n1 {
        margin-right: -.25rem !important
    }

    .mb-sm-n1,
    .my-sm-n1 {
        margin-bottom: -.25rem !important
    }

    .ml-sm-n1,
    .mx-sm-n1 {
        margin-left: -.25rem !important
    }

    .m-sm-n2 {
        margin: -.5rem !important
    }

    .mt-sm-n2,
    .my-sm-n2 {
        margin-top: -.5rem !important
    }

    .mr-sm-n2,
    .mx-sm-n2 {
        margin-right: -.5rem !important
    }

    .mb-sm-n2,
    .my-sm-n2 {
        margin-bottom: -.5rem !important
    }

    .ml-sm-n2,
    .mx-sm-n2 {
        margin-left: -.5rem !important
    }

    .m-sm-n3 {
        margin: -1rem !important
    }

    .mt-sm-n3,
    .my-sm-n3 {
        margin-top: -1rem !important
    }

    .mr-sm-n3,
    .mx-sm-n3 {
        margin-right: -1rem !important
    }

    .mb-sm-n3,
    .my-sm-n3 {
        margin-bottom: -1rem !important
    }

    .ml-sm-n3,
    .mx-sm-n3 {
        margin-left: -1rem !important
    }

    .m-sm-n4 {
        margin: -1.5rem !important
    }

    .mt-sm-n4,
    .my-sm-n4 {
        margin-top: -1.5rem !important
    }

    .mr-sm-n4,
    .mx-sm-n4 {
        margin-right: -1.5rem !important
    }

    .mb-sm-n4,
    .my-sm-n4 {
        margin-bottom: -1.5rem !important
    }

    .ml-sm-n4,
    .mx-sm-n4 {
        margin-left: -1.5rem !important
    }

    .m-sm-n5 {
        margin: -3rem !important
    }

    .mt-sm-n5,
    .my-sm-n5 {
        margin-top: -3rem !important
    }

    .mr-sm-n5,
    .mx-sm-n5 {
        margin-right: -3rem !important
    }

    .mb-sm-n5,
    .my-sm-n5 {
        margin-bottom: -3rem !important
    }

    .ml-sm-n5,
    .mx-sm-n5 {
        margin-left: -3rem !important
    }

    .m-sm-auto {
        margin: auto !important
    }

    .mt-sm-auto,
    .my-sm-auto {
        margin-top: auto !important
    }

    .mr-sm-auto,
    .mx-sm-auto {
        margin-right: auto !important
    }

    .mb-sm-auto,
    .my-sm-auto {
        margin-bottom: auto !important
    }

    .ml-sm-auto,
    .mx-sm-auto {
        margin-left: auto !important
    }
}

@media (min-width:768px) {
    .m-md-0 {
        margin: 0 !important
    }

    .mt-md-0,
    .my-md-0 {
        margin-top: 0 !important
    }

    .mr-md-0,
    .mx-md-0 {
        margin-right: 0 !important
    }

    .mb-md-0,
    .my-md-0 {
        margin-bottom: 0 !important
    }

    .ml-md-0,
    .mx-md-0 {
        margin-left: 0 !important
    }

    .m-md-1 {
        margin: .25rem !important
    }

    .mt-md-1,
    .my-md-1 {
        margin-top: .25rem !important
    }

    .mr-md-1,
    .mx-md-1 {
        margin-right: .25rem !important
    }

    .mb-md-1,
    .my-md-1 {
        margin-bottom: .25rem !important
    }

    .ml-md-1,
    .mx-md-1 {
        margin-left: .25rem !important
    }

    .m-md-2 {
        margin: .5rem !important
    }

    .mt-md-2,
    .my-md-2 {
        margin-top: .5rem !important
    }

    .mr-md-2,
    .mx-md-2 {
        margin-right: .5rem !important
    }

    .mb-md-2,
    .my-md-2 {
        margin-bottom: .5rem !important
    }

    .ml-md-2,
    .mx-md-2 {
        margin-left: .5rem !important
    }

    .m-md-3 {
        margin: 1rem !important
    }

    .mt-md-3,
    .my-md-3 {
        margin-top: 1rem !important
    }

    .mr-md-3,
    .mx-md-3 {
        margin-right: 1rem !important
    }

    .mb-md-3,
    .my-md-3 {
        margin-bottom: 1rem !important
    }

    .ml-md-3,
    .mx-md-3 {
        margin-left: 1rem !important
    }

    .m-md-4 {
        margin: 1.5rem !important
    }

    .mt-md-4,
    .my-md-4 {
        margin-top: 1.5rem !important
    }

    .mr-md-4,
    .mx-md-4 {
        margin-right: 1.5rem !important
    }

    .mb-md-4,
    .my-md-4 {
        margin-bottom: 1.5rem !important
    }

    .ml-md-4,
    .mx-md-4 {
        margin-left: 1.5rem !important
    }

    .m-md-5 {
        margin: 3rem !important
    }

    .mt-md-5,
    .my-md-5 {
        margin-top: 3rem !important
    }

    .mr-md-5,
    .mx-md-5 {
        margin-right: 3rem !important
    }

    .mb-md-5,
    .my-md-5 {
        margin-bottom: 3rem !important
    }

    .ml-md-5,
    .mx-md-5 {
        margin-left: 3rem !important
    }

    .p-md-0 {
        padding: 0 !important
    }

    .pt-md-0,
    .py-md-0 {
        padding-top: 0 !important
    }

    .pr-md-0,
    .px-md-0 {
        padding-right: 0 !important
    }

    .pb-md-0,
    .py-md-0 {
        padding-bottom: 0 !important
    }

    .pl-md-0,
    .px-md-0 {
        padding-left: 0 !important
    }

    .p-md-1 {
        padding: .25rem !important
    }

    .pt-md-1,
    .py-md-1 {
        padding-top: .25rem !important
    }

    .pr-md-1,
    .px-md-1 {
        padding-right: .25rem !important
    }

    .pb-md-1,
    .py-md-1 {
        padding-bottom: .25rem !important
    }

    .pl-md-1,
    .px-md-1 {
        padding-left: .25rem !important
    }

    .p-md-2 {
        padding: .5rem !important
    }

    .pt-md-2,
    .py-md-2 {
        padding-top: .5rem !important
    }

    .pr-md-2,
    .px-md-2 {
        padding-right: .5rem !important
    }

    .pb-md-2,
    .py-md-2 {
        padding-bottom: .5rem !important
    }

    .pl-md-2,
    .px-md-2 {
        padding-left: .5rem !important
    }

    .p-md-3 {
        padding: 1rem !important
    }

    .pt-md-3,
    .py-md-3 {
        padding-top: 1rem !important
    }

    .pr-md-3,
    .px-md-3 {
        padding-right: 1rem !important
    }

    .pb-md-3,
    .py-md-3 {
        padding-bottom: 1rem !important
    }

    .pl-md-3,
    .px-md-3 {
        padding-left: 1rem !important
    }

    .p-md-4 {
        padding: 1.5rem !important
    }

    .pt-md-4,
    .py-md-4 {
        padding-top: 1.5rem !important
    }

    .pr-md-4,
    .px-md-4 {
        padding-right: 1.5rem !important
    }

    .pb-md-4,
    .py-md-4 {
        padding-bottom: 1.5rem !important
    }

    .pl-md-4,
    .px-md-4 {
        padding-left: 1.5rem !important
    }

    .p-md-5 {
        padding: 3rem !important
    }

    .pt-md-5,
    .py-md-5 {
        padding-top: 3rem !important
    }

    .pr-md-5,
    .px-md-5 {
        padding-right: 3rem !important
    }

    .pb-md-5,
    .py-md-5 {
        padding-bottom: 3rem !important
    }

    .pl-md-5,
    .px-md-5 {
        padding-left: 3rem !important
    }

    .m-md-n1 {
        margin: -.25rem !important
    }

    .mt-md-n1,
    .my-md-n1 {
        margin-top: -.25rem !important
    }

    .mr-md-n1,
    .mx-md-n1 {
        margin-right: -.25rem !important
    }

    .mb-md-n1,
    .my-md-n1 {
        margin-bottom: -.25rem !important
    }

    .ml-md-n1,
    .mx-md-n1 {
        margin-left: -.25rem !important
    }

    .m-md-n2 {
        margin: -.5rem !important
    }

    .mt-md-n2,
    .my-md-n2 {
        margin-top: -.5rem !important
    }

    .mr-md-n2,
    .mx-md-n2 {
        margin-right: -.5rem !important
    }

    .mb-md-n2,
    .my-md-n2 {
        margin-bottom: -.5rem !important
    }

    .ml-md-n2,
    .mx-md-n2 {
        margin-left: -.5rem !important
    }

    .m-md-n3 {
        margin: -1rem !important
    }

    .mt-md-n3,
    .my-md-n3 {
        margin-top: -1rem !important
    }

    .mr-md-n3,
    .mx-md-n3 {
        margin-right: -1rem !important
    }

    .mb-md-n3,
    .my-md-n3 {
        margin-bottom: -1rem !important
    }

    .ml-md-n3,
    .mx-md-n3 {
        margin-left: -1rem !important
    }

    .m-md-n4 {
        margin: -1.5rem !important
    }

    .mt-md-n4,
    .my-md-n4 {
        margin-top: -1.5rem !important
    }

    .mr-md-n4,
    .mx-md-n4 {
        margin-right: -1.5rem !important
    }

    .mb-md-n4,
    .my-md-n4 {
        margin-bottom: -1.5rem !important
    }

    .ml-md-n4,
    .mx-md-n4 {
        margin-left: -1.5rem !important
    }

    .m-md-n5 {
        margin: -3rem !important
    }

    .mt-md-n5,
    .my-md-n5 {
        margin-top: -3rem !important
    }

    .mr-md-n5,
    .mx-md-n5 {
        margin-right: -3rem !important
    }

    .mb-md-n5,
    .my-md-n5 {
        margin-bottom: -3rem !important
    }

    .ml-md-n5,
    .mx-md-n5 {
        margin-left: -3rem !important
    }

    .m-md-auto {
        margin: auto !important
    }

    .mt-md-auto,
    .my-md-auto {
        margin-top: auto !important
    }

    .mr-md-auto,
    .mx-md-auto {
        margin-right: auto !important
    }

    .mb-md-auto,
    .my-md-auto {
        margin-bottom: auto !important
    }

    .ml-md-auto,
    .mx-md-auto {
        margin-left: auto !important
    }
}

@media (min-width:992px) {
    .m-lg-0 {
        margin: 0 !important
    }

    .mt-lg-0,
    .my-lg-0 {
        margin-top: 0 !important
    }

    .mr-lg-0,
    .mx-lg-0 {
        margin-right: 0 !important
    }

    .mb-lg-0,
    .my-lg-0 {
        margin-bottom: 0 !important
    }

    .ml-lg-0,
    .mx-lg-0 {
        margin-left: 0 !important
    }

    .m-lg-1 {
        margin: .25rem !important
    }

    .mt-lg-1,
    .my-lg-1 {
        margin-top: .25rem !important
    }

    .mr-lg-1,
    .mx-lg-1 {
        margin-right: .25rem !important
    }

    .mb-lg-1,
    .my-lg-1 {
        margin-bottom: .25rem !important
    }

    .ml-lg-1,
    .mx-lg-1 {
        margin-left: .25rem !important
    }

    .m-lg-2 {
        margin: .5rem !important
    }

    .mt-lg-2,
    .my-lg-2 {
        margin-top: .5rem !important
    }

    .mr-lg-2,
    .mx-lg-2 {
        margin-right: .5rem !important
    }

    .mb-lg-2,
    .my-lg-2 {
        margin-bottom: .5rem !important
    }

    .ml-lg-2,
    .mx-lg-2 {
        margin-left: .5rem !important
    }

    .m-lg-3 {
        margin: 1rem !important
    }

    .mt-lg-3,
    .my-lg-3 {
        margin-top: 1rem !important
    }

    .mr-lg-3,
    .mx-lg-3 {
        margin-right: 1rem !important
    }

    .mb-lg-3,
    .my-lg-3 {
        margin-bottom: 1rem !important
    }

    .ml-lg-3,
    .mx-lg-3 {
        margin-left: 1rem !important
    }

    .m-lg-4 {
        margin: 1.5rem !important
    }

    .mt-lg-4,
    .my-lg-4 {
        margin-top: 1.5rem !important
    }

    .mr-lg-4,
    .mx-lg-4 {
        margin-right: 1.5rem !important
    }

    .mb-lg-4,
    .my-lg-4 {
        margin-bottom: 1.5rem !important
    }

    .ml-lg-4,
    .mx-lg-4 {
        margin-left: 1.5rem !important
    }

    .m-lg-5 {
        margin: 3rem !important
    }

    .mt-lg-5,
    .my-lg-5 {
        margin-top: 3rem !important
    }

    .mr-lg-5,
    .mx-lg-5 {
        margin-right: 3rem !important
    }

    .mb-lg-5,
    .my-lg-5 {
        margin-bottom: 3rem !important
    }

    .ml-lg-5,
    .mx-lg-5 {
        margin-left: 3rem !important
    }

    .p-lg-0 {
        padding: 0 !important
    }

    .pt-lg-0,
    .py-lg-0 {
        padding-top: 0 !important
    }

    .pr-lg-0,
    .px-lg-0 {
        padding-right: 0 !important
    }

    .pb-lg-0,
    .py-lg-0 {
        padding-bottom: 0 !important
    }

    .pl-lg-0,
    .px-lg-0 {
        padding-left: 0 !important
    }

    .p-lg-1 {
        padding: .25rem !important
    }

    .pt-lg-1,
    .py-lg-1 {
        padding-top: .25rem !important
    }

    .pr-lg-1,
    .px-lg-1 {
        padding-right: .25rem !important
    }

    .pb-lg-1,
    .py-lg-1 {
        padding-bottom: .25rem !important
    }

    .pl-lg-1,
    .px-lg-1 {
        padding-left: .25rem !important
    }

    .p-lg-2 {
        padding: .5rem !important
    }

    .pt-lg-2,
    .py-lg-2 {
        padding-top: .5rem !important
    }

    .pr-lg-2,
    .px-lg-2 {
        padding-right: .5rem !important
    }

    .pb-lg-2,
    .py-lg-2 {
        padding-bottom: .5rem !important
    }

    .pl-lg-2,
    .px-lg-2 {
        padding-left: .5rem !important
    }

    .p-lg-3 {
        padding: 1rem !important
    }

    .pt-lg-3,
    .py-lg-3 {
        padding-top: 1rem !important
    }

    .pr-lg-3,
    .px-lg-3 {
        padding-right: 1rem !important
    }

    .pb-lg-3,
    .py-lg-3 {
        padding-bottom: 1rem !important
    }

    .pl-lg-3,
    .px-lg-3 {
        padding-left: 1rem !important
    }

    .p-lg-4 {
        padding: 1.5rem !important
    }

    .pt-lg-4,
    .py-lg-4 {
        padding-top: 1.5rem !important
    }

    .pr-lg-4,
    .px-lg-4 {
        padding-right: 1.5rem !important
    }

    .pb-lg-4,
    .py-lg-4 {
        padding-bottom: 1.5rem !important
    }

    .pl-lg-4,
    .px-lg-4 {
        padding-left: 1.5rem !important
    }

    .p-lg-5 {
        padding: 3rem !important
    }

    .pt-lg-5,
    .py-lg-5 {
        padding-top: 3rem !important
    }

    .pr-lg-5,
    .px-lg-5 {
        padding-right: 3rem !important
    }

    .pb-lg-5,
    .py-lg-5 {
        padding-bottom: 3rem !important
    }

    .pl-lg-5,
    .px-lg-5 {
        padding-left: 3rem !important
    }

    .m-lg-n1 {
        margin: -.25rem !important
    }

    .mt-lg-n1,
    .my-lg-n1 {
        margin-top: -.25rem !important
    }

    .mr-lg-n1,
    .mx-lg-n1 {
        margin-right: -.25rem !important
    }

    .mb-lg-n1,
    .my-lg-n1 {
        margin-bottom: -.25rem !important
    }

    .ml-lg-n1,
    .mx-lg-n1 {
        margin-left: -.25rem !important
    }

    .m-lg-n2 {
        margin: -.5rem !important
    }

    .mt-lg-n2,
    .my-lg-n2 {
        margin-top: -.5rem !important
    }

    .mr-lg-n2,
    .mx-lg-n2 {
        margin-right: -.5rem !important
    }

    .mb-lg-n2,
    .my-lg-n2 {
        margin-bottom: -.5rem !important
    }

    .ml-lg-n2,
    .mx-lg-n2 {
        margin-left: -.5rem !important
    }

    .m-lg-n3 {
        margin: -1rem !important
    }

    .mt-lg-n3,
    .my-lg-n3 {
        margin-top: -1rem !important
    }

    .mr-lg-n3,
    .mx-lg-n3 {
        margin-right: -1rem !important
    }

    .mb-lg-n3,
    .my-lg-n3 {
        margin-bottom: -1rem !important
    }

    .ml-lg-n3,
    .mx-lg-n3 {
        margin-left: -1rem !important
    }

    .m-lg-n4 {
        margin: -1.5rem !important
    }

    .mt-lg-n4,
    .my-lg-n4 {
        margin-top: -1.5rem !important
    }

    .mr-lg-n4,
    .mx-lg-n4 {
        margin-right: -1.5rem !important
    }

    .mb-lg-n4,
    .my-lg-n4 {
        margin-bottom: -1.5rem !important
    }

    .ml-lg-n4,
    .mx-lg-n4 {
        margin-left: -1.5rem !important
    }

    .m-lg-n5 {
        margin: -3rem !important
    }

    .mt-lg-n5,
    .my-lg-n5 {
        margin-top: -3rem !important
    }

    .mr-lg-n5,
    .mx-lg-n5 {
        margin-right: -3rem !important
    }

    .mb-lg-n5,
    .my-lg-n5 {
        margin-bottom: -3rem !important
    }

    .ml-lg-n5,
    .mx-lg-n5 {
        margin-left: -3rem !important
    }

    .m-lg-auto {
        margin: auto !important
    }

    .mt-lg-auto,
    .my-lg-auto {
        margin-top: auto !important
    }

    .mr-lg-auto,
    .mx-lg-auto {
        margin-right: auto !important
    }

    .mb-lg-auto,
    .my-lg-auto {
        margin-bottom: auto !important
    }

    .ml-lg-auto,
    .mx-lg-auto {
        margin-left: auto !important
    }
}

@media (min-width:1200px) {
    .m-xl-0 {
        margin: 0 !important
    }

    .mt-xl-0,
    .my-xl-0 {
        margin-top: 0 !important
    }

    .mr-xl-0,
    .mx-xl-0 {
        margin-right: 0 !important
    }

    .mb-xl-0,
    .my-xl-0 {
        margin-bottom: 0 !important
    }

    .ml-xl-0,
    .mx-xl-0 {
        margin-left: 0 !important
    }

    .m-xl-1 {
        margin: .25rem !important
    }

    .mt-xl-1,
    .my-xl-1 {
        margin-top: .25rem !important
    }

    .mr-xl-1,
    .mx-xl-1 {
        margin-right: .25rem !important
    }

    .mb-xl-1,
    .my-xl-1 {
        margin-bottom: .25rem !important
    }

    .ml-xl-1,
    .mx-xl-1 {
        margin-left: .25rem !important
    }

    .m-xl-2 {
        margin: .5rem !important
    }

    .mt-xl-2,
    .my-xl-2 {
        margin-top: .5rem !important
    }

    .mr-xl-2,
    .mx-xl-2 {
        margin-right: .5rem !important
    }

    .mb-xl-2,
    .my-xl-2 {
        margin-bottom: .5rem !important
    }

    .ml-xl-2,
    .mx-xl-2 {
        margin-left: .5rem !important
    }

    .m-xl-3 {
        margin: 1rem !important
    }

    .mt-xl-3,
    .my-xl-3 {
        margin-top: 1rem !important
    }

    .mr-xl-3,
    .mx-xl-3 {
        margin-right: 1rem !important
    }

    .mb-xl-3,
    .my-xl-3 {
        margin-bottom: 1rem !important
    }

    .ml-xl-3,
    .mx-xl-3 {
        margin-left: 1rem !important
    }

    .m-xl-4 {
        margin: 1.5rem !important
    }

    .mt-xl-4,
    .my-xl-4 {
        margin-top: 1.5rem !important
    }

    .mr-xl-4,
    .mx-xl-4 {
        margin-right: 1.5rem !important
    }

    .mb-xl-4,
    .my-xl-4 {
        margin-bottom: 1.5rem !important
    }

    .ml-xl-4,
    .mx-xl-4 {
        margin-left: 1.5rem !important
    }

    .m-xl-5 {
        margin: 3rem !important
    }

    .mt-xl-5,
    .my-xl-5 {
        margin-top: 3rem !important
    }

    .mr-xl-5,
    .mx-xl-5 {
        margin-right: 3rem !important
    }

    .mb-xl-5,
    .my-xl-5 {
        margin-bottom: 3rem !important
    }

    .ml-xl-5,
    .mx-xl-5 {
        margin-left: 3rem !important
    }

    .p-xl-0 {
        padding: 0 !important
    }

    .pt-xl-0,
    .py-xl-0 {
        padding-top: 0 !important
    }

    .pr-xl-0,
    .px-xl-0 {
        padding-right: 0 !important
    }

    .pb-xl-0,
    .py-xl-0 {
        padding-bottom: 0 !important
    }

    .pl-xl-0,
    .px-xl-0 {
        padding-left: 0 !important
    }

    .p-xl-1 {
        padding: .25rem !important
    }

    .pt-xl-1,
    .py-xl-1 {
        padding-top: .25rem !important
    }

    .pr-xl-1,
    .px-xl-1 {
        padding-right: .25rem !important
    }

    .pb-xl-1,
    .py-xl-1 {
        padding-bottom: .25rem !important
    }

    .pl-xl-1,
    .px-xl-1 {
        padding-left: .25rem !important
    }

    .p-xl-2 {
        padding: .5rem !important
    }

    .pt-xl-2,
    .py-xl-2 {
        padding-top: .5rem !important
    }

    .pr-xl-2,
    .px-xl-2 {
        padding-right: .5rem !important
    }

    .pb-xl-2,
    .py-xl-2 {
        padding-bottom: .5rem !important
    }

    .pl-xl-2,
    .px-xl-2 {
        padding-left: .5rem !important
    }

    .p-xl-3 {
        padding: 1rem !important
    }

    .pt-xl-3,
    .py-xl-3 {
        padding-top: 1rem !important
    }

    .pr-xl-3,
    .px-xl-3 {
        padding-right: 1rem !important
    }

    .pb-xl-3,
    .py-xl-3 {
        padding-bottom: 1rem !important
    }

    .pl-xl-3,
    .px-xl-3 {
        padding-left: 1rem !important
    }

    .p-xl-4 {
        padding: 1.5rem !important
    }

    .pt-xl-4,
    .py-xl-4 {
        padding-top: 1.5rem !important
    }

    .pr-xl-4,
    .px-xl-4 {
        padding-right: 1.5rem !important
    }

    .pb-xl-4,
    .py-xl-4 {
        padding-bottom: 1.5rem !important
    }

    .pl-xl-4,
    .px-xl-4 {
        padding-left: 1.5rem !important
    }

    .p-xl-5 {
        padding: 3rem !important
    }

    .pt-xl-5,
    .py-xl-5 {
        padding-top: 3rem !important
    }

    .pr-xl-5,
    .px-xl-5 {
        padding-right: 3rem !important
    }

    .pb-xl-5,
    .py-xl-5 {
        padding-bottom: 3rem !important
    }

    .pl-xl-5,
    .px-xl-5 {
        padding-left: 3rem !important
    }

    .m-xl-n1 {
        margin: -.25rem !important
    }

    .mt-xl-n1,
    .my-xl-n1 {
        margin-top: -.25rem !important
    }

    .mr-xl-n1,
    .mx-xl-n1 {
        margin-right: -.25rem !important
    }

    .mb-xl-n1,
    .my-xl-n1 {
        margin-bottom: -.25rem !important
    }

    .ml-xl-n1,
    .mx-xl-n1 {
        margin-left: -.25rem !important
    }

    .m-xl-n2 {
        margin: -.5rem !important
    }

    .mt-xl-n2,
    .my-xl-n2 {
        margin-top: -.5rem !important
    }

    .mr-xl-n2,
    .mx-xl-n2 {
        margin-right: -.5rem !important
    }

    .mb-xl-n2,
    .my-xl-n2 {
        margin-bottom: -.5rem !important
    }

    .ml-xl-n2,
    .mx-xl-n2 {
        margin-left: -.5rem !important
    }

    .m-xl-n3 {
        margin: -1rem !important
    }

    .mt-xl-n3,
    .my-xl-n3 {
        margin-top: -1rem !important
    }

    .mr-xl-n3,
    .mx-xl-n3 {
        margin-right: -1rem !important
    }

    .mb-xl-n3,
    .my-xl-n3 {
        margin-bottom: -1rem !important
    }

    .ml-xl-n3,
    .mx-xl-n3 {
        margin-left: -1rem !important
    }

    .m-xl-n4 {
        margin: -1.5rem !important
    }

    .mt-xl-n4,
    .my-xl-n4 {
        margin-top: -1.5rem !important
    }

    .mr-xl-n4,
    .mx-xl-n4 {
        margin-right: -1.5rem !important
    }

    .mb-xl-n4,
    .my-xl-n4 {
        margin-bottom: -1.5rem !important
    }

    .ml-xl-n4,
    .mx-xl-n4 {
        margin-left: -1.5rem !important
    }

    .m-xl-n5 {
        margin: -3rem !important
    }

    .mt-xl-n5,
    .my-xl-n5 {
        margin-top: -3rem !important
    }

    .mr-xl-n5,
    .mx-xl-n5 {
        margin-right: -3rem !important
    }

    .mb-xl-n5,
    .my-xl-n5 {
        margin-bottom: -3rem !important
    }

    .ml-xl-n5,
    .mx-xl-n5 {
        margin-left: -3rem !important
    }

    .m-xl-auto {
        margin: auto !important
    }

    .mt-xl-auto,
    .my-xl-auto {
        margin-top: auto !important
    }

    .mr-xl-auto,
    .mx-xl-auto {
        margin-right: auto !important
    }

    .mb-xl-auto,
    .my-xl-auto {
        margin-bottom: auto !important
    }

    .ml-xl-auto,
    .mx-xl-auto {
        margin-left: auto !important
    }
}

.stretched-link::after {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    z-index: 1;
    pointer-events: auto;
    content: "";
    background-color: rgba(0, 0, 0, 0)
}

.text-monospace {
    font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace !important
}

.text-justify {
    text-align: justify !important
}

.text-wrap {
    white-space: normal !important
}

.text-nowrap {
    white-space: nowrap !important
}

.text-truncate {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap
}

.text-left {
    text-align: left !important
}

.text-right {
    text-align: right !important
}

.text-center {
    text-align: center !important
}

@media (min-width:576px) {
    .text-sm-left {
        text-align: left !important
    }

    .text-sm-right {
        text-align: right !important
    }

    .text-sm-center {
        text-align: center !important
    }
}

@media (min-width:768px) {
    .text-md-left {
        text-align: left !important
    }

    .text-md-right {
        text-align: right !important
    }

    .text-md-center {
        text-align: center !important
    }
}

@media (min-width:992px) {
    .text-lg-left {
        text-align: left !important
    }

    .text-lg-right {
        text-align: right !important
    }

    .text-lg-center {
        text-align: center !important
    }
}

@media (min-width:1200px) {
    .text-xl-left {
        text-align: left !important
    }

    .text-xl-right {
        text-align: right !important
    }

    .text-xl-center {
        text-align: center !important
    }
}

.text-lowercase {
    text-transform: lowercase !important
}

.text-uppercase {
    text-transform: uppercase !important
}

.text-capitalize {
    text-transform: capitalize !important
}

.font-weight-light {
    font-weight: 300 !important
}

.font-weight-lighter {
    font-weight: lighter !important
}

.font-weight-normal {
    font-weight: 400 !important
}

.font-weight-bold {
    font-weight: 700 !important
}

.font-weight-bolder {
    font-weight: bolder !important
}

.font-italic {
    font-style: italic !important
}

.text-white {
    color: #fff !important
}

.text-primary {
    color: #93e8e1 !important
}

a.text-primary:focus,
a.text-primary:hover {
    color: #e34902 !important
}

.text-secondary {
    color: #ffffff !important
}

a.text-secondary:focus,
a.text-secondary:hover {
    color: #0056b3 !important
}

.text-success {
    color: #d4edda !important
}

a.text-success:focus,
a.text-success:hover {
    color: #19692c !important
}

.text-info {
    color: #17a2b8 !important
}

a.text-info:focus,
a.text-info:hover {
    color: #0f6674 !important
}

.text-warning {
    color: #ffc107 !important
}

a.text-warning:focus,
a.text-warning:hover {
    color: #ba8b00 !important
}

.text-danger {
    color: #dc3545 !important
}

a.text-danger:focus,
a.text-danger:hover {
    color: #a71d2a !important
}

.text-light {
    color: #f8f9fa !important
}

a.text-light:focus,
a.text-light:hover {
    color: #cbd3da !important
}

.text-dark {
    color: #343a40 !important
}

a.text-dark:focus,
a.text-dark:hover {
    color: #121416 !important
}

.text-body {
    color: #212529 !important
}

.text-muted {
    color: #6c757d !important
}

.text-black-50 {
    color: rgba(0, 0, 0, .5) !important
}

.text-white-50 {
    color: rgba(255, 255, 255, .5) !important
}

.text-hide {
    font: 0/0 a;
    color: transparent;
    text-shadow: none;
    background-color: transparent;
    border: 0
}

.text-decoration-none {
    text-decoration: none !important
}

.text-break {
    word-wrap: break-word !important
}

.text-reset {
    color: inherit !important
}

.visible {
    visibility: visible !important
}

.invisible {
    visibility: hidden !important
}

@media print {

    *,
    ::after,
    ::before {
        text-shadow: none !important;
        box-shadow: none !important
    }

    a:not(.btn) {
        text-decoration: underline
    }

    abbr[title]::after {
        content: " (" attr(title) ")"
    }

    pre {
        white-space: pre-wrap !important
    }

    blockquote,
    pre {
        border: 1px solid #adb5bd;
        page-break-inside: avoid
    }

    thead {
        display: table-header-group
    }

    img,
    tr {
        page-break-inside: avoid
    }

    h2,
    h3,
    p {
        orphans: 3;
        widows: 3
    }

    h2,
    h3 {
        page-break-after: avoid
    }

    @page {
        size: a3
    }

    body {
        min-width: 992px !important
    }

    .container {
        min-width: 992px !important
    }

    .navbar {
        display: none
    }

    .badge {
        border: 1px solid #000
    }

    .table {
        border-collapse: collapse !important
    }

    .table td,
    .table th {
        background-color: #fff !important
    }

    .table-bordered td,
    .table-bordered th {
        border: 1px solid #dee2e6 !important
    }

    .table-dark {
        color: inherit
    }

    .table-dark tbody+tbody,
    .table-dark td,
    .table-dark th,
    .table-dark thead th {
        border-color: #dee2e6
    }

    .table .thead-dark th {
        color: inherit;
        border-color: #dee2e6
    }
}

======================================================================
File: xian-web-wallet/js/external.js
======================================================================
var callbackKey = null;
window.addEventListener("message", (event) => {
    console.log(event.data);
    if (event.data.type === "HTML") {
      insertHTMLAndExecuteScripts(document.getElementById("app-box"), event.data.html);
    }
    if (event.data.type === "INITIAL_STATE") {
      publicKey = event.data.state.publicKey;
      unencryptedPrivateKey = event.data.state.unencryptedPrivateKey;
      locked = event.data.state.locked;
      tx_history = event.data.state.tx_history;
    }
    if (event.data.type === "REQUEST_TRANSACTION") {
      const some_data = event.data.data;
      callbackKey = event.data.callbackKey;
      document.getElementById("requestTransactionContract").innerHTML = some_data["data"]["contract"];
      document.getElementById("requestTransactionFunction").innerHTML = some_data["data"]["method"];
      document.getElementById("requestTransactionParams").innerHTML = JSON.stringify(some_data["data"]["kwargs"]);
      document.getElementById("requestTransactionStampLimit").innerHTML = some_data["data"]["stampLimit"];
      document.getElementById("requestTransactionChainId").innerHTML = some_data["data"]["chainId"];
    }
    if (event.data.type === "REQUEST_SIGNATURE") {
      const some_data = event.data.data;
      callbackKey = event.data.callbackKey;
      document.getElementById("requestSignatureMessage").innerHTML = some_data["data"]["message"];
    }
    if (event.data.type === "REQUEST_TOKEN") {
      const some_data = event.data.data;
      callbackKey = event.data.callbackKey;
      document.getElementById("requestTokenMessage").innerHTML = some_data["data"]["contract"];
      getTokenInfo(some_data["data"]["contract"]).then(token_info => {
        document.getElementById("requestTokenName").innerHTML = token_info.name;
        document.getElementById("requestTokenSymbol").innerHTML = token_info.symbol;
      });
    }
  });

======================================================================
File: xian-web-wallet/js/tx-result-manager.js
======================================================================
const MAX_ATTEMPTS = 5; // Maximum number of attempts for each transaction
const INTERVAL = 2000; // Interval in milliseconds

async function updateTxHistory() {
    let historyUpdated = false;
    for (const tx of tx_history) {
        if (tx["status"] === "pending") {
            if (!tx.hasOwnProperty("attempts")) {
                tx["attempts"] = 0;
            }
            if (tx["attempts"] >= MAX_ATTEMPTS) {
                tx["status"] = "error";
                historyUpdated = true;
                continue;
            }
            tx["attempts"] += 1;
            try {
                const response = await fetch(`${RPC}/tx?hash=0x${tx["hash"]}`);
                const data = await response.json();
                if (response.status !== 200) {
                    continue;
                }
                if (data["result"]["tx_result"]["code"] === 0) {
                    tx["status"] = "success";
                    toast("success", `Transaction <a class="text-light" style=" text-overflow: ellipsis; width: 5rem; overflow: hidden; text-decoration: underline;margin-left: 0.25rem; " href="`+EXPLORER+`/tx/` + tx["hash"] + `" target="_blank">` + tx["hash"] + `</a> success!`);
                } else {
                    tx["status"] = "error";
                    toast("danger", `Transaction <a class="text-light" style=" text-overflow: ellipsis; width: 5rem; overflow: hidden; text-decoration: underline;margin-left: 0.25rem; " href="`+EXPLORER+`/tx/` + tx["hash"] + `" target="_blank">` + tx["hash"] + `</a> failed`);
                }
                historyUpdated = true;
            } catch (error) {
                
            }
        }
    }
    if (historyUpdated) {
        localStorage.setItem("tx_history", JSON.stringify(tx_history));
        if (app_page == "wallet"){
            changePage("wallet");
        }
    }
}

// Run the updateTxHistory function every couple of seconds
setInterval(updateTxHistory, INTERVAL);

======================================================================
File: xian-web-wallet/js/toaster.js
======================================================================
// Why do I even need to make this? Why do you need to have markup for every toast in bootstrap? Why can't I just call a function and pass in the type and message?

function toast(type, message) {
    // Types: primary, secondary, success, danger, warning, info, light, dark
    var toast = document.createElement('div');
    toast.classList.add('bg-' + type);
    let lightTypes = ['primary', 'secondary', 'info', 'light', 'warning'];
    if (lightTypes.includes(type)) {
        toast.classList.add('text-dark');
    }
    else {
        toast.classList.add('text-light');
    }

    toast.classList.add('toast');
    toast.classList.add('align-items-center');
    toast.classList.add('border-0');
    toast.classList.add('position-fixed');
    toast.classList.add('top-0');
    toast.classList.add('end-0');
    toast.classList.add('p-3');
    toast.classList.add('m-3');
    toast.style.zIndex = 9999;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');

    toast.innerHTML = message;

    var dismissButton = document.createElement('button');
    dismissButton.classList.add('btn-close');
    dismissButton.setAttribute('type', 'button');
    dismissButton.setAttribute('data-bs-dismiss', 'toast');
    dismissButton.setAttribute('aria-label', 'Close');
    toast.appendChild(dismissButton);

    document.body.appendChild(toast);
    let bsToast = new bootstrap.Toast(toast);
    bsToast.show();

    // Remove toast after it's hidden
    toast.addEventListener('hidden.bs.toast', function() {
        document.body.removeChild(toast);
    });
}




======================================================================
File: xian-web-wallet/js/index.js
======================================================================
// Save the original fetch function
const originalFetch = window.fetch;

// Define a function to wrap fetch with timeout
function fetchWithTimeout(url, options, timeout = 5000) {
    return Promise.race([
        originalFetch(url, options),
        new Promise((_, reject) =>
            setTimeout(() => reject(new Error('Request timeout')), timeout)
        )
    ]);
}

// Override the global fetch function
window.fetch = function(url, options) {
    return fetchWithTimeout(url, options);
};

if (document.getElementById('side-change-page-settings')) {
    document.getElementById('side-change-page-settings').addEventListener('click', function() {
        changePage('settings');
    });
}

if (document.getElementById('side-change-page-ide')) {
    document.getElementById('side-change-page-ide').addEventListener('click', function() {
        changePage('ide');
    });
}

if (document.getElementById('side-change-page-wallet')) {
document.getElementById('side-change-page-wallet').addEventListener('click', function() {
    changePage('wallet');
});
}

if(document.getElementById('side-lock-wallet')) {
document.getElementById('side-lock-wallet').addEventListener('click', function() {
    lockWallet();
});
}

if(document.getElementById('side-change-page-insights')) {
document.getElementById('side-change-page-insights').addEventListener('click', function() {
    changePage('insights');
});

}
if(document.getElementById('side-change-page-ecosystem-news')) {
document.getElementById('side-change-page-ecosystem-news').addEventListener('click', function() {
    changePage('ecosystem-news');
});
}
if(document.getElementById('side-change-page-messenger')) {
    document.getElementById('side-change-page-messenger').addEventListener('click', function() {
        changePage('messenger');
    });
    }
    

function lockWallet() {
    let confirm_lock = confirm("Are you sure you want to lock the wallet?");
    if (!confirm_lock) {
        return;
    }
    // Locks the wallet
    unencryptedPrivateKey = null;
    locked = true;
    changePage('password-input');
}

const SESSION_EXPIRATION_IN_MIN = 30;
async function getOrCreateSessionId() {
    let { sessionData } = await chrome.storage.session.get('sessionData');
    const currentTimeInMs = Date.now();
  
    if (sessionData && sessionData.timestamp) {
      const durationInMin = (currentTimeInMs - sessionData.timestamp) / 60000;
      if (durationInMin > SESSION_EXPIRATION_IN_MIN) {
        sessionData = null;
      } else {
        sessionData.timestamp = currentTimeInMs;
        await chrome.storage.session.set({ sessionData });
      }
    }
  
    if (!sessionData) {
      sessionData = {
        session_id: currentTimeInMs.toString(),
        timestamp: currentTimeInMs,
      };
      await chrome.storage.session.set({ sessionData });
    }
  
    return sessionData.session_id;
}

async function getOrCreateClientId() {
    const result = await chrome.storage.local.get('clientId');
    let clientId = result.clientId;
    if (!clientId) {
      clientId = self.crypto.randomUUID();
      await chrome.storage.local.set({ clientId });
    }
    return clientId;
  }

async function sendEventGA(name, params = {}) {
    if (!runningAsExtension()) {
        return;
    }
    const sessionId = await getOrCreateSessionId();
    await fetch(`https://www.google-analytics.com/mp/collect?measurement_id=G-9ZK7ZQJJC5&api_secret=3_ZUpum4Qe6bHM-Z8HAXxQ`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            client_id: await getOrCreateClientId(),
            events: [
                {
                    name: name,
                    params: {
                        ...params,
                        session_id: sessionId,
                    },
                },
            ],
        }),
    });
}

(async () => {
    // Wait for sodium to initialize
    await sodium.ready;

    // Now you can safely use sodium functions
    console.log("Sodium is ready!");
})();

======================================================================
File: xian-web-wallet/js/pyodide-linting.js
======================================================================
let pyodide;
        
async function setUpLinter(){
    try{
        pyodide = await loadPyodide();
        await pyodide.loadPackage(['micropip', 'pyflakes']);
        await pyodide.runPythonAsync(`
            import micropip
            await micropip.install(['/python3-dist/xian_contracting_linter-0.2.14-py3-none-any.whl'])
        `);
    
    } catch (error) {
        console.error('Initialization error:', error);
    }
}

setUpLinter();

======================================================================
File: xian-web-wallet/js/router.js
======================================================================
// Define helper functions EARLIER in the file

function insertHTMLAndExecuteScripts(container, htmlContent) {
    if (!container) {
        console.error("Container element not found for insertHTMLAndExecuteScripts");
        return;
    }
    container.innerHTML = htmlContent;
    const scripts = container.querySelectorAll("script");

    // Identify and remove previously loaded scripts to prevent duplicates
    // Use a more specific selector if possible, or ensure scripts have unique IDs/attributes
    // const oldScripts = document.querySelectorAll('script[data-script="dynamic"]');
    // oldScripts.forEach(script => script.remove()); // Be careful with removing scripts this way

    scripts.forEach((originalScript) => {
        if (originalScript.src) {
             // Check if script with this src already exists in head to avoid duplicates
             if (!document.head.querySelector(`script[src="${originalScript.src}"]`)) {
                 const script = document.createElement("script");
                 script.src = originalScript.src;
                 // script.setAttribute('data-script', 'dynamic'); // Mark script for identification
                 script.onload = () => {
                     // console.log(`Script loaded: ${script.src}`); // Optional logging
                 };
                 script.onerror = () => {
                      console.error(`Failed to load script: ${script.src}`);
                 };
                 document.head.appendChild(script);
             } else {
                 // console.log(`Script already loaded: ${originalScript.src}`); // Optional logging
             }

        } else {
            // Inline scripts might be blocked by CSP in extensions.
            // Consider extracting inline logic into separate .js files referenced by src.
            console.warn("Inline script execution attempted and might be blocked by CSP. Content:", originalScript.textContent.substring(0, 100) + "...");
             // If absolutely necessary and CSP allows 'unsafe-inline', you could eval, but it's risky:
             // try { eval(originalScript.textContent); } catch (e) { console.error("Error executing inline script:", e); }
        }
    });
}


// --- Global Variables (Keep these at the top) ---
var app_page = "get-started";
var app_box = document.getElementById("app-box");
// ... (other global variables: encryptedSeed, accounts, etc.) ...
var encryptedSeed = null;
var unencryptedMnemonic = null;
var accounts = [];
var selectedAccountIndex = 0;
var locked = true;
var tx_history = JSON.parse(localStorage.getItem("tx_history")) || [];
var sendResponse = null;
var externalWindow = null;
var callbacks = {};
var callbackId = 0;

// --- Other Helper Functions (like popup_params, getSelectedAccount etc.) ---
function popup_params(width, height) {
    // ... (implementation as before) ...
     var a = typeof window.screenX != 'undefined' ? window.screenX : window.screenLeft;
     var i = typeof window.screenY != 'undefined' ? window.screenY : window.screenTop;
     var g = typeof window.outerWidth!='undefined' ? window.outerWidth : document.documentElement.clientWidth;
     var f = typeof window.outerHeight != 'undefined' ? window.outerHeight: (document.documentElement.clientHeight - 22);
     var h = (a < 0) ? window.screen.width + a : a;
     var left = parseInt(h + ((g - width) / 2), 10);
     var top = parseInt(i + ((f-height) / 2.5), 10);
     return 'width=' + width + ',height=' + height + ',left=' + left + ',top=' + top + ',scrollbars=1';
}
function getSelectedAccount() {
    // ... (implementation as before) ...
     if (locked || accounts.length === 0) {
         return null;
     }
     const account = accounts.find(acc => acc.index === selectedAccountIndex);
     if (!account) {
          console.warn(`Selected account index ${selectedAccountIndex} not found in accounts list. Defaulting to index 0.`);
          return accounts[0] || null;
     }
     return account;
}
function getSelectedVK() {
    // ... (implementation as before) ...
    const account = getSelectedAccount();
    return account ? account.vk : null;
}


// --- External Window Communication ---
function createExternalWindow(page, some_data = null, send_response = null) {
    // ... (implementation as before, it calls loadHtmlAndScripts) ...
      const loadHtmlAndScripts = (htmlPath) => { // Define INSIDE or ensure it's defined before createExternalWindow
        fetch(htmlPath)
          .then((response) => response.text())
          .then((htmlContent) => {
            if (!externalWindow || externalWindow.closed) {
              externalWindow = window.open("index-external.html", "", "width=400,height=600," + popup_params(400, 600)); // Applied popup_params
              externalWindow.onload = () => {
                externalWindow.postMessage({
                  type: "HTML",
                  html: htmlContent
                }, "*");
                sendInitialState(); // Send state after window is loaded
                sendPageSpecificMessage(page, some_data);
              };
            } else {
              // If window exists, just send messages
              externalWindow.postMessage({
                type: "HTML",
                html: htmlContent
              }, "*");
               sendInitialState();
               sendPageSpecificMessage(page, some_data);
               externalWindow.focus(); // Bring existing window to front
            }
          });
      };

       // Send relevant state to the popup/external window
       const sendInitialState = () => { // Define INSIDE or ensure defined before createExternalWindow
         // IMPORTANT: Only send necessary, non-sensitive info.
         // DO NOT send unencryptedMnemonic to the popup.
         // The popup will need the selected account's VK for display/context.
         const selectedAccount = accounts.find(acc => acc.index === selectedAccountIndex);
         externalWindow.postMessage({
           type: "INITIAL_STATE",
           state: {
               // Send selected account VK instead of a single global publicKey
               selectedVk: selectedAccount ? selectedAccount.vk : null,
               selectedAccountIndex: selectedAccountIndex, // Send index
               locked: locked,
               // Send necessary parts of tx_history if needed by the popup,
               // or let the popup request it if required.
               // tx_history: tx_history, // Be cautious about sending large/sensitive history
               CHAIN_ID: CHAIN_ID // Send Chain ID
               }
         }, "*");
          // Also send unencrypted mnemonic ONLY IF the popup needs to perform signing itself
          // AND you trust the popup context. Generally, signing should happen in the main extension context.
          // For this implementation, let's assume signing happens here (router.js context)
          // So, the external window only needs to display info and send requests back.
       };

        const sendPageSpecificMessage = (page, some_data) => { // Define INSIDE or ensure defined before createExternalWindow
             const callbackKey = 'callback_' + (callbackId++);
             callbacks[callbackKey] = send_response; // Store the original sendResponse from background.js

             let type = "";
             let dataToSend = {};

             if (page === "request-transaction") {
                 type = "REQUEST_TRANSACTION";
                 // Prepare data for the transaction request template
                  dataToSend = {
                      contract: some_data.data.contract,
                      method: some_data.data.function, // Changed from 'method' to 'function' based on xian.js
                      kwargs: some_data.data.kwargs,
                      // Stamp limit might be estimated later, pass initial if available
                      stampLimit: some_data.data.stamps_supplied || 'Estimating...',
                      chainId: CHAIN_ID // Pass current Chain ID
                  };
             } else if (page === "request-signature") {
                 type = "REQUEST_SIGNATURE";
                 dataToSend = {
                     message: some_data.data.message
                 };
             } else if (page === "request-token") {
                 type = "REQUEST_TOKEN";
                 dataToSend = {
                     contract: some_data.data.contract // Pass the contract name
                 };
             }

             console.log("Posting to external window:", { type: type, data: dataToSend, callbackKey: callbackKey });
             externalWindow.postMessage({
                 type: type,
                 data: dataToSend, // Send structured data
                 callbackKey: callbackKey
             }, "*");
         };

         // Determine which HTML template to load based on the request type
         let templatePath = "";
         switch (page) {
             case "request-transaction":
                 templatePath = "templates/request-transaction.html";
                 break;
             case "request-signature":
                 templatePath = "templates/request-signature.html";
                 break;
             case "request-token":
                  templatePath = "templates/request-token.html";
                 break;
             default:
                 console.error("Unknown page type for external window:", page);
                 return; // Don't open a window for unknown types
         }
         loadHtmlAndScripts(templatePath); // Call the inner function
}
window.addEventListener("message", (event) => {
    // ... (listener implementation as before) ...
      // Check origin for security if necessary, e.g.,
     // if (event.origin !== "chrome-extension://your-extension-id") return;

     const callbackKey = event.data.callbackKey;
     const sendResponseFunc = callbacks[callbackKey];

     if (!sendResponseFunc) {
        // console.log("No callback found for key:", callbackKey, "Event Data:", event.data);
         return; // Ignore if no callback matches (might be other messages)
     }

     // Handle responses based on the type originally requested
     if (event.data.type === "REQUEST_TRANSACTION_RESPONSE") { // Expecting a specific response type
         console.log("Transaction response from popup:", event.data.data);

          // --- SIGNING LOGIC MOVED HERE ---
          if (event.data.data.confirmed && event.data.data.details) {
               const details = event.data.data.details;
               const selectedAcct = getSelectedAccount(); // Get current account

               if (locked || !unencryptedMnemonic || !selectedAcct) {
                    sendResponseFunc({ errors: ['Wallet locked or unavailable for signing.'] });
                    delete callbacks[callbackKey];
                    return;
               }

               // Reconstruct transaction payload
               let transaction = {
                   payload: {
                       chain_id: CHAIN_ID,
                       contract: details.contract,
                       function: details.method, // Name used in popup
                       kwargs: details.kwargs,
                       stamps_supplied: details.stamps_supplied
                       // nonce/sender added by signTransaction
                   },
                   metadata: { signature: "" }
               };

               // Sign and Broadcast
               signTransaction(transaction, unencryptedMnemonic, selectedAcct.index)
                   .then(signedTx => broadcastTransaction(signedTx))
                   .then(response => {
                        if (response.error === 'timeout') {
                             sendResponseFunc({ status: 'sent_timeout', txid: 'TIMEOUT' }); // Indicate timeout
                             prependToTransactionHistory("TIMEOUT", details.contract, details.method, details.kwargs, 'pending', new Date().toLocaleString());
                        } else if (response && response.result && response.result.hash) {
                             const hash = response.result.hash;
                             const status = response.result.code === 0 ? 'pending' : 'error';
                             prependToTransactionHistory(hash, details.contract, details.method, details.kwargs, status, new Date().toLocaleString());
                             if (status === 'error') {
                                 sendResponseFunc({ errors: [response.result.log || 'Transaction failed on broadcast check.'] });
                             } else {
                                 sendResponseFunc({ status: 'success', txid: hash }); // Success
                             }
                        } else {
                             sendResponseFunc({ errors: [response.result?.log || 'Broadcast failed or unexpected response.'] });
                        }
                        // Refresh UI if needed
                        if (app_page === "wallet") { changePage("wallet"); }
                   })
                   .catch(err => {
                        console.error("Error signing/broadcasting from popup confirmation:", err);
                        sendResponseFunc({ errors: [err.message || 'Signing or broadcast failed.'] });
                   });

          } else {
              // User rejected or error in popup data
               sendResponseFunc(event.data.data); // Pass rejection/errors back
          }
          // --- END SIGNING LOGIC ---

     } else if (event.data.type === "REQUEST_SIGNATURE_RESPONSE") {
         console.log("Signature response from popup:", event.data.data);

          // --- SIGNING LOGIC MOVED HERE ---
          if (event.data.data.confirmed && event.data.data.message) {
              const messageToSign = event.data.data.message;
              const selectedAcct = getSelectedAccount();

              if (locked || !unencryptedMnemonic || !selectedAcct) {
                   sendResponseFunc({ signature: null, errors: ['Wallet locked or unavailable for signing.'] });
                   delete callbacks[callbackKey];
                   return;
              }

              signMessage(messageToSign, unencryptedMnemonic, selectedAcct.index)
                  .then(signature => {
                       sendResponseFunc({ signature: signature, errors: null }); // Send signature back
                       toast('success', 'Message signed successfully.');
                  })
                  .catch(err => {
                       console.error("Error signing message from popup confirmation:", err);
                       sendResponseFunc({ signature: null, errors: [err.message || 'Signing failed.'] });
                  });

          } else {
              // User rejected
               sendResponseFunc(event.data.data); // Pass rejection back { confirmed: false, signature: null, errors: ['rejected'] }
          }
          // --- END SIGNING LOGIC ---

     } else if (event.data.type === "REQUEST_TOKEN_RESPONSE") {
          console.log("Token response from popup:", event.data.data);

          // --- PROCESSING LOGIC MOVED HERE ---
           if (event.data.data.confirmed && event.data.data.contract) {
               const contractToAdd = event.data.data.contract;

               // Validate contract name again? Optional.
               if (!/^[a-zA-Z0-9_.]+$/.test(contractToAdd)) { // Allow dots for subcontracts
                    sendResponseFunc({ success: false, errors: ['Invalid contract name format received.'] });
               } else {
                   // Add to token list (ensure global token_list is available)
                   if (!window.token_list) window.token_list = []; // Initialize if needed
                   if (!window.token_list.includes(contractToAdd)) {
                       window.token_list.push(contractToAdd);
                       localStorage.setItem("token_list", JSON.stringify(window.token_list)); // Persist
                       toast('success', `Token ${contractToAdd} added to list.`);
                        sendResponseFunc({ success: true });
                         // Refresh wallet UI if currently viewing it
                         if (app_page == "wallet"){
                              changePage("wallet");
                         }
                   } else {
                        toast('info', `Token ${contractToAdd} is already in your list.`);
                         sendResponseFunc({ success: true }); // Still success, just didn't change anything
                   }
               }
           } else {
               // User rejected
                sendResponseFunc(event.data.data); // Pass rejection back
           }
           // --- END PROCESSING LOGIC ---

      } else if (event.data.type === "POPUP_READY") {
           // Popup signaled it's ready, maybe resend initial state if needed
           console.log("Popup is ready.");
           // Optionally resend state if there was a timing issue
           // sendInitialState();
     } else {
          console.log("Received unhandled message type from popup:", event.data.type);
     }

     // Clean up the callback after processing
     delete callbacks[callbackKey];
});

// --- Page Navigation ---
function sideNavActive() {
    // ... (implementation as before) ...
      try {
         const activeClass = "active-side-nav";
         const navItems = [
             "side-change-page-wallet", "side-change-page-ide",
             "side-change-page-insights", "side-change-page-ecosystem-news",
             "side-change-page-settings", "side-change-page-messenger"
         ];
          // Determine the target ID based on the current app_page
          let targetId = `side-change-page-${app_page}`;

           // Handle cases where the app_page doesn't directly map to a nav item ID
          if (['send-token', 'receive-token', 'add-to-token-list', 'create-token', 'send-advanced-transaction', 'new-proposal'].includes(app_page)) {
              targetId = 'side-change-page-wallet'; // Highlight 'Wallet' for these related pages
          } else if (app_page === 'governance') { // Example if governance maps to insights
               targetId = 'side-change-page-insights';
          }

         navItems.forEach(id => {
             const element = document.getElementById(id);
             if (element) {
                 if (id === targetId) {
                     element.classList.add(activeClass);
                 } else {
                     element.classList.remove(activeClass);
                 }
             }
         });

       } catch (error) {
         console.error("Error updating side nav active state:", error);
       }
}

function changePage(page, some_data = null) {
    // --- Check if app_box exists ---
    app_box = document.getElementById("app-box"); // Re-check element
    if (!app_box) {
        console.error("Fatal Error: app-box element not found. Cannot change page.");
        // Maybe display an error message directly on the body
        document.body.innerHTML = "<h1>Error: UI container not found.</h1>";
        return;
    }
    // --- End Check ---

    sendEventGA("page_view", {engagement_time_msec: 100, page_title: page, page_location: page});
    app_page = page;
    sideNavActive(); // Update nav highlighting

    // Wallet State Checks (as before)
    const requiresUnlock = ![
        "get-started", "create-wallet", "import-wallet", "password-input", "ecosystem-news"
    ].includes(page);
    if (requiresUnlock && locked) {
        console.log("Wallet locked, redirecting to password input.");
        page = "password-input";
        app_page = page;
        sideNavActive();
    }
    const creationPages = ["get-started", "create-wallet", "import-wallet"];
    if (creationPages.includes(page) && !locked && encryptedSeed) {
         console.log("Wallet exists and unlocked, redirecting to wallet.");
         page = "wallet";
         app_page = page;
         sideNavActive();
    }

    // --- loadHtmlAndScripts definition needed HERE before usage ---
     const loadHtmlAndScripts = (htmlPath) => {
         fetch(htmlPath)
             .then((response) => response.text())
              // Use the globally defined insertHTMLAndExecuteScripts
             .then((htmlContent) => insertHTMLAndExecuteScripts(app_box, htmlContent))
             .then(() => {
                  // Page-specific initializations (as before)
                  if (page === "send-token") {
                       const selectedAccount = accounts.find(acc => acc.index === selectedAccountIndex);
                       if (selectedAccount) {
                            document.getElementById("tokenName").innerHTML = some_data;
                       } else {
                            changePage('wallet');
                       }
                   }
                   // ... (other page specific logic like side nav visibility) ...
                   const hideNavPages = ["password-input", "create-wallet", "import-wallet", "get-started"];
                    const sideNav = document.getElementById("side-nav"); // Use ID now
                    const appBoxElement = document.querySelector(".app-box"); // Target the container more specifically

                    if (sideNav && appBoxElement) {
                       if (hideNavPages.includes(page)) {
                           sideNav.style.display = "none";
                           // Reset styles possibly set for when nav is visible
                            appBoxElement.style.borderTopLeftRadius = "8px";
                            appBoxElement.style.borderBottomLeftRadius = "8px";
                            appBoxElement.style.borderTopRightRadius = "8px"; // Ensure right is also rounded
                            appBoxElement.style.borderLeftWidth = "1px";

                       } else {
                           sideNav.style.display = "flex"; // Use flex as per previous CSS
                           if (window.innerWidth > 768) {
                               // Desktop layout: Nav left, App right
                               appBoxElement.style.borderLeftWidth = "0px";
                               appBoxElement.style.borderTopLeftRadius = "0px";
                               appBoxElement.style.borderBottomLeftRadius = "0px";
                               appBoxElement.style.borderTopRightRadius = "8px"; // Keep top right rounded
                                sideNav.style.borderTopLeftRadius = "8px"; // Round top-left of nav
                                sideNav.style.borderBottomLeftRadius = "8px"; // Round bottom-left of nav
                                sideNav.style.borderTopRightRadius = "0px"; // Nav right border straight
                                sideNav.style.borderBottomRightRadius = "0px";
                                sideNav.style.borderBottomWidth = "1px";
                           } else {
                               // Mobile layout: Nav top, App bottom
                                appBoxElement.style.borderTopLeftRadius = "0px";
                                appBoxElement.style.borderTopRightRadius = "0px";
                                appBoxElement.style.borderBottomLeftRadius = "8px"; // Round bottom-left of app
                                appBoxElement.style.borderBottomRightRadius = "8px"; // Round bottom-right of app
                                appBoxElement.style.borderLeftWidth = "1px";
                                appBoxElement.style.borderTopWidth = "0px"; // No top border if nav is above

                                sideNav.style.borderTopLeftRadius = "8px";
                                sideNav.style.borderTopRightRadius = "8px";
                                sideNav.style.borderBottomLeftRadius = "0px"; // Nav bottom straight
                                sideNav.style.borderBottomRightRadius = "0px";
                                sideNav.style.borderBottomWidth = "0px"; // No bottom border separating from app-box
                           }
                       }
                    } else {
                         console.warn("Could not find side-nav or app-box element for styling.");
                    }

             })
             .catch(error => {
                 console.error(`Error loading page ${page}:`, error);
                 if (app_page !== 'wallet') changePage('wallet');
             });
     };
    // --- End loadHtmlAndScripts definition ---


    const pageTemplates = {
        // ... (mapping as before) ...
         "get-started": "templates/get-started.html",
         "create-wallet": "templates/create-wallet.html",
         "import-wallet": "templates/import-wallet.html",
         "wallet": "templates/wallet.html",
         "password-input": "templates/password-input.html",
         "send-token": "templates/send-token.html",
         "receive-token": "templates/receive-token.html",
         "settings": "templates/settings.html",
         "send-advanced-transaction": "templates/advanced-transaction.html",
         "add-to-token-list": "templates/add-to-token-list.html",
         "ide": "templates/ide.html",
         "insights": "templates/insights.html",
         "new-proposal": "templates/new-proposal.html",
         "ecosystem-news": "templates/ecosystem-news.html",
         "create-token": "templates/create-token.html",
         "messenger": "templates/messenger.html"
    };
    const templatePath = pageTemplates[page];

    if (templatePath) {
        loadHtmlAndScripts(templatePath); // Call the inner function
    } else {
        console.error(`Unknown page: ${page}. Redirecting to wallet.`);
        changePage('wallet');
    }
}

// --- Initialization Logic (DOMContentLoaded) ---
document.addEventListener("DOMContentLoaded", async (event) => {
    // ... (online status and chain ID fetch as before) ...
     if (document.getElementById("onlineStatus") == null) {
       // Likely running in the external window, skip main init
       return;
     }
     let online_status_element = document.getElementById("onlineStatus");

     // Initial Ping and Chain ID fetch
     ping().then(online_status => {
           const statusIndicator = online_status
               ? "<div class='mt-1px'><div class='online-circle' title='Node is Online'></div></div>"
               : "<div class='mt-1px'><div class='offline-circle' title='Node is Offline'></div></div>";
           online_status_element.innerHTML = `${statusIndicator} <div>${RPC.replace("https://", "").replace("http://", "")}</div>`;
     }).catch(error => {
         online_status_element.innerHTML = "<div class='mt-1px'><div class='offline-circle' title='Node is Offline'></div></div> <div>" + RPC.replace("https://", "").replace("http://", "") + "</div>";
     });

     await getChainID(); // Ensure CHAIN_ID is fetched early

     // Read HD Wallet related data
     encryptedSeed = await readEncryptedSeed();
     accounts = await readAccounts();
     selectedAccountIndex = await readSelectedAccountIndex();

     // Determine initial page
     if (encryptedSeed && accounts.length > 0) {
         locked = true;
         changePage("password-input"); // Start at password input if wallet exists
     } else {
         locked = true;
         encryptedSeed = null; accounts = []; selectedAccountIndex = 0; // Ensure clean state
         changePage("get-started");
     }
});

======================================================================
File: xian-web-wallet/js/xian.js
======================================================================
var RPC = localStorage.getItem("rpc") || "https://node.xian.org";
var EXPLORER = localStorage.getItem("explorer") || "https://explorer.xian.org";
var CHAIN_ID = null;

// Assuming 'nacl' and 'bip39' are globally available from included scripts
// Assuming 'HDKey' is available (needs micro-ed25519-hdkey library) - NOTE: This dependency wasn't in the original index.html, it needs to be added. Let's proceed assuming it's added.

// --- Helper Functions ---

function toHexString(byteArray) {
    return Array.from(byteArray, function(byte) {
        return ('0' + (byte & 0xFF).toString(16)).slice(-2);
    }).join('');
}

function fromHexString(hexString) {
    // Ensure the hex string has an even length
    if (hexString.length % 2 !== 0) {
        console.warn("Hex string has odd length, padding with leading zero.");
        hexString = '0' + hexString;
    }
    try {
        return new Uint8Array(hexString.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
    } catch (e) {
        console.error("Error converting hex string to Uint8Array:", e, "Input:", hexString);
        throw e; // Rethrow the error after logging
    }
}

// Helper to concatenate Uint8Arrays (needed for nacl.sign.detached)
function concatUint8Arrays(array1, array2) {
    const result = new Uint8Array(array1.length + array2.length);
    result.set(array1, 0);
    result.set(array2, array1.length);
    return result;
}

// Helper for string to buffer conversion
function str2buf(str) {
    return new TextEncoder().encode(str);
}

// --- Encryption / Decryption (Now for Seed Phrase) ---

function encryptSeed(mnemonic, password) {
    let passwordBytes = new TextEncoder().encode(password);
    let key = nacl.hash(passwordBytes).slice(0, 32); // Derive key from password hash
    let nonce = nacl.randomBytes(nacl.secretbox.nonceLength); // Generate random nonce
    let mnemonicBytes = new TextEncoder().encode(mnemonic); // Convert mnemonic to bytes
    let encryptedMnemonic = nacl.secretbox(mnemonicBytes, nonce, key);

    // Combine nonce and encrypted mnemonic for storage
    let combined = new Uint8Array(nonce.length + encryptedMnemonic.length);
    combined.set(nonce);
    combined.set(encryptedMnemonic, nonce.length);

    return toHexString(combined);
}

function decryptSeed(encryptedSeedHex, password) {
    try {
        let combined = fromHexString(encryptedSeedHex);
        let nonce = combined.slice(0, nacl.secretbox.nonceLength);
        let message = combined.slice(nacl.secretbox.nonceLength);

        let passwordBytes = new TextEncoder().encode(password);
        let key = nacl.hash(passwordBytes).slice(0, 32); // Derive key from password hash

        let decryptedBytes = nacl.secretbox.open(message, nonce, key);

        if (!decryptedBytes) {
            console.error("Decryption failed, possibly wrong password.");
            return null; // Indicate decryption failure
        }

        return new TextDecoder().decode(decryptedBytes); // Convert decrypted bytes back to mnemonic string
    } catch (error) {
        console.error("Error during seed decryption:", error);
        return null; // Indicate failure
    }
}


// --- HD Wallet Key Generation & Derivation ---

/**
 * Derives a key pair for a specific BIP32 derivation path from a mnemonic.
 * @param {string} mnemonic - The BIP39 mnemonic phrase.
 * @param {number} index - The derivation index (e.g., 0 for the first account).
 * @returns {{sk: Uint8Array, vk: Uint8Array, derivationPath: string}} Key pair and path.
 * @throws {Error} If derivation fails or keys mismatch.
 */
function deriveKeyPairFromMnemonic(mnemonic, index) {
    if (!bip39.validateMnemonic(mnemonic)) {
        throw new Error("Invalid mnemonic phrase provided.");
    }
    const seed = bip39.mnemonicToSeedSync(mnemonic); // Get the master seed
    const hdkeyMaster = ed25519Hdkey.HDKey.fromMasterSeed(seed);
    const derivationPath = `m/44'/789'/${index}'/0'/0'`; // Standard Xian derivation path structure
    const hdkeyDerived = hdkeyMaster.derive(derivationPath);

    // Use nacl.sign.keyPair.fromSeed with the derived private key (first 32 bytes of seed for Ed25519)
    const keyPair = nacl.sign.keyPair.fromSeed(hdkeyDerived.privateKey);

    // Cross-verify public key (optional but good practice)
    const naclVkHex = toHexString(keyPair.publicKey);
    const hdVkHex = toHexString(hdkeyDerived.publicKey); // HDKey might include a prefix, adjust if needed
    
    // Basic comparison - adjust if HDKey's publicKey format differs significantly
    // This comparison might need refinement based on micro-ed25519-hdkey specifics
    if (naclVkHex !== hdVkHex && !hdVkHex.endsWith(naclVkHex)) { // Simple check, might need improvement
         console.warn(`Potential VK mismatch: NaCL=${naclVkHex}, HDKey=${hdVkHex}. Using NaCL's.`);
         // Decide which VK to trust or handle error. NaCL's is usually the one used for signing/verification.
    }


    return {
        sk: keyPair.secretKey.slice(0, 32), // Extract the 32-byte secret key part
        vk: keyPair.publicKey,           // Use the public key derived by nacl
        derivationPath: derivationPath
    };
}


/**
 * Creates a new master seed (mnemonic) and encrypts it.
 * Derives the first account (index 0).
 * @param {string} password - Password to encrypt the mnemonic.
 * @returns {{publicKey: string, encryptedSeed: string}} The public key of the first account and the encrypted mnemonic.
 */
function createMasterSeed(password) {
    const mnemonic = bip39.generateMnemonic(256); // Generate a 24-word mnemonic
    const encryptedSeed = encryptSeed(mnemonic, password);

    // Derive the first key pair (index 0) to get the initial public key
    const firstKeyPair = deriveKeyPairFromMnemonic(mnemonic, 0);

    return {
        publicKey: toHexString(firstKeyPair.vk), // VK of the first account
        encryptedSeed: encryptedSeed,
        unencryptedMnemonic: mnemonic // Return the mnemonic temporarily for immediate use
    };
}

/**
 * Imports a wallet from a mnemonic phrase and encrypts it.
 * Derives the first account (index 0).
 * @param {string} mnemonic - The mnemonic phrase to import.
 * @param {string} password - Password to encrypt the mnemonic.
 * @returns {{publicKey: string, encryptedSeed: string}|null} VK of first account and encrypted seed, or null if invalid mnemonic.
 */
function importMasterSeedFromMnemonic(mnemonic, password) {
    if (!bip39.validateMnemonic(mnemonic)) {
        console.error("Invalid mnemonic provided during import.");
        return null;
    }

    const encryptedSeed = encryptSeed(mnemonic, password);
    const firstKeyPair = deriveKeyPairFromMnemonic(mnemonic, 0);

    return {
        publicKey: toHexString(firstKeyPair.vk),
        encryptedSeed: encryptedSeed,
        unencryptedMnemonic: mnemonic // Return temporarily for immediate use
    };
}

// --- Transaction and Message Signing (Modified for HD) ---

async function getNonce(publicKey) { // Added publicKey parameter
  try {
      const response = await fetchWithTimeout(RPC + '/abci_query?path="/get_next_nonce/' + publicKey + '"');

      if (response.ok) {
          const responseData = await response.json();
           // Check if response.result or response.result.response is null
           if (!responseData.result || !responseData.result.response) {
                console.warn("Nonce query returned unexpected structure:", responseData);
                return 0; // Default to 0 if structure is missing
            }
          // Check for null or "AA==" value which indicates nonce is 0
          if (responseData.result.response.value === null || responseData.result.response.value === "AA==") {
              return 0;
          } else {
              // Decode and parse the nonce, handle potential errors
              try {
                  const decodedValue = atob(responseData.result.response.value);
                  const nonce = parseInt(decodedValue, 10);
                  // Check if nonce is a valid number
                  if (isNaN(nonce)) {
                    console.error("Decoded nonce is not a number:", decodedValue);
                    return 0; // Default to 0 if parsing fails
                  }
                  return nonce;
              } catch (decodeError) {
                  console.error("Error decoding nonce:", decodeError, "Raw value:", responseData.result.response.value);
                  return 0; // Default to 0 if decoding fails
              }
          }
      } else {
          console.error("Failed to fetch nonce: HTTP status " + response.status);
          // Don't throw here, return a default or handle appropriately
          return 0; // Or handle error state differently
      }
  } catch (error) {
      console.error("Error fetching nonce:", error);
       // Check if it's a timeout error
       if (error.message === 'Request timeout') {
        console.warn("Nonce request timed out. Defaulting nonce to 0.");
        return 0; // Default nonce on timeout
    }
      return 0; // Return default nonce on other errors
  }
}

/**
 * Signs a transaction using the private key derived for the specified account index.
 * @param {object} transaction - The transaction object.
 * @param {string} decryptedMnemonic - The user's decrypted mnemonic phrase.
 * @param {number} accountIndex - The index of the account to sign with.
 * @returns {Promise<object>} The signed transaction object.
 */
async function signTransaction(transaction, decryptedMnemonic, accountIndex) {
    try {
        const keyPair = deriveKeyPairFromMnemonic(decryptedMnemonic, accountIndex);
        const senderVk = toHexString(keyPair.vk);
        const derivedSk = keyPair.sk; // This is the 32-byte secret key

        // Get nonce for the specific sender public key
        const nonce = await getNonce(senderVk);
        transaction.payload.nonce = nonce;
        transaction.payload.sender = senderVk; // Make sure sender VK is correct

        // Sort the keys in payload for deterministic signature generation
        let orderedPayload = {};
        Object.keys(transaction.payload).sort().forEach(function(key) {
            orderedPayload[key] = transaction.payload[key];
        });
        transaction.payload = orderedPayload; // Update transaction with ordered payload

        let serializedTransaction = JSON.stringify(orderedPayload);
        let transactionUint8Array = str2buf(serializedTransaction); // Use helper

        // Create the 64-byte key required by nacl.sign.detached (sk + vk)
        let combinedKey = concatUint8Arrays(derivedSk, keyPair.vk);

        // Use nacl.sign.detached to get the signature
        let signatureUint8Array = nacl.sign.detached(transactionUint8Array, combinedKey);

        // Add the signature to metadata
        transaction.metadata.signature = toHexString(signatureUint8Array);

        return transaction;

    } catch (error) {
        console.error("Error signing transaction:", error);
        throw error; // Re-throw the error to be handled by the caller
    }
}


/**
 * Signs a message using the private key derived for the specified account index.
 * @param {string} message - The message string to sign.
 * @param {string} decryptedMnemonic - The user's decrypted mnemonic phrase.
 * @param {number} accountIndex - The index of the account to sign with.
 * @returns {Promise<string>} The hex string of the signature.
 */
async function signMessage(message, decryptedMnemonic, accountIndex) {
     try {
        const keyPair = deriveKeyPairFromMnemonic(decryptedMnemonic, accountIndex);
        const derivedSk = keyPair.sk;

        // Create the 64-byte key required by nacl.sign.detached (sk + vk)
        let combinedKey = concatUint8Arrays(derivedSk, keyPair.vk);

        let messageUint8Array = str2buf(message); // Use helper
        let signatureUint8Array = nacl.sign.detached(messageUint8Array, combinedKey);

        return toHexString(signatureUint8Array);
    } catch (error) {
        console.error("Error signing message:", error);
        throw error;
    }
}

// --- Network & Blockchain Interaction Functions (Mostly unchanged, but check dependencies) ---

async function broadcastTransaction(signedTransaction) {
  // Broadcast the transaction as hex
  // signedTransaction = signedTransaction[0]; // This might be needed depending on how signTransaction resolves
  let txToSend = JSON.stringify(signedTransaction); // Ensure it's the signed object
  let txHex = toHexString(str2buf(txToSend)); // Use helpers

  try {
      const response = await fetchWithTimeout(RPC + '/broadcast_tx_sync?tx="' + txHex + '"');
      const responseData = await response.json();
      return responseData;
  } catch (error) {
      console.error('Error broadcasting transaction:', error);
      // Check if it's a timeout error
      if (error.message === 'Request timeout') {
        toast('warning', 'Broadcast request timed out. Transaction might have been sent, check explorer.');
        // Return a specific structure or throw a custom error for timeout
        return { error: 'timeout', message: 'Broadcast timed out' };
      }
      throw error;
  }
}

async function getContractFunctions(contract) {
  try {
      const response = await fetchWithTimeout(RPC + '/abci_query?path="/contract_methods/' + contract + '"');
      if (response.ok) {
          const responseData = await response.json();
          if (!responseData.result || !responseData.result.response || responseData.result.response.value === "AA==" || responseData.result.response.value === null) {
               console.warn(`No methods found or null response for contract: ${contract}`);
              return null; // Or return an empty structure: { methods: [], variables: [] }
          }
          const decoded = atob(responseData.result.response.value);
          return JSON.parse(decoded);
      } else {
          console.error('Failed to fetch contract functions:', response.status, contract);
          return null; // Return null instead of throwing for graceful handling
      }
  } catch (error) {
      console.error('Error fetching contract functions:', error, contract);
       if (error.message === 'Request timeout') {
            toast('warning', `Request for methods of ${contract} timed out.`);
        }
      return null; // Return null on error
  }
}

async function getContractCode(contract) {
  try {
      const response = await fetchWithTimeout(RPC + '/abci_query?path="/contract/' + contract + '"');
      if (response.ok) {
          const responseData = await response.json();
          if (!responseData.result || !responseData.result.response || responseData.result.response.value === "AA==" || responseData.result.response.value === null) {
              console.warn(`No code found or null response for contract: ${contract}`);
              return null;
          }
          return atob(responseData.result.response.value);
      } else {
          console.error('Failed to fetch contract code:', response.status, contract);
          return null;
      }
  } catch (error) {
      console.error('Error fetching contract code:', error, contract);
        if (error.message === 'Request timeout') {
            toast('warning', `Request for code of ${contract} timed out.`);
        }
      return null;
  }
}

async function getVariable(contract, variable, key = "") {
  try {
      let path = `/get/${contract}.${variable}`;
      if (key !== "") {
          // Ensure key is properly encoded if it contains special characters
          path += `:${encodeURIComponent(key)}`;
      }
      const response = await fetchWithTimeout(RPC + '/abci_query?path="' + path + '"');
      const data = await response.json();

      if (!data.result || !data.result.response || data.result.response.value === "AA==" || data.result.response.value === null) {
          // console.log(`Variable or key not found: ${contract}.${variable}${key ? ':' + key : ''}`);
          return null;
      }
      return atob(data.result.response.value);
  } catch (error) {
      console.error(`Error fetching variable: ${contract}.${variable}${key ? ':' + key : ''}`, error);
       if (error.message === 'Request timeout') {
            toast('warning', `Request for variable ${contract}.${variable}${key ? ':' + key : ''} timed out.`);
        }
      // Consider returning null or a specific error object instead of throwing
      return null;
    //   throw error; // Or rethrow if critical
  }
}

async function ping() {
  try {
    const response = await fetchWithTimeout(RPC + '/status');
    return response.ok;
  } catch(error) {
     if (error.message === 'Request timeout') {
            console.warn('Ping request timed out.');
        } else {
            console.error('Ping failed:', error);
        }
    return false;
  }
}

async function sanitizeHTML(html) {
    // Basic sanitization, consider a more robust library if complex HTML is expected
    if (typeof html !== 'string') return '';
    return html.replace(/</g, "<").replace(/>/g, ">");
}

async function getTokenInfo(contract) {
  let tokenInfo = { contract: contract, name: null, symbol: null, token_logo_url: null }; // Initialize properties

  if (contract === "currency") {
      tokenInfo["name"] = "Xian";
      tokenInfo["symbol"] = "Xian";
      // Optionally add a default logo URL for Xian native token
      tokenInfo["token_logo_url"] = "assets/xian-white.svg"; // Example path
      return tokenInfo;
  }

  try {
      // Use Promise.all for concurrent fetching
      const results = await Promise.all([
          getVariable(contract, 'metadata', 'token_name'),
          getVariable(contract, 'metadata', 'token_symbol'),
          getVariable(contract, 'metadata', 'token_logo_url')
      ]);

      // Assign results after sanitizing
      tokenInfo.name = results[0] ? await sanitizeHTML(results[0]) : 'Unknown Name';
      tokenInfo.symbol = results[1] ? await sanitizeHTML(results[1]) : '???';
      tokenInfo.token_logo_url = results[2] ? await sanitizeHTML(results[2]) : null; // Keep null if not found

       // Handle cases where core info might be missing but contract exists
       if (tokenInfo.name === 'Unknown Name' && tokenInfo.symbol === '???') {
            // Attempt to check if the contract exists at all, e.g., by fetching code
            const codeExists = await getContractCode(contract);
            if (!codeExists) {
                 console.warn(`Contract ${contract} might not exist or metadata is missing.`);
                 // Mark as potentially non-existent or invalid standard token
                 tokenInfo.name = "\x9Eée"; // Using the original marker for non-existent/error
                 tokenInfo.symbol = "\x9Eée";
            } else if (tokenInfo.name === 'Unknown Name') {
                // If code exists but name is missing, use contract name as fallback
                 tokenInfo.name = await sanitizeHTML(contract);
            }
       }


      return tokenInfo;
  } catch (error) {
      console.error(`Error retrieving token info for ${contract}:`, error);
       // Return initialized structure on error, possibly marking it
       tokenInfo.name = "\x9Eée";
       tokenInfo.symbol = "\x9Eée";
      return tokenInfo;
  }
}


async function getStampRate() {
  try {
      // Note: The original path included '.S:', which might be specific to certain state structures.
      // If '.S:' is not standard, adjust the path accordingly. Example: "/get/stamp_cost.value"
      // Let's assume the original path is correct for now.
      const response = await fetchWithTimeout(RPC + '/abci_query?path="/get/stamp_cost.S:value"');
      const data = await response.json();

      if (!data.result || !data.result.response || data.result.response.value === "AA==" || data.result.response.value === null) {
          console.warn("Stamp rate not found or null response.");
          return null; // Return null if not found or error
      }

      // Decode and parse, ensuring it's a valid integer
      try {
          const decodedValue = atob(data.result.response.value);
          const rate = parseInt(decodedValue, 10);
           if (isNaN(rate)) {
               console.error("Decoded stamp rate is not a number:", decodedValue);
               return null;
           }
          return rate;
      } catch (decodeError) {
          console.error("Error decoding stamp rate:", decodeError, "Raw value:", data.result.response.value);
          return null;
      }

  } catch (error) {
      console.error("Error fetching stamp rate:", error);
        if (error.message === 'Request timeout') {
            toast('warning', 'Request for stamp rate timed out.');
        }
      return null; // Return null on fetch error
  }
}

async function getChainID() {
  // Cache chain ID if already fetched
  if (CHAIN_ID) {
      return CHAIN_ID;
  }
  try {
      const response = await fetchWithTimeout(RPC + '/genesis');
      const data = await response.json();

      if (data.result && data.result.genesis && data.result.genesis["chain_id"]) {
          CHAIN_ID = data.result.genesis["chain_id"];
          return CHAIN_ID;
      } else {
           console.error("Could not find chain_id in genesis response:", data);
           return null;
      }
  } catch (error) {
      console.error("Error fetching chain ID:", error);
        if (error.message === 'Request timeout') {
            toast('warning', 'Request for chain ID timed out.');
        }
      return null; // Return null on error
  }
}

async function estimateStamps(signedTransaction) {
    try {
        // Ensure the input is the actual transaction object, not an array containing it
        const txObject = Array.isArray(signedTransaction) ? signedTransaction[0] : signedTransaction;
        if (!txObject || typeof txObject !== 'object') {
             console.error("Invalid signedTransaction object passed to estimateStamps:", signedTransaction);
             return { stamps: null, tx_result: null, success: false };
        }

        let serializedTransaction = JSON.stringify(txObject);
        let transactionUint8Array = str2buf(serializedTransaction); // Use helper
        let signedTransactionHex = toHexString(transactionUint8Array);

        const response = await fetchWithTimeout(RPC + '/abci_query?path="/calculate_stamps/' + signedTransactionHex + '"');
        const data = await response.json();

        if (!data.result || !data.result.response || data.result.response.value === "AA==" || data.result.response.value === null) {
            console.warn("Stamp estimation returned null or no value.");
             // Try to get more info from the log if available
            const log = data.result && data.result.response ? data.result.response.log : "No details available.";
            console.error("Stamp estimation failed:", log);
            return { stamps: null, tx_result: log, success: false }; // Provide log as result on failure
        }

        let tx_result_str = atob(data.result.response.value);
        let tx_result = JSON.parse(tx_result_str);

        // Validate the structure of tx_result
        if (typeof tx_result.stamps_used === 'undefined' || typeof tx_result.status === 'undefined') {
            console.error("Unexpected structure in stamp estimation response:", tx_result);
             return { stamps: null, tx_result: "Invalid response structure", success: false };
        }

        let stamps = parseInt(tx_result["stamps_used"], 10);
         if (isNaN(stamps)) {
              console.error("Parsed stamps_used is not a number:", tx_result["stamps_used"]);
              stamps = null; // Treat as error if parsing fails
         }

        let result = {
            stamps: stamps,
            tx_result: tx_result["result"] || (tx_result["status"] !== 0 ? tx_result_str : null), // Provide result or full string on error
            success: tx_result["status"] === 0
        };
        return result;

    } catch (error) {
        console.error("Error fetching stamp estimation:", error);
         if (error.message === 'Request timeout') {
            toast('warning', 'Stamp estimation request timed out.');
        }
        return { stamps: null, tx_result: error.message, success: false }; // Include error message
    }
}

// --- Balance and Name Service Functions (Need publicKey) ---

// Modified to accept publicKey explicitly
async function execute_balance_of(contract, address) {
  // No need to read from secure cookie here, address is passed in
  let payload = {
        "sender": address, // Use the provided address
        "contract": contract,
        "function": "balance_of",
        "kwargs": {
            "address": address
        }
    };
    let bytes = str2buf(JSON.stringify(payload)); // Use helper
    let hex = toHexString(bytes);

    try {
        const response = await fetchWithTimeout(RPC + '/abci_query?path="/simulate_tx/' + hex + '"');
        const data = await response.json();

         if (!data.result || !data.result.response || data.result.response.value === null) {
            console.warn(`Balance query returned null for ${contract} / ${address}`);
            // Attempt fallback to getVariable if simulation fails or returns null
            const balanceVar = await getVariable(contract, "balances", address);
            if (balanceVar === null) {
                return "0.00000000"; // Return formatted zero if variable is also null
            }
             try {
                return parseFloat(balanceVar).toFixed(8);
            } catch (parseError) {
                 console.error(`Failed to parse balance from getVariable for ${contract} / ${address}:`, balanceVar);
                 return "0.00000000";
            }
        }

        let decoded = atob(data.result.response.value);

        // Check for specific error markers or empty results from simulation
        if (decoded === "žée" || decoded === "AA==" || decoded === "") {
             console.warn(`Simulation returned empty/marker for ${contract} / ${address}, falling back to getVariable.`);
             const balanceVar = await getVariable(contract, "balances", address);
             if (balanceVar === null) {
                 return "0.00000000";
             }
            try {
                return parseFloat(balanceVar).toFixed(8);
            } catch (parseError) {
                console.error(`Failed to parse balance from getVariable fallback for ${contract} / ${address}:`, balanceVar);
                return "0.00000000";
            }
        }

        try {
            // Parse the simulation result
            let simulationResult = JSON.parse(decoded);
             if (simulationResult.status !== 0 || typeof simulationResult.result === 'undefined' || simulationResult.result === null) {
                 console.warn(`Simulation failed or returned null result for ${contract} / ${address}. Status: ${simulationResult.status}`);
                  // Fallback if simulation status is non-zero or result is missing
                 const balanceVar = await getVariable(contract, "balances", address);
                  if (balanceVar === null) return "0.00000000";
                  try { return parseFloat(balanceVar).toFixed(8); } catch { return "0.00000000"; }
             }

            // Parse the balance from the result
            let balance = parseFloat(simulationResult.result);
             if (isNaN(balance)) {
                  console.error(`Parsed balance is NaN from simulation for ${contract} / ${address}:`, simulationResult.result);
                 // Fallback on NaN
                  const balanceVar = await getVariable(contract, "balances", address);
                  if (balanceVar === null) return "0.00000000";
                  try { return parseFloat(balanceVar).toFixed(8); } catch { return "0.00000000"; }
             }

            return balance.toFixed(8);
        } catch (parseError) {
            console.error(`Error parsing simulation/balance result for ${contract} / ${address}:`, parseError, "Decoded:", decoded);
             // Final fallback on any parsing error
             const balanceVar = await getVariable(contract, "balances", address);
             if (balanceVar === null) return "0.00000000";
             try { return parseFloat(balanceVar).toFixed(8); } catch { return "0.00000000"; }
        }
    } catch (error) {
        console.error(`Error executing balance_of for ${contract} / ${address}:`, error);
         if (error.message === 'Request timeout') {
            toast('warning', `Balance request for ${contract} timed out.`);
        }
        // Fallback on fetch error
         const balanceVar = await getVariable(contract, "balances", address);
         if (balanceVar === null) return "0.00000000";
         try { return parseFloat(balanceVar).toFixed(8); } catch { return "0.00000000"; }
    }
}


async function execute_get_main_name_to_address(name) {
    // Sender can be empty for read-only simulations
    let payload = {
          "sender": "", // Can be empty or a placeholder address
          "contract": "con_name_service_final", // Assuming this is the correct contract
          "function": "get_main_name_to_address",
          "kwargs": {
              "name": name
          }
      };
      let bytes = str2buf(JSON.stringify(payload)); // Use helper
      let hex = toHexString(bytes);

      try {
        const response = await fetchWithTimeout(RPC + '/abci_query?path="/simulate_tx/' + hex + '"');
        const data = await response.json();

         if (!data.result || !data.result.response || data.result.response.value === null) {
              console.warn(`Name service query returned null for name: ${name}`);
              return "None"; // Indicate not found
         }

        let decoded = atob(data.result.response.value);

        // Check for specific error markers or empty results
        if (decoded === "žée" || decoded === "AA==" || decoded === "") {
            // console.log(`Name service simulation returned empty/marker for name: ${name}`);
            return "None";
        }

        try {
             let simulationResult = JSON.parse(decoded);

             // Check simulation status and result presence
             if (simulationResult.status !== 0 || typeof simulationResult.result === 'undefined' || simulationResult.result === null || simulationResult.result === 'None') {
                 // console.log(`Name service simulation failed or returned None for name: ${name}. Status: ${simulationResult.status}`);
                 return "None";
             }

             // Clean up the result string (remove potential quotes)
             let address = simulationResult.result.replace(/^['"]|['"]$/g, "");

             // Basic validation for address format (optional but recommended)
              if (typeof address === 'string' && address.length === 64 && /^[0-9a-fA-F]+$/.test(address)) {
                 return address;
              } else {
                   console.warn(`Name service returned invalid address format for ${name}:`, simulationResult.result);
                   return "None";
              }

        } catch (parseError) {
            console.error(`Error parsing name service result for ${name}:`, parseError, "Decoded:", decoded);
            return "None"; // Indicate error/not found on parsing failure
        }
    } catch (error) {
        console.error(`Error executing get_main_name_to_address for ${name}:`, error);
         if (error.message === 'Request timeout') {
            toast('warning', `Name service request for ${name} timed out.`);
        }
        return "None"; // Indicate error/not found on fetch failure
    }
}

======================================================================
File: xian-web-wallet/js/dark-mode.js
======================================================================
document.addEventListener('DOMContentLoaded', (event) => {
    const toggler = document.getElementById('darkModeToggler');
    const body = document.body;
    
    function updateTogglerUI() {
        if (body.classList.contains('dark-mode')) {
            toggler.innerHTML = '<i class="fas fa-sun"></i>';
            toggler.classList.replace('btn-light', 'btn-dark');
        } else {
            toggler.innerHTML = '<i class="fas fa-moon"></i>';
            toggler.classList.replace('btn-dark', 'btn-light');
        }
    }

    if (localStorage.getItem('darkMode') === null) {
        localStorage.setItem('darkMode', 'true');
     }

    if (localStorage.getItem('darkMode') === 'true') {
        body.classList.add('dark-mode');
        updateTogglerUI();
    }

    if (localStorage.getItem('darkMode') === 'false') {
        body.classList.remove('dark-mode');
        updateTogglerUI();
    }

    toggler.addEventListener('click', () => {
        body.classList.toggle('dark-mode');
        const isDarkMode = body.classList.contains('dark-mode');
        localStorage.setItem('darkMode', isDarkMode);
        updateTogglerUI();
    });
});

======================================================================
File: xian-web-wallet/js/extension.js
======================================================================
if (runningAsExtension()) {
    let isUnsafe = (str) => {
        if (str.length < 2 ){
            return true;
        }
        if (str.length > 10000){
            return true;
        }
        try {
            obj = JSON.parse(str);
            if (obj.hasOwnProperty('payload')){
                return true;
            }
            if (obj.hasOwnProperty('metadata')){
                return true;
            }
            if (obj.hasOwnProperty('chain_id')){
                return true;
            }
            return false;
        } catch (e) {
            return false;
        }
        return false;
    };

    // Listen for messages from the background script
    chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
        if (message.type === 'getWalletInfo') {
            sendResponse({address: publicKey, locked: locked, chainId: CHAIN_ID});
        }
        if (message.type === 'dAppSendTransaction') {
            if (locked) {
                sendResponse({errors: ['Wallet is locked']});
                return;
            }
            message.data.chainId = CHAIN_ID;
            createExternalWindow('request-transaction', message, sendResponse);
            
        }
        if (message.type === 'dAppSignMessage') {
            // We expect the message to be a string that cannot be parsed as JSON
            if (isUnsafe(message.data.message)) {
                sendResponse({errors: ['Invalid message']});
                return;
            }

            if (locked) {
                sendResponse({errors: ['Wallet is locked']});
                return;
            }
            createExternalWindow('request-signature', message, sendResponse);
            
        }
        if (message.type === 'dAppAddToken') {
            if (locked) {
                sendResponse({errors: ['Wallet is locked']});
                return;
            }
            createExternalWindow('request-token', message, sendResponse);
            
        }

        return true;
    });
}

======================================================================
File: xian-web-wallet/js/helpers.js
======================================================================
function copyToClipboard(elementId) {
    let element = document.getElementById(elementId);
    // span
    let range, selection;
    if (document.body.createTextRange) {
        range = document.body.createTextRange();
        range.moveToElementText(element);
        range.select();
    } else if (window.getSelection) {
        selection = window.getSelection();
        range = document.createRange();
        range.selectNodeContents(element);
        selection.removeAllRanges();
        selection.addRange(range);
    }
    document.execCommand('copy');
    alert('Copied to clipboard');
}

function copyTextToClipboard(text) {
    let element = document.createElement('textarea');
    element.value = text;
    document.body.appendChild(element);
    element.select();
    document.execCommand('copy');
    document.body.removeChild(element);
    alert('Copied to clipboard');
}

function goToWallet() {
    Promise.all([
        readSecureCookie('publicKey'),
        readSecureCookie('encryptedPrivateKey')
    ]).then((values) => {
        if( values[0] === null || values[1] === null) {
            changePage('get-started');
        } else {
            changePage('wallet');
        }
    });
}

function prependToTransactionHistory(hash, contract, function_name, kwargs, status, timestamp) {
    tx_history.unshift({
        hash: hash,
        contract: contract,
        function: function_name,
        kwargs: kwargs,
        status: status,
        timestamp: timestamp
    });
    localStorage.setItem('tx_history', JSON.stringify(tx_history));
}

======================================================================
File: xian-web-wallet/js/cookietoolz.js
======================================================================
// Helper function to check if running as an extension
function runningAsExtension() {
    // Check for chrome.runtime or browser.runtime to cover Chrome and Firefox/Edge
    return (typeof chrome !== "undefined" && chrome.runtime && chrome.runtime.id) ||
           (typeof browser !== "undefined" && browser.runtime && browser.runtime.id);
}

// Unified function to save data
async function saveData(name, value) {
    if (runningAsExtension()) {
        // Use extension storage API (asynchronous)
        const storageItem = {};
        storageItem[name] = value;
        try {
            if (typeof chrome !== "undefined" && chrome.storage && chrome.storage.local) {
                await new Promise((resolve, reject) => {
                    chrome.storage.local.set(storageItem, () => {
                        if (chrome.runtime.lastError) {
                            reject(chrome.runtime.lastError);
                        } else {
                            resolve();
                        }
                    });
                });
            } else if (typeof browser !== "undefined" && browser.storage && browser.storage.local) {
                await browser.storage.local.set(storageItem);
            } else {
                 console.warn("Extension storage API not available.");
                 // Fallback or error handling if needed
                 localStorage.setItem(name, value); // Basic fallback
            }
        } catch (error) {
            console.error("Error saving to extension storage:", error);
             // Optional: Fallback to localStorage on error
             localStorage.setItem(name, value);
        }
    } else {
        // Use localStorage for web (synchronous)
        try {
            localStorage.setItem(name, value);
        } catch (error) {
            console.error("Error saving to localStorage:", error);
            // Handle potential storage errors (e.g., quota exceeded)
        }
    }
}

// Unified function to read data
async function readData(name) {
    if (runningAsExtension()) {
        // Use extension storage API (asynchronous)
        try {
            if (typeof chrome !== "undefined" && chrome.storage && chrome.storage.local) {
                 return await new Promise((resolve, reject) => {
                     chrome.storage.local.get([name], function(result) {
                         if (chrome.runtime.lastError) {
                             reject(chrome.runtime.lastError);
                         } else {
                             resolve(result[name]); // Returns undefined if key doesn't exist
                         }
                     });
                 });
            } else if (typeof browser !== "undefined" && browser.storage && browser.storage.local) {
                const result = await browser.storage.local.get(name);
                return result[name]; // Returns undefined if key doesn't exist
            } else {
                 console.warn("Extension storage API not available.");
                 return localStorage.getItem(name); // Basic fallback
            }
        } catch (error) {
            console.error("Error reading from extension storage:", error);
            return localStorage.getItem(name); // Fallback on error
        }
    } else {
        // Use localStorage for web (synchronous)
        return localStorage.getItem(name); // Returns null if key doesn't exist
    }
}

// Unified function to remove data
async function removeData(name) {
    if (runningAsExtension()) {
        // Use extension storage API (asynchronous)
         try {
            if (typeof chrome !== "undefined" && chrome.storage && chrome.storage.local) {
                 await new Promise((resolve, reject) => {
                    chrome.storage.local.remove(name, () => {
                         if (chrome.runtime.lastError) {
                             reject(chrome.runtime.lastError);
                         } else {
                             resolve();
                         }
                    });
                 });
            } else if (typeof browser !== "undefined" && browser.storage && browser.storage.local) {
                await browser.storage.local.remove(name);
            } else {
                 console.warn("Extension storage API not available.");
                 localStorage.removeItem(name); // Basic fallback
            }
        } catch (error) {
            console.error("Error removing from extension storage:", error);
             localStorage.removeItem(name); // Fallback on error
        }
    } else {
        // Use localStorage for web (synchronous)
        localStorage.removeItem(name);
    }
}


// --- Convenience Wrappers (Keep old names for compatibility if needed, but point to new functions) ---

// Wrapper for saving the encrypted seed
async function saveEncryptedSeed(encryptedSeed) {
    await saveData('encryptedSeed', encryptedSeed);
}

// Wrapper for reading the encrypted seed
async function readEncryptedSeed() {
    return await readData('encryptedSeed');
}

// Wrapper for removing the encrypted seed
async function removeEncryptedSeed() {
    await removeData('encryptedSeed');
}

// Wrapper for saving the accounts list (as JSON string)
async function saveAccounts(accountsArray) {
    await saveData('accounts', JSON.stringify(accountsArray));
}

// Wrapper for reading the accounts list (parses JSON string)
async function readAccounts() {
    const accountsJson = await readData('accounts');
    try {
        return accountsJson ? JSON.parse(accountsJson) : []; // Return empty array if null/undefined
    } catch (e) {
        console.error("Error parsing accounts JSON from storage:", e);
        return []; // Return empty array on parsing error
    }
}

// Wrapper for removing the accounts list
async function removeAccounts() {
    await removeData('accounts');
}

// Wrapper for saving the selected account index
async function saveSelectedAccountIndex(index) {
    // Ensure index is stored as a string for consistency with localStorage
    await saveData('selectedAccountIndex', String(index));
}

// Wrapper for reading the selected account index (parses to number)
async function readSelectedAccountIndex() {
    const indexStr = await readData('selectedAccountIndex');
    // Default to 0 if not found or invalid
    const index = parseInt(indexStr, 10);
    return isNaN(index) ? 0 : index;
}

// Wrapper for removing the selected account index
async function removeSelectedAccountIndex() {
    await removeData('selectedAccountIndex');
}

// --- Keep old cookie functions for reference or potential specific use, but mark as deprecated ---

/*
 * @deprecated Use saveData instead.
 */
function createSecureCookie(name, value, days) {
    console.warn("createSecureCookie is deprecated. Use saveData instead.");
    // Original cookie implementation (kept for reference)
    let expires = "";
    if (days) {
        let date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        expires = "; expires=" + date.toUTCString();
    }
    // Note: Secure flag requires HTTPS. samesite=strict is good practice.
    document.cookie = name + "=" + (value || "") + expires + "; path=/; SameSite=Strict; Secure";
}

/*
 * @deprecated Use readData instead.
 */
async function readSecureCookie(name) {
     console.warn("readSecureCookie is deprecated. Use readData instead.");
     // Try new method first
     const data = await readData(name);
     if (data !== undefined && data !== null) {
         return data;
     }
     // Fallback to old cookie method if needed (optional)
    let nameEQ = name + "=";
    let ca = document.cookie.split(';');
    for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') {
            c = c.substring(1, c.length);
        }
        if (c.indexOf(nameEQ) === 0) {
            return c.substring(nameEQ.length, c.length);
        }
    }
    return null;
}

/*
 * @deprecated Use removeData instead.
 */
function eraseSecureCookie(name) {
     console.warn("eraseSecureCookie is deprecated. Use removeData instead.");
     removeData(name); // Call the new unified function
    // Original cookie implementation (kept for reference)
    document.cookie = name + '=; Max-Age=-99999999; path=/; SameSite=Strict; Secure';
}

======================================================================
File: xian-web-wallet/js/placeholder.min.js
======================================================================
!function(t,e){"object"==typeof module&&module.exports?module.exports=e(t):t.placeholder=e(t)}("undefined"!=typeof window?window:this,function(){function t(t){c&&u||(c=document.createElement("canvas"),u=c.getContext("2d"));var e=parseInt(t.a[0]),n=parseInt(t.a[1]);c.width=e,c.height=n,u.clearRect(0,0,e,n),u.fillStyle=t.c,u.fillRect(0,0,e,n),u.fillStyle=t.d,u.font=t.e+" normal "+t.f+" "+(t.g||100)+"px "+t.h;var r=1;if(""===t.g){var o=.7*e,l=.7*n,i=u.measureText(t.b).width,a=100;r=Math.min(o/i,l/a)}return u.translate(e/2,n/2),u.scale(r,r),u.textAlign="center",u.textBaseline="middle",u.fillText(t.b,0,0),c}function e(){return"#"+("00000"+(16777216*Math.random()<<0).toString(16)).slice(-6)}function n(t){t=t||{};var n=t.size||"128x128",r=t.text||n,o=t.bgcolor||e(),l=t.color||e(),i=t.fstyle||"normal",a=t.fweight||"bold",c=t.fsize||"",u=t.ffamily||"consolas",f={};return n=n.split("x"),2!==n.length&&(n=[128,128]),f.a=n,f.b=r,f.c=o,f.d=l,f.e=i,f.f=a,f.g=c,f.h=u,t=null,f}function r(e){return e=n(e),t(e)}function o(t){return r(t).toDataURL()}function l(t,e,n){return t.getAttribute(e)||n}function i(t){var e,n={},r=t.split("&");for(var o in r){e=r[o].split("=");try{n[e[0]]=decodeURIComponent(e[1])}catch(l){n[e[0]]=e[1]}}return n}function a(t){for(var e,n,r=document.querySelectorAll("img.placeholder"),a=0;a<r.length;a++)e=r[a],!t&&l(e,f,"")||(n=i(l(e,"options","")),e.setAttribute("src",o(n)),e.setAttribute(f,"1"))}var c,u,f="placeholder-rendered";return a(),{getData:o,getCanvas:r,render:a}});

